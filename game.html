<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>جاري فتح اللعبة</title>
  <style>
    :root{
      --bg1:#4b2a4e;
      --bg2:#6b3b6a;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --accent:#f4c400;
      --btn:#1f4fa3;
    }
    body{
      margin:0; min-height:100vh;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 700px at 30% 10%, rgba(255,255,255,.10), transparent 60%),
                  linear-gradient(180deg,var(--bg2),var(--bg1));
      display:flex; align-items:center; justify-content:center;
      padding:18px 12px; box-sizing:border-box;
    }
    /* ✅ افتراضيًا نخلي الواجهة “غير ملحوظة” */
    .wrap{ width:min(520px,100%); opacity:0; pointer-events:none; transition:.15s ease; }
    .show{ opacity:1; pointer-events:auto; }

    .card{
      background:var(--card);
      border-radius:18px;
      padding:18px 16px;
      box-shadow:0 14px 30px rgba(0,0,0,.22);
      text-align:center;
    }
    .top{display:flex;align-items:center;justify-content:center;gap:10px;margin:0 0 8px}
    .top img{width:40px;height:40px;object-fit:contain}
    .title{margin:6px 0 8px;font-size:18px;font-weight:800;color:var(--text)}
    .sub{margin:0 0 14px;color:var(--muted);font-size:14px;line-height:1.6}

    .spinner{
      width:34px;height:34px;border-radius:50%;
      border:4px solid rgba(31,79,163,.18);
      border-top-color: var(--btn);
      margin:8px auto 12px;
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .btn{
      border:0; border-radius:12px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      min-width:170px;
    }
    .btn-primary{background:var(--btn);color:#fff}
    .btn-accent{background:var(--accent);color:#111}
    .small{font-size:12px;color:#777;margin-top:10px}
  </style>
</head>
<body>

  <!-- ✅ هذا الصندوق ما يظهر إلا لو صار خطأ فعلي بعد محاولتين -->
  <div class="wrap" id="wrap">
    <div class="card">
      <div class="top">
        <img src="/logo.png" alt="Sandooq" />
      </div>
      <div class="title" id="t">تعذر الفتح</div>
      <div class="spinner" id="sp"></div>
      <p class="sub" id="m">فيه مشكلة مؤقتة. جرّب إعادة المحاولة.</p>

      <div class="row">
        <button class="btn btn-primary" id="retryBtn">إعادة المحاولة</button>
        <button class="btn btn-accent" id="goActivateBtn">فتح صفحة التفعيل</button>
      </div>

      <div class="small" id="debug"></div>
    </div>
  </div>

<script>
(function(){
  const wrap = document.getElementById("wrap");
  const t = document.getElementById("t");
  const m = document.getElementById("m");
  const sp = document.getElementById("sp");
  const debugEl = document.getElementById("debug");
  const retryBtn = document.getElementById("retryBtn");
  const goActBtn = document.getElementById("goActivateBtn");

  function showErrorUI(title, msg, dbg){
    t.textContent = title || "تعذر الفتح";
    m.textContent = msg || "فيه مشكلة مؤقتة. جرّب إعادة المحاولة.";
    sp.style.display = "none";
    debugEl.textContent = dbg || "";
    wrap.classList.add("show");
  }

  function ensureDeviceId(){
    const key = "sandooq_device_id_v1";
    let id = localStorage.getItem(key);
    if(!id){
      id = (crypto?.randomUUID ? crypto.randomUUID() :
        ("dev_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
      localStorage.setItem(key, id);
    }
    return id;
  }

  function go(url){
    location.replace(url);
  }

  function here(){
    return location.pathname + (location.search || "") + (location.hash || "");
  }

  function targetGame(){
    // ننقل نفس الـ query للملف الكبير
    return "/game_full.html" + (location.search || "") + (location.hash || "");
  }

  async function fetchMe(deviceId){
    // ✅ جرّب GET أول (أسرع/أخف)، وإذا رجع 405 جرّب POST
    let res = await fetch("/api2/me", {
      method: "GET",
      headers: { "X-Device-Id": deviceId },
      credentials: "include"
    });

    if (res.status === 405) {
      res = await fetch("/api2/me", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Device-Id": deviceId
        },
        credentials: "include",
        body: "{}"
      });
    }

    let data = null;
    try { data = await res.json(); } catch {}
    return { res, data };
  }

  async function checkOnce(){
    const deviceId = ensureDeviceId();

    const { res, data } = await fetchMe(deviceId);

    // غير مسجّل/جلسة غير موجودة
    if(!res.ok || !data || data.ok !== true){
      const next = encodeURIComponent(here());
      go("/activate?next=" + next);
      return;
    }

    // مسجّل لكن غير مفعّل
    if(!data.activated){
      const next = encodeURIComponent(here());
      go("/activate?next=" + next);
      return;
    }

    // ✅ تمام: افتح اللعبة الكبيرة فورًا
    go(targetGame());
  }

  async function checkWithRetry(){
    // ✅ محاولة 1
    try{
      await checkOnce();
      return;
    }catch(e1){
      // ✅ محاولة 2 بعد 500ms
      try{
        await new Promise(r=>setTimeout(r, 500));
        await checkOnce();
        return;
      }catch(e2){
        // ✅ هنا فقط نظهر واجهة الخطأ (نادر)
        showErrorUI(
          "تعذر الفتح",
          "فيه مشكلة مؤقتة. جرّب إعادة المحاولة.",
          String((e2 && e2.message) ? e2.message : e2)
        );
      }
    }
  }

  retryBtn.addEventListener("click", ()=>{
    sp.style.display = "block";
    wrap.classList.remove("show");
    checkWithRetry();
  });

  goActBtn.addEventListener("click", ()=>{
    const next = encodeURIComponent(here());
    go("/activate?next=" + next);
  });

  // ✅ ابدأ فورًا (بدون ما يلاحظ المستخدم)
  checkWithRetry();
})();
</script>

</body>
</html>

<!-- game.html – إصدار 2 (بوابة تحقق صامتة + ما تظهر إلا عند فشل مرتين) -->
