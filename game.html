<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>سباق الحروف</title>
  <style>
    :root{
      --bg:#1f4fa3;
      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --green:#1aa34a;
      --orange:#f28c00;
      --red:#c01818;

      --hexGreen:  rgba(0, 140, 70, .42);
      --hexOrange: rgba(255, 140, 0, .42);
      --hexPale:   rgba(255, 215, 80, .68);
      --hexBorder: rgba(0,0,0,.10);
    }

    body{margin:0;background:var(--bg);font-family:Arial, sans-serif;color:#fff;text-align:center}
    header{position:relative;padding:14px 14px 0}
    /* ✅ تكبير بسيط ليكون واضح بالجوال */
    .logo{position:absolute;left:14px;top:12px;width:56px;height:56px;object-fit:contain}
    .gameName{position:absolute;right:14px;top:20px;font-size:14px;opacity:.95}
    h1{margin:18px 0 10px;color:var(--yellow);font-size:28px}
    .wrap{width:95%;max-width:900px;margin:0 auto}

    .card{
      background:var(--card);color:var(--text);
      width:100%;margin:12px auto;padding:12px;border-radius:12px;
      box-sizing:border-box
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}
    .btn{padding:12px 14px;font-size:16px;border:none;border-radius:10px;cursor:pointer}
    .btnYellow{background:var(--yellow);color:#000}
    .btnGreen{background:var(--green);color:#fff}
    .btnRed{background:var(--red);color:#fff}
    .btnOrange{background:var(--orange);color:#fff}

    .codeBox{font-size:18px}
    .codeNum{font-size:28px;font-weight:bold;letter-spacing:2px}

    .teams{display:flex;gap:10px;flex-wrap:wrap}
    .teamCol{flex:1;min-width:240px;border-radius:12px;padding:10px;color:#fff}
    .teamGreen{background:rgba(26,163,74,.9)}
    .teamOrange{background:rgba(242,140,0,.9)}
    .teamTitle{font-weight:bold;margin-bottom:8px}
    .playerItem{
      background:rgba(255,255,255,.18);
      padding:8px;border-radius:10px;margin:6px 0;cursor:pointer
    }

    /* MAP */
    .mapOuter{width:100%;display:flex;justify-content:center}
    .mapScale{
      width:min(92vw, 760px);
      transform:scale(var(--zoom, 1));
      transform-origin:center top;
    }
    .mapBox{
      position:relative;
      width:100%;
      border-radius:12px;
      overflow:hidden;
      background:transparent;
    }
    .mapBox img{
      width:100%;
      height:auto;
      display:block;
      object-fit:unset;
    }

    .overlaySvg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:auto;
    }
    .overlaySvg .cell{
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      stroke: var(--hexBorder);
      stroke-width: 1;
    }

    .overlaySvg .state0{ fill: rgba(0,0,0,0.001); }
    .overlaySvg .state1{ fill: var(--hexPale); }
    .overlaySvg .state2{ fill: var(--hexGreen); }
    .overlaySvg .state3{ fill: var(--hexOrange); }

    @keyframes palePulse {
      0%   { opacity: 1; }
      50%  { opacity: .35; }
      100% { opacity: 1; }
    }
    .overlaySvg .state1.pulse { animation: palePulse 0.9s ease-in-out infinite; }

    .below{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:stretch}
    .buzzBox{
      min-width:260px;flex:1;
      border-radius:12px;padding:12px;color:#fff;
      display:flex;align-items:center;justify-content:center;font-size:18px
    }
    .buzzEmpty{background:rgba(0,0,0,.25)}
    .questionBox{
      min-width:260px;flex:2;
      border-radius:12px;padding:12px;background:#fff;color:#111;text-align:right
    }
    .qTitle{font-weight:bold;margin-bottom:8px}
    .qText{line-height:1.6}
    .qAns{line-height:1.6;margin-top:8px;opacity:.9}
    .smallNote{font-size:12px;opacity:.85;margin-top:8px}

    .buzzRow{display:flex;gap:10px;flex-wrap:wrap;align-items:stretch;justify-content:center}
    .nextQBtn{min-width:160px}

    .playerBtnWrap{margin-top:14px}
    .playerBigBtn{
      width:min(92vw, 520px);
      height:110px;
      border:none;border-radius:18px;
      background:var(--red);
      cursor:pointer;
    }
    .disabled{opacity:.5;cursor:not-allowed}

    .footerBtn{
      width:100%;max-width:520px;margin:10px auto 18px;
      padding:14px;border:none;border-radius:12px;background:var(--yellow);cursor:pointer;color:#000;font-size:18px
    }
    a{color:inherit}

    /* Timer UI */
    .timerSelect{
      padding:12px 10px;
      font-size:16px;
      border-radius:10px;
      border:0;
      background:#fff;
      color:#111;
      min-width:120px;
    }
    .timerCircle{
      width:56px;height:56px;
      border-radius:50%;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      user-select:none;
    }
    @keyframes timerFlash {
      0%   { background: var(--red); color:#fff; }
      50%  { background: var(--yellow); color:#000; }
      100% { background: var(--red); color:#fff; }
    }
    .timerFlashing{
      animation: timerFlash .6s linear infinite;
    }

    /* ✅ مشاركة اللعبة (Modal) */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(92vw, 520px);
      background:#fff; color:#111;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
      text-align:right;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(0,0,0,.08);
      font-weight:bold;
    }
    .modalClose{
      border:none;background:transparent;font-size:20px;cursor:pointer;
    }
    .modalBody{ padding:14px; }
    .shareTabs{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:12px}
    .shareBox{
      background:#f3f5f9;
      border-radius:14px;
      padding:14px;
      text-align:center;
    }
    .bigCode{font-size:34px;font-weight:800;letter-spacing:2px}
    .copyNote{font-size:12px;color:#444;margin-top:8px}
    .linkBox{
      background:#fff;
      border:1px dashed rgba(0,0,0,.25);
      border-radius:12px;
      padding:12px;
      word-break:break-all;
      user-select:text;
      text-align:left;
      direction:ltr;
      font-size:13px;
    }
    .copyBtn{
      margin-top:10px;
      width:100%;
      max-width:260px;
    }
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <header>
    <img class="logo" src="logo.png" alt="شعار صندوق المسابقات">
    <div id="gameName" class="gameName"></div>
    <h1>سباق الحروف</h1>
  </header>

  <div class="wrap">
    <div id="main" class="card">جاري التحميل...</div>
    <button class="footerBtn" onclick="location.href='index.html'">الرجوع للرئيسية</button>
  </div>

  <!-- ✅ مكتبة QR (للباركود) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    const MAPS = [
      [
        ["ش","أ","ث","د","هـ"],
        ["ي","ح","ض","ن","ك"],
        ["غ","ظ","ق","ر","ع"],
        ["ص","ز","س","ط","و"],
        ["ذ","ل","ب","م","ج"]
      ],
      [
        ["ق","ص","و","د","ب"],
        ["ح","ي","ض","هـ","ث"],
        ["ك","ط","ش","ز","م"],
        ["أ","ر","س","ظ","ث"],
        ["ذ","غ","هـ","ع","ج"]
      ],
      [
        ["ذ","ج","أ","ب","ر"],
        ["ي","ح","ز","ل","س"],
        ["ث","ظ","ق","ض","ع"],
        ["ص","ن","د","ط","غ"],
        ["ك","خ","هـ","م","و"]
      ]
    ];

    const QUESTIONS = {};
    const ALL_LETTERS = Array.from(new Set(MAPS.flat(2)));
    for(const L of ALL_LETTERS){
      QUESTIONS[L] = Array.from({length:25}, (_,i) => ({
        q: `(${i+1}) سؤال لحرف ${L}`,
        a: `${L}...`
      }));
    }

    /* ====== (باقي الأسئلة كما هي - لم يتم تغييرها) ====== */
    QUESTIONS["هـ"] = [
      { q: "هي البنيه او الاطار الذي يستخدم لدعم شيئ ما ويمكن ان يكون معنوياً مثل المباني او معنوياً مثل (……..)", a: "هيكل" },
      { q: "هو مايهدى من الانعام الى الحرم تقرباً الى الله", a: "هدي" },
      { q: "هو نوع من الشعر نقيض المديح ويُكتب عندما الشاعر يعبر عن سخطة واشمئزازه", a: "هجاء" },
      { q: "هو نبات عطري يُستخدم في الطبخ والقهوة ويُعرف بـ \"ملك التوابل\"؟", a: "هيل" },
      { q: "هي مدينة يابانية تعرضت لأول قنبلة ذرية", a: "هيروشيما" },
      { q: "من هو النبي الذي ارسله الله الى قوم عاد؟", a: "هود عليه السلام" },
      { q: "من أول من سعى بين الصفا و المروة ؟", a: "هاجر ام اسماعيل عليه السلام" },
      { q: "هي صفة بين المشي والركض", a: "هروله" },
      { q: "هو الكلام الفارغ الذي لا معنى له", a: "هراء" },
      { q: "هي كلمة في اللغة العربية تعني اعطاء الشخص ماله لشخص اخر بلا عوض", a: "هبه" },
      { q: "ماذا يطلق على صوت الموج", a: "هدير" },
      { q: "هو موقع شهير على شبكة اﻹنترنت خاص بإنشاء بريد إلكتروني مجاني", a: "هوتميل" },
      { q: "هو مسلسل كرتوني قديم معروف عند الطيبين يبدأ اسمه بحرف هـ", a: "هزيم الرعد" },
      { q: "هي هضبة تقع في وسط المملكة العربية السعودية", a: "هضبة نجد" },
      { q: "هي الحالة التي يشعر بها الانسان عندما يصبح خائفاً", a: "هلع" },
      { q: "شخصية من شخصيات الممثل عبدالله السدحان في مسلسل طاش ماطاش", a: "هدبدب" },
      { q: "هو لقب يطلق على قمة سلسلة جبال معروفة عالمياً", a: "هملايا" },
      { q: "هو غاز خفيف جداً وغير قابل للاشتعال ويستخدم في المناطيد", a: "هيليوم" },
      { q: "مدينة ألمانية تعتبر من أهم الموانئ الأوروبية", a: "هامبورغ" },
      { q: "هي نوبات من الانفعالات الشديدة او الضحك والبكاء غير المنضبط", a: "هستيريا" },
      { q: "هو اسم يطلق على الاشخاص اللذين يتركون وطنهم للعيش في بلد آخر", a: "هجرة" },
      { q: "هي نشاط منتظم يمارسه الشخص في وقت فراغة گ/ الرسم او الطبخ الخ…", a: "هوايه" },
      { q: "هو المطر الخفيف المتواصل الذي يهطل على دفعات", a: "هتان" },
      { q: "هي ولاية امريكية تتكون من عدة جز وتقع في المحيط الهادئ", a: "هاواي" },
      { q: "هو ممر مائي ضيق يربط الخليج العربي بخليج عُمان يسمى مضيق ……..؟", a: "هرمز" }
    ];

    /* (ملاحظة) باقي الحروف كما هي من نسختك الأخيرة… */

    QUESTIONS["خ"] = [
      { q: "هو لقب أطلق على النبي إبراهيم.", a: "خليل الله" },
      { q: "ماهي الأرض التي فتحها المسلمون في عهد النبي بعد معركة قصيرة مع اليهود؟", a: "خيبر" },
      { q: "ما هو المصطلح العربي والقرآني الذي يعني أن عاقبة الأمر كرائحة المسك؟", a: "ختامها مسك" },
      { q: "هو امتداد واسع في الأرض يحدثه بحر؟", a: "خليج" },
      { q: "انتقال مفصل من موضعه؟", a: "خلع" },
      { q: "في مجال القانون، الطرف الآخر في القضية", a: "خصم" },
      { q: "ما اللفظ الذي يدلُّ على الإيجاز والاختصار في أي سياق أو نص؟", a: "خلاصة" },
      { q: "انعقاد اللسان عن الكلام ؟", a: "خرس" },
      { q: "ما الفعل الذي يعني الاستسلام والخضوع مع انعدام المقاومة؟", a: "خنوع" },
      { q: "هو بمعنى فقد بعض ما عنده؟", a: "خسر" }
    ];

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(location.search);
    const role = params.get("role");
    const code = params.get("code");
    const hostKey = params.get("key");
    const pid = params.get("pid");

    const main = document.getElementById("main");
    const gameNameEl = document.getElementById("gameName");

    if(!role || !code){
      main.textContent = "بيانات الدخول غير مكتملة.";
      throw new Error("Missing params");
    }

    const roomRef = ref(db, `rooms/${code}`);

    function teamColor(team){
      return team === "green" ? "rgba(26,163,74,.9)" : "rgba(242,140,0,.9)";
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function cellKey(row,col){ return `${row}-${col}`; }

    const BBOX_CACHE = {};

    function detectHexBBox(img){
      const nw = img.naturalWidth, nh = img.naturalHeight;
      const maxW = 700;
      const scale = Math.min(1, maxW / nw);

      const cw = Math.round(nw * scale);
      const ch = Math.round(nh * scale);

      const canvas = document.createElement("canvas");
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext("2d", { willReadFrequently:true });
      ctx.drawImage(img, 0, 0, cw, ch);

      const data = ctx.getImageData(0,0,cw,ch).data;

      let minX = cw, minY = ch, maxX = -1, maxY = -1;
      let found = false;

      const step = 2;
      for(let y=0; y<ch; y+=step){
        for(let x=0; x<cw; x+=step){
          const i = (y*cw + x) * 4;
          const r = data[i], g = data[i+1], b = data[i+2];
          const mx = Math.max(r,g,b), mn = Math.min(r,g,b);
          const avg = (r+g+b)/3;

          if(avg > 180 && (mx - mn) < 60){
            found = true;
            if(x < minX) minX = x;
            if(y < minY) minY = y;
            if(x > maxX) maxX = x;
            if(y > maxY) maxY = y;
          }
        }
      }

      if(!found){
        return { x0:0.12, y0:0.04, x1:0.90, y1:0.95 };
      }

      minX = Math.max(0, minX - 2);
      minY = Math.max(0, minY - 2);
      maxX = Math.min(cw - 1, maxX + 2);
      maxY = Math.min(ch - 1, maxY + 2);

      return {
        x0: minX / cw,
        y0: minY / ch,
        x1: (maxX + 1) / cw,
        y1: (maxY + 1) / ch,
      };
    }

    function setStateClass(el, st){
      el.classList.remove("state0","state1","state2","state3","pulse");
      el.classList.add(`state${st}`);
      if(st === 1) el.classList.add("pulse");
    }

    function hexPointsPointyTop(x, y, w, h){
      const pts = [
        [x + w/2, y],
        [x + w,   y + h*0.25],
        [x + w,   y + h*0.75],
        [x + w/2, y + h],
        [x,       y + h*0.75],
        [x,       y + h*0.25],
      ];
      return pts.map(p => `${p[0].toFixed(2)},${p[1].toFixed(2)}`).join(" ");
    }

    /* Timer state */
    let TIMER_RUNNING = false;
    let TIMER_DONE = false;
    let TIMER_SELECTED = 10;
    let TIMER_REMAINING = 10;
    let TIMER_INTERVAL = null;

    function beep(){
      try{
        const AC = window.AudioContext || window.webkitAudioContext;
        if(!AC) return;
        const ctx = new AC();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.12;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(() => {
          o.stop();
          ctx.close();
        }, 300);
      }catch(e){}
    }

    function stopTimer(){
      if(TIMER_INTERVAL){
        clearInterval(TIMER_INTERVAL);
        TIMER_INTERVAL = null;
      }
      TIMER_RUNNING = false;
    }

    function applyTimerUI(){
      const sel = document.getElementById("timerSelect");
      const btn = document.getElementById("timerBtn");
      if(!sel || !btn) return;

      sel.value = String(TIMER_SELECTED);

      if(TIMER_DONE) btn.classList.add("timerFlashing");
      else btn.classList.remove("timerFlashing");

      btn.textContent = TIMER_RUNNING ? String(TIMER_REMAINING) : String(TIMER_SELECTED);
    }

    /* ✅ ثبات الزوم (لا يرجع للأصلي عند الضغط/التحديث) */
    const ZOOM_STORAGE_KEY = `sandooq_zoom_${code}_${role}_${pid||"host"}`;
    function getSavedZoom(){
      const v = parseFloat(localStorage.getItem(ZOOM_STORAGE_KEY) || "1");
      return (Number.isFinite(v) ? Math.min(1.35, Math.max(0.8, v)) : 1);
    }
    function saveZoom(v){
      localStorage.setItem(ZOOM_STORAGE_KEY, String(v));
    }

    function makeJoinUrl(roomCode){
      const u = new URL("join.html", location.href);
      u.searchParams.set("code", roomCode);
      return u.toString();
    }

    function copyToClipboard(text){
      const ok = () => {
        // لا نضيف عناصر جديدة، فقط تنبيه بسيط
        alert("تم نسخ الرابط");
      };
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(ok).catch(() => fallback());
      }else{
        fallback();
      }
      function fallback(){
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); ok(); }catch(e){}
        document.body.removeChild(ta);
      }
    }

    function renderHostLobby(room){
      const players = room.players || {};
      const list = Object.entries(players).map(([id,p]) => ({id, ...p}));

      const green = list.filter(p => p.team === "green");
      const orange = list.filter(p => p.team === "orange");

      main.innerHTML = `
        <div class="codeBox">رمز اللعبة</div>
        <div class="codeNum">${escapeHtml(room.code)}</div>
        <div class="smallNote">شارك الرمز مع اللاعبين للدخول</div>

        <div style="height:12px"></div>

        <div class="teams">
          <div class="teamCol teamGreen">
            <div class="teamTitle">الفريق الأخضر</div>
            <div id="greenList"></div>
          </div>
          <div class="teamCol teamOrange">
            <div class="teamTitle">الفريق البرتقالي</div>
            <div id="orangeList"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <button id="shareBtn" class="btn btnYellow">مشاركة اللعبة</button>
          <button id="startBtn" class="btn btnGreen">ابدأ اللعبة</button>
        </div>

        <div class="smallNote">يمكنك الضغط على اسم لاعب لنقله للفريق الآخر</div>

        <!-- ✅ نافذة مشاركة اللعبة -->
        <div id="shareBack" class="modalBack hidden">
          <div class="modal" role="dialog" aria-modal="true">
            <div class="modalHeader">
              <span>مشاركة اللعبة</span>
              <button id="shareClose" class="modalClose" aria-label="إغلاق">✕</button>
            </div>
            <div class="modalBody">
              <div class="shareTabs">
                <button id="tabCode" class="btn btnGreen">مشاركة عبر الرمز</button>
                <button id="tabQr" class="btn btnOrange">مشاركة عبر الباركود</button>
                <button id="tabLink" class="btn btnYellow">مشاركة عبر الرابط</button>
              </div>

              <div id="shareContent" class="shareBox"></div>
            </div>
          </div>
        </div>
      `;

      const greenList = document.getElementById("greenList");
      const orangeList = document.getElementById("orangeList");

      function draw(colEl, arr){
        colEl.innerHTML = arr.map(p => `<div class="playerItem" data-id="${escapeHtml(p.id)}">${escapeHtml(p.name)}</div>`).join("") || `<div class="smallNote">لا يوجد</div>`;
      }
      draw(greenList, green);
      draw(orangeList, orange);

      main.querySelectorAll(".playerItem").forEach(el => {
        el.addEventListener("click", async () => {
          const id = el.getAttribute("data-id");
          const p = players[id];
          if(!p) return;
          const newTeam = (p.team === "green") ? "orange" : "green";
          await update(ref(db, `rooms/${code}/players/${id}`), { team: newTeam });
        });
      });

      document.getElementById("startBtn").addEventListener("click", async () => {
        await update(roomRef, {
          status: "started",
          activeMap: 0,
          freeze: false,
          buzzer: null,
          current: { letter: null, qIndex: 0, row: null, col: null, map: 0 }
        });
      });

      /* ✅ مشاركة اللعبة */
      const back = document.getElementById("shareBack");
      const closeBtn = document.getElementById("shareClose");
      const openBtn = document.getElementById("shareBtn");
      const content = document.getElementById("shareContent");
      const joinUrl = makeJoinUrl(room.code);

      function openModal(){
        back.classList.remove("hidden");
        showCode(); // افتراضي
      }
      function closeModal(){
        back.classList.add("hidden");
      }

      openBtn.addEventListener("click", openModal);
      closeBtn.addEventListener("click", closeModal);
      back.addEventListener("click", (e) => {
        if(e.target === back) closeModal();
      });

      function showCode(){
        content.innerHTML = `
          <div class="smallNote" style="margin-bottom:8px">رمز الغرفة</div>
          <div class="bigCode">${escapeHtml(room.code)}</div>
          <div class="copyNote">أرسل الرمز للاعبين للدخول</div>
        `;
      }

      function showQr(){
        content.innerHTML = `
          <div class="smallNote" style="margin-bottom:10px">امسح الباركود للدخول مباشرة</div>
          <div id="qrBox" style="display:flex;justify-content:center"></div>
          <div class="copyNote" style="margin-top:10px">يفتح صفحة كتابة الاسم ثم انتظار بدء اللعبة</div>
        `;
        const el = document.getElementById("qrBox");
        if(el){
          el.innerHTML = "";
          try{
            new QRCode(el, { text: joinUrl, width: 220, height: 220 });
          }catch(e){
            el.textContent = "تعذر توليد الباركود";
          }
        }
      }

      /* ✅ (الجديد) مشاركة عبر الرابط + زر نسخ الرابط */
      function showLink(){
        content.innerHTML = `
          <div class="smallNote" style="margin-bottom:10px">انسخ الرابط وأرسله للاعبين</div>
          <div class="linkBox" id="linkText">${escapeHtml(joinUrl)}</div>
          <button id="copyLinkBtn" class="btn btnGreen copyBtn">نسخ الرابط</button>
        `;
        const copyBtn = document.getElementById("copyLinkBtn");
        copyBtn?.addEventListener("click", () => copyToClipboard(joinUrl));
      }

      document.getElementById("tabCode").addEventListener("click", showCode);
      document.getElementById("tabQr").addEventListener("click", showQr);
      document.getElementById("tabLink").addEventListener("click", showLink);
    }

    function renderWaiting(msg){
      main.innerHTML = `<div class="muted">${escapeHtml(msg)}</div>`;
    }

    function renderGame(room, me){
      gameNameEl.textContent = room?.name ? room.name : "";

      const isHost = role === "host";
      const started = room.status === "started";

      const savedZoom = getSavedZoom();

      main.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div style="font-size:14px;opacity:.9">رمز: <b>${escapeHtml(room.code)}</b></div>
          <div></div>
        </div>

        <div class="mapOuter">
          <div id="mapScale" class="mapScale" style="--zoom:${savedZoom}">
            <div id="mapBox" class="mapBox">
              <img id="mapImg" src="" alt="">
              <svg id="overlay" class="overlaySvg"></svg>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="row" style="justify-content:space-between">
          <div class="row">
            ${isHost ? `<button id="mapBtn" class="btn btnYellow">تغيير الخريطة</button>` : ""}
            <input id="zoom" type="range" min="0.8" max="1.35" step="0.01" value="${savedZoom}" />
            ${isHost ? `<button id="freezeBtn" class="btn ${room.freeze ? "btnRed" : "btnGreen"}">${room.freeze ? "مجمّد" : "مفعل"}</button>` : ""}
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="below">
          <div class="buzzRow" style="flex:1;min-width:260px">
            <div id="buzzBox" class="buzzBox buzzEmpty">—</div>

            ${isHost ? `
              <button id="nextQ" class="btn btnYellow nextQBtn">تغيير السؤال</button>

              <select id="timerSelect" class="timerSelect">
                <option value="10">10 ث</option>
                <option value="15">15 ث</option>
                <option value="20">20 ث</option>
                <option value="25">25 ث</option>
                <option value="30">30 ث</option>
              </select>

              <button id="timerBtn" class="btn btnOrange timerCircle">10</button>
            ` : ""}
          </div>

          ${isHost ? `
            <div class="questionBox">
              <div class="qTitle">السؤال</div>
              <div id="qText" class="qText">اختر حرفًا من الخريطة</div>
              <div id="qAns" class="qAns"></div>
            </div>
          ` : `
            <div class="questionBox">
              <div class="qTitle">الحالة</div>
              <div class="qText">${started ? "جاهز" : "بانتظار المقدم"}</div>
            </div>
          `}
        </div>

        ${(!isHost) ? `
          <div class="playerBtnWrap">
            <button id="buzzBtn" class="playerBigBtn"></button>
            <div class="smallNote">${started ? "اضغط للإجابة" : "بانتظار بدء اللعبة"}</div>

            <div style="height:10px"></div>
            <div class="card" style="background:#fff;color:#111;border-radius:14px;max-width:520px;margin:0 auto;padding:14px">
              <div style="font-weight:bold;color:#c01818;margin-bottom:6px">اشتري اللعبة الآن</div>
              <div style="font-size:13px;color:#333;margin-bottom:10px">هذا رابط المتجر الرسمي لشراء اللعبة</div>
              <div style="background:#f4c400;padding:12px;border-radius:12px;direction:ltr;text-align:center;font-weight:bold">
                https://sandooq-m.com
              </div>
            </div>
          </div>
        ` : ""}
      `;

      const mapImg = document.getElementById("mapImg");
      const overlay = document.getElementById("overlay");
      const mapScale = document.getElementById("mapScale");
      const zoom = document.getElementById("zoom");

      const activeMap = Number(room.activeMap || 0);

      const src = ([
        "maps/map1.jpeg",
        "maps/map2.jpeg",
        "maps/map3.jpeg"
      ][activeMap] || "maps/map1.jpeg");

      mapImg.src = src;

      overlay.innerHTML = "";
      overlay.setAttribute("xmlns", "http://www.w3.org/2000/svg");

      const svgNS = "http://www.w3.org/2000/svg";
      for(let row=0; row<5; row++){
        for(let col=0; col<5; col++){
          const poly = document.createElementNS(svgNS, "polygon");
          poly.classList.add("cell", "state0");
          poly.setAttribute("data-row", row);
          poly.setAttribute("data-col", col);
          overlay.appendChild(poly);
        }
      }

      overlay.style.pointerEvents = isHost ? "auto" : "none";

      function applyZoomFix(){
        const mapBox = document.getElementById("mapBox");
        const mapOuter = document.querySelector(".mapOuter");
        if(!mapBox || !mapOuter) return;

        const z = Number(zoom.value || 1);
        mapScale.style.setProperty("--zoom", z);
        saveZoom(z); // ✅ حفظ الزوم فوراً

        const baseH = mapBox.offsetHeight || 0;
        const extra = Math.max(0, baseH * (z - 1));
        mapOuter.style.marginBottom = `${extra}px`;
      }

      function placeHexes(){
        const W = mapImg.clientWidth;
        const H = mapImg.clientHeight;
        if(!W || !H) return;

        overlay.setAttribute("viewBox", `0 0 ${W} ${H}`);
        overlay.setAttribute("preserveAspectRatio", "none");

        const bbox = BBOX_CACHE[src];
        if(!bbox) return;

        const x0 = bbox.x0 * W;
        const y0 = bbox.y0 * H;
        const x1 = bbox.x1 * W;
        const y1 = bbox.y1 * H;

        const gridW = x1 - x0;
        const gridH = y1 - y0;

        const w = gridW / 5.5;
        const h = gridH / 4.0;
        const stepY = h * 0.75;

        const cells = overlay.querySelectorAll(".cell");
        let i = 0;
        for(let row=0; row<5; row++){
          for(let col=0; col<5; col++){
            const left = x0 + col*w + (row%2)*(w/2);
            const top  = y0 + row*stepY;
            cells[i++].setAttribute("points", hexPointsPointyTop(left, top, w, h));
          }
        }

        applyZoomFix();
      }

      function onMapReady(){
        if(!BBOX_CACHE[src]) BBOX_CACHE[src] = detectHexBBox(mapImg);
        requestAnimationFrame(placeHexes);
      }

      if(mapImg.complete) onMapReady();
      else mapImg.addEventListener("load", onMapReady, { once:true });

      window.addEventListener("resize", () => {
        placeHexes();
        applyZoomFix();
      });

      const mapStates = (room.mapStates && room.mapStates[String(activeMap)]) ? room.mapStates[String(activeMap)] : {};
      overlay.querySelectorAll(".cell").forEach(cell => {
        const r = Number(cell.getAttribute("data-row"));
        const c = Number(cell.getAttribute("data-col"));
        const k = cellKey(r,c);
        const st = Number(mapStates?.[k] ?? 0);
        setStateClass(cell, st);
      });

      const buzzBox = document.getElementById("buzzBox");
      const buzzer = room.buzzer;

      if(buzzer && buzzer.name){
        buzzBox.classList.remove("buzzEmpty");
        buzzBox.style.background = teamColor(buzzer.team);
        buzzBox.textContent = buzzer.name;
      }else{
        buzzBox.classList.add("buzzEmpty");
        buzzBox.style.background = "rgba(0,0,0,.25)";
        buzzBox.textContent = "—";
      }

      if(isHost){
        const qText = document.getElementById("qText");
        const qAns  = document.getElementById("qAns");
        const cur = room.current || {};

        if(cur.letter){
          const list = QUESTIONS[cur.letter] || [];
          if(!list.length){
            qText.textContent = `لا توجد أسئلة لهذا الحرف: ${cur.letter}`;
            qAns.textContent  = "";
          }else{
            const idx = Number(cur.qIndex || 0) % list.length;
            const item = list[idx];
            qText.textContent = item?.q ?? "—";
            qAns.textContent  = item?.a ?? "";
          }
        }else{
          qText.textContent = "اختر حرفًا من الخريطة";
          qAns.textContent  = "";
        }
      }

      zoom.addEventListener("input", () => {
        applyZoomFix();
      });

      const mapBtn = document.getElementById("mapBtn");
      if(mapBtn){
        mapBtn.addEventListener("click", async () => {
          const next = (activeMap + 1) % 3;
          await update(roomRef, {
            activeMap: next,
            buzzer: null,
            current: { letter: null, qIndex: 0, row: null, col: null, map: next }
          });
        });
      }

      const freezeBtn = document.getElementById("freezeBtn");
      if(freezeBtn){
        freezeBtn.addEventListener("click", async () => {
          await update(roomRef, { freeze: !room.freeze, buzzer: null });
        });
      }

      const nextQ = document.getElementById("nextQ");
      if(nextQ){
        nextQ.addEventListener("click", async () => {
          const cur = room.current || {};
          if(!cur.letter) return;
          const list = QUESTIONS[cur.letter] || [];
          if(!list.length) return;
          const nextIndex = (Number(cur.qIndex || 0) + 1) % list.length;
          await update(roomRef, { current: { ...cur, qIndex: nextIndex } });
        });
      }

      const timerSelect = document.getElementById("timerSelect");
      const timerBtn = document.getElementById("timerBtn");
      if(timerSelect && timerBtn){
        timerSelect.addEventListener("change", () => {
          TIMER_SELECTED = Number(timerSelect.value || 10);
          if(!TIMER_RUNNING && !TIMER_DONE){
            TIMER_REMAINING = TIMER_SELECTED;
          }
          applyTimerUI();
        });

        timerBtn.addEventListener("click", () => {
          if(TIMER_DONE){
            TIMER_DONE = false;
            stopTimer();
            TIMER_REMAINING = TIMER_SELECTED;
            applyTimerUI();
            return;
          }

          if(TIMER_RUNNING){
            stopTimer();
            TIMER_REMAINING = TIMER_SELECTED;
            applyTimerUI();
            return;
          }

          TIMER_RUNNING = true;
          TIMER_DONE = false;
          TIMER_REMAINING = TIMER_SELECTED;
          applyTimerUI();

          TIMER_INTERVAL = setInterval(() => {
            TIMER_REMAINING -= 1;

            const btn = document.getElementById("timerBtn");
            if(btn) btn.textContent = String(Math.max(0, TIMER_REMAINING));

            if(TIMER_REMAINING <= 0){
              stopTimer();
              TIMER_DONE = true;

              const b = document.getElementById("timerBtn");
              if(b){
                b.textContent = "0";
                b.classList.add("timerFlashing");
              }

              beep();
            }
          }, 1000);
        });

        applyTimerUI();
      }

      if(isHost){
        overlay.querySelectorAll(".cell").forEach(cell => {
          cell.addEventListener("click", async (e) => {
            e.preventDefault();
            if(room.status !== "started") return;

            const r = Number(cell.getAttribute("data-row"));
            const c = Number(cell.getAttribute("data-col"));
            const k = cellKey(r,c);

            const st = Number(mapStates?.[k] ?? 0);
            const next = (st + 1) % 4;

            const letter = MAPS[activeMap][r][c];

            const updates = {};
            updates[`rooms/${code}/mapStates/${activeMap}/${k}`] = next;
            updates[`rooms/${code}/buzzer`] = null;
            updates[`rooms/${code}/current`] = { letter, qIndex: 0, row: r, col: c, map: activeMap };

            await update(ref(db), updates);
          });
        });
      }

      const buzzBtn = document.getElementById("buzzBtn");
      if(buzzBtn){
        const disabled = (!started) || room.freeze || !me || !me.name;
        if(disabled) buzzBtn.classList.add("disabled");

        buzzBtn.addEventListener("click", async () => {
          if(!started) return;
          if(room.freeze) return;
          if(!me) return;

          const buzzerRef = ref(db, `rooms/${code}/buzzer`);
          await runTransaction(buzzerRef, (cur) => {
            if(cur === null){
              return { pid, name: me.name, team: me.team, ts: Date.now() };
            }
            return;
          });
        });
      }

      // ✅ تطبيق الزوم المحفوظ مباشرة بعد الرسم
      applyZoomFix();
    }

    onValue(roomRef, (snap) => {
      if(!snap.exists()){
        main.textContent = "اللعبة غير موجودة (رمز غير صحيح).";
        return;
      }
      const room = snap.val();
      gameNameEl.textContent = room?.name ? room.name : "";

      if(role === "host"){
        if(!hostKey || hostKey !== room.presenterKey){
          main.textContent = "صلاحية المقدم غير صحيحة.";
          return;
        }
        if(room.status === "lobby"){
          renderHostLobby(room);
          return;
        }
        renderGame(room, null);
        return;
      }

      const players = room.players || {};
      const me = pid ? players[pid] : null;

      if(!pid || !me){
        main.textContent = "بيانات اللاعب غير صحيحة.";
        return;
      }

      if(room.status === "lobby"){
        renderWaiting("بانتظار بدء اللعبة من المقدم...");
        return;
      }

      renderGame(room, me);
    });
  </script>
</body>
</html>
