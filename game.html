<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>سباق الحروف - جاري التحميل</title>

  <!-- تقليل الكاش قدر الإمكان -->
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- ✅ (تسريع) تجهيز اتصالات Firebase مبكر -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//www.gstatic.com">

  <!-- ✅ (تسريع) تنزيل ملف اللعبة الكبيرة بدري -->
  <link rel="preload" href="./game_full.html" as="document">

  <!-- ✅ (مهم) تسجيل Service Worker بدري (نفس فكرة index/join/game_full) -->
  <script>
  (function(){
    try{
      if(!("serviceWorker" in navigator)) return;
      if(!window.isSecureContext && location.hostname !== "localhost") return;

      // استخدم نفس رقم إصدار ملفاتك لكسر الكاش عند الحاجة
      var ASSET_VERSION = "2026-02-15-1";
      var vq = "?v=" + encodeURIComponent(ASSET_VERSION);

      navigator.serviceWorker
        .register("./sw.js" + vq, { scope: "./" })
        .then(function(reg){ try{ reg && reg.update && reg.update(); }catch(e){} })
        .catch(function(err){ console.warn("SW register failed.", err); });

    }catch(e){
      console.warn("SW register error.", e);
    }
  })();
  </script>

  <style>
    :root{
      --bgA:#7b3459;   /* عنابي فاتح */
      --bgB:#4b1f36;   /* عنابي غامق */
      --white:#fff;
      --shadow: rgba(0,0,0,.35);
      --text:#ffffff;
      --muted: rgba(255,255,255,.78);
      --btnText:#111;
      --btnBg:#ffffff;
      --btnBorder:#1b1b1b;
      --danger:#ffdddd;
      --dangerText:#7a1a1a;
      --card:#ffffff;
      --cardText:#111;
      --blue:#1f4fa3;
      --yellow:#f4c400;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 25% 10%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(135deg, var(--bgA), var(--bgB));
      overflow-x:hidden;
    }

    header{
      position:relative;
      padding:22px 16px 0;
      text-align:center;
    }
    .logo{
      position:absolute;
      left:14px;
      top:16px;
      width:46px;
      height:46px;
      object-fit:contain;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.25));
      pointer-events:none;
    }
    .game-title{
      display:inline-block;
      padding:10px 16px;
      border-radius:14px;
      font-size:44px;
      font-weight:900;
      letter-spacing:.5px;
      color:#fff;
      text-shadow: 0 8px 16px rgba(0,0,0,.35);
    }
    .loading-text{
      margin:10px 0 0;
      font-size:16px;
      font-weight:700;
      color:var(--muted);
    }

    .center{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: calc(100vh - 170px);
      padding:18px 12px;
    }

    /* دائرة تحميل بسيطة */
    .spinner{
      width:34px;height:34px;border-radius:50%;
      border:4px solid rgba(255,255,255,.22);
      border-top-color: rgba(255,255,255,.95);
      animation:spin .9s linear infinite;
      margin:10px auto 0;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* مساعد صغير */
    .hint{
      margin-top:14px;
      font-size:13px;
      color:rgba(255,255,255,.72);
      text-align:center;
      line-height:1.7;
    }
    .hint a{
      color:#fff;
      text-decoration:underline;
      font-weight:800;
    }

    /* زر الرئيسية مثل الصورة */
    .home-btn{
      position:fixed;
      left:16px;
      bottom:18px;
      background:var(--btnBg);
      color:var(--btnText);
      border:2px solid var(--btnBorder);
      border-radius:20px;
      padding:12px 16px;
      font-weight:900;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      cursor:pointer;
      z-index:5;
    }

    footer{
      position:fixed;
      right:14px;
      bottom:20px;
      font-size:12px;
      color:rgba(255,255,255,.8);
      z-index:4;
      text-shadow: 0 6px 12px rgba(0,0,0,.25);
      user-select:none;
    }

    /* نافذة خطأ واضحة (تظهر فقط عند الحاجة) */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px 12px;
      z-index:50;
    }
    .overlay.show{display:flex}

    .card{
      width:min(560px, 100%);
      background:var(--card);
      color:var(--cardText);
      border-radius:18px;
      padding:16px 14px;
      box-shadow:0 16px 34px rgba(0,0,0,.35);
      text-align:center;
    }
    .card h3{
      margin:6px 0 10px;
      font-size:18px;
      font-weight:900;
    }
    .card p{
      margin:0 0 12px;
      color:#444;
      line-height:1.7;
      font-size:14px;
    }
    .actions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      min-width:170px;
    }
    .btn-blue{background:var(--blue);color:#fff}
    .btn-yellow{background:var(--yellow);color:#111}
    .btn-white{background:#f1f1f1;color:#111}

    .debug{
      margin-top:10px;
      font-size:12px;
      color:#666;
      word-break:break-word;
      text-align:right;
      background:#fafafa;
      border:1px solid #eee;
      padding:10px;
      border-radius:12px;
      display:none;
    }
    .debug.show{display:block}
  </style>
</head>

<body>
  <!-- بصمة عشان نكشف لو فيه Rewrite يرجع لنفس الصفحة -->
  <!-- GATEWAY_V3_SANDOOQ -->

  <header>
    <img class="logo" src="/logo.png" alt="Sandooq" />
    <div class="game-title">سباق الحروف</div>
    <div class="loading-text">جاري التحميل...</div>
  </header>

  <div class="center">
    <div style="width:100%; text-align:center">
      <div class="spinner" aria-label="loading"></div>

      <div class="hint" id="hint">
        إذا طول التحميل أكثر من 5 ثواني:
        <br>
        <a href="./game_full.html" id="manualOpen">افتح اللعبة يدويًا</a>
        &nbsp;•&nbsp;
        <a href="/activate" id="manualActivate">افتح صفحة التفعيل</a>
      </div>
    </div>
  </div>

  <button class="home-btn" id="homeBtn">الرئيسية</button>
  <footer>© جميع الحقوق محفوظة لمتجر صندوق المسابقات</footer>

  <!-- Overlay عند الخطأ -->
  <div class="overlay" id="ov">
    <div class="card">
      <h3 id="ovTitle">تعذر فتح اللعبة</h3>
      <p id="ovMsg">فيه مشكلة مؤقتة. جرّب إعادة المحاولة.</p>

      <div class="actions">
        <button class="btn btn-blue" id="retryBtn">إعادة المحاولة</button>
        <button class="btn btn-yellow" id="goActivateBtn">فتح صفحة التفعيل</button>
        <button class="btn btn-white" id="openGameBtn">فتح اللعبة يدويًا</button>
      </div>

      <div class="debug" id="dbg"></div>
    </div>
  </div>

<script>
(function(){
  const ov = document.getElementById("ov");
  const ovTitle = document.getElementById("ovTitle");
  const ovMsg = document.getElementById("ovMsg");
  const dbg = document.getElementById("dbg");
  const retryBtn = document.getElementById("retryBtn");
  const goActivateBtn = document.getElementById("goActivateBtn");
  const openGameBtn = document.getElementById("openGameBtn");
  const homeBtn = document.getElementById("homeBtn");

  const qs = new URLSearchParams(location.search);
  const DBG = qs.get("dbg") === "1";

  function showOverlay(title, msg, debugText){
    ovTitle.textContent = title || "تعذر فتح اللعبة";
    ovMsg.textContent = msg || "فيه مشكلة مؤقتة. جرّب إعادة المحاولة.";
    if(debugText){
      dbg.textContent = debugText;
      dbg.classList.add("show");
    }else{
      dbg.textContent = "";
      dbg.classList.remove("show");
    }
    ov.classList.add("show");
  }

  function hideOverlay(){
    ov.classList.remove("show");
    dbg.classList.remove("show");
    dbg.textContent = "";
  }

  function ensureDeviceId(){
    const key = "sandooq_device_id_v1";
    let id = localStorage.getItem(key);
    if(!id){
      id = (crypto?.randomUUID ? crypto.randomUUID() :
        ("dev_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
      localStorage.setItem(key, id);
    }
    return id;
  }

  function token(){
    return localStorage.getItem("sandooq_token_v1") || "";
  }

  function here(){
    return location.pathname + (location.search || "") + (location.hash || "");
  }

  function go(url){
    location.replace(url);
  }

  function buildActivateNext(){
    return "/activate?next=" + encodeURIComponent(here());
  }

  function selfFingerprintInText(txt){
    return (txt || "").includes("GATEWAY_V3_SANDOOQ");
  }

  function dbgLog(t){
    if(!DBG) return;
    try{
      const el = document.getElementById("dbg");
      if(el){
        el.textContent = String(t || "");
        el.classList.add("show");
      }
    }catch(e){}
  }

  async function probeHtml(url){
    // ✅ (تسريع/تقليل تكلفة) نجيب جزء صغير فقط (Range) بدل تحميل الملف كله
    const u = url + (url.includes("?") ? "&" : "?") + "__probe=" + Date.now();
    const headers = { "Range": "bytes=0-4096" };
    const res = await fetch(u, { cache:"no-store", credentials:"include", headers });
    if(!res.ok) return { ok:false, status:res.status, url };

    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const txt = await res.text();
    const isHtml = ct.includes("text/html") || txt.includes("<!DOCTYPE html") || txt.includes("<html");
    if(!isHtml) return { ok:false, status:200, url, reason:"not_html" };
    if(selfFingerprintInText(txt)) return { ok:false, status:200, url, reason:"rewrite_to_gateway" };
    return { ok:true, status:200, url };
  }

  async function quickHeadOk(url){
    try{
      const u = url + (url.includes("?") ? "&" : "?") + "__h=" + Date.now();
      const res = await fetch(u, { method:"HEAD", cache:"no-store", credentials:"include" });
      if(res && res.ok) return true;
    }catch(e){}
    return false;
  }

  async function findGameFullFast(){
    // ✅ المسار الطبيعي: لا نلف — نجرب HEAD سريع على ./game_full.html
    const primary = "./game_full.html";
    const tried = [];

    const headOk = await quickHeadOk(primary);
    tried.push({ url: primary, headOk });

    if(headOk){
      return { found:true, url: primary, tried };
    }

    // fallback: نفس منطقك السابق لكن بـ probe (Range)
    const candidates = [
      "./game_full.html",
      "/game_full.html",
      "/app/game_full.html",
      "./app/game_full.html"
    ];

    for(const c of candidates){
      try{
        const r = await probeHtml(c);
        tried.push(r);
        if(r.ok) return { found:true, url:c, tried };
      }catch(e){
        tried.push({ ok:false, url:c, error:String(e && e.message ? e.message : e) });
      }
    }

    return { found:false, url: primary, tried };
  }

  async function fetchMe(){
    const deviceId = ensureDeviceId();
    const tkn = token();

    const headers = { "X-Device-Id": deviceId };
    if(tkn) headers["Authorization"] = "Bearer " + tkn;

    // جرّب GET أول، ثم POST لو 405
    let res = await fetch("/api2/me", {
      method:"GET",
      headers,
      credentials:"include",
      cache:"no-store"
    });

    if(res.status === 405){
      res = await fetch("/api2/me", {
        method:"POST",
        headers: Object.assign({ "Content-Type":"application/json" }, headers),
        credentials:"include",
        cache:"no-store",
        body:"{}"
      });
    }

    let data = null;
    try{ data = await res.json(); }catch{}
    return { res, data, deviceId, hasToken: !!tkn };
  }

  async function openHomeSafely(){
    // محاولة ذكية: لو المستخدم مفعّل نوديه الصفحة الرئيسية بدون لفّات
    try{
      const { res, data } = await fetchMe();
      if(res.ok && data && data.ok === true && data.activated){
        go("./index.html");
        return;
      }
    }catch{}
    go(buildActivateNext());
  }

  async function run(){
    hideOverlay();

    // ✅ (تسريع) شغّل فحص game_full + فحص /me بالتوازي
    const [gf, me] = await Promise.all([
      findGameFullFast(),
      fetchMe()
    ]);

    // 1) game_full موجود؟
    if(!gf.found){
      const debugText = JSON.stringify(gf.tried, null, 2);
      showOverlay(
        "ملف اللعبة الكبير غير موجود",
        "ما قدرت ألقى game_full.html (أو فيه Rewrite يرجعنا لنفس البوابة). تأكد إن الملف مرفوع بنفس الاسم (حروف صغيرة) وفي نفس المستودع.",
        debugText
      );
      openGameBtn.onclick = ()=> go("./game_full.html");
      return;
    }

    // 2) تحقق من الدخول/التفعيل
    const { res, data } = me;

    if(!res.ok || !data || data.ok !== true){
      go(buildActivateNext());
      return;
    }

    if(!data.activated){
      go(buildActivateNext());
      return;
    }

    // 3) تمام: افتح اللعبة الكبيرة مع نفس query/hash
    const target = gf.url + (location.search || "") + (location.hash || "");
    go(target);
  }

  async function runWithRetry(){
    try{
      await run();
    }catch(e1){
      try{
        await new Promise(r=>setTimeout(r, 350));
        await run();
      }catch(e2){
        showOverlay(
          "تعذر فتح اللعبة",
          "صار خطأ أثناء التحميل. جرّب إعادة المحاولة.",
          "err=" + String(e2 && e2.message ? e2.message : e2)
        );
      }
    }
  }

  retryBtn.addEventListener("click", runWithRetry);
  goActivateBtn.addEventListener("click", ()=> go(buildActivateNext()));
  openGameBtn.addEventListener("click", ()=> go("./game_full.html"));
  homeBtn.addEventListener("click", openHomeSafely);

  // ابدأ فورًا
  runWithRetry();
})();
</script>

</body>
</html>

<!-- VERSION: game.html – vGatewayFastParallel-5 -->
