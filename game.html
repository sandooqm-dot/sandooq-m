<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø­Ø±ÙˆÙ</title>

  <!-- âœ… Ø®Ø· Baloo Bhaijaan Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan&display=swap" rel="stylesheet">

  <style>
    :root{
      /* âœ… ØªØºÙ…ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø´ÙˆÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØªØºÙŠØ± Ø§Ù„Ù‡ÙˆÙŠØ©) */
      --bg:#163f8e;

      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --green:#1aa34a;
      --orange:#f28c00;
      --red:#c01818;

      /* âœ… ØªØºÙ…ÙŠÙ‚/ØªÙ‚ÙˆÙŠØ© Ø£Ù„ÙˆØ§Ù† ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø³Ø¯Ø§Ø³ÙŠØ§Øª Ø´ÙˆÙŠ */
      --hexGreen:  rgba(0, 140, 70, .50);
      --hexOrange: rgba(255, 140, 0, .50);
      --hexPale:   rgba(255, 215, 80, .74);
      --hexBorder: rgba(0,0,0,.10);

      /* âœ… Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø¤Ù‚Øª */
      --timerFill: #14b8a6;      /* ØªØ±ÙƒÙˆØ§Ø²ÙŠ */
      --timerFillLast5:#ff3b30;  /* Ø£Ø­Ù…Ø± ÙˆØ§Ø¶Ø­ */
      --timerStart:#0ea5e9;      /* Ø£Ø²Ø±Ù‚ Ù„Ø²Ø± Ø§Ø¨Ø¯Ø£ */
    }

    body{margin:0;background:var(--bg);font-family:Arial, sans-serif;color:#fff;text-align:center}
    header{position:relative;padding:14px 14px 0}

    /* âœ… ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø¥Ù„Ù‰ 75*75 */
    .logo{position:absolute;left:14px;top:14px;width:75px;height:75px;object-fit:contain}

    /* âœ… ØµÙ†Ø¯ÙˆÙ‚ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø²Ø¬Ø§Ø¬ÙŠ Ø´ÙØ§Ù) + 4 ÙƒÙ„Ù…Ø§Øª (Ø³Ø·Ø±ÙŠÙ†) Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø·ÙŠØ¹ ÙƒÙ„Ù…Ø© */
    .gameName{
      position:absolute;
      right:14px;
      top:14px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:2px;

      width:min(56vw, 260px);
      padding:8px 12px;
      border-radius:14px;

      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.28);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color:#fff;

      box-shadow:0 6px 18px rgba(0,0,0,.12);

      font-size:18px;
      font-weight:900;
      line-height:1.2;
      text-align:center;

      overflow:hidden;
      box-sizing:border-box;
    }
    .gameName:empty{display:none;}
    .gnLine{
      display:block;
      width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* âœ… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© */
    h1{
      margin:18px 0 10px;
      color:var(--yellow);
      font-size:28px;
      font-family:'Baloo Bhaijaan', Arial, sans-serif;
      font-weight:800;
    }

    .wrap{width:95%;max-width:900px;margin:0 auto}

    .card{
      background:var(--card);color:var(--text);
      width:100%;margin:12px auto;padding:12px;border-radius:12px;
      box-sizing:border-box
    }

    /* âœ… Ø±ÙØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨ ÙÙ‚Ø· */
    #main.inGame{
      margin-top:8px;
      padding-top:8px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}
    .btn{padding:12px 14px;font-size:16px;border:none;border-radius:10px;cursor:pointer}
    .btnYellow{background:var(--yellow);color:#000}
    .btnGreen{background:var(--green);color:#fff}
    .btnRed{background:var(--red);color:#fff}
    .btnOrange{background:var(--orange);color:#fff}

    .codeBox{font-size:18px}
    .codeNum{font-size:28px;font-weight:bold;letter-spacing:2px}

    .teams{display:flex;gap:10px;flex-wrap:wrap}
    .teamCol{flex:1;min-width:240px;border-radius:12px;padding:10px;color:#fff}
    .teamGreen{background:rgba(26,163,74,.92)}
    .teamOrange{background:rgba(242,140,0,.92)}
    .teamTitle{font-weight:bold;margin-bottom:8px}
    .playerItem{
      background:rgba(255,255,255,.18);
      padding:8px;border-radius:10px;margin:6px 0;cursor:pointer
    }

    /* MAP */
    .mapOuter{width:100%;display:flex;justify-content:center}
    .mapScale{
      width:min(92vw, 760px);
      transform:scale(var(--zoom, 1));
      transform-origin:center top;
    }
    .mapBox{
      position:relative;
      width:100%;
      border-radius:12px;
      overflow:hidden;
      background:transparent;
    }
    .mapBox img{
      width:100%;
      height:auto;
      display:block;
      object-fit:unset;
    }

    .overlaySvg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:auto;
    }
    .overlaySvg .cell{
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      stroke: var(--hexBorder);
      stroke-width: 1;
    }

    .overlaySvg .state0{ fill: rgba(0,0,0,0.001); }
    .overlaySvg .state1{ fill: var(--hexPale); }
    .overlaySvg .state2{ fill: var(--hexGreen); }
    .overlaySvg .state3{ fill: var(--hexOrange); }

    @keyframes palePulse {
      0%   { opacity: 1; }
      50%  { opacity: .35; }
      100% { opacity: 1; }
    }
    .overlaySvg .state1.pulse { animation: palePulse 0.9s ease-in-out infinite; }

    .below{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:stretch}
    .buzzBox{
      min-width:260px;flex:1;
      border-radius:12px;padding:12px;color:#fff;
      display:flex;align-items:center;justify-content:center;font-size:18px
    }
    .buzzEmpty{background:rgba(0,0,0,.25)}
    .questionBox{
      min-width:260px;flex:2;
      border-radius:12px;padding:12px;background:#fff;color:#111;text-align:right
    }
    .qTitle{font-weight:bold;margin-bottom:8px}

    /* âœ… ØªÙƒØ¨ÙŠØ± Ø®Ø· Ø§Ù„Ø³Ø¤Ø§Ù„ */
    .qText{line-height:1.6;font-size:22px}

    /* âœ… Ø§Ù„Ø¬ÙˆØ§Ø¨: Ø£ØµØºØ± + Ù…Ù„Ø§Ø¦Ù… Ù„Ø·ÙˆÙ„ Ø§Ù„Ø¬ÙˆØ§Ø¨ + ÙŠÙ„Ù Ù„Ø¹Ø¯Ø© Ø£Ø³Ø·Ø± */
    .qAns{
      line-height:1.6;
      margin:12px auto 0;
      background:var(--green);
      color:#fff;
      padding:10px 18px;
      border-radius:12px;
      text-align:center;
      font-size:22px;
      font-weight:900;
      opacity:1;
      display:none;

      width:fit-content;
      max-width:100%;
      white-space:normal;
      overflow-wrap:break-word;
    }

    .smallNote{font-size:12px;opacity:.85;margin-top:8px}
    .muted{color:var(--muted);}

    .buzzRow{display:flex;gap:10px;flex-wrap:wrap;align-items:stretch;justify-content:center}
    .nextQBtn{min-width:160px}

    .playerBtnWrap{margin-top:14px}
    .playerBigBtn{
      width:min(92vw, 520px);
      height:110px;
      border:none;border-radius:18px;
      background:var(--red);
      cursor:pointer;

      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:28px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .disabled{opacity:.5;cursor:not-allowed}

    .footerBtn{
      width:100%;max-width:520px;margin:10px auto 18px;
      padding:14px;border:none;border-radius:12px;background:var(--yellow);cursor:pointer;color:#000;font-size:18px
    }
    a{color:inherit}

    /* âœ… Ù…Ø¤Ù‚Øª (ØªØ¹Ø¨Ø¦Ø© Ø¯Ø§Ø¦Ø±ÙŠØ© ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ 12) + Ø¢Ø®Ø± 5 Ø«ÙˆØ§Ù†ÙŠ Ø£Ø±Ù‚Ø§Ù… Ø­Ù…Ø±Ø§Ø¡ */
    .timerWrap{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      z-index:6;
    }

    .timerClockBtn{
      width:72px;height:72px;
      border-radius:50%;
      border:none;
      background:#fff;
      position:relative;
      cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.12);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      color:#fff;
      user-select:none;
      overflow:hidden;
    }
    .timerClockBtn:active{ transform: translateY(1px); box-shadow:0 1px 0 rgba(0,0,0,.12); }

    .timerClockBtn::before{
      content:"";
      position:absolute;
      inset:6px;
      border-radius:50%;
      background: conic-gradient(
        from 0deg,
        rgba(0,0,0,.08) 0turn calc((1 - var(--p, 1)) * 1turn),
        var(--timerFill, #14b8a6) calc((1 - var(--p, 1)) * 1turn) 1turn
      );
      opacity:1;
    }

    @keyframes timerFlashFill {
      0%   { opacity: 1; }
      50%  { opacity: .35; }
      100% { opacity: 1; }
    }
    .timerClockBtn.timerFlashing::before{
      animation: timerFlashFill .6s linear infinite;
    }
    .timerClockBtn.timerFlashing{
      outline: 3px solid rgba(0,0,0,.06);
      outline-offset: 2px;
    }

    .timerIcon{
      position:relative;
      z-index:2;
      font-size:28px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
      height:100%;
      text-shadow:0 2px 10px rgba(0,0,0,.25);
      transition: opacity .08s linear;
    }

    .timerBurst{
      position:absolute;
      inset:0;
      z-index:3;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:var(--timerFillLast5); /* âœ… Ø£Ø±Ù‚Ø§Ù… Ø­Ù…Ø±Ø§Ø¡ ÙˆØ§Ø¶Ø­Ø© */
      text-shadow:0 3px 12px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      font-size:48px;
      transform:scale(.45);
    }
    @keyframes timerPop {
      0%   { opacity:0; transform:scale(.45); }
      25%  { opacity:1; transform:scale(1.25); }
      100% { opacity:0; transform:scale(2.8); }
    }
    .timerBurst.show{ animation: timerPop .75s ease-out forwards; }

    .timerStartBtn{
      min-width:140px;
      height:46px;
      border-radius:12px;
      background:var(--timerStart);
      color:#fff;
      font-weight:900;
      box-shadow:0 2px 0 rgba(0,0,0,.12);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .timerStartBtn:active{ transform: translateY(1px); box-shadow:0 1px 0 rgba(0,0,0,.12); }
    .timerStartBtn.running{
      opacity:.55;
    }

    .timerPicker{
      position:absolute;
      top:calc(100% + 8px);
      left:50%;
      transform:translateX(-50%) translateY(-6px);
      opacity:0;
      pointer-events:none;
      display:flex;
      flex-direction:column;
      gap:8px;
      width:min(220px, 86vw);
      background:rgba(255,255,255,.97);
      border:1px solid rgba(0,0,0,.08);
      border-radius:12px;
      padding:10px;
      box-shadow:0 10px 22px rgba(0,0,0,.20);
      transition: opacity .16s ease, transform .16s ease;
      z-index:80;
      text-align:center;
    }
    .timerPicker.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
      pointer-events:auto;
    }
    .timerOptRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .timerOptBtn{
      min-width:64px;
      height:36px;
      border:none;
      border-radius:10px;
      background:rgba(31,79,163,.08);
      color:#111;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .timerOptBtn.active{
      background:rgba(31,79,163,.22);
      box-shadow: inset 0 0 0 2px rgba(31,79,163,.18);
    }
    .timerOptBtn:active{ transform: translateY(1px); }

    /* âœ… Ù†Ø³Ø®Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
    .timerPlayerView{ pointer-events:none; user-select:none; }
    .timerClockBtn.player{ width:78px;height:78px; }

    /* âœ… Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
    .scoreBar{
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      margin:10px 0 8px;
      flex-wrap:wrap;
    }
    .teamLabel{
      font-weight:bold;
      font-size:14px;
      color:#fff;
      padding:6px 10px;
      border-radius:10px;
      white-space:nowrap;
    }
    .teamLabel.green{ background: rgba(26,163,74,.95); }
    .teamLabel.orange{ background: rgba(242,140,0,.95); }

    .scoreBoxBtn{
      min-width:64px;
      height:44px;
      border-radius:12px;
      border:none;
      background:#fff;
      color:#111;
      font-size:22px;
      font-weight:bold;
      cursor:default;
    }

    /* âœ… Ø´Ø±ÙŠØ· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù‚Ø§Ø· 0-10 */
    .scoreCtrl{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      z-index:5;
    }
    .scoreBoxBtn.clickable{
      cursor:pointer;
      box-shadow: 0 2px 0 rgba(0,0,0,.12);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .scoreBoxBtn.clickable:active{ transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,.12); }

    .scorePicker{
      position:absolute;
      top:calc(100% + 6px);
      left:50%;
      transform:translateX(-50%) translateY(-6px);
      opacity:0;
      pointer-events:none;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:center;
      width:min(280px, 86vw);
      background:rgba(255,255,255,.96);
      border:1px solid rgba(0,0,0,.08);
      border-radius:12px;
      padding:10px;
      box-shadow:0 10px 22px rgba(0,0,0,.20);
      transition: opacity .16s ease, transform .16s ease;
      z-index:50;
    }
    .scorePicker.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
      pointer-events:auto;
    }
    .scorePickBtn{
      width:38px;height:34px;
      border:none;border-radius:10px;
      background:rgba(31,79,163,.08);
      color:#111;
      font-weight:bold;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .scorePickBtn:active{ transform: translateY(1px); }

    .scoreHint{
      font-size:12px;
      opacity:.85;
      margin-top:4px;
    }

    /* âœ… Ø²Ø± Ø´Ø±Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© + Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø³Ù„Ø© */
    .buyNowWrap{margin-top:10px;display:flex;justify-content:center}
    .buyNowBtn{
      width:min(92vw, 520px);
      padding:14px 16px;
      border:none;
      border-radius:14px;
      background:#8b5cf6;
      color:#fff;
      font-size:18px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 3px 0 rgba(0,0,0,.15);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;

      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .buyNowBtn:active{ transform: translateY(1px); box-shadow:0 2px 0 rgba(0,0,0,.15); }
    .cartIcon{font-size:20px;line-height:1}

    /* âœ… ØµÙØ­Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: ÙƒØ±Øª Ø£ØµØºØ± + ØªÙƒØ¨ÙŠØ± Ù†Øµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± */
    .waitingLayout{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      padding:6px 0 2px;
    }
    .waitingMsg{
      font-size:22px;
      font-weight:900;
      color:#111;
    }

    /* âœ… Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© */
    .shareBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:14px;
      box-sizing:border-box;
    }
    .shareModal{
      width:min(92vw, 520px);
      background:#fff;
      color:#111;
      border-radius:14px;
      padding:14px;
      text-align:right;
      position:relative;
      box-sizing:border-box;
    }
    .shareClose{
      position:absolute;
      left:10px;
      top:10px;
      border:none;
      background:transparent;
      font-size:22px;
      cursor:pointer;
      line-height:1;
    }
    .shareTitle{
      font-weight:bold;
      margin:0 0 10px;
      text-align:center;
    }
    .shareChoices{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0 8px}
    .sharePanel{
      display:none;
      background:rgba(31,79,163,.06);
      border:1px solid rgba(0,0,0,.08);
      border-radius:12px;
      padding:12px;
      text-align:center;
    }
    .qrImg{
      width:220px;height:220px;
      display:block;
      margin:0 auto;
      border-radius:10px;
      background:#fff;
    }
    .shareSmall{
      font-size:12px;
      opacity:.85;
      text-align:center;
      margin-top:8px;
      word-break:break-all;
    }
  </style>
</head>
<body>
  <header>
    <img class="logo" src="logo.png" alt="Ø´Ø¹Ø§Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª">
    <div id="gameName" class="gameName"></div>
    <h1>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø­Ø±ÙˆÙ</h1>
    <!-- âœ… ØªÙ… Ø­Ø°Ù (Ø±Ù…Ø²: ####) Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ -->
  </header>

  <div class="wrap">
    <div id="main" class="card">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <button class="footerBtn" onclick="location.href='index.html'">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    // âœ… Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø®Ø±Ø§Ø¦Ø· ÙˆÙ„Ø§ Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ø­Ø±ÙˆÙ
    const MAPS = [
      [
        ["Ø´","Ø£","Ø«","Ø¯","Ù‡Ù€"],
        ["ÙŠ","Ø­","Ø¶","Ù†","Ùƒ"],
        ["Øº","Ø¸","Ù‚","Ø±","Ø¹"],
        ["Øµ","Ø²","Ø³","Ø·","Ùˆ"],
        ["Ø°","Ù„","Ø¨","Ù…","Ø¬"]
      ],
      [
        ["Ù‚","Øµ","Ùˆ","Ø¯","Ø¨"],
        ["Ø­","ÙŠ","Ø¶","Ù‡Ù€","Ø«"],
        ["Ùƒ","Ø·","Ø´","Ø²","Ù…"],
        ["Ø£","Ø±","Ø³","Ø¸","Ø«"],
        ["Ø°","Øº","Ù‡Ù€","Ø¹","Ø¬"]
      ],
      [
        ["Ø°","Ø¬","Ø£","Ø¨","Ø±"],
        ["ÙŠ","Ø­","Ø²","Ù„","Ø³"],
        ["Ø«","Ø¸","Ù‚","Ø¶","Ø¹"],
        ["Øµ","Ù†","Ø¯","Ø·","Øº"],
        ["Ùƒ","Ø®","Ù‡Ù€","Ù…","Ùˆ"]
      ]
    ];

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(location.search);
    const role = params.get("role");
    const code = params.get("code");
    const hostKey = params.get("key");
    const pid = params.get("pid");

    const main = document.getElementById("main");
    const gameNameEl = document.getElementById("gameName");

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    /* âœ… ØªÙ†Ø³ÙŠÙ‚ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©: 4 ÙƒÙ„Ù…Ø§Øª (2 ÙÙˆÙ‚ + 2 ØªØ­Øª) */
    function setGameName(raw){
      if(!gameNameEl) return;
      const s0 = String(raw ?? "").replace(/\s+/g, " ").trim();
      if(!s0){
        gameNameEl.innerHTML = "";
        return;
      }

      // 4 ÙƒÙ„Ù…Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø·ÙŠØ¹ ÙƒÙ„Ù…Ø©)
      const words = s0.split(" ").filter(Boolean).slice(0, 4);

      const top = words.slice(0, 2).join(" ");
      const bottom = words.slice(2, 4).join(" ");

      gameNameEl.innerHTML =
        `<span class="gnLine">${escapeHtml(top)}</span>` +
        `<span class="gnLine">${escapeHtml(bottom)}</span>`;
    }

    if(!role || !code){
      main.textContent = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.";
      throw new Error("Missing params");
    }

    const roomRef = ref(db, `rooms/${code}`);

    function teamColor(team){
      return team === "green" ? "rgba(26,163,74,.9)" : "rgba(242,140,0,.9)";
    }

    function cellKey(row,col){ return `${row}-${col}`; }

    const BBOX_CACHE = {};
        function detectHexBBox(img){
      const nw = img.naturalWidth, nh = img.naturalHeight;
      const maxW = 700;
      const scale = Math.min(1, maxW / nw);

      const cw = Math.round(nw * scale);
      const ch = Math.round(nh * scale);

      const canvas = document.createElement("canvas");
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext("2d", { willReadFrequently:true });
      ctx.drawImage(img, 0, 0, cw, ch);

      const data = ctx.getImageData(0,0,cw,ch).data;

      let minX = cw, minY = ch, maxX = -1, maxY = -1;
      let found = false;

      const step = 2;
      for(let y=0; y<ch; y+=step){
        for(let x=0; x<cw; x+=step){
          const i = (y*cw + x) * 4;
          const r = data[i], g = data[i+1], b = data[i+2];
          const mx = Math.max(r,g,b), mn = Math.min(r,g,b);
          const avg = (r+g+b)/3;

          if(avg > 180 && (mx - mn) < 60){
            found = true;
            if(x < minX) minX = x;
            if(y < minY) minY = y;
            if(x > maxX) maxX = x;
            if(y > maxY) maxY = y;
          }
        }
      }

      if(!found){
        return { x0:0.12, y0:0.04, x1:0.90, y1:0.95 };
      }

      minX = Math.max(0, minX - 2);
      minY = Math.max(0, minY - 2);
      maxX = Math.min(cw - 1, maxX + 2);
      maxY = Math.min(ch - 1, maxY + 2);

      return {
        x0: minX / cw,
        y0: minY / ch,
        x1: (maxX + 1) / cw,
        y1: (maxY + 1) / ch,
      };
    }

    function setStateClass(el, st){
      el.classList.remove("state0","state1","state2","state3","pulse");
      el.classList.add(`state${st}`);
      if(st === 1) el.classList.add("pulse");
    }

    function hexPointsPointyTop(x, y, w, h){
      const pts = [
        [x + w/2, y],
        [x + w,   y + h*0.25],
        [x + w,   y + h*0.75],
        [x + w/2, y + h],
        [x,       y + h*0.75],
        [x,       y + h*0.25],
      ];
      return pts.map(p => `${p[0].toFixed(2)},${p[1].toFixed(2)}`).join(" ");
    }

    /* âœ… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† ÙƒÙˆØ¯Ùƒ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) */
    const QUESTIONS = {};
    const ALL_LETTERS = Array.from(new Set(MAPS.flat(2)));
    for(const L of ALL_LETTERS){
      QUESTIONS[L] = Array.from({length:25}, (_,i) => ({
        q: `(${i+1}) Ø³Ø¤Ø§Ù„ Ù„Ø­Ø±Ù ${L}`,
        a: `${L}...`
      }));
    }

    // Ø­Ø±Ù Ù‡Ù€
    QUESTIONS["Ù‡Ù€"] = [
      { q: "Ù‡ÙŠ Ø§Ù„Ø¨Ù†ÙŠÙ‡ Ø§Ùˆ Ø§Ù„Ø§Ø·Ø§Ø± Ø§Ù„Ø°ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Ù„Ø¯Ø¹Ù… Ø´ÙŠØ¦ Ù…Ø§ ÙˆÙŠÙ…ÙƒÙ† Ø§Ù† ÙŠÙƒÙˆÙ† Ù…Ø¹Ù†ÙˆÙŠØ§Ù‹ Ù…Ø«Ù„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ùˆ Ù…Ø¹Ù†ÙˆÙŠØ§Ù‹ Ù…Ø«Ù„ (â€¦â€¦..)", a: "Ù‡ÙŠÙƒÙ„" },
      { q: "Ù‡Ùˆ Ù…Ø§ÙŠÙ‡Ø¯Ù‰ Ù…Ù† Ø§Ù„Ø§Ù†Ø¹Ø§Ù… Ø§Ù„Ù‰ Ø§Ù„Ø­Ø±Ù… ØªÙ‚Ø±Ø¨Ø§Ù‹ Ø§Ù„Ù‰ Ø§Ù„Ù„Ù‡", a: "Ù‡Ø¯ÙŠ" },
      { q: "Ù‡Ùˆ Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø´Ø¹Ø± Ù†Ù‚ÙŠØ¶ Ø§Ù„Ù…Ø¯ÙŠØ­ ÙˆÙŠÙÙƒØªØ¨ Ø¹Ù†Ø¯Ù…Ø§ Ø§Ù„Ø´Ø§Ø¹Ø± ÙŠØ¹Ø¨Ø± Ø¹Ù† Ø³Ø®Ø·Ø© ÙˆØ§Ø´Ù…Ø¦Ø²Ø§Ø²Ù‡", a: "Ù‡Ø¬Ø§Ø¡" },
      { q: "Ù‡Ùˆ Ù†Ø¨Ø§Øª Ø¹Ø·Ø±ÙŠ ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø·Ø¨Ø® ÙˆØ§Ù„Ù‚Ù‡ÙˆØ© ÙˆÙŠÙØ¹Ø±Ù Ø¨Ù€ \"Ù…Ù„Ùƒ Ø§Ù„ØªÙˆØ§Ø¨Ù„\"ØŸ", a: "Ù‡ÙŠÙ„" },
      { q: "Ù‡ÙŠ Ù…Ø¯ÙŠÙ†Ø© ÙŠØ§Ø¨Ø§Ù†ÙŠØ© ØªØ¹Ø±Ø¶Øª Ù„Ø£ÙˆÙ„ Ù‚Ù†Ø¨Ù„Ø© Ø°Ø±ÙŠØ©", a: "Ù‡ÙŠØ±ÙˆØ´ÙŠÙ…Ø§" },
      { q: "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù†Ø¨ÙŠ Ø§Ù„Ø°ÙŠ Ø§Ø±Ø³Ù„Ù‡ Ø§Ù„Ù„Ù‡ Ø§Ù„Ù‰ Ù‚ÙˆÙ… Ø¹Ø§Ø¯ØŸ", a: "Ù‡ÙˆØ¯ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…" },
      { q: "Ù…Ù† Ø£ÙˆÙ„ Ù…Ù† Ø³Ø¹Ù‰ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ§ Ùˆ Ø§Ù„Ù…Ø±ÙˆØ© ØŸ", a: "Ù‡Ø§Ø¬Ø± Ø§Ù… Ø§Ø³Ù…Ø§Ø¹ÙŠÙ„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…" },
      { q: "Ù‡ÙŠ ØµÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´ÙŠ ÙˆØ§Ù„Ø±ÙƒØ¶", a: "Ù‡Ø±ÙˆÙ„Ù‡" },
      { q: "Ù‡Ùˆ Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„ÙØ§Ø±Øº Ø§Ù„Ø°ÙŠ Ù„Ø§ Ù…Ø¹Ù†Ù‰ Ù„Ù‡", a: "Ù‡Ø±Ø§Ø¡" },
      { q: "Ù‡ÙŠ ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØªØ¹Ù†ÙŠ Ø§Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø´Ø®Øµ Ù…Ø§Ù„Ù‡ Ù„Ø´Ø®Øµ Ø§Ø®Ø± Ø¨Ù„Ø§ Ø¹ÙˆØ¶", a: "Ù‡Ø¨Ù‡" },
      { q: "Ù…Ø§Ø°Ø§ ÙŠØ·Ù„Ù‚ Ø¹Ù„Ù‰ ØµÙˆØª Ø§Ù„Ù…ÙˆØ¬", a: "Ù‡Ø¯ÙŠØ±" },
      { q: "Ù‡Ùˆ Ù…ÙˆÙ‚Ø¹ Ø´Ù‡ÙŠØ± Ø¹Ù„Ù‰ Ø´Ø¨ÙƒØ© Ø§ï»¹Ù†ØªØ±Ù†Øª Ø®Ø§Øµ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¬Ø§Ù†ÙŠ", a: "Ù‡ÙˆØªÙ…ÙŠÙ„" },
      { q: "Ù‡Ùˆ Ù…Ø³Ù„Ø³Ù„ ÙƒØ±ØªÙˆÙ†ÙŠ Ù‚Ø¯ÙŠÙ… Ù…Ø¹Ø±ÙˆÙ Ø¹Ù†Ø¯ Ø§Ù„Ø·ÙŠØ¨ÙŠÙ† ÙŠØ¨Ø¯Ø£ Ø§Ø³Ù…Ù‡ Ø¨Ø­Ø±Ù Ù‡Ù€", a: "Ù‡Ø²ÙŠÙ… Ø§Ù„Ø±Ø¹Ø¯" },
      { q: "Ù‡ÙŠ Ù‡Ø¶Ø¨Ø© ØªÙ‚Ø¹ ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©", a: "Ù‡Ø¶Ø¨Ø© Ù†Ø¬Ø¯" },
      { q: "Ù‡ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØ´Ø¹Ø± Ø¨Ù‡Ø§ Ø§Ù„Ø§Ù†Ø³Ø§Ù† Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµØ¨Ø­ Ø®Ø§Ø¦ÙØ§Ù‹", a: "Ù‡Ù„Ø¹" },
      { q: "Ø´Ø®ØµÙŠØ© Ù…Ù† Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ù…Ù…Ø«Ù„ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø³Ø¯Ø­Ø§Ù† ÙÙŠ Ù…Ø³Ù„Ø³Ù„ Ø·Ø§Ø´ Ù…Ø§Ø·Ø§Ø´", a: "Ù‡Ø¯Ø¨Ø¯Ø¨" },
      { q: "Ù‡Ùˆ Ù„Ù‚Ø¨ ÙŠØ·Ù„Ù‚ Ø¹Ù„Ù‰ Ù‚Ù…Ø© Ø³Ù„Ø³Ù„Ø© Ø¬Ø¨Ø§Ù„ Ù…Ø¹Ø±ÙˆÙØ© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹", a: "Ù‡Ù…Ù„Ø§ÙŠØ§" },
      { q: "Ù‡Ùˆ ØºØ§Ø² Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ ÙˆØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø´ØªØ¹Ø§Ù„ ÙˆÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø·ÙŠØ¯", a: "Ù‡ÙŠÙ„ÙŠÙˆÙ…" },
      { q: "Ù…Ø¯ÙŠÙ†Ø© Ø£Ù„Ù…Ø§Ù†ÙŠØ© ØªØ¹ØªØ¨Ø± Ù…Ù† Ø£Ù‡Ù… Ø§Ù„Ù…ÙˆØ§Ù†Ø¦ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠØ©", a: "Ù‡Ø§Ù…Ø¨ÙˆØ±Øº" },
      { q: "Ù‡ÙŠ Ù†ÙˆØ¨Ø§Øª Ù…Ù† Ø§Ù„Ø§Ù†ÙØ¹Ø§Ù„Ø§Øª Ø§Ù„Ø´Ø¯ÙŠØ¯Ø© Ø§Ùˆ Ø§Ù„Ø¶Ø­Ùƒ ÙˆØ§Ù„Ø¨ÙƒØ§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ù†Ø¶Ø¨Ø·", a: "Ù‡Ø³ØªÙŠØ±ÙŠØ§" },
      { q: "Ù‡Ùˆ Ø§Ø³Ù… ÙŠØ·Ù„Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø´Ø®Ø§Øµ Ø§Ù„Ù„Ø°ÙŠÙ† ÙŠØªØ±ÙƒÙˆÙ† ÙˆØ·Ù†Ù‡Ù… Ù„Ù„Ø¹ÙŠØ´ ÙÙŠ Ø¨Ù„Ø¯ Ø¢Ø®Ø±", a: "Ù‡Ø¬Ø±Ø©" },
      { q: "Ù‡ÙŠ Ù†Ø´Ø§Ø· Ù…Ù†ØªØ¸Ù… ÙŠÙ…Ø§Ø±Ø³Ù‡ Ø§Ù„Ø´Ø®Øµ ÙÙŠ ÙˆÙ‚Øª ÙØ±Ø§ØºØ© Ú¯/ Ø§Ù„Ø±Ø³Ù… Ø§Ùˆ Ø§Ù„Ø·Ø¨Ø® Ø§Ù„Ø®â€¦", a: "Ù‡ÙˆØ§ÙŠÙ‡" },
      { q: "Ù‡Ùˆ Ø§Ù„Ù…Ø·Ø± Ø§Ù„Ø®ÙÙŠÙ Ø§Ù„Ù…ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙŠ ÙŠÙ‡Ø·Ù„ Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª", a: "Ù‡ØªØ§Ù†" },
      { q: "Ù‡ÙŠ ÙˆÙ„Ø§ÙŠØ© Ø§Ù…Ø±ÙŠÙƒÙŠØ© ØªØªÙƒÙˆÙ† Ù…Ù† Ø¹Ø¯Ø© Ø¬Ø² ÙˆØªÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù…Ø­ÙŠØ· Ø§Ù„Ù‡Ø§Ø¯Ø¦", a: "Ù‡Ø§ÙˆØ§ÙŠ" },
      { q: "Ù‡Ùˆ Ù…Ù…Ø± Ù…Ø§Ø¦ÙŠ Ø¶ÙŠÙ‚ ÙŠØ±Ø¨Ø· Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ø®Ù„ÙŠØ¬ Ø¹ÙÙ…Ø§Ù† ÙŠØ³Ù…Ù‰ Ù…Ø¶ÙŠÙ‚ â€¦â€¦..ØŸ", a: "Ù‡Ø±Ù…Ø²" }
    ];

    // Ø­Ø±Ù Ø¯
    QUESTIONS["Ø¯"] = [
      { q: "Ù‡ÙŠ Ù‚ÙˆÙ„ ÙŠØ·Ù„Ø¨ Ø¨Ù‡ Ø§Ù„Ø¥Ù†Ø³Ø§Ù† Ø¥Ø«Ø¨Ø§Øª Ø­Ù‚ Ø¹Ù„Ù‰ Ø¹Ù„Ù‰ Ø§Ù„ØºÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙƒÙ…", a: "Ø¯Ø¹ÙˆÙ‰" },
      { q: "Ù…Ù† Ù‡Ùˆ Ù…Ø®ØªØ±Ø¹ Ø§Ù„Ø§Ø·Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†ÙÙˆØ®Ø© Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª", a: "Ø¬ÙˆÙ† Ø¨ÙˆÙŠØ¯ Ø¯Ù†Ù„ÙˆØ¨" },
      { q: "Ù‡Ùˆ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø¯Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¯ÙˆÙ„Ø© ÙˆÙŠØ­Ø¯Ø¯ Ø­Ù‚ÙˆÙ‚ ÙˆÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†", a: "Ø¯Ø³ØªÙˆØ±" },
      { q: "ÙŠØ³Ù…Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø³ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØªÙ…ÙŠØ² Ø¨Ø­ÙƒÙ… Ø§Ù„Ø´Ø¹Ø¨ â€¦..", a: "Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ©" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ø³Ù… Ø§ÙˆÙ„ Ø¹Ù…Ù„Ø© Ø§Ø³Ù„Ø§Ù…ÙŠØ© ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®", a: "Ø¯ÙŠÙ†Ø§Ø±" },
      { q: "Ù‡Ùˆ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø·ÙˆÙŠÙ„ Ø§Ùˆ Ù…Ø¯Ø© Ø§Ù„Ø­ÙŠØ§Ø© ÙƒÙ„Ù‡Ø§", a: "Ø¯Ù‡Ø±" },
      { q: "Ù…Ø§Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¯ÙˆÙ„Ø© Ø§Ù„Ø³Ù†ØºØ§Ù„", a: "Ø¯Ø§ÙƒØ§Ø±" },
      { q: "Ù‡Ùˆ Ø³ÙˆØ§Ø¯ Ø§Ù„Ù„ÙŠÙ„ ÙˆØ¶Ù„Ù…ØªÙ‡", a: "Ø¯Ø¬Ù‰" },
      { q: "Ù‡Ùˆ Ù…Ø§Ø¡ Ù„Ù… ÙŠØ®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø§Ø±Ø¶ ÙˆÙ„Ù… ÙŠÙ†Ø²Ù„ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø¡", a: "Ø¯Ù…ÙˆØ¹" },
      { q: "Ù‡Ùˆ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹ Ø£Ùˆ Ø§Ù„Ù…Ø­ØªØ§Ù„ ÙÙŠ Ø£Ù‚ÙˆØ§Ù„Ù‡ ÙˆØ§ÙØ¹Ø§Ù„Ù‡", a: "Ø¯Ø¬Ø§Ù„" },
      { q: "Ù‡Ùˆ Ø§Ù„Ø§Ø­ØªÙŠØ§Ù„ ÙˆØ§Ù„Ø®Ø¯Ø§Ø¹ ÙˆØªØ¯Ø¨ÙŠØ± Ø§Ù„Ø´Ø± Ø¨Ù…Ù‡Ø§Ø±Ø©", a: "Ù‡Ø¯ÙŠØ±" },
      { q: "Ù‡ÙŠ ØµÙÙ‡ ØªÙ…Ø²Ø¬ Ø¨ÙŠÙ† Ø§Ù„ÙØ·Ù†Ø© ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ ÙˆØ¥Ø¯Ø±Ø§Ùƒ Ø§Ù„Ø§Ù…ÙˆØ±", a: "Ø¯Ù‡Ø§Ø¡" },
      { q: "Ù…Ø§Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¯ÙˆÙ„Ø© ØªÙ†Ø²Ø§Ù†ÙŠØ§", a: "Ø¯Ø§Ø± Ø§Ù„Ø³Ù„Ø§Ù…" },
      { q: "Ù…Ù† Ù…Ø¯Ù† Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ù…ØµØ± Ø§Ù„Ø¹Ø±Ø¨", a: "Ø¯Ù…ÙŠØ§Ø·" },
      { q: "Ù‡Ùˆ ØµØºÙŠØ± Ø§Ù„Ø¯Ø¨", a: "Ø¯ÙŠØ³Ù…" },
      { q: "Ù‡Ùˆ Ø§Ù„Ø·Ø§Ø¦Ø± Ø§Ù„Ø°ÙŠ ÙŠÙƒÙ†Ù‰ Ø¨Ø£Ø¨ÙŠ Ø§Ù„ÙŠÙ‚Ø¶Ø§Øª", a: "Ø¯ÙŠÙƒ" },
      { q: "Ù…Ø§Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§ÙŠØ±Ù„Ù†Ø¯Ø§", a: "Ø¯Ø¨Ù„Ù†" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ Ø§Ù„Ø°ÙŠ Ù„ÙŠØ³ Ù„Ù‡ Ù†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ„Ø§ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ©", a: "Ø¯Ø§Ø¦Ø±Ø©" },
      { q: "Ù‡Ùˆ Ø§Ù„Ù…Ø±Ø¶ Ùˆ Ø§Ù„Ø¹Ù„Ø©", a: "Ø¯Ø§Ø¡" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø¨Ø­Ø±ÙŠ Ø§Ù„Ø°ÙŠ ÙˆÙØµÙ Ø¨Ø£Ù†Ù‡ Ø§Ø°ÙƒÙ‰ Ù…Ø®Ù„ÙˆÙ‚Ø§Øª Ø§Ù„Ø¨Ø­Ø±", a: "Ø¯ÙˆÙ„ÙÙŠÙ†" },
      { q: "Ù‡Ùˆ Ø¹ÙƒØ³ ÙƒÙ„Ù…Ø© ÙØ§ØªØ­", a: "Ø¯Ø§ÙƒÙ†" },
      { q: "Ù‡ÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙƒØ«ÙŠØ±Ø© Ø§Ù„Ù…Ø·Ø±", a: "Ø¯Ø§Ø¬Ù†Ø©" },
      { q: "Ø§ÙƒÙ…Ù„ Ø§Ù„Ù…Ø«Ù„ : Ù…Ù† Ø®Ø±Ø¬ Ù…Ù†â€¦â€¦..Ù‚Ù„ Ù…Ù‚Ø¯Ø§Ø±Ù‡", a: "Ø¯Ø§Ø±Ù‡" },
      { q: "Ø§ÙƒÙ…Ù„ Ø§Ù„Ù…Ø«Ù„ : Ù„ÙƒÙ„â€¦â€¦..Ø¯ÙˆØ§Ø¡", a: "Ø¯Ø§Ø¡" },
      { q: "Ù‡ÙŠ Ù…Ø±Ø§Ø¯Ù ÙƒÙ„Ù…Ø© â€¦â€¦Ø¥Ø´Ø§Ø±Ø©", a: "Ø¯Ù„Ø§Ù„Ø©" }
    ];

    // Ø­Ø±Ù Ø£
    QUESTIONS["Ø£"] = [
      { q: "ÙˆØ­Ø¯Ø© Ù„Ù‚ÙŠØ§Ø³ Ø´Ø¯Ø© Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ", a: "Ø£Ù…Ø¨ÙŠØ±" },
      { q: "Ù…Ù† Ù‡Ùˆ Ø§ÙˆÙ„ Ù…Ù† Ø¬Ù…Ø¹ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ø¨ÙŠÙ† Ù„ÙˆØ­ÙŠÙ†", a: "Ø§Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„ØµØ¯ÙŠÙ‚" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø°ÙŠ ÙŠÙØ¹Ø±Ù Ø¨Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø§Ø²Ø±Ù‚", a: "Ø§Ù„Ø§Ø±Ø¶" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„Ù†Ø¨ÙŠ Ø§Ù„Ø°ÙŠ Ø§Ù„Ø°ÙŠ Ø£ÙØ·Ù„Ù‚ Ø¹Ù„ÙŠÙ‡ Ù„Ù‚Ø¨ Ù†Ø¨ÙŠ Ø§Ù„ØµØ¨Ø±", a: "Ø£ÙŠÙˆØ¨ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…" },
      { q: "Ù‡Ùˆ ØºØ§Ø² ÙŠØªÙƒÙˆÙ† Ù…Ù† Ø«Ù„Ø§Ø«Ø© Ø°Ø±Ø§Øª Ø£ÙƒØ³Ø¬ÙŠÙ† ÙˆÙŠÙˆØ¬Ø¯ ÙÙŠ Ø§Ù„ØºÙ„Ø§Ù Ø§Ù„Ø¬ÙˆÙŠ Ù„Ù„Ø§Ø±Ø¶ ÙƒØ·Ø¨Ù‚Ø© Ù…Ø´Ù‡ÙˆØ±Ø©", a: "Ø§Ù„Ø§ÙˆØ²ÙˆÙ†" },
      { q: "Ù…Ø§Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª", a: "Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ" },
      { q: "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ø§Ù…Ø±ÙŠÙƒÙŠ Ø§Ù„Ø°ÙŠ Ø§ØµØ¯Ø± Ø§Ø¹Ù„Ø§Ù† Ø§Ù„ØªØ­Ø±ÙŠØ±", a: "Ø£Ø¨Ø±Ø§Ù‡Ø§Ù… Ù„ÙŠÙ†ÙƒÙˆÙ„Ù†" },
      { q: "Ø³ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ø·Ù„Ù‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ø³Ù… Ø§Ø®Øª Ø§Ù„Ø·ÙˆÙŠÙ„ØªÙŠÙ†", a: "Ø§Ù„Ø£Ø¹Ø±Ø§Ù" },
      { q: "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø´Ø§Ø¹Ø± Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ¹ØªØ¨Ø± Ø£Ù…ÙŠØ± Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", a: "Ø£Ø­Ù…Ø¯ Ø´ÙˆÙ‚ÙŠ" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ø·ÙˆÙ„ Ù†Ù‡Ø± ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… Ø¨Ø¹Ø¯ Ù†Ù‡Ø± Ø§Ù„Ù†ÙŠÙ„", a: "Ø§Ù„Ø£Ù…Ø§Ø²ÙˆÙ†" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ ÙŠØ±Ù‰ ØµØ¯ÙŠÙ‚Ø© ÙˆØ¹Ø¯ÙˆÙ‡ Ø¨Ø¹ÙŠÙ† ÙˆØ§Ø­Ø¯Ø©", a: "Ø§Ù„Ø£Ø¹ÙˆØ±" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ ÙŠÙØ·Ù„Ù‚ Ø¹Ù„Ù‰ Ø§Ø³Ø¨Ø§Ù†ÙŠØ§ Ù‚Ø¯ÙŠÙ…Ø§Ù‹", a: "Ø§Ù„Ø£Ù†Ø¯Ù„Ø³" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„Ø°ÙŠ ÙƒÙ„Ù…Ø§ ØªØ­Ø±Ùƒ Ø®Ø·ÙˆØ© ÙÙ‚Ø¯ Ø¬Ø²Ø¡ Ù…Ù† Ø°ÙŠÙ„Ù‡", a: "Ø§Ù„Ø¥Ø¨Ø±Ø©" },
      { q: "Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ø§Ù†Ø³Ø¬Ø© Ø§Ù„ØªÙŠ ØªÙ‚ÙˆÙ… Ø¹Ù„Ù‰ Ø±Ø¨Ø· Ø§Ù„Ø¹Ø¶Ù„Ø§Øª Ø¨Ø§Ù„Ø¹Ø¸Ø§Ù…", a: "Ø£ÙˆØªØ§Ø±" },
      { q: "Ù…Ø§Ù‡Ùˆ Ù„ÙˆÙ† Ø§Ù„Ø²Ù…Ø±Ø¯", a: "Ø£Ø®Ø¶Ø±" },
      { q: "Ù…Ø§Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ØªØ±ÙƒÙŠØ§", a: "Ø£Ù†Ù‚Ø±Ø©" },
      { q: "Ù…Ø§Ù‡ÙŠ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙŠ ÙØ§Ø²Øª Ø¨Ø£ÙˆÙ„ Ù†Ø³Ø®Ø© Ù„ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù…", a: "Ø£ÙˆØ±ÙˆØºÙˆØ§ÙŠ" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø°ÙŠ ØªØ±ØªÙŠØ¨Ù‡ Ø§Ù„Ø«Ø§Ù„Ø« Ù…Ù† Ø§Ù„ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ø´Ù…Ø³ÙŠÙ‡", a: "Ø§Ù„Ø§Ø±Ø¶" },
      { q: "Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙŠÙˆÙ†Ø§Ù†", a: "Ø£Ø«ÙŠÙ†Ø§" },
      { q: "Ù‡ÙŠ Ø§ØµØºØ± Ù‚Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù… Ù…Ù† Ø­ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø­Ø©", a: "Ø§ÙˆØ±ÙˆØ¨Ø§" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ù† Ù…Ø²Ø¬ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ØµÙØ± ÙˆØ§Ù„Ø§Ø²Ø±Ù‚", a: "Ø§Ø®Ø¶Ø±" },
      { q: "Ù‡Ùˆ Ù…Ø¬Ø§Ù„ ÙŠÙ‡ØªÙ… Ø¨Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ù†Ø¸Ù…Ø© ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª ÙˆØ§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ù…Ù† Ø§Ù„Ù‡Ø¬Ù…Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©", a: "Ø§Ù„Ø§Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ" },
      { q: "Ø§ÙƒÙ…Ù„ Ø§Ù„Ù…Ø«Ù„ : Ø§Ù„Ù‚Ø±Ø¯ Ø¨Ø¹ÙŠÙ† â€¦â€¦..ØºØ²Ø§Ù„", a: "Ø£Ù…Ù‡" },
      { q: "Ù‡Ùˆ Ø¹Ù„Ù… ÙŠÙ‡ØªÙ… Ø¨Ø¯Ø§Ø±Ø³Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© ÙˆØ§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ©", a: "Ø£Ø­ÙŠØ§Ø¡" },
      { q: "Ù…Ø§Ù‡Ùˆ Ù…Ø¹Ù†Ù‰ ÙƒÙ„Ù…Ø© Ø¥Ù…Ø§Ø·Ø©", a: "Ø¥Ø²Ø§Ù„Ø©" }
    ];

    // Ø­Ø±Ù Ø«
    QUESTIONS["Ø«"] = [
      { q: "Ù…Ø§Ù‡Ùˆ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ø£Ø¨Ø¬Ø¯ÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", a: "Ø«Ù…Ø§Ù†ÙŠØ© ÙˆØ¹Ø´Ø±ÙˆÙ† Ø­Ø±ÙØ§Ù‹" },
      { q: "ØµÙØ© Ù…Ù† Ø£Ù‡Ù… ØµÙØ§Øª Ø§Ù„Ø´Ø¬Ø§Ø¹Ø©", a: "Ø«Ø¨Ø§Øª" },
      { q: "Ù‡Ùˆ ÙˆØµÙ ÙŠØ·Ù„Ù‚ Ø¹Ù„Ù‰ ÙƒØ«ÙŠØ± Ø§Ù„ÙƒÙ„Ø§Ù…", a: "Ø«Ø±Ø«Ø§Ø±" },
      { q: "ÙƒÙ… Ø¹Ø¯Ø¯ ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©", a: "Ø«Ù…Ø§Ù†ÙŠØ©" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø¹Ø¯Ø¯ Ø§Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…", a: "Ø«Ù„Ø§Ø«ÙˆÙ† Ø¬Ø²Ø¡Ù‹" },
      { q: "Ù…Ù† Ø§ÙˆÙ„ Ø§Ù„Ø®Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø³Ù„Ù…ÙŠÙ† ÙˆÙ„ÙÙ‚Ø¨ Ø¨Ø®Ø·ÙŠØ¨ Ø§Ù„Ø±Ø³ÙˆÙ„", a: "Ø«Ø§Ø¨Øª Ø¨Ù† Ù‚ÙŠØ³" },
      { q: "Ù‡Ùˆ Ù…Ù†Ø·Ù‚Ø© ÙÙŠ Ø§Ù„ÙØ¶Ø§Ø¡ Ø­ÙŠØ« Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ© Ù‚ÙˆÙŠØ© Ù„Ø¯Ø±Ø¬Ø© Ø§Ù†Ù‡ Ù„Ø§ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ø­Ø¯ Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù†Ù‡Ø§ ØŒ Ø­ØªÙ‰ Ø§Ù„Ø¶ÙˆØ¡", a: "Ø§Ù„Ø«Ù‚Ø¨ Ø§Ù„Ø§Ø³ÙˆØ¯" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠØ©", a: "Ø«Ù„Ø§Ø«Ø© Ù„Ø§Ø¹Ø¨ÙŠÙ†" },
      { q: "ÙƒÙ… Ø¹Ø¯Ø¯ ÙÙ‚Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙÙ‚Ø±ÙŠ", a: "Ø«Ù„Ø§Ø«Ø© ÙˆØ«Ù„Ø§Ø«ÙˆÙ†" },
      { q: "ÙŠØ·Ù„Ù‚ ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…Ø§Ø¹Ø© Ù…Ù† Ø§Ù„Ù†Ø§Ø³", a: "Ø«ÙÙ„Ø©" },
      { q: "Ø¨Ù„Ø¯Ø© Ø§Ù„Ø±Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ù…Ø´Ù‡ÙˆØ± Ø£Ø­Ù…Ø¯ Ø¨Ù† Ù…Ø§Ø¬Ø¯ Ù‚Ø±Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ (ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©)", a: "Ø«Ø±Ù…Ø¯Ø§" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ø³Ø¨Ø¹Ø© Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…ØªÙ„Ø§ØµÙ‚Ø© ÙÙŠ Ø§Ù„Ø³Ù…Ø§Ø¡", a: "Ø«Ø±ÙŠØ§" },
      { q: "ÙƒÙ… ØªØ³ØªØºØ±Ù‚ Ø§Ù„Ø§Ø±Ø¶ Ù„Ù„Ø¯ÙˆØ±Ø§Ù† Ø­ÙˆÙ„ Ø§Ù„Ø´Ù…Ø³", a: "Ø«Ù„Ø§Ø« Ù…Ø£Ø¦Ù‡ ÙˆØ®Ù…Ø³Ø© ÙˆØ³ØªÙˆÙ† ÙŠÙˆÙ…Ø§Ù‹" },
      { q: "ÙƒÙ„Ù…Ø© ØªØ³ØªØ·ÙŠØ¹ Ø£Ù† ØªÙ‚Ø±Ø£Ù‡Ø§ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ùˆ Ø§Ù„Ø´Ù…Ø§Ù„", a: "Ø«Ù„Ø«" },
      { q: "Ù‡Ùˆ Ù…Ø±Ø¶ ÙŠØµÙŠØ¨ ÙØ±ÙˆØ© Ø´Ø¹Ø± Ø§Ù„Ø§Ù†Ø³Ø§Ù†", a: "Ø«Ø¹Ù„Ø¨Ø©" },
      { q: "Ù‡Ùˆ Ø§Ù„Ø·Ø§Ø¦Ø± Ø§Ù„Ø°ÙŠ ÙŠÙƒÙ†Ù‰ Ø¨Ø£Ø¨ÙŠ Ø§Ù„ÙŠÙ‚Ø¶Ø§Øª", a: "Ø¯ÙŠÙƒ" },
      { q: "Ø§Ø³Ù… Ù†Ø¨Ø§Øª ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø·Ø¨ ÙƒÙ…Ø¶Ø§Ø¯ Ù„Ù„Ø§Ù„ØªÙ‡Ø§Ø¨", a: "Ø«ÙˆÙ…" },
      { q: "Ù‡ÙŠ Ù…Ø¯ÙŠÙ†Ø© Ø³Ø¹ÙˆØ¯ÙŠØ© Ø³Ø§Ø­Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø§Ø­Ù…Ø±", a: "Ø«ÙˆÙ„" },
      { q: "Ù‡Ùˆ ÙˆÙØ±Ø© Ø§Ù„Ù…Ø§Ù„ ÙˆÙƒØ«Ø±ØªÙ‡", a: "Ø«Ø±Ø§Ø¡" },
      { q: "Ù…Ø±Ø§Ø¯Ù ÙƒÙ„Ù…Ø© ÙˆØ²Ù†", a: "Ø«Ù‚Ù„" },
      { q: "Ù‡Ùˆ Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ù‡Ù…Ø± Ø¨ØºØ²Ø§Ø±Ø© Ùˆ Ø³ÙŠÙ„Ø§Ù†Ù‡ Ø´Ø¯ÙŠØ¯", a: "Ø«Ø¬Ø§Ø¬" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„ØµÙˆØª Ø§Ù„ØªÙŠ ØªØµØ¯Ø±Ø© Ø§Ù„Ø´Ø§Ø© Ø§Ùˆ Ø§Ù„Ø®Ø±ÙˆÙ ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", a: "Ø«ØºØ§Ø¡" },
      { q: "Ù…Ø§Ù‡Ùˆ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø§Ø®ÙŠØ± Ù„Ù„Ø­Ø¬Ø§Ø¬ Ø¨Ù† ÙŠÙˆØ³Ù", a: "Ø§Ù„Ø«Ù‚ÙÙŠ" },
      { q: "Ù‡Ùˆ Ø¹ÙƒØ³ ÙƒÙ„Ù…Ø© Ù…ØªØ­Ø±Ùƒ", a: "Ø«Ø§Ø¨Øª" }
    ];

    /* âœ… Timer state */
    const TIMER_UI = {
      tick: null,
      lastSecond: null,
      lastDoneStartTs: null,
      latestTimer: null,
      isHost: false
    };

    function normalizeTimer(t){
      const sel = Number(t?.sel || 10);
      const dur = Number(t?.dur || sel);
      const running = !!t?.running;
      const startTs = Number(t?.startTs || 0);
      const done = !!t?.done;
      return { sel, dur, running, startTs, done };
    }

    function computeTimerView(t){
      const now = Date.now();
      const sel = Number(t.sel || 10);
      const dur = Number(t.dur || sel);
      const running = !!t.running;
      const startTs = Number(t.startTs || 0);
      const doneFlag = !!t.done;

      let remaining = sel;
      if(running && startTs){
        remaining = dur - Math.floor((now - startTs) / 1000);
      }else{
        remaining = sel;
      }
      if(!Number.isFinite(remaining)) remaining = sel;
      remaining = Math.max(0, remaining);

      const done = doneFlag || (running && remaining === 0);
      const inLast5 = running && remaining > 0 && remaining <= 5;

      const baseDur = (running ? dur : sel) || 1;
      const progress = Math.max(0, Math.min(1, remaining / baseDur));

      return { sel, dur, running, startTs, remaining, done, inLast5, progress };
    }

    function forceBurst(n){
      const burst = document.getElementById("timerBurst");
      if(!burst) return;
      burst.textContent = String(n);
      burst.classList.remove("show");
      void burst.offsetWidth;
      burst.classList.add("show");
    }

    function applyTimerDom(){
      const clock = document.getElementById("timerClock");
      if(!clock) return;

      const t = normalizeTimer(TIMER_UI.latestTimer || {});
      const view = computeTimerView(t);

      const fill = view.inLast5 ? "var(--timerFillLast5)" : "var(--timerFill)";
      clock.style.setProperty("--timerFill", fill);
      clock.style.setProperty("--p", String(view.progress));

      if(view.done){
        clock.classList.add("timerFlashing");
      }else{
        clock.classList.remove("timerFlashing");
      }

      clock.style.color = "#fff";

      const iconEl = clock.querySelector(".timerIcon");
      if(iconEl) iconEl.style.opacity = view.inLast5 ? "0" : "1";

      if(view.inLast5){
        if(TIMER_UI.lastSecond !== view.remaining){
          TIMER_UI.lastSecond = view.remaining;
          forceBurst(view.remaining);
        }
      }else{
        TIMER_UI.lastSecond = null;
      }

      const startBtn = document.getElementById("timerStartBtn");
      if(startBtn && TIMER_UI.isHost){
        /* âœ… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù„Ø§ ÙŠØ±Ø¬Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ "Ø§Ø¨Ø¯Ø£" */
        if(view.running){
          startBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª";
          startBtn.classList.add("running");
        }else if(view.done){
          startBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª";
          startBtn.classList.add("running");
        }else{
          startBtn.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª";
          startBtn.classList.remove("running");
        }
      }

      if(TIMER_UI.isHost){
        if(view.running && view.remaining === 0){
          if(TIMER_UI.lastDoneStartTs !== view.startTs){
            TIMER_UI.lastDoneStartTs = view.startTs;
            update(ref(db, `rooms/${code}/timer`), { running:false, done:true });
          }
        }
      }
    }

    function ensureTimerTicker(){
      if(TIMER_UI.tick) return;
      TIMER_UI.tick = setInterval(() => {
        applyTimerDom();
      }, 200);
    }

    function initTimerDefaultsIfNeeded(room){
      if(role !== "host") return;
      if(!room) return;

      const t = room.timer;
      if(t && typeof t === "object") return;

      const key = `__timer_init_${code}`;
      if(window[key]) return;
      window[key] = true;

      update(ref(db, `rooms/${code}/timer`), {
        sel: 10,
        dur: 10,
        running: false,
        startTs: 0,
        done: false
      });
    }

    if(!window.__scorePickerBound){
      window.__scorePickerBound = true;
      document.addEventListener("click", () => {
        document.querySelectorAll(".scorePicker.show").forEach(p => p.classList.remove("show"));
      });
    }

    if(!window.__timerPickerBound){
      window.__timerPickerBound = true;
      document.addEventListener("click", () => {
        document.querySelectorAll(".timerPicker.show").forEach(p => p.classList.remove("show"));
      });
    }

    function beep(){
      try{
        const AC = window.AudioContext || window.webkitAudioContext;
        if(!AC) return;
        const ctx = new AC();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.12;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(() => {
          o.stop();
          ctx.close();
        }, 300);
      }catch(e){}
    }

    function buildJoinUrl(roomCode){
      const u = new URL("join.html", location.href);
      u.searchParams.set("code", roomCode);
      return u.toString();
    }
    function buildQrUrl(dataUrl){
      const size = "220x220";
      return `https://api.qrserver.com/v1/create-qr-code/?size=${size}&data=${encodeURIComponent(dataUrl)}`;
    }
    async function copyText(txt){
      try{
        if(navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(txt);
          return true;
        }
      }catch(e){}
      try{
        const ta = document.createElement("textarea");
        ta.value = txt;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }catch(e){}
      return false;
    }

    const STORE_URL = "https://sandooq-m.com";
    function openStoreUrl(){
      try{
        const w = window.open(STORE_URL, "_blank", "noopener,noreferrer");
        if(!w) location.href = STORE_URL;
      }catch(e){
        location.href = STORE_URL;
      }
    }
    document.addEventListener("click", (e) => {
      const el = e.target?.closest?.('[data-store-link], #storeBtn, #storeLink');
      if(el){
        e.preventDefault();
        openStoreUrl();
      }
      const a = e.target?.closest?.("a[href]");
      if(a){
        const href = (a.getAttribute("href") || "").trim();
        if(href.includes("sandooq-m.com") && !/^https?:\/\//i.test(href)){
          a.setAttribute("href", "https://" + href.replace(/^\/+/, ""));
        }
      }
    }, true);

    function renderHostLobby(room){
      main.classList.remove("inGame");

      const players = room.players || {};
      const list = Object.entries(players).map(([id,p]) => ({id, ...p}));

      const green = list.filter(p => p.team === "green");
      const orange = list.filter(p => p.team === "orange");

      /* âœ… Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù…Ø² Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù„ÙˆØ¨ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ù„Ø±Ù…Ø² ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©) */
      main.innerHTML = `
        <div class="teams">
          <div class="teamCol teamGreen">
            <div class="teamTitle">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</div>
            <div id="greenList"></div>
          </div>
          <div class="teamCol teamOrange">
            <div class="teamTitle">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</div>
            <div id="orangeList"></div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <button id="shareBtn" class="btn btnYellow">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button>
          <button id="startBtn" class="btn btnGreen">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>

        <div class="smallNote">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ù„Ø§Ø¹Ø¨ Ù„Ù†Ù‚Ù„Ù‡ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±</div>

        <div id="shareBackdrop" class="shareBackdrop">
          <div class="shareModal">
            <button id="shareClose" class="shareClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
            <div class="shareTitle">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù„Ø¹Ø¨Ø©</div>

            <div class="shareChoices">
              <button id="shareQrBtn" class="btn btnOrange">Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
              <button id="shareCodeBtn" class="btn btnGreen">Ø±Ù…Ø²</button>
              <button id="shareLinkBtn" class="btn btnYellow">Ø±Ø§Ø¨Ø·</button>
            </div>

            <div id="shareQrPanel" class="sharePanel">
              <img id="qrImg" class="qrImg" alt="QR">
              <div class="shareSmall" id="joinUrlTxt"></div>
              <div class="row" style="justify-content:center;margin-top:10px">
                <button id="copyJoinBtn1" class="btn btnYellow">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
              </div>
              <div class="shareSmall">Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…</div>
            </div>

            <div id="shareCodePanel" class="sharePanel">
              <div class="codeBox" style="text-align:center">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©</div>
              <div style="font-size:34px;font-weight:bold;letter-spacing:2px;margin-top:6px">${escapeHtml(room.code)}</div>
            </div>

            <div id="shareLinkPanel" class="sharePanel">
              <div class="codeBox" style="text-align:center">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
              <div class="shareSmall" id="joinUrlTxt2"></div>
              <div class="row" style="justify-content:center;margin-top:10px">
                <button id="copyJoinBtn2" class="btn btnYellow">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
              </div>
            </div>
          </div>
        </div>
      `;

      const greenList = document.getElementById("greenList");
      const orangeList = document.getElementById("orangeList");

      function draw(colEl, arr){
        colEl.innerHTML = arr.map(p => `<div class="playerItem" data-id="${escapeHtml(p.id)}">${escapeHtml(p.name)}</div>`).join("") || `<div class="smallNote">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;
      }
      draw(greenList, green);
      draw(orangeList, orange);

      main.querySelectorAll(".playerItem").forEach(el => {
        el.addEventListener("click", async () => {
          const id = el.getAttribute("data-id");
          const p = players[id];
          if(!p) return;
          const newTeam = (p.team === "green") ? "orange" : "green";
          await update(ref(db, `rooms/${code}/players/${id}`), { team: newTeam });
        });
      });

      document.getElementById("startBtn").addEventListener("click", async () => {
        await update(roomRef, {
          status: "started",
          activeMap: 0,
          freeze: false,
          buzzer: null,
          current: { letter: null, qIndex: 0, row: null, col: null, map: 0 }
        });
      });

      const shareBackdrop = document.getElementById("shareBackdrop");
      const shareBtn = document.getElementById("shareBtn");
      const shareClose = document.getElementById("shareClose");
      const shareQrBtn = document.getElementById("shareQrBtn");
      const shareCodeBtn = document.getElementById("shareCodeBtn");
      const shareLinkBtn = document.getElementById("shareLinkBtn");
      const shareQrPanel = document.getElementById("shareQrPanel");
      const shareCodePanel = document.getElementById("shareCodePanel");
      const shareLinkPanel = document.getElementById("shareLinkPanel");
      const qrImg = document.getElementById("qrImg");
      const joinUrlTxt = document.getElementById("joinUrlTxt");
      const joinUrlTxt2 = document.getElementById("joinUrlTxt2");
      const copyJoinBtn1 = document.getElementById("copyJoinBtn1");
      const copyJoinBtn2 = document.getElementById("copyJoinBtn2");

      const joinUrl = buildJoinUrl(room.code);
      const qrUrl = buildQrUrl(joinUrl);

      function showPanel(which){
        shareQrPanel.style.display = (which === "qr") ? "block" : "none";
        shareCodePanel.style.display = (which === "code") ? "block" : "none";
        shareLinkPanel.style.display = (which === "link") ? "block" : "none";
      }

      function openShare(){
        shareBackdrop.style.display = "flex";
        showPanel("code");
      }
      function closeShare(){
        shareBackdrop.style.display = "none";
      }

      shareBtn.addEventListener("click", openShare);
      shareClose.addEventListener("click", closeShare);
      shareBackdrop.addEventListener("click", (e) => {
        if(e.target === shareBackdrop) closeShare();
      });

      shareQrBtn.addEventListener("click", () => {
        showPanel("qr");
        qrImg.src = qrUrl;
        joinUrlTxt.textContent = joinUrl;
      });

      shareCodeBtn.addEventListener("click", () => {
        showPanel("code");
      });

      shareLinkBtn.addEventListener("click", () => {
        showPanel("link");
        joinUrlTxt2.textContent = joinUrl;
      });

      if(copyJoinBtn1){
        copyJoinBtn1.addEventListener("click", async () => {
          const ok = await copyText(joinUrl);
          copyJoinBtn1.textContent = ok ? "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…" : "ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®";
          setTimeout(()=> copyJoinBtn1.textContent = "Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·", 1200);
        });
      }
      if(copyJoinBtn2){
        copyJoinBtn2.addEventListener("click", async () => {
          const ok = await copyText(joinUrl);
          copyJoinBtn2.textContent = ok ? "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…" : "ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®";
          setTimeout(()=> copyJoinBtn2.textContent = "Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·", 1200);
        });
      }
    }
        /* âœ… ØªØºÙ…ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© + ØªÙØ¹ÙŠÙ„ Ø´ÙƒÙ„ Ø²Ø¬Ø§Ø¬ÙŠ Ù„Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ø§Ù„Ù€ CSS Ø§Ù„Ø³Ø§Ø¨Ù‚) */
    try{
      document.documentElement.style.setProperty("--bg", "#173f8f"); /* Ø£ØºÙ…Ù‚ Ø´ÙˆÙŠ */
    }catch(e){}

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) ØªÙ†Ø³ÙŠÙ‚ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©: Ø²Ø¬Ø§Ø¬ÙŠ + 4 ÙƒÙ„Ù…Ø§Øª (2 ÙÙˆÙ‚ + 2 ØªØ­Øª) */
    function setGameName(raw){
      if(!gameNameEl) return;
      const s0 = String(raw ?? "").replace(/\s+/g, " ").trim();
      if(!s0){
        gameNameEl.innerHTML = "";
        gameNameEl.style.display = "none";
        return;
      }
      gameNameEl.style.display = "flex";

      // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 4 ÙƒÙ„Ù…Ø§Øª (Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø·ÙŠØ¹ ÙƒÙ„Ù…Ø©)
      const words0 = s0.split(" ").filter(Boolean);
      const words = words0.slice(0, 4);

      const top = words.slice(0, 2).join(" ");
      const bottom = words.slice(2, 4).join(" ");

      gameNameEl.innerHTML =
        `<span class="gnLine">${escapeHtml(top)}</span>` +
        `<span class="gnLine">${escapeHtml(bottom)}</span>`;

      /* âœ… Ø²Ø¬Ø§Ø¬ÙŠ Ø´ÙØ§Ù */
      gameNameEl.style.background = "rgba(255,255,255,.18)";
      gameNameEl.style.color = "#fff";
      gameNameEl.style.border = "1px solid rgba(255,255,255,.22)";
      gameNameEl.style.backdropFilter = "blur(8px)";
      gameNameEl.style.webkitBackdropFilter = "blur(8px)";
      gameNameEl.style.boxShadow = "0 2px 0 rgba(0,0,0,.10)";
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) Ø£Ø±Ù‚Ø§Ù… Ø¢Ø®Ø± 5 Ø«ÙˆØ§Ù†ÙŠ: Ø£Ø­Ù…Ø± ÙˆØ§Ø¶Ø­ */
    function forceBurst(n){
      const burst = document.getElementById("timerBurst");
      if(!burst) return;
      burst.textContent = String(n);
      burst.style.color = "var(--timerFillLast5)";  /* Ø£Ø­Ù…Ø± ÙˆØ§Ø¶Ø­ */
      burst.classList.remove("show");
      void burst.offsetWidth;
      burst.classList.add("show");
    }

    function renderWaiting(msg){
      main.classList.remove("inGame");

      /* âœ… (ØªØ¹Ø¯ÙŠÙ„) ØªØµØºÙŠØ±/Ù…Ù„Ø§Ø¦Ù…Ø© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± + ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù†Øµ + Ø±ÙØ¹ Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ + Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø³Ù„Ø© ÙŠØ³Ø§Ø± Ø§Ù„Ù†Øµ */
      main.innerHTML = `
        <div class="waitingLayout" style="min-height:auto;">
          <div style="
            width:min(92vw, 520px);
            margin: 0 auto;
            background:#fff;
            border-radius:14px;
            padding:14px 12px;
            box-shadow:0 2px 0 rgba(0,0,0,.10);
          ">
            <div style="
              font-size:22px;
              font-weight:900;
              color:#111;
              line-height:1.6;
            ">${escapeHtml(msg)}</div>
          </div>

          <div class="buyNowWrap" style="margin-top:18px;padding-bottom:10px;">
            <button class="buyNowBtn" data-store-link type="button" style="
              display:flex;
              align-items:center;
              justify-content:center;
              gap:10px;
            ">
              <span aria-hidden="true" style="font-size:20px;line-height:1;">ğŸ›’</span>
              <span>Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ø¶ØºØ· Ù‡Ù†Ø§</span>
            </button>
          </div>
        </div>
      `;
    }

    function renderGame(room, me){
      main.classList.add("inGame");
      setGameName(room?.name);

      const isHost = role === "host";
      const started = room.status === "started";

      initTimerDefaultsIfNeeded(room);

      const scores = room.scores || {};
      const scoreGreen = Number(scores.green || 0);
      const scoreOrange = Number(scores.orange || 0);

      const pickerButtons = Array.from({length:11}, (_,i)=>(
        `<button class="scorePickBtn" data-val="${i}" type="button">${i}</button>`
      )).join("");

      const timerOptions = [10,15,20,25,30].map(v => (
        `<button class="timerOptBtn" data-timer="${v}" type="button">${v} Ø«</button>`
      )).join("");

      main.innerHTML = `
        <div class="scoreBar">
          <span class="teamLabel orange">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</span>

          ${
            isHost ? `
              <div class="scoreCtrl">
                <button id="scoreOrangeVal" class="scoreBoxBtn clickable" type="button">${scoreOrange}</button>
                <div id="scorePickerOrange" class="scorePicker" role="menu" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ">
                  ${pickerButtons.replaceAll('data-val="', 'data-team="orange" data-val="')}
                </div>
              </div>
            ` : `
              <button class="scoreBoxBtn" disabled>${scoreOrange}</button>
            `
          }

          ${
            isHost ? `
              <div class="scoreCtrl">
                <button id="scoreGreenVal" class="scoreBoxBtn clickable" type="button">${scoreGreen}</button>
                <div id="scorePickerGreen" class="scorePicker" role="menu" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø®Ø¶Ø±">
                  ${pickerButtons.replaceAll('data-val="', 'data-team="green" data-val="')}
                </div>
              </div>
            ` : `
              <button class="scoreBoxBtn" disabled>${scoreGreen}</button>
            `
          }

          <span class="teamLabel green">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±</span>
        </div>
        ${isHost ? `<div class="scoreHint">Ø§Ù„Ù…Ù‚Ø¯Ù… ÙÙ‚Ø·: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø«Ù… Ø§Ø®ØªØ± Ø±Ù‚Ù…Ù‹Ø§ Ù…Ù† 0 Ø¥Ù„Ù‰ 10</div>` : ``}

        <div class="mapOuter">
          <div id="mapScale" class="mapScale" style="--zoom:1">
            <div id="mapBox" class="mapBox">
              <img id="mapImg" src="" alt="">
              <svg id="overlay" class="overlaySvg"></svg>
            </div>
          </div>
        </div>

        <div style="height:6px"></div>
        <div class="row" style="justify-content:space-between">
          <div class="row">
            ${isHost ? `<button id="mapBtn" class="btn btnYellow">ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>` : ""}
            <input id="zoom" type="range" min="0.8" max="1.35" step="0.01" value="1" />
            ${isHost ? `<button id="freezeBtn" class="btn ${room.freeze ? "btnRed" : "btnGreen"}">${room.freeze ? "Ù…Ø¬Ù…Ù‘Ø¯" : "Ù…ÙØ¹Ù„"}</button>` : ""}
          </div>
        </div>

        <div style="height:6px"></div>
        <div class="below">
          <div class="buzzRow" style="flex:1;min-width:260px">
            <div id="buzzBox" class="buzzBox buzzEmpty">â€”</div>

            ${isHost ? `
              <button id="nextQ" class="btn btnYellow nextQBtn">ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„</button>

              <div class="timerWrap" id="timerWrap">
                <button id="timerClock" class="timerClockBtn" type="button" aria-label="Ø§Ù„Ù…Ø¤Ù‚Øª">
                  <span class="timerIcon">â±</span>
                  <span id="timerBurst" class="timerBurst"></span>
                </button>

                <button id="timerStartBtn" class="btn timerStartBtn" type="button">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª</button>

                <div id="timerPicker" class="timerPicker" role="menu" aria-label="Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ‚Øª Ø§Ù„Ù…Ø¤Ù‚Øª">
                  <div class="timerOptRow">${timerOptions}</div>
                </div>
              </div>
            ` : `
              <div class="timerWrap timerPlayerView" id="timerWrap">
                <button id="timerClock" class="timerClockBtn player" type="button" tabindex="-1" aria-hidden="true">
                  <span class="timerIcon">â±</span>
                  <span id="timerBurst" class="timerBurst"></span>
                </button>
              </div>
            `}
          </div>

          ${isHost ? `
            <div class="questionBox">
              <div class="qTitle">Ø§Ù„Ø³Ø¤Ø§Ù„</div>
              <div id="qText" class="qText">Ø§Ø®ØªØ± Ø­Ø±ÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</div>
              <div id="qAns" class="qAns"></div>
            </div>
          ` : `
            <div class="questionBox">
              <div class="qTitle">Ø§Ù„Ø­Ø§Ù„Ø©</div>
              <div class="qText">${started ? "Ø¬Ø§Ù‡Ø²" : "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù‚Ø¯Ù…"}</div>
            </div>
          `}
        </div>

        ${(!isHost) ? `
          <div class="playerBtnWrap">
            <button id="buzzBtn" class="playerBigBtn">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>

            <div class="buyNowWrap" style="margin-top:10px;">
              <button class="buyNowBtn" data-store-link type="button" style="
                display:flex;
                align-items:center;
                justify-content:center;
                gap:10px;
              ">
                <span aria-hidden="true" style="font-size:20px;line-height:1;">ğŸ›’</span>
                <span>Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ø¶ØºØ· Ù‡Ù†Ø§</span>
              </button>
            </div>
          </div>
        ` : ""}
      `;

      /* âœ… (ØªØ¹Ø¯ÙŠÙ„) ØªØµØºÙŠØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø± Ù„ÙŠÙƒÙˆÙ† Ù…Ù„Ø§Ø¦Ù… Ù„Ø·ÙˆÙ„ Ø§Ù„Ø¬ÙˆØ§Ø¨ + Ø§Ù„ØªÙØ§Ù Ø¹Ø¯Ø© Ø£Ø³Ø·Ø± */
      if(isHost){
        const qAns = document.getElementById("qAns");
        if(qAns){
          qAns.style.display = "none";
          qAns.style.width = "fit-content";
          qAns.style.maxWidth = "92%";
          qAns.style.margin = "12px auto 0";
          qAns.style.padding = "10px 14px";
          qAns.style.borderRadius = "14px";
          qAns.style.whiteSpace = "normal";
          qAns.style.wordBreak = "keep-all";
        }
      }

      /* âœ… (ØªØ¹Ø¯ÙŠÙ„ 1) Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø´Ø±ÙŠØ· 0-10 */
      if(isHost){
        const pickerOrange = document.getElementById("scorePickerOrange");
        const pickerGreen  = document.getElementById("scorePickerGreen");
        const valOrangeBtn = document.getElementById("scoreOrangeVal");
        const valGreenBtn  = document.getElementById("scoreGreenVal");

        const hideAll = () => {
          pickerOrange?.classList.remove("show");
          pickerGreen?.classList.remove("show");
        };

        const togglePicker = (picker) => {
          const shown = picker.classList.contains("show");
          hideAll();
          if(!shown) picker.classList.add("show");
        };

        const setScore = async (team, value) => {
          const v = Math.max(0, Math.min(10, Number(value)));
          await update(ref(db, `rooms/${code}/scores`), { [team]: v });
        };

        if(pickerOrange) pickerOrange.addEventListener("click", (e)=>e.stopPropagation());
        if(pickerGreen)  pickerGreen.addEventListener("click", (e)=>e.stopPropagation());

        if(valOrangeBtn && pickerOrange){
          valOrangeBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            togglePicker(pickerOrange);
          });
        }
        if(valGreenBtn && pickerGreen){
          valGreenBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            togglePicker(pickerGreen);
          });
        }

        main.querySelectorAll(".scorePickBtn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const team = btn.getAttribute("data-team");
            const val  = btn.getAttribute("data-val");
            if(!team) return;
            await setScore(team, val);
            hideAll();
          });
        });
      }

      TIMER_UI.latestTimer = room.timer || {};
      TIMER_UI.isHost = isHost;
      ensureTimerTicker();
      applyTimerDom();

      if(isHost){
        const clock = document.getElementById("timerClock");
        const picker = document.getElementById("timerPicker");
        const startBtn = document.getElementById("timerStartBtn");

        if(clock && picker){
          clock.addEventListener("click", (e) => {
            e.stopPropagation();
            const shown = picker.classList.contains("show");
            document.querySelectorAll(".timerPicker.show").forEach(p => p.classList.remove("show"));
            if(!shown) picker.classList.add("show");
          });

          picker.addEventListener("click", (e)=>e.stopPropagation());

          const cur = normalizeTimer(room.timer || {});
          const sel = Number(cur.sel || 10);
          picker.querySelectorAll(".timerOptBtn").forEach(b=>{
            const v = Number(b.getAttribute("data-timer"));
            b.classList.toggle("active", v === sel);
          });

          picker.querySelectorAll(".timerOptBtn").forEach(btn => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const v = Number(btn.getAttribute("data-timer"));
              if(![10,15,20,25,30].includes(v)) return;

              await update(ref(db, `rooms/${code}/timer`), {
                sel: v,
                ...(normalizeTimer(room.timer || {}).running ? {} : { dur: v, done:false, startTs:0 })
              });

              picker.querySelectorAll(".timerOptBtn").forEach(b=>{
                const vv = Number(b.getAttribute("data-timer"));
                b.classList.toggle("active", vv === v);
              });
            });
          });
        }

        if(startBtn){
          startBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const t = normalizeTimer(TIMER_UI.latestTimer || {});
            const sel = Number(t.sel || 10);

            /* âœ… (ØªØ¹Ø¯ÙŠÙ„) Ø²Ø± Ø§Ù„Ù…Ø¤Ù‚Øª:
               - Ø¥Ø°Ø§ Ø´ØºØ§Ù„: ÙŠÙˆÙ‚Ù ÙˆÙŠØµÙŠØ± Ø¬Ø§Ù‡Ø²
               - Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ (done): ÙŠØ¨Ù‚Ù‰ Ù…ÙƒØªÙˆØ¨ "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª" Ø­ØªÙ‰ ØªØ¶ØºØ·Ù‡ ÙˆÙŠØ¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯
            */
            if(t.running){
              await update(ref(db, `rooms/${code}/timer`), {
                running:false,
                done:false,
                startTs:0,
                dur: sel
              });
              return;
            }

            await update(ref(db, `rooms/${code}/timer`), {
              sel,
              dur: sel,
              running:true,
              done:false,
              startTs: Date.now()
            });
          });
        }
      }
            }

      const mapImg = document.getElementById("mapImg");
      const overlay = document.getElementById("overlay");
      const mapScale = document.getElementById("mapScale");
      const zoom = document.getElementById("zoom");

      const activeMap = Number(room.activeMap || 0);

      const src = ([
        "maps/map1.jpeg",
        "maps/map2.jpeg",
        "maps/map3.jpeg"
      ][activeMap] || "maps/map1.jpeg");

      mapImg.src = src;

      overlay.innerHTML = "";
      overlay.setAttribute("xmlns", "http://www.w3.org/2000/svg");

      const svgNS = "http://www.w3.org/2000/svg";
      for(let row=0; row<5; row++){
        for(let col=0; col<5; col++){
          const poly = document.createElementNS(svgNS, "polygon");
          poly.classList.add("cell", "state0");
          poly.setAttribute("data-row", row);
          poly.setAttribute("data-col", col);
          overlay.appendChild(poly);
        }
      }

      overlay.style.pointerEvents = isHost ? "auto" : "none";

      const ZOOM_KEY = `sabaq_zoom_${code}`;
      const savedZoom = Number(localStorage.getItem(ZOOM_KEY) || "");
      if(zoom && Number.isFinite(savedZoom) && savedZoom >= 0.8 && savedZoom <= 1.35){
        zoom.value = String(savedZoom);
      }

      function applyZoomFix(){
        const mapBox = document.getElementById("mapBox");
        const mapOuter = document.querySelector(".mapOuter");
        if(!mapBox || !mapOuter) return;

        const z = Number(zoom.value || 1);
        mapScale.style.setProperty("--zoom", z);

        const baseH = mapBox.offsetHeight || 0;
        const extra = Math.max(0, baseH * (z - 1));
        mapOuter.style.marginBottom = `${extra}px`;
      }

      function placeHexes(){
        const W = mapImg.clientWidth;
        const H = mapImg.clientHeight;
        if(!W || !H) return;

        overlay.setAttribute("viewBox", `0 0 ${W} ${H}`);
        overlay.setAttribute("preserveAspectRatio", "none");

        const bbox = BBOX_CACHE[src];
        if(!bbox) return;

        const x0 = bbox.x0 * W;
        const y0 = bbox.y0 * H;
        const x1 = bbox.x1 * W;
        const y1 = bbox.y1 * H;

        const gridW = x1 - x0;
        const gridH = y1 - y0;

        const w = gridW / 5.5;
        const h = gridH / 4.0;
        const stepY = h * 0.75;

        const cells = overlay.querySelectorAll(".cell");
        let i = 0;
        for(let row=0; row<5; row++){
          for(let col=0; col<5; col++){
            const left = x0 + col*w + (row%2)*(w/2);
            const top  = y0 + row*stepY;
            cells[i++].setAttribute("points", hexPointsPointyTop(left, top, w, h));
          }
        }

        applyZoomFix();
      }

      function onMapReady(){
        if(!BBOX_CACHE[src]) BBOX_CACHE[src] = detectHexBBox(mapImg);
        requestAnimationFrame(placeHexes);
      }

      if(mapImg.complete) onMapReady();
      else mapImg.addEventListener("load", onMapReady, { once:true });

      window.addEventListener("resize", () => {
        placeHexes();
        applyZoomFix();
      });

      const mapStates = (room.mapStates && room.mapStates[String(activeMap)]) ? room.mapStates[String(activeMap)] : {};
      overlay.querySelectorAll(".cell").forEach(cell => {
        const r = Number(cell.getAttribute("data-row"));
        const c = Number(cell.getAttribute("data-col"));
        const k = cellKey(r,c);
        const st = Number(mapStates?.[k] ?? 0);
        setStateClass(cell, st);
      });

      const buzzBox = document.getElementById("buzzBox");
      const buzzer = room.buzzer;

      if(buzzer && buzzer.name){
        buzzBox.classList.remove("buzzEmpty");
        buzzBox.style.background = teamColor(buzzer.team);
        buzzBox.textContent = buzzer.name;
      }else{
        buzzBox.classList.add("buzzEmpty");
        buzzBox.style.background = "rgba(0,0,0,.25)";
        buzzBox.textContent = "â€”";
      }

      if(isHost){
        const qText = document.getElementById("qText");
        const qAns  = document.getElementById("qAns");
        const cur = room.current || {};

        if(cur.letter){
          const list = QUESTIONS[cur.letter] || [];
          if(!list.length){
            qText.textContent = `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø±Ù: ${cur.letter}`;
            qAns.textContent  = "";
            qAns.style.display = "none";
          }else{
            const idx = Number(cur.qIndex || 0) % list.length;
            const item = list[idx];
            qText.textContent = item?.q ?? "â€”";
            qAns.textContent  = item?.a ?? "";

            qAns.style.display = (qAns.textContent.trim() ? "block" : "none");
          }
        }else{
          qText.textContent = "Ø§Ø®ØªØ± Ø­Ø±ÙÙ‹Ø§ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
          qAns.textContent  = "";
          qAns.style.display = "none";
        }
      }

      zoom.addEventListener("input", () => {
        const z = Number(zoom.value || 1);
        localStorage.setItem(ZOOM_KEY, String(z));
        applyZoomFix();
      });

      const mapBtn = document.getElementById("mapBtn");
      if(mapBtn){
        mapBtn.addEventListener("click", async () => {
          const next = (activeMap + 1) % 3;
          await update(roomRef, {
            activeMap: next,
            buzzer: null,
            current: { letter: null, qIndex: 0, row: null, col: null, map: next }
          });
        });
      }

      const freezeBtn = document.getElementById("freezeBtn");
      if(freezeBtn){
        freezeBtn.addEventListener("click", async () => {
          await update(roomRef, { freeze: !room.freeze, buzzer: null });
        });
      }

      const nextQ = document.getElementById("nextQ");
      if(nextQ){
        nextQ.addEventListener("click", async () => {
          const cur = room.current || {};
          if(!cur.letter) return;
          const list = QUESTIONS[cur.letter] || [];
          if(!list.length) return;
          const nextIndex = (Number(cur.qIndex || 0) + 1) % list.length;
          await update(roomRef, { current: { ...cur, qIndex: nextIndex } });
        });
      }

      if(isHost){
        overlay.querySelectorAll(".cell").forEach(cell => {
          cell.addEventListener("click", async (e) => {
            e.preventDefault();
            if(room.status !== "started") return;

            const r = Number(cell.getAttribute("data-row"));
            const c = Number(cell.getAttribute("data-col"));
            const k = cellKey(r,c);

            const st = Number(mapStates?.[k] ?? 0);
            const next = (st + 1) % 4;

            const letter = MAPS[activeMap][r][c];

            const updates = {};
            updates[`rooms/${code}/mapStates/${activeMap}/${k}`] = next;
            updates[`rooms/${code}/buzzer`] = null;
            updates[`rooms/${code}/current`] = { letter, qIndex: 0, row: r, col: c, map: activeMap };

            await update(ref(db), updates);
          });
        });
      }

      const buzzBtn = document.getElementById("buzzBtn");
      if(buzzBtn){
        const disabled = (!started) || room.freeze || !me || !me.name;
        if(disabled) buzzBtn.classList.add("disabled");

        buzzBtn.addEventListener("click", async () => {
          if(!started) return;
          if(room.freeze) return;
          if(!me) return;

          const buzzerRef = ref(db, `rooms/${code}/buzzer`);
          await runTransaction(buzzerRef, (cur) => {
            if(cur === null){
              return { pid, name: me.name, team: me.team, ts: Date.now() };
            }
            return;
          });
        });
      }
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…) Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙ applyTimerDom Ø¹Ø´Ø§Ù†:
       - Ø²Ø± Ø§Ù„Ù…Ø¤Ù‚Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙŠØ¨Ù‚Ù‰ "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª" (Ù…Ø§ ÙŠØ±Ø¬Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ "Ø§Ø¨Ø¯Ø£")
       - Ø¢Ø®Ø± 5 Ø«ÙˆØ§Ù†ÙŠ: Ø£Ø±Ù‚Ø§Ù… Ø­Ù…Ø±Ø§Ø¡ ÙˆØ§Ø¶Ø­Ø© (ØªÙ… ÙÙŠ forceBurst)
    */
    function applyTimerDom(){
      const clock = document.getElementById("timerClock");
      if(!clock) return;

      const t = normalizeTimer(TIMER_UI.latestTimer || {});
      const view = computeTimerView(t);

      const fill = view.inLast5 ? "var(--timerFillLast5)" : "var(--timerFill)";
      clock.style.setProperty("--timerFill", fill);
      clock.style.setProperty("--p", String(view.progress));

      if(view.done){
        clock.classList.add("timerFlashing");
      }else{
        clock.classList.remove("timerFlashing");
      }

      clock.style.color = "#fff";

      const iconEl = clock.querySelector(".timerIcon");
      if(iconEl) iconEl.style.opacity = view.inLast5 ? "0" : "1";

      if(view.inLast5){
        if(TIMER_UI.lastSecond !== view.remaining){
          TIMER_UI.lastSecond = view.remaining;
          forceBurst(view.remaining);
        }
      }else{
        TIMER_UI.lastSecond = null;
      }

      const startBtn = document.getElementById("timerStartBtn");
      if(startBtn && TIMER_UI.isHost){
        if(view.running){
          startBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª";
          startBtn.classList.add("running");
        }else if(view.done){
          startBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª"; /* âœ… ÙŠØ¨Ù‚Ù‰ Ù‡ÙƒØ°Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ */
          startBtn.classList.remove("running");
          startBtn.style.opacity = "1";
        }else{
          startBtn.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª";
          startBtn.classList.remove("running");
        }
      }

      if(TIMER_UI.isHost){
        if(view.running && view.remaining === 0){
          if(TIMER_UI.lastDoneStartTs !== view.startTs){
            TIMER_UI.lastDoneStartTs = view.startTs;
            update(ref(db, `rooms/${code}/timer`), { running:false, done:true });
          }
        }
      }
    }
        /* âœ… (ØªØ¹Ø¯ÙŠÙ„) Ø¢Ø®Ø± 5 Ø«ÙˆØ§Ù†ÙŠ: Ø§Ù„Ø±Ù‚Ù… ÙŠÙƒÙˆÙ† Ø£Ø­Ù…Ø± ÙˆØ§Ø¶Ø­ */
    function forceBurst(n){
      const burst = document.getElementById("timerBurst");
      if(!burst) return;
      burst.textContent = String(n);
      burst.style.color = "var(--timerFillLast5)"; /* Ø£Ø­Ù…Ø± */
      burst.classList.remove("show");
      void burst.offsetWidth;
      burst.classList.add("show");
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) ØªØ­Ø³ÙŠÙ† ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¤Ù‚Øª: ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ (12) ÙˆØªÙ†Ù‚Øµ Ù…Ø¹ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø© */
    function applyTimerDom(){
      const clock = document.getElementById("timerClock");
      if(!clock) return;

      const t = normalizeTimer(TIMER_UI.latestTimer || {});
      const view = computeTimerView(t);

      const fill = view.inLast5 ? "var(--timerFillLast5)" : "var(--timerFill)";
      const p = Math.max(0, Math.min(1, view.progress));

      // Ø·Ø¨Ù‚Ø© ØªØ¹Ø¨Ø¦Ø© Ù†ØªØ­ÙƒÙ… ÙÙŠÙ‡Ø§ Ø¨Ø§Ù„Ù€ JS (Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ ::before)
      let layer = clock.querySelector(".timerFillLayer");
      if(!layer){
        layer = document.createElement("span");
        layer.className = "timerFillLayer";
        layer.style.position = "absolute";
        layer.style.inset = "6px";
        layer.style.borderRadius = "50%";
        layer.style.zIndex = "1";
        layer.style.pointerEvents = "none";
        clock.insertBefore(layer, clock.firstChild);
      }

      layer.style.background = `conic-gradient(from -90deg,
        ${fill} 0turn ${p}turn,
        rgba(0,0,0,.08) ${p}turn 1turn
      )`;

      if(view.done){
        clock.classList.add("timerFlashing");
        layer.style.animation = "timerFlashFill .6s linear infinite";
      }else{
        clock.classList.remove("timerFlashing");
        layer.style.animation = "none";
      }

      clock.style.color = "#fff";

      const iconEl = clock.querySelector(".timerIcon");
      if(iconEl) iconEl.style.opacity = view.inLast5 ? "0" : "1";

      if(view.inLast5){
        if(TIMER_UI.lastSecond !== view.remaining){
          TIMER_UI.lastSecond = view.remaining;
          forceBurst(view.remaining);
        }
      }else{
        TIMER_UI.lastSecond = null;
      }

      // âœ… Ø²Ø± Ø§Ø¨Ø¯Ø£/Ø¥ÙŠÙ‚Ø§Ù (ÙŠØ¨Ù‚Ù‰ "Ø¥ÙŠÙ‚Ø§Ù" Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡)
      const startBtn = document.getElementById("timerStartBtn");
      if(startBtn && TIMER_UI.isHost){
        if(view.running){
          startBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª";
          startBtn.classList.add("running");
        }else if(view.done){
          startBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª";
          startBtn.classList.remove("running");
          startBtn.style.opacity = "1";
        }else{
          startBtn.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª";
          startBtn.classList.remove("running");
        }
      }

      // âœ… Ø¥Ù†Ù‡Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ­ÙØ¸ done
      if(TIMER_UI.isHost){
        if(view.running && view.remaining === 0){
          if(TIMER_UI.lastDoneStartTs !== view.startTs){
            TIMER_UI.lastDoneStartTs = view.startTs;
            update(ref(db, `rooms/${code}/timer`), { running:false, done:true });
          }
        }
      }
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) ØªØºÙ…ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø´ÙˆÙŠ + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ø²Ø¬Ø§Ø¬ÙŠ */
    function applyThemeTweaks(){
      try{
        document.documentElement.style.setProperty("--bg", "#173a86"); /* Ø£ØºÙ…Ù‚ Ø´ÙˆÙŠ */
      }catch(e){}
    }
    function makeGameNameGlassy(){
      if(!gameNameEl) return;
      gameNameEl.style.background = "rgba(255,255,255,.18)";
      gameNameEl.style.border = "1px solid rgba(255,255,255,.28)";
      gameNameEl.style.backdropFilter = "blur(10px)";
      gameNameEl.style.webkitBackdropFilter = "blur(10px)";
      gameNameEl.style.color = "#fff";
      gameNameEl.style.boxShadow = "0 6px 18px rgba(0,0,0,.18)";
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø®ÙØ§Ø¡ (Ø±Ù…Ø²: ####) Ù…Ù† ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª â€” Ø§Ù„Ø±Ù…Ø² ÙŠØ¨Ù‚Ù‰ Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙ‚Ø· */
    function hideRoomBadge(){
      if(roomCodeBadge) roomCodeBadge.style.display = "none";
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) ØµÙØ­Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù†Øµ + ØªØµØºÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø© + Ø±ÙØ¹ Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ + Ø³Ù„Ø© ÙŠØ³Ø§Ø± Ø§Ù„Ù†Øµ */
    function patchWaitingUI(){
      const layout = document.querySelector(".waitingLayout");
      if(layout){
        layout.style.minHeight = "44vh";
        layout.style.justifyContent = "center";
        layout.style.gap = "10px";
      }

      const msg = document.querySelector(".waitingLayout .muted");
      if(msg){
        msg.style.fontSize = "22px";
        msg.style.fontWeight = "900";
        msg.style.color = "#111";
        msg.style.lineHeight = "1.7";
        msg.style.margin = "8px auto 0";
      }

      const buyWrap = document.querySelector(".waitingLayout .buyNowWrap");
      if(buyWrap){
        buyWrap.style.marginTop = "18px";
        buyWrap.style.paddingTop = "0";
      }

      const buyBtn = document.querySelector(".waitingLayout .buyNowBtn");
      if(buyBtn){
        buyBtn.innerHTML = `ğŸ›’ Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ø¶ØºØ· Ù‡Ù†Ø§`;
      }
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) Ø­Ø°Ù Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØµØºÙŠØ±Ø© ØªØ­Øª Ø²Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£Ø­Ù…Ø± (Ù…ÙƒØ±Ø±Ø©) */
    function removePlayerSmallNote(){
      const note = document.querySelector(".playerBtnWrap .smallNote");
      if(note) note.remove();
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) ØªØµØºÙŠØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø± Ù„ÙŠÙƒÙˆÙ† Ù…Ù„Ø§Ø¦Ù… Ù„Ø·ÙˆÙ„ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ù…Ø¹ Ø§Ù„ØªÙØ§Ù */
    function patchAnswerBox(){
      const qAns = document.getElementById("qAns");
      if(!qAns) return;
      qAns.style.width = "fit-content";
      qAns.style.maxWidth = "100%";
      qAns.style.marginLeft = "auto";
      qAns.style.marginRight = "auto";
      qAns.style.padding = "10px 14px";
      qAns.style.whiteSpace = "normal";
      qAns.style.lineHeight = "1.7";
      qAns.style.borderRadius = "14px";
      qAns.style.wordBreak = "normal";
      qAns.style.overflowWrap = "break-word";
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒØ¨ÙŠØ± Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø±Ù…Ø² Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† Ø¨Ø´ÙƒÙ„ ØµØºÙŠØ±) */
    function patchShareCodeBig(room){
      const big = document.querySelector(".shareCodeBig");
      if(big){
        big.textContent = `Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: ${room.code}`;
        big.style.fontSize = "18px";
        big.style.letterSpacing = "1px";
        big.style.marginTop = "10px";
      }
    }

    /* âœ… (ØªØ¹Ø¯ÙŠÙ„) Ø²Ø± Ø§Ù„Ù…Ø¤Ù‚Øª: Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙŠØ¨Ù‚Ù‰ "Ø¥ÙŠÙ‚Ø§Ù" ÙˆØ£ÙˆÙ„ Ø¶ØºØ·Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ = ØªØµÙÙŠØ± ÙÙ‚Ø· */
    function patchTimerStartButton(){
      const oldBtn = document.getElementById("timerStartBtn");
      if(!oldBtn) return;

      const newBtn = oldBtn.cloneNode(true);
      oldBtn.replaceWith(newBtn);

      newBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const t = normalizeTimer(TIMER_UI.latestTimer || {});
        const sel = Number(t.sel || 10);

        // Ø¥Ø°Ø§ Ø´ØºØ§Ù„: Ø¥ÙŠÙ‚Ø§Ù + ØªØµÙÙŠØ±
        if(t.running){
          await update(ref(db, `rooms/${code}/timer`), {
            sel,
            dur: sel,
            running:false,
            done:false,
            startTs:0
          });
          return;
        }

        // âœ… Ø¥Ø°Ø§ Ù…Ù†ØªÙ‡ÙŠ: Ø£ÙˆÙ„ Ø¶ØºØ·Ø© ØªØµÙÙŠØ± ÙÙ‚Ø· (ÙŠØµÙŠØ± Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯Ù‡Ø§ "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª")
        if(t.done){
          await update(ref(db, `rooms/${code}/timer`), {
            sel,
            dur: sel,
            running:false,
            done:false,
            startTs:0
          });
          return;
        }

        // Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯
        await update(ref(db, `rooms/${code}/timer`), {
          sel,
          dur: sel,
          running:true,
          done:false,
          startTs: Date.now()
        });
      });
    }

    applyThemeTweaks();
    makeGameNameGlassy();
    hideRoomBadge();

    onValue(roomRef, (snap) => {
      hideRoomBadge();

      if(!snap.exists()){
        main.textContent = "Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­).";
        setGameName("");
        return;
      }
      const room = snap.val();

      // âœ… Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© + Ø²Ø¬Ø§Ø¬ÙŠ
      setGameName(room?.name);
      makeGameNameGlassy();

      // âœ… Ø§Ù„Ù…Ø¤Ù‚Øª Ù…ØªØ²Ø§Ù…Ù†
      TIMER_UI.latestTimer = room.timer || {};

      // âœ… (Ù…Ù‡Ù…) Ù„Ø§ Ù†Ø¸Ù‡Ø± (Ø±Ù…Ø²: ####) ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
      hideRoomBadge();

      if(role === "host"){
        if(!hostKey || hostKey !== room.presenterKey){
          main.textContent = "ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
          return;
        }
        if(room.status === "lobby"){
          renderHostLobby(room);
          hideRoomBadge();
          patchShareCodeBig(room);     // ÙŠØ´ÙŠÙ„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒØ¨ÙŠØ± Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
          return;
        }

        renderGame(room, null);
        hideRoomBadge();
        patchAnswerBox();
        patchTimerStartButton();       // Ø³Ù„ÙˆÙƒ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        return;
      }

      const players = room.players || {};
      const me = pid ? players[pid] : null;

      if(!pid || !me){
        main.textContent = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        return;
      }

      if(room.status === "lobby"){
        renderWaiting("Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø¯Ù…...");
        hideRoomBadge();
        patchWaitingUI();              // ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù†Øµ + Ø±ÙØ¹ Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ + ğŸ›’
        return;
      }

      renderGame(room, me);
      hideRoomBadge();
      removePlayerSmallNote();         // ÙŠØ­Ø°Ù Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙƒØ±Ø± ØªØ­Øª Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø±
    });
  </script>
</body>
</html>
