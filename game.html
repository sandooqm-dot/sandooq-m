<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>سباق الحروف</title>

  <style>
    /* ✅ خط AA-GALAXY (ارفع الملف بجانب game.html) */
    @font-face{
      font-family:"AA-GALAXY";
      src:url("AA-GALAXY.otf") format("opentype");
      font-weight:normal;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --bg1:#7a1f61;
      --bg2:#5d234a;
      --bg3:#3b1033;

      --white:#fff;
      --black:#111;

      --orange:#f28c00;
      --green:#1aa34a;
      --red:#e53935;

      --hexGreen:  rgba(0, 140, 70, .42);
      --hexOrange: rgba(255, 140, 0, .42);
      --hexPale:   rgba(255, 215, 80, .70);
      --hexBorder: rgba(0,0,0,.12);

      --timerFill:#b43d69;

      /* ✅ سماوي زر الأسئلة الخاصة */
      --cyan:#7fe7ff;
      --cyan2:#3bd6ff;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      color:#fff;
      text-align:center;
      font-family:"AA-GALAXY", Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 45%, var(--bg3) 100%);
      min-height:100vh;
    }

    a{color:inherit}

    /* ✅ هيدر */
    header{
      padding:16px 14px 6px;
    }
    .headerRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      width:100%;
      direction:ltr;
    }
    .logo{
      width:74px;height:74px;
      object-fit:contain;
      flex:0 0 auto;
    }
    h1{
      margin:0;
      flex:1 1 auto;
      text-align:center;
      color:#fff;
      font-size:52px;
      line-height:1.05;
      font-weight:900;
      text-shadow:0 10px 22px rgba(0,0,0,.35);
      direction:rtl;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding-top:6px;
    }
    .gameName{
      flex:0 0 auto;
      width:min(30vw, 190px);
      min-height:58px;
      padding:10px 10px;
      border-radius:10px;
      background:rgba(0,0,0,.10);
      border:5px solid rgba(0,0,0,.85);
      color:#fff;
      font-weight:900;
      line-height:1.15;
      text-align:center;
      overflow:hidden;
      direction:rtl;
      box-shadow:0 10px 22px rgba(0,0,0,.22);
    }
    .gameName:empty{display:none;}
    .gnText{
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      overflow:hidden;
      word-break:break-word;
      white-space:normal;
      font-size:18px;
    }

    .wrap{width:95%;max-width:980px;margin:0 auto}
    .card{background:transparent;color:#fff;width:100%;margin:8px auto 0;padding:0;border-radius:0}

    /* =========================
       Layout (Portrait/Landscape)
    ========================= */
    .gameLayout{
      width:min(92vw, 860px);
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      direction:rtl; /* عشان يمين/يسار في الوضع الأفقي */
    }
    .sideMap, .sideMain{ width:100%; }

    /* ✅ الوضع الأفقي: الخريطة يمين + الأدوات تحتها، والباقي يسار */
    @media (orientation: landscape){
      .gameLayout{
        width:min(96vw, 1180px);
        max-width:1200px;
        flex-direction:row;
        align-items:flex-start;
        gap:14px;
      }
      .sideMap{ flex:0 0 54%; }
      .sideMain{ flex:1 1 auto; }
    }

    /* =========================
       LANDING / LOBBY
    ========================= */
    .panel{
      width:min(92vw, 760px);
      margin:12px auto 0;
      padding:16px;
      border-radius:22px;
      background:rgba(255,255,255,.10);
      border:4px solid rgba(255,255,255,.35);
      box-shadow:0 14px 28px rgba(0,0,0,.22);
      display:flex;
      flex-direction:column;
      gap:12px;
      text-align:center;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center}
    .in{
      width:min(560px, 92%);
      height:56px;
      border-radius:18px;
      border:4px solid rgba(0,0,0,.85);
      outline:none;
      padding:0 12px;
      font-size:18px;
      font-weight:900;
      text-align:center;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .btn{
      padding:12px 14px;
      font-size:20px;
      border:none;
      border-radius:18px;
      cursor:pointer;
      font-weight:900;
      font-family:"AA-GALAXY", Arial, sans-serif;
      box-shadow:0 10px 22px rgba(0,0,0,.22);
      border:5px solid rgba(0,0,0,.85);
      background:#fff;
      color:#111;
      min-width:180px;
      height:62px;
    }
    .btn:active{ transform: translateY(1px); }
    .smallNote{font-size:14px;opacity:.9;margin-top:2px}

    /* =========================
       MAP
    ========================= */
    .mapOuter{width:100%;display:flex;justify-content:center}
    .mapScale{
      width:min(92vw, 760px);
      transform:scale(var(--zoom, 1));
      transform-origin:center top;
    }
    .mapBox{
      position:relative;
      width:100%;
      border-radius:8px;
      overflow:hidden;
      background:transparent;
      border:10px solid rgba(242,140,0,.95);
      box-shadow:0 14px 28px rgba(0,0,0,.25);
    }
    .mapBox img{
      width:100%;
      height:auto;
      display:block;
      background:#0b7a2a;
    }
    .overlaySvg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:auto;
    }
    .overlaySvg .cell{
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      stroke: var(--hexBorder);
      stroke-width: 1;
    }
    .overlaySvg .state0{ fill: rgba(0,0,0,0.001); }
    .overlaySvg .state1{ fill: var(--hexPale); }
    .overlaySvg .state2{ fill: var(--hexGreen); }
    .overlaySvg .state3{ fill: var(--hexOrange); }

    @keyframes palePulse {
      0%   { opacity: 1; }
      50%  { opacity: .35; }
      100% { opacity: 1; }
    }
    .overlaySvg .state1.pulse { animation: palePulse 0.9s ease-in-out infinite; }

    /* =========================
       أدوات تحت الخريطة
    ========================= */
    .mapToolsRow{
      margin:12px auto 8px;
      width:min(92vw, 760px);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      direction:rtl;
      flex-wrap:wrap;
    }

    .toolBtn{
      width:54px;height:54px;
      border:none;
      border-radius:50%;
      background:#fff;
      color:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.20);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      border:3px solid rgba(0,0,0,.10);
      position:relative;
      overflow:visible;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .toolBtn:active{ transform: translateY(1px); }
    .toolBtn svg{ width:28px;height:28px; fill:#111; }
    .toolBtn .txtIcon{ font-size:30px; font-weight:900; line-height:1; }

    /* ✅ سماوي عند الأسئلة الخاصة */
    .toolBtn.cyan{
      background: linear-gradient(180deg, var(--cyan) 0%, var(--cyan2) 100%);
      border-color: rgba(0,0,0,.18);
    }
    .toolBtn.cyan svg{ fill:#08303a; }
    .toolBtn.cyan .txtIcon{ color:#08303a; }

    /* ✅ علامة (?) باهتة */
    .helpDot{
      position:absolute;
      top:-6px;
      left:-6px;
      width:18px;height:18px;
      border-radius:50%;
      background:rgba(255,255,255,.55);
      border:2px solid rgba(0,0,0,.20);
      color:rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:900;
      line-height:1;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
      user-select:none;
    }
    .helpPopover{
      position:fixed;
      z-index:99999;
      max-width:min(300px, 86vw);
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.96);
      border:4px solid rgba(0,0,0,.85);
      box-shadow:0 16px 30px rgba(0,0,0,.25);
      color:#111;
      text-align:right;
      font-weight:900;
      font-size:14px;
      line-height:1.5;
      display:none;
    }

    .zoomWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      width:min(360px, 86vw);
      padding:8px 10px;
      border-radius:14px;
      background:transparent;
    }
    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      width:100%;
      height:8px;
      border-radius:999px;
      background:rgba(255,255,255,.70);
      outline:none;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:26px;
      height:26px;
      border-radius:6px;
      background:#111;
      border:3px solid rgba(255,255,255,.80);
      box-shadow:0 6px 14px rgba(0,0,0,.25);
      cursor:pointer;
    }
    input[type="range"]::-moz-range-thumb{
      width:26px;height:26px;border-radius:6px;
      background:#111;border:3px solid rgba(255,255,255,.80);
      cursor:pointer;
    }

    /* =========================
       لوحة النتائج (Scoreboard)
    ========================= */
    .scoreBar{
      width:100%;
      margin:6px auto 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      direction:rtl;
      flex-wrap:wrap;
    }
    .teamPill{
      min-width:170px;
      height:52px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:24px;
      color:#fff;
      border:4px solid rgba(0,0,0,.55);
      box-shadow:0 10px 22px rgba(0,0,0,.22);
      padding:0 14px;
      white-space:nowrap;
    }
    .teamPill.orange{ background:rgba(242,140,0,.95); }
    .teamPill.green{ background:rgba(26,163,74,.95); }

    .scoreBox{
      width:64px;
      height:64px;
      border-radius:18px;
      border:6px solid rgba(0,0,0,.85);
      background:#fff;
      color:#111;
      font-weight:900;
      font-size:34px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 12px 24px rgba(0,0,0,.22);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    button.scoreBox{ cursor:pointer; }
    .scoreBox.readonly{ opacity:.95; }

    /* نافذة اختيار رقم النقاط */
    .scoreBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99998;
      padding:14px;
    }
    .scoreModal{
      width:min(92vw, 560px);
      background:#fff;
      color:#111;
      border-radius:20px;
      border:8px solid rgba(0,0,0,.85);
      box-shadow:0 18px 34px rgba(0,0,0,.30);
      padding:14px 14px 16px;
      text-align:center;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .scoreTitle{
      font-weight:900;
      font-size:22px;
      margin:4px 0 10px;
    }
    .scoreGrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      direction:ltr;
    }
    .scorePick{
      height:56px;
      border-radius:16px;
      border:5px solid rgba(0,0,0,.85);
      background:#fff;
      font-weight:900;
      font-size:24px;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .scorePick:active{ transform: translateY(1px); }

    /* =========================
       شريط اسم أول لاعب
    ========================= */
    .firstPressBar{
      margin:8px auto 10px;
      width:100%;
      border-radius:999px;
      padding:14px 14px;
      background:rgba(255,255,255,.10);
      border:4px solid rgba(255,255,255,.70);
      color:#fff;
      font-weight:900;
      font-size:22px;
      box-shadow:0 10px 22px rgba(0,0,0,.22);
    }
    .firstPressBar.filled{
      border-color: rgba(255,255,255,.80);
      color:#fff;
    }

    /* =========================
       صف الأزرار + المؤقت
    ========================= */
    .controlRow{
      width:100%;
      margin:0 auto 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }

    .pillBtn{
      flex:1 1 0;
      height:72px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      border:4px solid rgba(255,255,255,.75);
      color:#fff;
      font-size:26px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.22);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      padding:0 18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .pillBtn:active{ transform: translateY(1px); box-shadow:0 8px 18px rgba(0,0,0,.22); }
    .pillBtn.disabled{opacity:.45; cursor:not-allowed}

    /* المؤقت وسط */
    .timerWrap{ flex:0 0 auto; display:flex; justify-content:center; align-items:center; }
    .timerClockBtn{
      width:134px;height:134px;
      border:none;
      background:transparent;
      border-radius:50%;
      cursor:pointer;
      position:relative;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .timerClockBtn::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:50%;
      border:6px solid rgba(255,255,255,.85);
      box-shadow:0 12px 26px rgba(0,0,0,.28);
    }
    .timerClockBtn::after{
      content:"";
      position:absolute;
      inset:14px;
      border-radius:50%;
      background:var(--timerFill);
    }
    .timerRing{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      transform: rotate(-90deg);
      pointer-events:none;
      z-index:2;
      opacity:0;
    }
    .timerRing circle{
      fill: transparent;
      stroke: rgba(255,255,255,.95);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset .20s linear;
    }
    .timerNumber{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#fff;
      font-size:52px;
      z-index:3;
      text-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .timerNumber.red{ color:#ff2a2a; }
    @keyframes pop {
      0%{ transform:scale(1); }
      50%{ transform:scale(1.12); }
      100%{ transform:scale(1); }
    }
    .timerNumber.pop{ animation:pop .20s ease-in-out; }

    @keyframes flash {
      0%{ filter:brightness(1); }
      50%{ filter:brightness(1.8); }
      100%{ filter:brightness(1); }
    }
    .timerClockBtn.flash{ animation:flash .45s ease-in-out infinite; }

    /* =========================
       بطاقة السؤال
    ========================= */
    .questionCard{
      width:100%;
      margin:10px auto 6px;
      background:#fff;
      color:#111;
      border-radius:28px;
      border:10px solid rgba(0,0,0,.88);
      box-shadow:0 18px 34px rgba(0,0,0,.30);
      padding:22px 16px 18px;
      text-align:center;
    }
    /* ✅ لون السؤال أسود */
    .qText{
      color:#111;
      font-size:34px;
      font-weight:900;
      line-height:1.35;
      margin:0 0 14px;
    }

    /* ✅ زر الجواب التفاعلي */
    .answerBtn{
      width:min(380px, 92%);
      height:70px;
      border-radius:999px;
      border:none;
      color:#fff;
      font-size:26px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 12px 24px rgba(0,0,0,.22);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      padding:0 16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .answerBtn:active{ transform: translateY(1px); }
    .answerBtn.disabled{ opacity:.45; cursor:not-allowed; }
    .answerBtn.answerHidden{ background:#ff2a2a; }
    .answerBtn.answerShown{ background:rgba(26,163,74,.98); }

    /* =========================
       Player big button
    ========================= */
    .playerBtnWrap{margin-top:10px}
    .playerBigBtn{
      width:min(92vw, 520px);
      height:110px;
      border:none;border-radius:20px;
      background:rgba(224,57,53,.95);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:30px;
      font-weight:900;
      box-shadow:0 14px 28px rgba(0,0,0,.25);
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .playerBigBtn.disabled{opacity:.45; cursor:not-allowed}

    /* =========================
       أسفل الصفحة
    ========================= */
    .bottomBar{
      width:95%;
      max-width:980px;
      margin:18px auto 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:0 4px;
    }
    .homeBtn{
      border:none;
      border-radius:999px;
      padding:14px 20px;
      background:rgba(255,255,255,.92);
      color:#111;
      font-size:22px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 12px 24px rgba(0,0,0,.22);
      border:5px solid rgba(0,0,0,.85);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    /* ✅ عبارة الحقوق أصغر وأخف */
    .rightsTxt{
      font-size:13px;
      opacity:.55;
      text-align:right;
      padding-right:6px;
      white-space:nowrap;
    }

    /* =========================
       احتفال الفوز
    ========================= */
    .winBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99997;
      padding:14px;
    }
    .winCard{
      width:min(92vw, 680px);
      border-radius:28px;
      border:10px solid rgba(0,0,0,.88);
      background:rgba(255,255,255,.96);
      box-shadow:0 20px 36px rgba(0,0,0,.32);
      padding:26px 18px 22px;
      text-align:center;
      color:#111;
      position:relative;
      overflow:hidden;
      font-family:"AA-GALAXY", Arial, sans-serif;
    }
    .winTitle{
      font-weight:900;
      font-size:38px;
      line-height:1.2;
      margin:0 0 10px;
    }
    .winSub{
      font-weight:900;
      font-size:22px;
      opacity:.85;
      margin:0;
    }
    .winConfetti{
      position:absolute;
      inset:-20px;
      pointer-events:none;
      opacity:.85;
    }
    .confettiPiece{
      position:absolute;
      width:10px;
      height:18px;
      border-radius:4px;
      opacity:.95;
      animation: fall 1.6s linear infinite;
    }
    @keyframes fall{
      0%{ transform: translateY(-40px) rotate(0deg); opacity:.95; }
      100%{ transform: translateY(520px) rotate(260deg); opacity:.90; }
    }

    /* رسالة صغيرة */
    .toast{
      width:min(92vw, 760px);
      margin:10px auto 0;
      background:rgba(255,255,255,.10);
      border:3px solid rgba(255,255,255,.30);
      border-radius:18px;
      padding:10px 12px;
      font-weight:900;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      display:none;
    }
  </style>
</head>

<body>
  <header>
    <div class="headerRow">
      <img class="logo" src="logo.png" alt="شعار صندوق المسابقات">
      <h1>سباق الحروف</h1>
      <div id="gameName" class="gameName"></div>
    </div>
  </header>

  <div class="wrap">
    <div id="toast" class="toast"></div>
    <div id="main" class="card">جاري التحميل...</div>

    <div class="bottomBar">
      <button class="homeBtn" onclick="location.href='index.html'">الرئيسية</button>
      <div class="rightsTxt">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>
    </div>
  </div>

  <!-- ✅ نافذة شرح الأزرار -->
  <div id="helpPopover" class="helpPopover"></div>

  <!-- ✅ اختيار النقاط -->
  <div id="scoreBackdrop" class="scoreBackdrop">
    <div class="scoreModal" role="dialog" aria-modal="true" aria-label="اختيار النقاط">
      <div id="scoreTitle" class="scoreTitle">اختر النقاط</div>
      <div id="scoreGrid" class="scoreGrid"></div>
      <div class="smallNote" style="color:#111;opacity:.75;margin-top:10px">انقر خارج النافذة للإغلاق</div>
    </div>
  </div>

  <!-- ✅ احتفال الفوز -->
  <div id="winBackdrop" class="winBackdrop">
    <div class="winCard" role="dialog" aria-modal="true" aria-label="احتفال الفوز">
      <div id="winConfetti" class="winConfetti"></div>
      <div id="winTitle" class="winTitle">مبروك الفوز</div>
      <p id="winSub" class="winSub"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, child, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    /* =========================
       Firebase
    ========================= */
    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* =========================
       بيانات الخرائط (كما عندك)
    ========================= */
    const MAPS = [
      [
        ["ش","أ","ث","د","هـ"],
        ["ي","ح","ض","ن","ك"],
        ["غ","ظ","ق","ر","ع"],
        ["ص","ز","س","ط","و"],
        ["ذ","ل","ب","م","ج"]
      ],
      [
        ["ق","ص","و","د","ب"],
        ["ح","ي","ض","هـ","ث"],
        ["ك","ط","ش","ز","م"],
        ["أ","ر","س","ظ","ث"],
        ["ذ","غ","هـ","ع","ج"]
      ],
      [
        ["ذ","ج","أ","ب","ر"],
        ["ي","ح","ز","ل","س"],
        ["ث","ظ","ق","ض","ع"],
        ["ص","ن","د","ط","غ"],
        ["ك","خ","هـ","م","و"]
      ]
    ];

    /* =========================
       الأسئلة
       (ملاحظة: باقي الحروف placeholders — كما عندك)
    ========================= */
    const QUESTIONS = {};
    const ALL_LETTERS = Array.from(new Set(MAPS.flat(2)));
    for(const L of ALL_LETTERS){
      QUESTIONS[L] = Array.from({length:25}, (_,i) => ({ q:`(${i+1}) سؤال لحرف ${L}`, a:`${L}...` }));
    }

    QUESTIONS["هـ"] = [
      { q: "هي البنيه او الاطار الذي يستخدم لدعم شيئ ما ويمكن ان يكون معنوياً مثل المباني او معنوياً مثل (……..)", a: "هيكل" },
      { q: "هو مايهدى من الانعام الى الحرم تقرباً الى الله", a: "هدي" },
      { q: "هو نوع من الشعر نقيض المديح ويُكتب عندما الشاعر يعبر عن سخطة واشمئزازه", a: "هجاء" },
      { q: "هو نبات عطري يُستخدم في الطبخ والقهوة ويُعرف بـ \"ملك التوابل\"؟", a: "هيل" },
      { q: "هي مدينة يابانية تعرضت لأول قنبلة ذرية", a: "هيروشيما" },
      { q: "من هو النبي الذي ارسله الله الى قوم عاد؟", a: "هود عليه السلام" },
      { q: "من أول من سعى بين الصفا و المروة ؟", a: "هاجر ام اسماعيل عليه السلام" },
      { q: "هي صفة بين المشي والركض", a: "هروله" },
      { q: "هو الكلام الفارغ الذي لا معنى له", a: "هراء" },
      { q: "هي كلمة في اللغة العربية تعني اعطاء الشخص ماله لشخص اخر بلا عوض", a: "هبه" },
      { q: "ماذا يطلق على صوت الموج", a: "هدير" },
      { q: "هو موقع شهير على شبكة اﻹنترنت خاص بإنشاء بريد إلكتروني مجاني", a: "هوتميل" },
      { q: "هو مسلسل كرتوني قديم معروف عند الطيبين يبدأ اسمه بحرف هـ", a: "هزيم الرعد" },
      { q: "هي هضبة تقع في وسط المملكة العربية السعودية", a: "هضبة نجد" },
      { q: "هي الحالة التي يشعر بها الانسان عندما يصبح خائفاً", a: "هلع" },
      { q: "شخصية من شخصيات الممثل عبدالله السدحان في مسلسل طاش ماطاش", a: "هدبدب" },
      { q: "هو لقب يطلق على قمة سلسلة جبال معروفة عالمياً", a: "هملايا" },
      { q: "هو غاز خفيف جداً وغير قابل للاشتعال ويستخدم في المناطيد", a: "هيليوم" },
      { q: "مدينة ألمانية تعتبر من أهم الموانئ الأوروبية", a: "هامبورغ" },
      { q: "هي نوبات من الانفعالات الشديدة او الضحك والبكاء غير المنضبط", a: "هستيريا" },
      { q: "هو اسم يطلق على الاشخاص اللذين يتركون وطنهم للعيش في بلد آخر", a: "هجرة" },
      { q: "هي نشاط منتظم يمارسه الشخص في وقت فراغة گ/ الرسم او الطبخ الخ…", a: "هوايه" },
      { q: "هو المطر الخفيف المتواصل الذي يهطل على دفعات", a: "هتان" },
      { q: "هي ولاية امريكية تتكون من عدة جز وتقع في المحيط الهادئ", a: "هاواي" },
      { q: "هو ممر مائي ضيق يربط الخليج العربي بخليج عُمان يسمى مضيق ……..؟", a: "هرمز" }
    ];

    /* =========================
       Helpers
    ========================= */
    const $ = (id)=>document.getElementById(id);
    const main = $("main");
    const toastEl = $("toast");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.style.display="none", 2400);
    }

    function qs(){
      const p = new URLSearchParams(location.search);
      return {
        code: (p.get("code")||"").trim(),
        role: (p.get("role")||"").trim(), // "host" | "player"
        name: (p.get("name")||"").trim()
      };
    }

    function genCode(){
      return String(Math.floor(100000 + Math.random()*900000));
    }

    function safeText(s){ return (s||"").toString(); }

    /* =========================
       UI: Help Popover
    ========================= */
    const helpPopover = $("helpPopover");
    let helpOpen = false;

    function showHelp(anchorEl, text){
      helpPopover.textContent = text;
      helpPopover.style.display = "block";
      helpOpen = true;

      const r = anchorEl.getBoundingClientRect();
      const x = Math.min(window.innerWidth - 16, Math.max(16, r.left + r.width/2));
      const y = Math.min(window.innerHeight - 16, Math.max(16, r.top + r.height + 10));
      helpPopover.style.left = x + "px";
      helpPopover.style.top = y + "px";
      helpPopover.style.transform = "translateX(-50%)";
    }

    function hideHelp(){
      helpPopover.style.display = "none";
      helpOpen = false;
    }

    document.addEventListener("click", (e)=>{
      if(!helpOpen) return;
      const t = e.target;
      if(t.classList && t.classList.contains("helpDot")) return;
      if(t === helpPopover || helpPopover.contains(t)) return;
      hideHelp();
    }, true);

    /* =========================
       UI: Score Modal
    ========================= */
    const scoreBackdrop = $("scoreBackdrop");
    const scoreGrid = $("scoreGrid");
    const scoreTitle = $("scoreTitle");
    let scorePickCb = null;

    function openScorePicker(title, cb){
      scoreTitle.textContent = title;
      scoreGrid.innerHTML = "";
      scorePickCb = cb;

      // أرقام 0 - 30
      const nums = Array.from({length:31}, (_,i)=>i);
      for(const n of nums){
        const b = document.createElement("button");
        b.className = "scorePick";
        b.textContent = n;
        b.onclick = ()=>{
          closeScorePicker();
          cb(n);
        };
        scoreGrid.appendChild(b);
      }
      scoreBackdrop.style.display = "flex";
    }
    function closeScorePicker(){
      scoreBackdrop.style.display = "none";
      scorePickCb = null;
    }
    scoreBackdrop.addEventListener("click", (e)=>{
      if(e.target === scoreBackdrop) closeScorePicker();
    });

    /* =========================
       UI: Winner Celebration
    ========================= */
    const winBackdrop = $("winBackdrop");
    const winTitle = $("winTitle");
    const winSub = $("winSub");
    const winConfetti = $("winConfetti");

    function buildConfetti(){
      winConfetti.innerHTML = "";
      const colors = ["#f28c00","#1aa34a","#b43d69","#7fe7ff","#ffffff","#111111"];
      for(let i=0;i<36;i++){
        const d = document.createElement("div");
        d.className = "confettiPiece";
        d.style.left = (Math.random()*100) + "%";
        d.style.top = (-10 - Math.random()*40) + "px";
        d.style.animationDelay = (Math.random()*0.8) + "s";
        d.style.animationDuration = (1.2 + Math.random()*0.9) + "s";
        d.style.background = colors[Math.floor(Math.random()*colors.length)];
        winConfetti.appendChild(d);
      }
    }

    function showWin(team){
      buildConfetti();
      winTitle.textContent = "مبروك الفوز";
      if(team === "green"){
        winSub.textContent = "الفوز للفريق الأخضر";
      }else if(team === "orange"){
        winSub.textContent = "الفوز للفريق البرتقالي";
      }else{
        winSub.textContent = "";
      }
      winBackdrop.style.display = "flex";
      clearTimeout(winBackdrop._t);
      winBackdrop._t = setTimeout(()=> winBackdrop.style.display="none", 2600);
    }
    winBackdrop.addEventListener("click", ()=>{ winBackdrop.style.display="none"; });

    /* =========================
       Hex grid geometry (25 خلايا)
       (شبكة 5x5 — للتوافق مع خرائطك الحالية)
    ========================= */
    const ROWS = 5;
    const COLS = 5;
    const CELL_COUNT = ROWS * COLS;

    // جيران سداسي (نمط offset)
    function neighbors(r,c){
      // even-r horizontal layout (flat-top)
      const even = (r % 2 === 0);
      const dirs = even
        ? [[0,-1],[0,1],[-1,0],[-1,1],[1,0],[1,1]]
        : [[0,-1],[0,1],[-1,-1],[-1,0],[1,-1],[1,0]];
      const out = [];
      for(const [dr,dc] of dirs){
        const nr=r+dr, nc=c+dc;
        if(nr>=0 && nr<ROWS && nc>=0 && nc<COLS) out.push([nr,nc]);
      }
      return out;
    }

    function idx(r,c){ return r*COLS + c; }

    /* =========================
       Winner detection
       الأخضر: وصل يسار -> يمين
       البرتقالي: وصل أعلى -> أسفل
    ========================= */
    function hasGreenWin(states){
      const q = [];
      const seen = new Set();
      // start: left edge cells that are green(state2)
      for(let r=0;r<ROWS;r++){
        if(states[idx(r,0)] === 2){
          q.push([r,0]);
          seen.add(r+","+0);
        }
      }
      while(q.length){
        const [r,c] = q.shift();
        if(c === COLS-1) return true; // reached right edge
        for(const [nr,nc] of neighbors(r,c)){
          const key = nr+","+nc;
          if(seen.has(key)) continue;
          if(states[idx(nr,nc)] !== 2) continue;
          seen.add(key);
          q.push([nr,nc]);
        }
      }
      return false;
    }

    function hasOrangeWin(states){
      const q = [];
      const seen = new Set();
      // start: top edge cells that are orange(state3)
      for(let c=0;c<COLS;c++){
        if(states[idx(0,c)] === 3){
          q.push([0,c]);
          seen.add("0,"+c);
        }
      }
      while(q.length){
        const [r,c] = q.shift();
        if(r === ROWS-1) return true; // reached bottom edge
        for(const [nr,nc] of neighbors(r,c)){
          const key = nr+","+nc;
          if(seen.has(key)) continue;
          if(states[idx(nr,nc)] !== 3) continue;
          seen.add(key);
          q.push([nr,nc]);
        }
      }
      return false;
    }

    /* =========================
       Question helpers
    ========================= */
    function pickRandomLetter(mapIndex){
      const letters = MAPS[mapIndex].flat();
      return letters[Math.floor(Math.random()*letters.length)];
    }

    function pickQuestion(letter, mode, privateBank){
      const list = (mode === "private" && privateBank && privateBank[letter] && privateBank[letter].length)
        ? privateBank[letter]
        : (QUESTIONS[letter] || []);
      if(!list.length) return { q:`سؤال لحرف ${letter}`, a:`${letter}...` };
      return list[Math.floor(Math.random()*list.length)];
    }

    function loadPrivateQuestions(code){
      try{
        const raw = localStorage.getItem("PRIVATE_Q_"+code);
        if(!raw) return {};
        const obj = JSON.parse(raw);
        return (obj && typeof obj === "object") ? obj : {};
      }catch(e){ return {}; }
    }
    function savePrivateQuestions(code, obj){
      localStorage.setItem("PRIVATE_Q_"+code, JSON.stringify(obj||{}));
    }

    /* =========================
       Timer helpers (Host controls)
    ========================= */
    const TIMER_DEFAULT = 25;

    function nowMs(){ return Date.now(); }

    function computeTimerRemaining(timer){
      // timer: {running, total, endAtMs, remaining}
      if(!timer) return TIMER_DEFAULT;
      if(!timer.running) return (typeof timer.remaining === "number" ? timer.remaining : TIMER_DEFAULT);
      const left = Math.max(0, Math.ceil((timer.endAtMs - nowMs())/1000));
      return left;
    }

    /* =========================
       Render: Landing
    ========================= */
    function renderLanding(){
      main.innerHTML = `
        <div class="panel">
          <div style="font-size:26px;font-weight:900">إنشاء / دخول</div>

          <div class="row">
            <button id="createBtn" class="btn">إنشاء لعبة</button>
          </div>

          <div class="row" style="margin-top:6px">
            <input id="joinCode" class="in" inputmode="numeric" placeholder="اكتب كود اللعبة (6 أرقام)" maxlength="6" />
            <input id="joinName" class="in" placeholder="اكتب اسمك" maxlength="18" />
          </div>

          <div class="row">
            <button id="joinBtn" class="btn">دخول لاعب</button>
          </div>

          <div class="smallNote">المقدم ينشئ اللعبة ثم يشارك الكود مع اللاعبين</div>
        </div>
      `;

      $("createBtn").onclick = async ()=>{
        const code = genCode();
        const roomRef = ref(db, "rooms/"+code);
        const init = {
          createdAt: nowMs(),
          state: {
            mapIndex: 0,
            zoom: 1,
            cells: Array(CELL_COUNT).fill(0),
            qMode: "general",
            q: { text:"", answer:"", letter:"", shown:false },
            scores: { green:0, orange:0 },
            firstPress: { name:"", team:"", frozen:false },
            timer: { running:false, total:TIMER_DEFAULT, remaining:TIMER_DEFAULT, endAtMs:0 },
            winner: "" // "green" | "orange" | ""
          },
          players: {}
        };
        await update(roomRef, init);
        location.href = location.pathname + "?code="+code+"&role=host";
      };

      $("joinBtn").onclick = ()=>{
        const code = $("joinCode").value.trim();
        const name = $("joinName").value.trim();
        if(code.length !== 6) return toast("اكتب كود صحيح (6 أرقام)");
        if(!name) return toast("اكتب اسمك");
        location.href = location.pathname + "?code="+encodeURIComponent(code)+"&role=player&name="+encodeURIComponent(name);
      };
    }

    /* =========================
       Render: Host / Player
    ========================= */
    function renderGameShell(role){
      const isHost = (role === "host");

      main.innerHTML = `
        <div class="gameLayout">
          <div class="sideMap">
            <div class="mapOuter">
              <div class="mapScale" id="mapScale" style="--zoom:1">
                <div class="mapBox">
                  <img id="mapImg" src="map1.jpeg" alt="الخريطة">
                  <svg id="overlaySvg" class="overlaySvg" viewBox="0 0 1000 600" preserveAspectRatio="none"></svg>
                </div>
              </div>
            </div>

            <div class="mapToolsRow">
              <div class="zoomWrap">
                <input id="zoomRange" type="range" min="0.8" max="1.6" step="0.05" value="1">
              </div>

              <button id="btnMap" class="toolBtn" title="تغيير الخريطة">
                <span class="helpDot" data-help="تغيير الخريطة">?</span>
                <span class="txtIcon">↻</span>
              </button>

              <button id="btnClear" class="toolBtn" title="تفريغ الخريطة">
                <span class="helpDot" data-help="تفريغ الخريطة">?</span>
                <span class="txtIcon">×</span>
              </button>

              <button id="btnQMode" class="toolBtn" title="تغيير نوع الأسئلة">
                <span class="helpDot" data-help="تغيير نوع الأسئلة">?</span>
                <span class="txtIcon">▣</span>
              </button>

              <button id="btnSettings" class="toolBtn" title="الإعدادات">
                <span class="txtIcon">⚙</span>
              </button>
            </div>
          </div>

          <div class="sideMain">
            <div class="scoreBar">
              <div class="teamPill orange">الفريق البرتقالي</div>
              <button id="scoreOrange" class="scoreBox ${isHost ? "" : "readonly"}" ${isHost ? "" : "disabled"}>0</button>
              <button id="scoreGreen" class="scoreBox ${isHost ? "" : "readonly"}" ${isHost ? "" : "disabled"}>0</button>
              <div class="teamPill green">الفريق الأخضر</div>
            </div>

            <div id="firstPress" class="firstPressBar">اسم اللاعب الذي يضغط أولاً</div>

            <div class="controlRow">
              <!-- ✅ تم تبديل مكان زر تجميد الأزرار مع زر تغيير السؤال -->
              <button id="btnFreeze" class="pillBtn">تجميد الأزرار</button>

              <div class="timerWrap">
                <button id="timerBtn" class="timerClockBtn" ${isHost ? "" : "disabled"} aria-label="المؤقت">
                  <svg id="timerRing" class="timerRing" viewBox="0 0 100 100">
                    <circle id="ringCircle" cx="50" cy="50" r="44"></circle>
                  </svg>
                  <div id="timerNum" class="timerNumber">25</div>
                </button>
              </div>

              <button id="btnNextQ" class="pillBtn">تغيير السؤال</button>
            </div>

            <div class="questionCard">
              <div id="qText" class="qText">—</div>
              <button id="answerBtn" class="answerBtn answerHidden">${isHost ? "اضغط للإجابة" : "اضغط للإجابة"}</button>
            </div>

            ${isHost ? `
              <div class="panel" style="margin-top:10px">
                <div style="font-size:20px;font-weight:900">اللاعبون</div>
                <div id="playersList" style="text-align:right"></div>
                <div class="smallNote">اضغط على اسم اللاعب لتبديل الفريق (أخضر / برتقالي)</div>
              </div>
            ` : `
              <div class="playerBtnWrap">
                <button id="playerBuzz" class="playerBigBtn">اضغط هنا</button>
              </div>
            `}
          </div>
        </div>
      `;
    }

    /* =========================
       SVG overlay hexes (توليد 25 خلية)
    ========================= */
    function buildHexOverlay(svgEl){
      svgEl.innerHTML = "";
      // ضبط أبعاد السداسي في الـ viewBox
      const W = 1000, H = 600;
      const hexW = 150;
      const hexH = 130;
      const startX = 220;
      const startY = 95;

      // حساب نقاط سداسي flat-top
      function hexPoints(cx, cy){
        const a = hexW/2;
        const b = hexH/2;
        const pts = [
          [cx-a*0.5, cy-b],
          [cx+a*0.5, cy-b],
          [cx+a,     cy],
          [cx+a*0.5, cy+b],
          [cx-a*0.5, cy+b],
          [cx-a,     cy]
        ];
        return pts.map(p=>p.join(",")).join(" ");
      }

      for(let r=0;r<ROWS;r++){
        for(let c=0;c<COLS;c++){
          const shift = (r%2===0) ? 0 : (hexW*0.5);
          const cx = startX + c*hexW*0.9 + shift;
          const cy = startY + r*hexH*0.82;

          const poly = document.createElementNS("http://www.w3.org/2000/svg","polygon");
          poly.setAttribute("points", hexPoints(cx,cy));
          poly.setAttribute("data-r", r);
          poly.setAttribute("data-c", c);
          poly.setAttribute("class", "cell state0");
          svgEl.appendChild(poly);
        }
      }
    }

    function setHexStates(svgEl, states, pulseIdx){
      const polys = svgEl.querySelectorAll("polygon.cell");
      polys.forEach((p)=>{
        const r = +p.getAttribute("data-r");
        const c = +p.getAttribute("data-c");
        const s = states[idx(r,c)] || 0;
        p.classList.remove("state0","state1","state2","state3","pulse");
        p.classList.add("state"+s);
        if(s === 1 && pulseIdx === idx(r,c)) p.classList.add("pulse");
      });
    }

    /* =========================
       Main: connect to room
    ========================= */
    async function runRoom(code, role, name){
      renderGameShell(role);
      const isHost = (role === "host");

      const roomRef = ref(db, "rooms/"+code);
      const stateRef = ref(db, "rooms/"+code+"/state");
      const playersRef = ref(db, "rooms/"+code+"/players");

      // تحقق وجود الغرفة
      const snap = await get(roomRef);
      if(!snap.exists()){
        toast("الكود غير موجود");
        renderLanding();
        return;
      }

      // تسجيل اللاعب
      let myId = "";
      if(!isHost){
        myId = "p_" + Math.random().toString(16).slice(2,10);
        // اختيار فريق تلقائي (يتبدل عند دخول لاعبين جدد)
        await runTransaction(playersRef, (players)=>{
          players = players || {};
          const count = Object.keys(players).length;
          const team = (count % 2 === 0) ? "green" : "orange";
          players[myId] = { name: safeText(name||"لاعب"), team, joinedAt: nowMs() };
          return players;
        });
      }

      // private questions bank (على جهاز المقدم فقط)
      const privateBank = loadPrivateQuestions(code);

      // عناصر UI
      const mapImg = $("mapImg");
      const overlaySvg = $("overlaySvg");
      const mapScale = $("mapScale");
      const zoomRange = $("zoomRange");

      const btnMap = $("btnMap");
      const btnClear = $("btnClear");
      const btnQMode = $("btnQMode");
      const btnSettings = $("btnSettings");

      const scoreOrangeBtn = $("scoreOrange");
      const scoreGreenBtn = $("scoreGreen");

      const firstPressEl = $("firstPress");

      const btnFreeze = $("btnFreeze");
      const btnNextQ = $("btnNextQ");

      const timerBtn = $("timerBtn");
      const timerRing = $("timerRing");
      const ringCircle = $("ringCircle");
      const timerNum = $("timerNum");

      const qTextEl = $("qText");
      const answerBtn = $("answerBtn");

      const playersList = $("playersList");
      const playerBuzz = $("playerBuzz");

      buildHexOverlay(overlaySvg);

      // Tooltips (?) — فقط للأزرار الثلاثة المطلوبة
      main.querySelectorAll(".helpDot").forEach(dot=>{
        dot.addEventListener("click",(e)=>{
          e.stopPropagation();
          const t = dot.getAttribute("data-help") || "";
          let msg = "";
          if(t === "تغيير الخريطة") msg = "يبدّل بين الخرائط الثلاثة ويعيد تفريغ الخلايا للجولة الجديدة.";
          if(t === "تفريغ الخريطة") msg = "يعيد الخلايا للون الأبيض (تفريغ الجولة الحالية).";
          if(t === "تغيير نوع الأسئلة") msg = "يبدّل بين الأسئلة العامة وأسئلة المقدم الخاصة.";
          showHelp(dot, msg);
        });
      });

      // إعدادات (بسيطة: تعديل اسم اللعبة + تعديل أسئلة خاصة على جهاز المقدم)
      btnSettings.onclick = ()=>{
        if(!isHost){
          toast("الإعدادات للمقدم فقط");
          return;
        }
        const g = prompt("اكتب اسم اللعبة (اختياري):", "");
        if(g !== null){
          const el = $("gameName");
          el.innerHTML = g.trim() ? `<div class="gnText">${safeText(g.trim())}</div>` : "";
        }
        const want = confirm("هل تريد تعديل الأسئلة الخاصة على هذا الجهاز؟");
        if(!want) return;

        const letter = prompt("اكتب الحرف الذي تريد إضافة سؤال له (مثال: هـ):", "هـ");
        if(!letter) return;
        const q = prompt("اكتب نص السؤال:", "");
        if(!q) return;
        const a = prompt("اكتب الجواب:", "");
        if(!a) return;
        const L = letter.trim();
        privateBank[L] = privateBank[L] || [];
        privateBank[L].push({ q:q.trim(), a:a.trim() });
        savePrivateQuestions(code, privateBank);
        toast("تم حفظ السؤال الخاص على جهاز المقدم");
      };

      // Zoom
      zoomRange.oninput = ()=>{
        const z = +zoomRange.value;
        mapScale.style.setProperty("--zoom", z);
        if(isHost) update(stateRef, { zoom: z });
      };

      // Change map
      btnMap.onclick = async ()=>{
        if(!isHost){ toast("للمقدم فقط"); return; }
        const s = (await get(stateRef)).val();
        const next = ((s?.mapIndex ?? 0) + 1) % 3;
        await update(stateRef, {
          mapIndex: next,
          cells: Array(CELL_COUNT).fill(0),
          winner: "", // ✅ بدء جولة جديدة تلقائياً
          firstPress: { name:"", team:"", frozen: (s?.firstPress?.frozen ?? false) }
        });
      };

      // Clear map
      btnClear.onclick = async ()=>{
        if(!isHost){ toast("للمقدم فقط"); return; }
        const s = (await get(stateRef)).val();
        await update(stateRef, {
          cells: Array(CELL_COUNT).fill(0),
          winner: "", // ✅ بدء جولة جديدة تلقائياً
          firstPress: { name:"", team:"", frozen: (s?.firstPress?.frozen ?? false) }
        });
      };

      // Toggle Q Mode
      btnQMode.onclick = async ()=>{
        if(!isHost){ toast("للمقدم فقط"); return; }
        const s = (await get(stateRef)).val();
        const cur = s?.qMode || "general";
        const next = (cur === "general") ? "private" : "general";
        await update(stateRef, { qMode: next });
      };

      // Score pickers (Host only)
      if(isHost){
        scoreOrangeBtn.onclick = ()=> openScorePicker("نقاط الفريق البرتقالي", async (n)=>{
          await update(stateRef, { "scores/orange": n });
        });
        scoreGreenBtn.onclick = ()=> openScorePicker("نقاط الفريق الأخضر", async (n)=>{
          await update(stateRef, { "scores/green": n });
        });
      }

      // Freeze buzzer
      btnFreeze.onclick = async ()=>{
        if(!isHost){ toast("للمقدم فقط"); return; }
        const s = (await get(stateRef)).val();
        const frozen = !!(s?.firstPress?.frozen);
        await update(stateRef, { "firstPress/frozen": !frozen });
      };

      // Next Question
      btnNextQ.onclick = async ()=>{
        if(!isHost){ toast("للمقدم فقط"); return; }
        const s = (await get(stateRef)).val();
        const mapIndex = s?.mapIndex ?? 0;
        const mode = s?.qMode ?? "general";

        const letter = pickRandomLetter(mapIndex);
        const qa = pickQuestion(letter, mode, privateBank);

        await update(stateRef, {
          q: { text: qa.q, answer: qa.a, letter, shown: false }
        });
      };

      // Answer button (Host reveals only)
      answerBtn.onclick = async ()=>{
        if(!isHost) return; // اللاعب ما يكشف الجواب
        const s = (await get(stateRef)).val();
        const q = s?.q || {};
        if(!q.text) return;
        const shown = !!q.shown;
        await update(stateRef, { "q/shown": !shown });
      };

      // Player buzz
      if(playerBuzz){
        playerBuzz.onclick = async ()=>{
          const s = (await get(stateRef)).val();
          if(s?.firstPress?.frozen) return;
          if(s?.firstPress?.name) return; // أول لاعب فقط
          // اجلب اسمي/فريقي
          const ps = (await get(child(playersRef, myId))).val();
          const myName = ps?.name || name || "لاعب";
          const myTeam = ps?.team || "green";
          await update(stateRef, { firstPress: { name: myName, team: myTeam, frozen: (s?.firstPress?.frozen ?? false) } });
        };
      }

      // Clicking cells (Host only)
      overlaySvg.addEventListener("click", async (e)=>{
        if(!isHost) return;
        const poly = e.target;
        if(!(poly instanceof SVGPolygonElement)) return;
        const r = +poly.getAttribute("data-r");
        const c = +poly.getAttribute("data-c");
        const i = idx(r,c);

        const s = (await get(stateRef)).val();
        const cells = (s?.cells || Array(CELL_COUNT).fill(0)).slice();

        // دورة الألوان: أبيض(0) -> أصفر(1) -> أخضر(2) -> برتقالي(3) -> أبيض(0)
        const cur = cells[i] || 0;
        const next = (cur + 1) % 4;
        cells[i] = next;

        await update(stateRef, { cells });
      });

      // Players list (Host team assign)
      if(playersList && isHost){
        onValue(playersRef, (snap)=>{
          const players = snap.val() || {};
          const ids = Object.keys(players).sort((a,b)=>(players[a].joinedAt||0)-(players[b].joinedAt||0));
          playersList.innerHTML = "";
          if(!ids.length){
            playersList.innerHTML = `<div class="smallNote" style="opacity:.9;text-align:center">لا يوجد لاعبين</div>`;
            return;
          }
          for(const pid of ids){
            const p = players[pid];
            const div = document.createElement("div");
            div.style.margin = "6px 0";
            div.style.padding = "10px 12px";
            div.style.borderRadius = "16px";
            div.style.border = "4px solid rgba(0,0,0,.85)";
            div.style.background = (p.team === "green") ? "rgba(26,163,74,.75)" : "rgba(242,140,0,.75)";
            div.style.color = "#fff";
            div.style.fontWeight = "900";
            div.style.cursor = "pointer";
            div.textContent = p.name + " — " + (p.team==="green" ? "أخضر" : "برتقالي");
            div.onclick = async ()=>{
              const nextTeam = (p.team === "green") ? "orange" : "green";
              await update(child(playersRef, pid), { team: nextTeam });
            };
            playersList.appendChild(div);
          }
        });
      }

      /* =========================
         State listener (renders everything live)
      ========================= */
      let lastPulse = -1;
      let timerTick = null;

      function startTimerUiLoop(){
        if(timerTick) return;
        timerTick = setInterval(()=>{ /* trigger UI refresh via latestState */ }, 250);
      }

      let latestState = null;
      onValue(stateRef, (snap)=>{
        const s = snap.val();
        if(!s) return;
        latestState = s;

        // Map image
        const mi = s.mapIndex ?? 0;
        mapImg.src = ["map1.jpeg","map2.jpeg","map3.jpeg"][mi] || "map1.jpeg";

        // Zoom
        const z = s.zoom ?? 1;
        mapScale.style.setProperty("--zoom", z);
        if(Math.abs(+zoomRange.value - z) > 0.001) zoomRange.value = z;

        // Cells
        const cells = (s.cells && s.cells.length === CELL_COUNT) ? s.cells : Array(CELL_COUNT).fill(0);

        // نبض خفيف على آخر خلية صفراء (اختياري)
        lastPulse = cells.lastIndexOf(1);

        setHexStates(overlaySvg, cells, lastPulse);

        // Q mode button color
        const mode = s.qMode || "general";
        if(mode === "private") btnQMode.classList.add("cyan");
        else btnQMode.classList.remove("cyan");

        // Scores
        const sc = s.scores || {green:0, orange:0};
        scoreGreenBtn.textContent = sc.green ?? 0;
        scoreOrangeBtn.textContent = sc.orange ?? 0;

        // First press bar
        const fp = s.firstPress || {name:"", team:"", frozen:false};
        if(fp.name){
          firstPressEl.textContent = fp.name;
          firstPressEl.classList.add("filled");
          if(fp.team === "green") firstPressEl.style.background = "rgba(26,163,74,.85)";
          else if(fp.team === "orange") firstPressEl.style.background = "rgba(242,140,0,.85)";
          else firstPressEl.style.background = "rgba(255,255,255,.12)";
        }else{
          firstPressEl.textContent = "اسم اللاعب الذي يضغط أولاً";
          firstPressEl.classList.remove("filled");
          firstPressEl.style.background = "rgba(255,255,255,.10)";
        }

        // Freeze button label
        const frozen = !!fp.frozen;
        btnFreeze.textContent = frozen ? "إلغاء التجميد" : "تجميد الأزرار";

        // Player button state
        if(playerBuzz){
          if(frozen) playerBuzz.classList.add("disabled");
          else playerBuzz.classList.remove("disabled");
        }

        // Question
        const q = s.q || {text:"", answer:"", shown:false};
        qTextEl.textContent = q.text || "—";

        // ✅ زر الجواب التفاعلي
        if(!q.text){
          answerBtn.textContent = isHost ? "اضغط للإجابة" : "اضغط للإجابة";
          answerBtn.classList.remove("answerShown");
          answerBtn.classList.add("answerHidden");
          if(!isHost) answerBtn.classList.add("disabled");
          else answerBtn.classList.remove("disabled");
        }else{
          if(q.shown){
            answerBtn.textContent = q.answer || "—";
            answerBtn.classList.remove("answerHidden");
            answerBtn.classList.add("answerShown");
          }else{
            answerBtn.textContent = "اضغط للإجابة";
            answerBtn.classList.remove("answerShown");
            answerBtn.classList.add("answerHidden");
          }
          if(!isHost) answerBtn.classList.add("disabled");
          else answerBtn.classList.remove("disabled");
        }

        // Winner celebration (show on change to winner)
        if(s.winner && s.winner !== ""){
          // نعرض الاحتفال عند أول وصول فقط (ثم يتوقف حتى تفريغ/تغيير الخريطة)
          if(!winBackdrop._lastWinner || winBackdrop._lastWinner !== s.winner){
            winBackdrop._lastWinner = s.winner;
            showWin(s.winner);
          }
        }else{
          winBackdrop._lastWinner = "";
        }

        // Timer UI render
        startTimerUiLoop();
        renderTimer(s.timer || {});
      });

      function renderTimer(timer){
        const total = (typeof timer.total === "number" ? timer.total : TIMER_DEFAULT);
        const left = computeTimerRemaining(timer);

        // رقم
        const prev = +timerNum.textContent || left;
        timerNum.textContent = left;

        // pop آخر 5 ثواني
        timerNum.classList.remove("pop","red");
        timerBtn.classList.remove("flash");

        if(left <= 5 && left > 0){
          timerNum.classList.add("red","pop");
        }
        if(left === 0 && timer.running){
          timerBtn.classList.add("flash");
          timerNum.classList.add("red");
        }

        // ring
        const r = 44;
        const C = 2 * Math.PI * r;
        ringCircle.style.strokeDasharray = String(C);
        timerRing.style.opacity = timer.running ? "1" : "0";
        const frac = total > 0 ? (left/total) : 0;
        const off = C * (1 - Math.max(0, Math.min(1, frac)));
        ringCircle.style.strokeDashoffset = String(off);

        // Host: click to start/stop (simple)
        if(isHost){
          timerBtn.onclick = async ()=>{
            const s = (await get(stateRef)).val();
            const t = s?.timer || {};
            const running = !!t.running;

            if(!running){
              const dur = (typeof t.remaining === "number") ? t.remaining : total;
              const endAtMs = nowMs() + dur*1000;
              await update(stateRef, { timer: { running:true, total: dur, remaining: dur, endAtMs } });
            }else{
              const leftNow = computeTimerRemaining(t);
              await update(stateRef, { timer: { running:false, total: t.total ?? total, remaining: leftNow, endAtMs: 0 } });
            }
          };
        }else{
          timerBtn.onclick = null;
        }

        // إذا المؤقت انتهى، نخليه يظل "منتهي" حتى المقدم يوقفه
        if(isHost && timer.running && left === 0){
          // نوقف تلقائيًا بعد 0 بثانية بسيطة عشان ما يطول الوميض
          clearTimeout(timerBtn._stopT);
          timerBtn._stopT = setTimeout(async ()=>{
            const s = (await get(stateRef)).val();
            const t = s?.timer || {};
            if(!t.running) return;
            const leftNow = computeTimerRemaining(t);
            if(leftNow !== 0) return;
            await update(stateRef, { timer: { running:false, total: t.total ?? total, remaining: 0, endAtMs: 0 } });
          }, 900);
        }
      }

      /* =========================
         Winner detection trigger (Host runs it after each cell update)
      ========================= */
      if(isHost){
        onValue(stateRef, async (snap)=>{
          const s = snap.val();
          if(!s) return;
          const cells = (s.cells && s.cells.length === CELL_COUNT) ? s.cells : Array(CELL_COUNT).fill(0);

          // إذا فيه فائز بالفعل، لا نكرر (إلى أن يتم تفريغ/تغيير الخريطة)
          if(s.winner && s.winner !== "") return;

          const gWin = hasGreenWin(cells);
          const oWin = hasOrangeWin(cells);

          if(gWin){
            await update(stateRef, { winner: "green" });
          }else if(oWin){
            await update(stateRef, { winner: "orange" });
          }
        });
      }
    }

    /* =========================
       Boot
    ========================= */
    const p = qs();

    // اسم اللعبة (من الـ localStorage اختياري)
    try{
      const savedName = localStorage.getItem("GAME_NAME") || "";
      if(savedName.trim()){
        $("gameName").innerHTML = `<div class="gnText">${safeText(savedName.trim())}</div>`;
      }
    }catch(e){}

    if(!p.code){
      renderLanding();
    }else{
      if(p.role !== "host" && p.role !== "player"){
        // إذا ما جاء role نفترض لاعب
        location.replace(location.pathname + "?code="+encodeURIComponent(p.code)+"&role=player&name="+encodeURIComponent(p.name||"لاعب"));
      }else{
        runRoom(p.code, p.role, p.name);
      }
    }
  </script>
</body>
</html>
