<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø­Ø±ÙˆÙ - Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</title>

  <!-- ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† -->
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- âœ… (ØªØ³Ø±ÙŠØ¹) ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¨Ø¯Ø±ÙŠ -->
  <link rel="preload" href="./game_full.html" as="document">

  <!-- âœ… (Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹): Ù„Ø§ ØªØ¸Ù‡Ø± Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø·ÙˆÙ„ -->
  <script>
  (function(){
    try{
      var d = document.documentElement;
      d.classList.add("js");              // Ù…Ø¹ JS Ù†Ø®ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
      window.__SANDOOQ_REVEAL_T = setTimeout(function(){
        try{ d.classList.add("reveal"); }catch(e){}
      }, 900); // ğŸ‘ˆ Ø¥Ø°Ø§ Ù…Ø§ ØªØ­ÙˆÙ„Øª Ø®Ù„Ø§Ù„ 0.9 Ø«Ø§Ù†ÙŠØ©ØŒ Ù†Ø¸Ù‡Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    }catch(e){}
  })();
  </script>

  <!-- âœ… (Ù…Ù‡Ù…) ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ø¯Ø±ÙŠ -->
  <script>
  (function(){
    try{
      if(!("serviceWorker" in navigator)) return;
      if(!window.isSecureContext && location.hostname !== "localhost") return;

      var ASSET_VERSION = "2026-02-15-1";
      var vq = "?v=" + encodeURIComponent(ASSET_VERSION);

      navigator.serviceWorker
        .register("./sw.js" + vq, { scope: "./" })
        .then(function(reg){ try{ reg && reg.update && reg.update(); }catch(e){} })
        .catch(function(err){ console.warn("SW register failed.", err); });

    }catch(e){
      console.warn("SW register error.", e);
    }
  })();
  </script>

  <style>
    :root{
      --bgA:#7b3459;
      --bgB:#4b1f36;
      --text:#ffffff;
      --muted: rgba(255,255,255,.78);
      --btnText:#111;
      --btnBg:#ffffff;
      --btnBorder:#1b1b1b;
      --card:#ffffff;
      --cardText:#111;
      --blue:#1f4fa3;
      --yellow:#f4c400;
    }

    *{box-sizing:border-box}

    /* âœ… Ù†Ø®Ù„ÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù‰ html Ø¹Ø´Ø§Ù† Ø­ØªÙ‰ Ù„Ùˆ Ø£Ø®ÙÙŠÙ†Ø§ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø§ ØªØµÙŠØ± Ø¨ÙŠØ¶Ø§Ø¡ */
    html{
      min-height:100%;
      background:
        radial-gradient(1200px 700px at 25% 10%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(135deg, var(--bgA), var(--bgB));
    }

    body{
      margin:0;
      min-height:100vh;
      font-family: Arial, sans-serif;
      color:var(--text);
      background: transparent;
      overflow-x:hidden;
    }

    /* âœ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ÙƒÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©) */
    .ui{ opacity:1; transition: opacity .14s ease; }

    /* âœ… Ø¥Ø°Ø§ JS Ø´ØºØ§Ù„: Ù†Ø®ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ */
    html.js .ui{
      opacity:0;
      pointer-events:none;
      user-select:none;
    }

    /* âœ… Ø¨Ø¹Ø¯ ÙˆÙ‚Øª Ø¨Ø³ÙŠØ· (Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£): Ù†Ø¸Ù‡Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
    html.js.reveal .ui{
      opacity:1;
      pointer-events:auto;
      user-select:auto;
    }

    header{
      position:relative;
      padding:22px 16px 0;
      text-align:center;
    }
    .logo{
      position:absolute;
      left:14px;
      top:16px;
      width:46px;
      height:46px;
      object-fit:contain;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.25));
      pointer-events:none;
    }
    .game-title{
      display:inline-block;
      padding:10px 16px;
      border-radius:14px;
      font-size:44px;
      font-weight:900;
      letter-spacing:.5px;
      color:#fff;
      text-shadow: 0 8px 16px rgba(0,0,0,.35);
    }
    .loading-text{
      margin:10px 0 0;
      font-size:16px;
      font-weight:700;
      color:var(--muted);
    }

    .center{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: calc(100vh - 170px);
      padding:18px 12px;
    }

    .spinner{
      width:34px;height:34px;border-radius:50%;
      border:4px solid rgba(255,255,255,.22);
      border-top-color: rgba(255,255,255,.95);
      animation:spin .9s linear infinite;
      margin:10px auto 0;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .hint{
      margin-top:14px;
      font-size:13px;
      color:rgba(255,255,255,.72);
      text-align:center;
      line-height:1.7;
    }
    .hint a{
      color:#fff;
      text-decoration:underline;
      font-weight:800;
    }

    .home-btn{
      position:fixed;
      left:16px;
      bottom:18px;
      background:var(--btnBg);
      color:var(--btnText);
      border:2px solid var(--btnBorder);
      border-radius:20px;
      padding:12px 16px;
      font-weight:900;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      cursor:pointer;
      z-index:5;
    }

    footer{
      position:fixed;
      right:14px;
      bottom:20px;
      font-size:12px;
      color:rgba(255,255,255,.8);
      z-index:4;
      text-shadow: 0 6px 12px rgba(0,0,0,.25);
      user-select:none;
    }

    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px 12px;
      z-index:50;
    }
    .overlay.show{display:flex}

    .card{
      width:min(560px, 100%);
      background:var(--card);
      color:var(--cardText);
      border-radius:18px;
      padding:16px 14px;
      box-shadow:0 16px 34px rgba(0,0,0,.35);
      text-align:center;
    }
    .card h3{
      margin:6px 0 10px;
      font-size:18px;
      font-weight:900;
    }
    .card p{
      margin:0 0 12px;
      color:#444;
      line-height:1.7;
      font-size:14px;
    }
    .actions{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      min-width:170px;
    }
    .btn-blue{background:var(--blue);color:#fff}
    .btn-yellow{background:var(--yellow);color:#111}
    .btn-white{background:#f1f1f1;color:#111}

    .debug{
      margin-top:10px;
      font-size:12px;
      color:#666;
      word-break:break-word;
      text-align:right;
      background:#fafafa;
      border:1px solid #eee;
      padding:10px;
      border-radius:12px;
      display:none;
    }
    .debug.show{display:block}
  </style>
</head>

<body>
  <!-- Ø¨ØµÙ…Ø© -->
  <!-- GATEWAY_V3_SANDOOQ -->

  <div class="ui">
    <header>
      <img class="logo" src="/logo.png" alt="Sandooq" />
      <div class="game-title">Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø­Ø±ÙˆÙ</div>
      <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </header>

    <div class="center">
      <div style="width:100%; text-align:center">
        <div class="spinner" aria-label="loading"></div>

        <div class="hint" id="hint">
          Ø¥Ø°Ø§ Ø·ÙˆÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø«ÙˆØ§Ù†ÙŠ:
          <br>
          <a href="./game_full.html" id="manualOpen">Ø§ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§</a>
          &nbsp;â€¢&nbsp;
          <a href="/activate" id="manualActivate">Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„</a>
        </div>
      </div>
    </div>

    <button class="home-btn" id="homeBtn">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <footer>Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù…ØªØ¬Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</footer>

    <div class="overlay" id="ov">
      <div class="card">
        <h3 id="ovTitle">ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>
        <p id="ovMsg">ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© Ù…Ø¤Ù‚ØªØ©. Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.</p>

        <div class="actions">
          <button class="btn btn-blue" id="retryBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
          <button class="btn btn-yellow" id="goActivateBtn">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„</button>
          <button class="btn btn-white" id="openGameBtn">ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§</button>
        </div>

        <div class="debug" id="dbg"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const ov = document.getElementById("ov");
  const ovTitle = document.getElementById("ovTitle");
  const ovMsg = document.getElementById("ovMsg");
  const dbg = document.getElementById("dbg");
  const retryBtn = document.getElementById("retryBtn");
  const goActivateBtn = document.getElementById("goActivateBtn");
  const openGameBtn = document.getElementById("openGameBtn");
  const homeBtn = document.getElementById("homeBtn");

  function forceReveal(){
    try{ clearTimeout(window.__SANDOOQ_REVEAL_T); }catch(e){}
    try{ document.documentElement.classList.add("reveal"); }catch(e){}
  }

  function showOverlay(title, msg, debugText){
    forceReveal();
    ovTitle.textContent = title || "ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø©";
    ovMsg.textContent = msg || "ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© Ù…Ø¤Ù‚ØªØ©. Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.";
    if(debugText){
      dbg.textContent = debugText;
      dbg.classList.add("show");
    }else{
      dbg.textContent = "";
      dbg.classList.remove("show");
    }
    ov.classList.add("show");
  }

  function hideOverlay(){
    ov.classList.remove("show");
    dbg.classList.remove("show");
    dbg.textContent = "";
  }

  function ensureDeviceId(){
    const key = "sandooq_device_id_v1";
    let id = localStorage.getItem(key);
    if(!id){
      id = (crypto?.randomUUID ? crypto.randomUUID() :
        ("dev_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
      localStorage.setItem(key, id);
    }
    return id;
  }

  function token(){
    return localStorage.getItem("sandooq_token_v1") || "";
  }

  function here(){
    return location.pathname + (location.search || "") + (location.hash || "");
  }

  function go(url){
    location.replace(url);
  }

  function buildActivateNext(){
    return "/activate?next=" + encodeURIComponent(here());
  }

  function gameFullUrl(){
    // Ù„Ùˆ Ø£Ø­Ø¯ ÙØªØ­Ù‡Ø§ Ø¨Ø§Ù„ØºÙ„Ø· Ù…Ù† /app/ Ù†Ø®Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§Ø± ØµØ­ÙŠØ­
    return location.pathname.includes("/app/") ? "../game_full.html" : "./game_full.html";
  }

  async function fetchMe(){
    const deviceId = ensureDeviceId();
    const tkn = token();

    const headers = { "X-Device-Id": deviceId };
    if(tkn) headers["Authorization"] = "Bearer " + tkn;

    let res = await fetch("/api2/me", {
      method:"GET",
      headers,
      credentials:"include",
      cache:"no-store"
    });

    if(res.status === 405){
      res = await fetch("/api2/me", {
        method:"POST",
        headers: Object.assign({ "Content-Type":"application/json" }, headers),
        credentials:"include",
        cache:"no-store",
        body:"{}"
      });
    }

    let data = null;
    try{ data = await res.json(); }catch{}
    return { res, data };
  }

  async function openHomeSafely(){
    try{
      const { res, data } = await fetchMe();
      if(res.ok && data && data.ok === true && data.activated){
        go("./index.html");
        return;
      }
    }catch{}
    go(buildActivateNext());
  }

  async function run(){
    hideOverlay();

    const { res, data } = await fetchMe();

    if(!res.ok || !data || data.ok !== true){
      go(buildActivateNext());
      return;
    }

    if(!data.activated){
      go(buildActivateNext());
      return;
    }

    // âœ… Ø£Ø³Ø±Ø¹ ØªØ­ÙˆÙŠÙ„ Ù…Ù…ÙƒÙ† (Ø¨Ø¯ÙˆÙ† ÙØ­Øµ Ù…Ø³Ø§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
    const target = gameFullUrl() + (location.search || "") + (location.hash || "");
    go(target);
  }

  async function runWithRetry(){
    try{
      await run();
    }catch(e1){
      try{
        await new Promise(r=>setTimeout(r, 350));
        await run();
      }catch(e2){
        showOverlay(
          "ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø©",
          "ØµØ§Ø± Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.",
          "err=" + String(e2 && e2.message ? e2.message : e2)
        );
      }
    }
  }

  retryBtn.addEventListener("click", runWithRetry);
  goActivateBtn.addEventListener("click", ()=> go(buildActivateNext()));
  openGameBtn.addEventListener("click", ()=> go(gameFullUrl()));
  homeBtn.addEventListener("click", openHomeSafely);

  runWithRetry();
})();
</script>

</body>
</html>

<!-- VERSION: game.html â€“ vStealthLoader-NoFirebase-7 -->
