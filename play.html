<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>بانتظار بدء اللعبة</title>

  <style>
    @font-face{
      font-family:"AA-GALAXY";
      src:url("AA-GALAXY.otf") format("opentype");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --bg1:#7b1f63;
      --bg2:#5f214f;
      --bg3:#3a1234;

      --white:#fff;
      --yellow:#f4c400;

      --purpleBtn:#6d28d9;
      --purpleBtn2:#7c3aed;

      --shadow: 0 16px 30px rgba(0,0,0,.30);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      color:#fff;
      text-align:center;
      font-family:"AA-GALAXY", Arial, sans-serif;

      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(900px 650px at 80% 25%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 48%, var(--bg3) 100%);

      min-height: 100svh;
      min-height: 100dvh;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;

      padding-top: calc(22px + env(safe-area-inset-top));
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
      padding-left:16px;
      padding-right:16px;
    }

    .topLogo{
      width:90px;
      height:90px;
      object-fit:contain;
      display:block;
      margin:0 auto 14px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }

    .center{
      flex:1;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      transform: translateY(-12px);
    }

    .title{
      font-size:22px;
      line-height:1.2;
      margin:0;
      text-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    .sub{
      margin:0;
      font-size:14px;
      opacity:.9;
      text-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      display:inline-block;
      vertical-align:-4px;
      margin-right:8px;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .buyBtn{
      width:min(320px, 70vw);
      height:46px;
      border:none;
      border-radius:12px;
      background: linear-gradient(180deg, var(--purpleBtn2), var(--purpleBtn));
      color:#fff;
      font-family:"AA-GALAXY", Arial, sans-serif;
      font-size:16px;
      cursor:pointer;
      box-shadow: var(--shadow);
    }

    .footer{
      width:100%;
      text-align:center;
      font-size:12px;
      opacity:.92;
      padding-top:10px;
    }

    .err{
      display:none;
      width:min(520px, 92vw);
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
    }
  </style>
</head>

<body>
  <!-- اللوجو أعلى الصفحة بالمنتصف -->
  <img class="topLogo" src="logo.png" alt="شعار صندوق المسابقات">

  <div class="center">
    <p class="title"><span class="spinner" aria-hidden="true"></span>بانتظار المقدم لبدء اللعبة</p>
    <p class="sub" id="msg">لحظة...</p>

    <!-- زر شراء اللعبة (منتصف الشاشة وحجمه أصغر) -->
    <button class="buyBtn" id="buyBtn">لشراء اللعبة اضغط هنا</button>

    <div class="err" id="errBox"></div>
  </div>

  <!-- الحقوق أسفل الصفحة بالمنتصف -->
  <div class="footer">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const BUY_URL = "https://sandooq-m.com";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const msg = document.getElementById("msg");
    const errBox = document.getElementById("errBox");
    const buyBtn = document.getElementById("buyBtn");

    buyBtn.addEventListener("click", () => {
      window.open(BUY_URL, "_blank", "noopener,noreferrer");
    });

    function normalizeDigits(s){
      const map = {
        "٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9",
        "۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9"
      };
      return String(s || "").replace(/[٠-٩۰-۹]/g, d => map[d] ?? d);
    }

    function cleanCode(s){
      return normalizeDigits(s).replace(/\D/g, "").slice(0,6);
    }

    function showErr(text){
      errBox.textContent = text;
      errBox.style.display = "block";
    }

    // نجيب بيانات الغرفة من الرابط (بدون عرضها للاعب)
    const params = new URLSearchParams(location.search);
    const code = cleanCode(params.get("code") || "");
    const pid  = (params.get("pid") || "").trim();

    // نخزنها (مخفية) للاحتياط بدون ما نعرضها
    if(code) sessionStorage.setItem("room_code", code);
    if(pid)  sessionStorage.setItem("player_pid", pid);

    if(code.length !== 6){
      msg.textContent = "افتح الرابط من المقدم";
      showErr("رمز الغرفة غير موجود في الرابط.");
    }else{
      msg.textContent = "بانتظار المقدم يبدأ اللعبة...";
      const statusRef = ref(db, `rooms/${code}/status`);

      onValue(statusRef, (snap) => {
        const st = snap.val();

        // عند بدء اللعبة: ننقل اللاعب لصفحة اللعب (وليس play.html)
        if(st === "started"){
          msg.textContent = "جاري فتح اللعبة...";
          const u = new URL("game.html", location.href);
          u.searchParams.set("role", "player");
          u.searchParams.set("code", code);
          if(pid) u.searchParams.set("pid", pid);
          location.replace(u.toString());
        }
      }, (err) => {
        showErr("صار خطأ في الاتصال. حاول تحدّث الصفحة.");
      });
    }
  </script>

  <!-- VERSION: play.html — v2 (Style match + no room code shown + redirect to game.html on started) -->
</body>
</html>
