<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>بانتظار بدء اللعبة</title>

  <meta name="theme-color" content="#7b1f63">

  <!-- خط اللعبة -->
  <link rel="preload" href="AA-GALAXY.otf?v=2026-02-15-1" as="font" type="font/otf" crossorigin>
  <link rel="preload" href="logo.png?v=2026-02-15-1" as="image" fetchpriority="high">

  <style>
    @font-face{
      font-family:"AA-GALAXY";
      src:url("AA-GALAXY.otf?v=2026-02-15-1") format("opentype");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }

    :root{
      /* نفس ألوان game_full.html */
      --bg1:#7b1f63;
      --bg2:#5f214f;
      --bg3:#3a1234;

      --card:#ffffff;
      --text:#111;
      --muted:#6b7280;

      --shadow: 0 16px 30px rgba(0,0,0,.30);

      /* زر الشراء البنفسجي */
      --buy:#7c3aed;
      --buy2:#6d28d9;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    html{
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 48%, var(--bg3) 100%);
    }

    body{
      margin:0;
      min-height:100svh;
      min-height:100dvh;

      font-family:"AA-GALAXY", Arial, sans-serif;
      color:#fff;

      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(900px 650px at 80% 25%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 48%, var(--bg3) 100%);

      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;

      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .box{
      width:min(620px, 92vw);
      background:var(--card);
      color:var(--text);
      border-radius:20px;
      padding:26px 18px 18px;
      text-align:center;
      box-shadow:var(--shadow);
    }

    .logo{
      width:74px;
      height:74px;
      object-fit:contain;
      display:block;
      margin:0 auto 10px;
    }

    h2{
      margin:8px 0 6px;
      font-size:22px;
      color:#111;
      font-weight:800;
    }

    p{
      margin:0;
      font-size:14px;
      color:#444;
      line-height:1.6;
    }

    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid #ddd;
      border-top-color: var(--bg1);
      display:inline-block;
      vertical-align:-4px;
      margin-right:8px;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .buyBtn{
      margin:16px auto 0;
      width:min(520px, 92vw);
      border:0;
      cursor:pointer;
      padding:14px 16px;
      border-radius:14px;
      font-size:16px;
      font-weight:900;
      font-family:"AA-GALAXY", Arial, sans-serif;

      background: linear-gradient(180deg, var(--buy) 0%, var(--buy2) 100%);
      color:#fff;
      box-shadow:0 10px 22px rgba(124,58,237,.25);
    }
    .buyBtn:active{ transform:translateY(1px); }

    .small{
      margin-top:12px;
      font-size:12px;
      color:#777;
    }

    .codeLine{
      margin-top:8px;
      font-size:12px;
      color:#666;
    }

    .hint{
      margin-top:10px;
      font-size:12px;
      color:#6b7280;
    }
  </style>
</head>
<body>
  <div class="box">
    <img class="logo" src="logo.png" alt="شعار صندوق المسابقات">
    <h2><span class="spinner" aria-hidden="true"></span>بانتظار بدء اللعبة</h2>
    <p id="msg">بانتظار المقدم يبدأ اللعبة…</p>
    <div class="codeLine" id="codeLine" style="display:none;"></div>

    <button class="buyBtn" id="buyBtn" type="button">لشراء اللعبة اضغط هنا</button>

    <div class="small">© صندوق المسابقات</div>
    <div class="hint" id="hint" style="display:none;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const msgEl = document.getElementById("msg");
    const codeLine = document.getElementById("codeLine");
    const hint = document.getElementById("hint");

    document.getElementById("buyBtn").onclick = () => {
      window.open("https://sandooq-m.com", "_blank", "noopener,noreferrer");
    };

    function normalizeDigits(s){
      const map = {
        "٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9",
        "۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9"
      };
      return String(s || "").replace(/[٠-٩۰-۹]/g, d => map[d] ?? d);
    }
    function cleanCode(s){
      return normalizeDigits(s).replace(/\D/g, "").slice(0,6);
    }

    const params = new URLSearchParams(location.search);
    const code = cleanCode(params.get("code") || params.get("room") || params.get("c") || "");
    const pid  = (params.get("pid") || "").trim();

    if(code){
      codeLine.style.display = "block";
      codeLine.textContent = "رمز الغرفة: " + code;
    }

    if(!code){
      msgEl.textContent = "الرابط ناقص (رمز الغرفة غير موجود).";
      hint.style.display = "block";
      hint.textContent = "ارجع وافتح رابط الـ QR من جديد.";
    } else {
      // تأكد الغرفة موجودة (اختياري)
      try{
        const roomSnap = await get(ref(db, `rooms/${code}`));
        if(!roomSnap.exists()){
          msgEl.textContent = "الغرفة غير موجودة أو انتهت.";
          hint.style.display = "block";
          hint.textContent = "تأكد من رمز الغرفة أو افتح الرابط الصحيح.";
        }
      }catch(e){}

      // راقب حالة الغرفة: إذا started ننقلهم
      const statusRef = ref(db, `rooms/${code}/status`);
      onValue(statusRef, (snap) => {
        const st = snap.val();
        if(st === "started"){
          msgEl.textContent = "بدأت اللعبة… جاري الدخول";
          const u = new URL("game.html", location.href); // game.html بوابة لـ game_full
          u.searchParams.set("role", "player");
          u.searchParams.set("code", code);
          if(pid) u.searchParams.set("pid", pid);
          location.replace(u.toString());
        }
      }, (err) => {
        msgEl.textContent = "صار خطأ بالاتصال، حاول تحديث الصفحة.";
      });
    }
  </script>

  <!-- VERSION: play.html — v2 (Style matches game_full + Buy button; waits for started then goes to game.html) -->
</body>
</html>
