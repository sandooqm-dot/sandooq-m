<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>بانتظار بدء اللعبة</title>

  <style>
    @font-face{
      font-family:"AA-GALAXY";
      src:url("AA-GALAXY.otf") format("opentype");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --bg1:#7b1f63;
      --bg2:#5f214f;
      --bg3:#3a1234;

      --white:#fff;
      --yellow:#f4c400;

      --purpleBtn:#6d28d9;
      --purpleBtn2:#7c3aed;

      --shadow: 0 16px 30px rgba(0,0,0,.30);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      color:#fff;
      text-align:center;
      font-family:"AA-GALAXY", Arial, sans-serif;

      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(900px 650px at 80% 25%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 48%, var(--bg3) 100%);

      min-height: 100svh;
      min-height: 100dvh;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;

      padding-top: calc(22px + env(safe-area-inset-top));
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
      padding-left:16px;
      padding-right:16px;
    }

    .topLogo{
      width:90px;
      height:90px;
      object-fit:contain;
      display:block;
      margin:0 auto 14px;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }

    .center{
      flex:1;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      transform: translateY(-12px);
    }

    .title{
      font-size:22px;
      line-height:1.2;
      margin:0;
      text-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    .sub{
      margin:0;
      font-size:14px;
      opacity:.9;
      text-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      display:inline-block;
      vertical-align:-4px;
      margin-right:8px;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .buyBtn{
      width:min(320px, 70vw);
      height:46px;
      border:none;
      border-radius:12px;
      background: linear-gradient(180deg, var(--purpleBtn2), var(--purpleBtn));
      color:#fff;
      font-family:"AA-GALAXY", Arial, sans-serif;
      font-size:16px;
      cursor:pointer;
      box-shadow: var(--shadow);
    }

    .footer{
      width:100%;
      text-align:center;
      font-size:12px;
      opacity:.92;
      padding-top:10px;
    }

    .err{
      display:none;
      width:min(520px, 92vw);
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
    }
  </style>
</head>

<body>
  <!-- اللوجو أعلى الصفحة بالمنتصف -->
  <img class="topLogo" src="logo.png" alt="شعار صندوق المسابقات">

  <div class="center">
    <p class="title"><span class="spinner" aria-hidden="true"></span>بانتظار المقدم لبدء اللعبة</p>
    <p class="sub" id="msg">لحظة...</p>

    <!-- زر شراء اللعبة (منتصف الشاشة وحجمه أصغر) -->
    <button class="buyBtn" id="buyBtn">لشراء اللعبة اضغط هنا</button>

    <div class="err" id="errBox"></div>
  </div>

  <!-- الحقوق أسفل الصفحة بالمنتصف -->
  <div class="footer">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>

  <script>
    // ✅ Firebase removed نهائياً: الاعتماد على Durable Objects (/state)
    const BUY_URL = "https://sandooq-m.com";

    const msg = document.getElementById("msg");
    const errBox = document.getElementById("errBox");
    const buyBtn = document.getElementById("buyBtn");

    buyBtn.addEventListener("click", () => {
      window.open(BUY_URL, "_blank", "noopener,noreferrer");
    });

    function normalizeDigits(s){
      const map = {
        "٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9",
        "۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9"
      };
      return String(s || "").replace(/[٠-٩۰-۹]/g, d => map[d] ?? d);
    }

    function cleanCode(s){
      return normalizeDigits(s).replace(/\D/g, "").slice(0,6);
    }

    function showErr(text){
      errBox.textContent = text;
      errBox.style.display = "block";
    }

    const params = new URLSearchParams(location.search);
    const code = cleanCode(params.get("code") || "");
    const pid  = (params.get("pid") || "").trim();

    // ✅ Sync base (Cloudflare Worker + DO)
    const SYNC_BASE = (params.get("sync") || "https://horof-sync.sandooq-m.workers.dev").replace(/\/$/,"");

    // نخزنها (مخفية) للاحتياط بدون ما نعرضها
    try{
      if(code) sessionStorage.setItem("room_code", code);
      if(pid)  sessionStorage.setItem("player_pid", pid);
    }catch(e){}

    function buildGameUrl(){
      const u = new URL("game.html", location.href);
      u.searchParams.set("role", "player");
      if(code) u.searchParams.set("code", code);
      if(pid) u.searchParams.set("pid", pid);
      // مهم: نمرر sync عشان game.html يمرره لـ game_full.html
      if(params.get("sync")) u.searchParams.set("sync", params.get("sync"));
      return u.toString();
    }

    async function fetchRoomState(){
      const url = `${SYNC_BASE}/state?room=${encodeURIComponent(code)}`;
      const r = await fetch(url, { cache:"no-store" });
      const j = await r.json().catch(()=>null);
      if(!j || !j.ok) throw new Error("STATE_FAIL");
      const st = (j.state && typeof j.state === "object") ? j.state : {};
      return st;
    }

    let alive = true;

    async function tick(){
      if(!alive) return;
      try{
        const room = await fetchRoomState();

        // لو الغرفة غير موجودة/فاضية
        if(!room || Object.keys(room).length === 0){
          msg.textContent = "افتح الرابط من المقدم";
          showErr("الغرفة غير موجودة أو لم يتم إنشاؤها بعد.");
          return;
        }

        const st = String(room.status || "");
        if(st === "started"){
          msg.textContent = "جاري فتح اللعبة...";
          location.replace(buildGameUrl());
          return;
        }

        // باقي في اللوبي
        msg.textContent = "بانتظار المقدم يبدأ اللعبة...";

      }catch(e){
        // ما نوقف الصفحة، نخليه يحاول
        msg.textContent = "بانتظار المقدم يبدأ اللعبة...";
      }
    }

    function loop(){
      if(!alive) return;
      tick();
      const delay = document.hidden ? 1800 : 900;
      setTimeout(loop, delay);
    }

    if(code.length !== 6){
      msg.textContent = "افتح الرابط من المقدم";
      showErr("رمز الغرفة غير موجود في الرابط.");
    }else{
      msg.textContent = "بانتظار المقدم يبدأ اللعبة...";
      loop();
    }

    window.addEventListener("beforeunload", ()=>{ alive = false; });
  </script>

  <!-- VERSION: play.html — vDO-Wait-NoFirebase-1 -->
</body>
</html>
