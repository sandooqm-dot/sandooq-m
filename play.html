<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>بانتظار بدء اللعبة</title>
  <style>
    :root{
      --bg:#1f4fa3;
      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
      --border:#e6dfc8;
    }
    body{
      margin:0; min-height:100vh;
      background:radial-gradient(circle at 30% 20%, rgba(255,255,255,.08), transparent 45%),
                 radial-gradient(circle at 70% 30%, rgba(244,196,0,.10), transparent 45%),
                 var(--bg);
      font-family:Arial, sans-serif;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .box{
      width:min(520px, 92vw);
      background:var(--card);
      border-radius:16px;
      border:2px solid var(--border);
      padding:22px 16px;
      text-align:center;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }
    .logo{ width:54px;height:54px;object-fit:contain; display:block;margin:0 auto 10px; }
    h2{ margin:6px 0 6px; font-size:20px; color:#111; }
    p{ margin:0; font-size:14px; color:#444; line-height:1.6; }
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid #ddd;border-top-color:#1f4fa3;
      display:inline-block; vertical-align:-4px;
      margin-left:6px;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .row{ display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap; }
    .btn{
      border:0; cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      font-size:15px;
      font-weight:700;
    }
    .btnPrimary{ background:var(--yellow); color:#000; }
    .btnGhost{ background:#eef2ff; color:#1f4fa3; }
    .small{ margin-top:10px; font-size:12px; color:#777; }
  </style>

  <!-- ✅ تسجيل Service Worker (مبكر + iOS-friendly) -->
  <script>
    (function () {
      if (!("serviceWorker" in navigator)) return;
      if (location.protocol !== "https:" && location.hostname !== "localhost") return;

      try{
        navigator.serviceWorker.register("./sw.js", { scope: "./", updateViaCache: "none" })
          .catch(function(){});
      }catch(e){
        navigator.serviceWorker.register("./sw.js").catch(function(){});
      }

      navigator.serviceWorker.ready
        .then(function(reg){ try{ reg.update(); }catch(e){} })
        .catch(function(){});
    })();
  </script>
</head>
<body>
  <div class="box">
    <img class="logo" src="logo.png" alt="شعار صندوق المسابقات">
    <h2>بانتظار بدء اللعبة <span class="spinner" aria-hidden="true"></span></h2>
    <p id="msg">لحظة.. يتم تجهيز الغرفة</p>

    <div class="row" id="actions" style="display:none">
      <button class="btn btnPrimary" id="retry">تحديث</button>
      <button class="btn btnGhost" id="back">رجوع</button>
    </div>

    <div class="small">© صندوق المسابقات</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    const params = new URLSearchParams(location.search);
    const code = (params.get("code") || "").trim();
    const pid  = (params.get("pid")  || "").trim();
    const role = (params.get("role") || "player").trim();

    const msgEl = document.getElementById("msg");
    const actions = document.getElementById("actions");

    function showActions(text){
      msgEl.textContent = text;
      actions.style.display = "flex";
    }

    document.getElementById("retry").onclick = ()=> location.reload();
    document.getElementById("back").onclick  = ()=> {
      // يرجع لصفحة الدخول مع تمرير الكود لو موجود
      const u = new URL("join.html", location.href);
      if (code) u.searchParams.set("code", code);
      location.href = u.toString();
    };

    // ✅ لا يوجد أي تحويل لصفحة /activate هنا — الضيوف فقط ينتظرون
    if(!/^[0-9]{6}$/.test(code) || !pid){
      showActions("الرابط ناقص (رمز الغرفة أو معرف اللاعب غير موجود). اضغط رجوع وأدخل من جديد.");
    }else{
      msgEl.textContent = "بانتظار المقدم يبدأ اللعبة… لا تقفل الصفحة";
      const app = initializeApp(firebaseConfig);
      const db  = getDatabase(app);

      const roomRef = ref(db, `rooms/${code}`);

      let redirected = false;

      onValue(roomRef, (snap) => {
        if(!snap.exists()){
          showActions("الغرفة غير موجودة أو انتهت. اضغط رجوع.");
          return;
        }

        const room = snap.val() || {};
        const st = String(room.status || "lobby");

        if(st === "started"){
          if(redirected) return;
          redirected = true;

          // ✅ عند بدء اللعبة: ادخل صفحة اللعب (وضع اللاعب)
          const u = new URL("game_full.html", location.href);
          u.searchParams.set("role", role || "player");
          u.searchParams.set("code", code);
          u.searchParams.set("pid", pid);
          location.replace(u.toString());
          return;
        }

        // باقي الحالات: خلي اللاعب ينتظر
        if(st === "lobby"){
          msgEl.textContent = "بانتظار المقدم يبدأ اللعبة…";
        }else{
          msgEl.textContent = "بانتظار تجهيز الغرفة…";
        }
      }, (err) => {
        showActions("صار خطأ بالاتصال. اضغط تحديث.");
      });
    }
  </script>

  <!-- VERSION: play.html — v2 (Guest waiting; NO redirect to /activate; redirect to game_full when started) -->
</body>
</html>
