<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>بانتظار بدء اللعبة</title>
  <style>
    :root{
      --bg:#1f4fa3;
      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
      --border:#e6dfc8;
    }
    body{
      margin:0; min-height:100vh;
      background:radial-gradient(circle at 30% 20%, rgba(255,255,255,.08), transparent 45%),
                 radial-gradient(circle at 70% 30%, rgba(244,196,0,.10), transparent 45%),
                 var(--bg);
      font-family:Arial, sans-serif;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .box{
      width:min(520px, 92vw);
      background:var(--card);
      border-radius:16px;
      border:2px solid var(--border);
      padding:22px 16px;
      text-align:center;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }
    .logo{ width:54px;height:54px;object-fit:contain; display:block;margin:0 auto 10px; }
    h2{ margin:6px 0 6px; font-size:20px; color:#111; }
    p{ margin:0; font-size:14px; color:#444; }
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid #ddd;border-top-color:#1f4fa3;
      display:inline-block; vertical-align:-4px;
      margin-left:6px;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .row{ display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap; }
    .btn{
      border:0; cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      font-size:15px;
      font-weight:700;
    }
    .btnPrimary{ background:var(--yellow); color:#000; }
    .btnGhost{ background:#eef2ff; color:#1f4fa3; }
    .small{ margin-top:10px; font-size:12px; color:#777; }
  </style>
</head>
<body>
  <div class="box">
    <img class="logo" src="logo.png" alt="شعار صندوق المسابقات">
    <h2>بانتظار بدء اللعبة <span class="spinner" aria-hidden="true"></span></h2>
    <p id="msg">بانتظار المقدم يبدأ اللعب…</p>

    <!-- ✅ زر شراء اللعبة (مثل ما طلبت) -->
    <div class="row">
      <button class="btn btnGhost" id="buyBtn">لشراء اللعبة اضغط هنا</button>
    </div>

    <!-- أزرار مساعدة تظهر فقط عند وجود مشكلة -->
    <div class="row" id="actions" style="display:none">
      <button class="btn btnGhost" id="backJoin">رجوع</button>
      <button class="btn btnPrimary" id="retry">تحديث</button>
    </div>

    <div class="small">© صندوق المسابقات</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(location.search);
    const code = (params.get("code") || "").trim();
    const pid  = (params.get("pid")  || "").trim();
    const role = (params.get("role") || "player").trim();

    const msgEl = document.getElementById("msg");
    const actionsEl = document.getElementById("actions");

    const BUY_URL  = "https://sandooq-m.com";
    const JOIN_URL = "join.html";
    const GAME_URL = "game.html"; // ✅ اللاعب يروح للعبة غير المحمية (بدون activate)

    document.getElementById("buyBtn").onclick = () => window.open(BUY_URL, "_blank", "noopener,noreferrer");

    document.getElementById("backJoin").onclick = () => {
      const u = new URL(JOIN_URL, location.href);
      if(code) u.searchParams.set("code", code);
      location.href = u.toString();
    };

    document.getElementById("retry").onclick = async () => {
      try{
        actionsEl.style.display = "none";
        msgEl.textContent = "بانتظار المقدم يبدأ اللعب…";
        if(!code) throw new Error("NO_CODE");
        const snap = await get(ref(db, `rooms/${code}`));
        if(!snap.exists()) throw new Error("ROOM_NOT_FOUND");
        const room = snap.val() || {};
        if(room.status === "started") goGame();
      }catch(e){
        showProblem();
      }
    };

    function showProblem(){
      msgEl.textContent = "ما قدرنا نجيب حالة الغرفة الآن. جرّب تحديث.";
      actionsEl.style.display = "flex";
    }

    function goGame(){
      const u = new URL(GAME_URL, location.href);
      u.searchParams.set("role", role || "player");
      u.searchParams.set("code", code);
      if(pid) u.searchParams.set("pid", pid);
      location.replace(u.toString());
    }

    // ✅ لو الرابط ناقص، لا نوديه لأي تفعيل — نخليه يرجع لصفحة الدخول
    if(!code){
      msgEl.textContent = "الرابط غير مكتمل. ارجع لصفحة الدخول وأدخل رمز اللعبة.";
      actionsEl.style.display = "flex";
    }else{
      const roomRef = ref(db, `rooms/${code}`);
      onValue(roomRef, (snap) => {
        if(!snap.exists()){
          msgEl.textContent = "رمز اللعبة غير صحيح أو الغرفة غير موجودة.";
          actionsEl.style.display = "flex";
          return;
        }
        const room = snap.val() || {};
        const st = room.status;

        if(st === "started"){
          msgEl.textContent = "تم بدء اللعبة… جاري الدخول";
          goGame();
          return;
        }

        // أي حالة غير started = انتظار
        msgEl.textContent = "بانتظار المقدم يبدأ اللعب…";
      }, () => {
        showProblem();
      });
    }
  </script>

  <!-- VERSION: play.html — v2 (Guest waiting via Firebase; redirect to game.html; keep old style + buy button) -->
</body>
</html>
