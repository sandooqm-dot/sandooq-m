<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>جاري فتح اللعبة</title>
  <style>
    :root{
      --bg:#1f4fa3;
      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
      --border:#e6dfc8;
    }
    body{
      margin:0; min-height:100vh;
      background:radial-gradient(circle at 30% 20%, rgba(255,255,255,.08), transparent 45%),
                 radial-gradient(circle at 70% 30%, rgba(244,196,0,.10), transparent 45%),
                 var(--bg);
      font-family:Arial, sans-serif;
      display:flex; align-items:center; justify-content:center;
      padding:16px;

      /* ✅ نخفي الصفحة بالبداية عشان ما تطلع إلا إذا فيه مشكلة */
      opacity:0;
      transition:opacity .15s ease;
    }
    body.show{ opacity:1; }

    .box{
      width:min(520px, 92vw);
      background:var(--card);
      border-radius:16px;
      border:2px solid var(--border);
      padding:22px 16px;
      text-align:center;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }
    .logo{
      width:54px;height:54px;object-fit:contain;
      display:block;margin:0 auto 10px;
    }
    h2{ margin:6px 0 6px; font-size:20px; color:#111; }
    p{ margin:0; font-size:14px; color:#444; }
    .row{
      display:flex; gap:10px; justify-content:center;
      margin-top:14px; flex-wrap:wrap;
    }
    .btn{
      border:0; cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      font-size:15px;
    }
    .btnPrimary{ background:var(--yellow); color:#000; font-weight:700; }
    .btnGhost{ background:#eef2ff; color:#1f4fa3; font-weight:700; }
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid #ddd;border-top-color:#1f4fa3;
      display:inline-block; vertical-align:-4px;
      margin-left:6px;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .small{ margin-top:10px; font-size:12px; color:#777; }
  </style>
</head>
<body>
  <div class="box">
    <img class="logo" src="logo.png" alt="شعار صندوق المسابقات">
    <h2>جاري فتح اللعبة <span class="spinner" aria-hidden="true"></span></h2>
    <p id="msg">لحظة.. نتحقق من التفعيل</p>

    <div class="row" style="display:none" id="actions">
      <button class="btn btnPrimary" id="goActivate">اذهب لصفحة التفعيل</button>
      <button class="btn btnGhost" id="retry">إعادة المحاولة</button>
    </div>

    <div class="small">© صندوق المسابقات</div>
  </div>

  <script>
    const ACTIVATE_URL = "/activate.html";
    const GAME_URL = "/game_full.html";

    function getAnyToken(){
      const keys = [
        "JWT","jwt","token","access_token","AUTH_TOKEN",
        "SANDOOQ_JWT","SANDOOQ_TOKEN","sandooq_jwt","sandooq_token"
      ];
      for(const k of keys){
        const v = localStorage.getItem(k);
        if(v && String(v).trim().length > 10) return String(v).trim();
      }
      return "";
    }

    let revealTimer = null;
    function revealIfNeeded(){
      // ✅ ما نكشف الصفحة إلا إذا فعلاً احتجناها (بعد 0.4 ثانية)
      if(revealTimer) return;
      revealTimer = setTimeout(()=> document.body.classList.add("show"), 400);
    }

    function showActions(text){
      revealIfNeeded();
      document.getElementById("msg").textContent = text;
      document.getElementById("actions").style.display = "flex";
    }

    async function check(){
      document.getElementById("actions").style.display = "none";
      document.getElementById("msg").textContent = "لحظة.. نتحقق من التفعيل";

      const token = getAnyToken();
      if(!token){
        showActions("ما فيه تفعيل محفوظ على هذا المتصفح. لازم تدخل صفحة التفعيل.");
        return;
      }

      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), 6000);

      try{
        const res = await fetch("/api/me", {
          method:"GET",
          headers:{ "Authorization": `Bearer ${token}` },
          cache:"no-store",
          signal: controller.signal
        });
        clearTimeout(t);

        if(!res.ok){
          showActions("التفعيل غير صالح أو انتهت الجلسة. افتح صفحة التفعيل.");
          return;
        }

        const data = await res.json().catch(()=> ({}));
        if(!data || data.ok !== true){
          showActions("تعذر التحقق من التفعيل. افتح صفحة التفعيل.");
          return;
        }

        // ✅ تمام: افتح اللعبة فوراً بدون ما تظهر صفحة التحميل
        location.replace(GAME_URL + "?v=" + Date.now());
      }catch(e){
        clearTimeout(t);
        showActions("فيه مشكلة اتصال/تحقق. جرّب إعادة المحاولة أو افتح صفحة التفعيل.");
      }
    }

    document.getElementById("goActivate").onclick = ()=> location.href = ACTIVATE_URL;
    document.getElementById("retry").onclick = ()=> check();

    // ✅ ابدأ تحقق فوراً
    check();
  </script>
</body>
</html>
