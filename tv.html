<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>عرض التلفاز - سباق الحروف</title>

  <!-- ✅ تسريع Firebase -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//www.gstatic.com">

  <!-- ✅ (اختياري) SW -->
  <script>
  (function(){
    try{
      if(!("serviceWorker" in navigator)) return;
      if(!window.isSecureContext && location.hostname !== "localhost") return;
      var ASSET_VERSION = "2026-02-18-tv-2";
      var vq = "?v=" + encodeURIComponent(ASSET_VERSION);
      navigator.serviceWorker.register("./sw.js" + vq, { scope:"./" }).catch(function(){});
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bgA:#7b3459;
      --bgB:#4b1f36;

      --card: rgba(255,255,255,.10);
      --bd: rgba(255,255,255,.16);
      --shadow: 0 18px 55px rgba(0,0,0,.35);

      --txt:#fff;
      --muted: rgba(255,255,255,.75);

      --yellow:#f4c400;
      --green:#16a34a;
      --orange:#f28c00;

      --zoom: 1.0;
    }

    @font-face{
      font-family:"AA-GALAXY";
      src:url("AA-GALAXY.otf") format("opentype");
      font-display:swap;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--txt);
      font-family:"AA-GALAXY", system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 25% 10%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(135deg, var(--bgA), var(--bgB));
      overflow:hidden;
    }

    /* Top bar */
    .topbar{
      height:78px;
      padding:10px 14px 0;
      display:grid;
      grid-template-columns: 64px 1fr auto;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:54px;height:54px;object-fit:contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      user-select:none; pointer-events:none;
      justify-self:start;
    }
    .gameName{
      text-align:center;
      font-size:34px;
      color:#fff;
      text-shadow: 0 10px 20px rgba(0,0,0,.35);
      line-height:1;
      padding-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .controls{
      justify-self:end;
      display:flex;
      align-items:center;
      gap:12px;
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,.18);
    }
    .scorePill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      min-width:130px;
      justify-content:space-between;
    }
    .scorePill .lbl{
      font-size:14px;
      color: rgba(255,255,255,.85);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
    }
    .scorePill .num{
      font-size:22px;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
      line-height:1;
    }
    .scorePill.green .num{ color: var(--green); }
    .scorePill.orange .num{ color: var(--orange); }

    .zoomBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
    }
    .zoomLbl{
      font-size:14px;
      color: rgba(255,255,255,.85);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
      white-space:nowrap;
    }
    input[type="range"]{ width:160px; }

    /* Main */
    .main{
      height: calc(100vh - 78px);
      padding:10px 12px 14px;
    }
    .panel{
      height:100%;
      background: var(--card);
      border:1px solid var(--bd);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Map viewport (never overlaps topbar because it’s inside panel) */
    .mapViewport{
      flex:1;
      border-radius:18px;
      overflow:hidden;
      position:relative;
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.10);
    }

    /* Stage scaled by slider */
    .mapStage{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      transform: scale(var(--zoom));
      transform-origin: top center;
      pointer-events:none; /* ✅ عرض فقط */
    }

    /* Keep consistent aspect ratio like the original maps */
    .mapFrame{
      width:min(1100px, 98vw);
      aspect-ratio: 1000 / 700;
      position:relative;
    }

    .mapImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    svg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
    }

    /* Overlay cells (transparent colors over the printed letters) */
    .cell{
      stroke: rgba(0,0,0,.10);
      stroke-width: 1;
      fill: rgba(0,0,0,0);
    }
    .s0{ fill: rgba(0,0,0,0); }
    .s1{ fill: rgba(244,196,0,.80); }   /* أصفر */
    .s2{ fill: rgba(22,163,74,.78); }   /* أخضر */
    .s3{ fill: rgba(242,140,0,.78); }   /* برتقالي */

    .statusLine{
      position:absolute;
      right:14px;
      bottom:10px;
      font-size:12px;
      color: rgba(255,255,255,.75);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      user-select:none;
    }

    /* Simple modal if no code */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(520px, 96vw);
      background: rgba(20, 8, 25, .95);
      border:1px solid rgba(255,255,255,.16);
      border-radius:18px;
      padding:16px 14px 14px;
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      text-align:center;
    }
    .mTitle{ margin:2px 0 10px; font-size:22px; color:var(--yellow); }
    .mHint{
      color:rgba(255,255,255,.78);
      font-size:13px;
      line-height:1.7;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      margin-bottom:12px;
    }
    .in{
      width: min(360px, 90vw);
      height:54px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      color:#fff;
      padding:0 14px;
      font-size:18px;
      outline:none;
      text-align:center;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
      letter-spacing:2px;
      direction:ltr;
    }
    .btn{
      width: min(360px, 90vw);
      height:56px;
      border:none;
      border-radius:16px;
      background: var(--yellow);
      color:#111;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      margin-top:12px;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .err{
      display:none;
      margin-top:10px;
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#7a1a1a;
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
      text-align:center;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <img class="logo" src="logo.png" alt="شعار صندوق المسابقات" onerror="this.style.display='none'">
    <div class="gameName" id="gameName">—</div>

    <div class="controls">
      <div class="scorePill green">
        <span class="lbl">الأخضر</span>
        <span class="num" id="scoreGreen">0</span>
      </div>

      <div class="scorePill orange">
        <span class="lbl">البرتقالي</span>
        <span class="num" id="scoreOrange">0</span>
      </div>

      <div class="zoomBox">
        <span class="zoomLbl">تكبير</span>
        <input id="zoomRange" type="range" min="0.90" max="1.35" step="0.01" value="1.00" />
      </div>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="mapViewport" id="mapViewport">
        <div class="mapStage" id="mapStage">
          <div class="mapFrame">
            <img class="mapImg" id="mapImg" alt="خريطة سباق الحروف">
            <svg id="overlaySvg" viewBox="0 0 1000 700" aria-label="طبقة تلوين الخلايا"></svg>
          </div>
        </div>

        <div class="statusLine" id="statusLine">جاري الاتصال...</div>
      </div>
    </div>
  </div>

  <!-- Code modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal">
      <div class="mTitle">عرض التلفاز</div>
      <div class="mHint">افتح الرابط هكذا: <span style="direction:ltr">tv.html?code=123456</span><br>أو اكتب رمز الغرفة هنا.</div>
      <input class="in" id="codeInput" maxlength="6" inputmode="numeric" placeholder="رمز الغرفة (6 أرقام)">
      <button class="btn" id="startBtn">ابدأ العرض</button>
      <div class="err" id="errBox"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getDatabase, ref, get, onValue,
      onChildAdded, onChildChanged, onChildRemoved,
      runTransaction, onDisconnect, update
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    function normalizeDigits(s){
      const map = {
        "٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9",
        "۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9"
      };
      return String(s || "").replace(/[٠-٩۰-۹]/g, d => map[d] ?? d);
    }
    function cleanCode(s){
      return normalizeDigits(s).replace(/\D/g, "").slice(0,6);
    }

    // UI
    const gameNameEl = document.getElementById("gameName");
    const scoreGreenEl = document.getElementById("scoreGreen");
    const scoreOrangeEl = document.getElementById("scoreOrange");
    const statusLine = document.getElementById("statusLine");
    const zoomRange = document.getElementById("zoomRange");
    const mapImg = document.getElementById("mapImg");
    const overlaySvg = document.getElementById("overlaySvg");

    const backdrop = document.getElementById("backdrop");
    const codeInput = document.getElementById("codeInput");
    const startBtn = document.getElementById("startBtn");
    const errBox = document.getElementById("errBox");

    zoomRange.addEventListener("input", () => {
      document.documentElement.style.setProperty("--zoom", String(zoomRange.value));
    });

    // TV device id
    function tvId(){
      const k="sandooq_tv_id_v1";
      let v = "";
      try{ v = localStorage.getItem(k) || ""; }catch(e){}
      if(!v){
        v = (crypto?.randomUUID ? crypto.randomUUID() : ("tv_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
        try{ localStorage.setItem(k, v); }catch(e){}
      }
      return v;
    }

    // Build overlay grid (5x5) – bigger so it matches the printed map
    const svgNS="http://www.w3.org/2000/svg";
    const cellElByKey = new Map(); // "r_c" -> polygon

    function hexPoints(cx, cy, r){
      const pts=[];
      for(let i=0;i<6;i++){
        const ang = (Math.PI/180) * (60*i - 30);
        pts.push(`${(cx + r*Math.cos(ang)).toFixed(2)},${(cy + r*Math.sin(ang)).toFixed(2)}`);
      }
      return pts.join(" ");
    }

    function buildGrid(){
      overlaySvg.innerHTML="";
      cellElByKey.clear();

      const W=1000, H=700;
      overlaySvg.setAttribute("viewBox", `0 0 ${W} ${H}`);

      const rows=5, cols=5;
      const r=86; // ✅ أكبر من قبل عشان تطابق خريطة الصور
      const dx=r*Math.sqrt(3);
      const dy=r*1.5;

      const gridW = cols*dx;
      const gridH = (rows-1)*dy + (2*r);

      const x0 = (W-gridW)/2 + (dx/2);
      const y0 = (H-gridH)/2 + r;

      for(let row=0; row<rows; row++){
        for(let col=0; col<cols; col++){
          const cx = x0 + col*dx + ((row%2)? (dx/2):0);
          const cy = y0 + row*dy;

          const poly=document.createElementNS(svgNS,"polygon");
          poly.setAttribute("points", hexPoints(cx,cy,r));
          poly.classList.add("cell","s0");
          const k = row + "_" + col;
          cellElByKey.set(k, poly);
          overlaySvg.appendChild(poly);
        }
      }
    }

    function setCellStateByRC(r,c,st){
      const k = r + "_" + c;
      const el = cellElByKey.get(k);
      if(!el) return;
      const v = Math.max(0, Math.min(3, Number(st||0)));
      el.classList.remove("s0","s1","s2","s3");
      el.classList.add("s"+v);
    }

    function parseCellKey(k){
      k = String(k||"").trim();
      let m;
      if((m = k.match(/^(\d+)[,_:\-|](\d+)$/))) return { r:+m[1], c:+m[2] };
      if((m = k.match(/^r(\d+)c(\d+)$/i))) return { r:+m[1], c:+m[2] };
      return null;
    }

    function resetAllCells(){
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          setCellStateByRC(r,c,0);
        }
      }
    }

    // Map images (root) – tries common names automatically
    function candidatesForMapIndex(idx){
      const i0 = Number(idx)||0;
      const i1 = i0 + 1; // in case your files start from 1
      const ext = ["png","webp","jpg","jpeg"];

      const out = [];
      for(const e of ext){
        out.push(`map${i0}.${e}`, `map_${i0}.${e}`, `map-${i0}.${e}`);
        out.push(`map${i1}.${e}`, `map_${i1}.${e}`, `map-${i1}.${e}`);
      }
      // also allow generic names
      out.push("map.png","map.webp","map.jpg");
      return [...new Set(out)];
    }

    function loadImageTry(src){
      return new Promise((resolve) => {
        const im = new Image();
        const t = setTimeout(()=>resolve(false), 900);
        im.onload = ()=>{ clearTimeout(t); resolve(true); };
        im.onerror = ()=>{ clearTimeout(t); resolve(false); };
        im.src = src + (src.includes("?")?"&":"?") + "_tv=" + Date.now();
      });
    }

    async function setMapImage(activeMap){
      const list = candidatesForMapIndex(activeMap);
      for(const src of list){
        try{
          const ok = await loadImageTry("./" + src);
          if(ok){
            mapImg.src = "./" + src;
            return true;
          }
        }catch(e){}
      }
      return false;
    }

    // Celebration (خفيف) على زيادة النقاط
    let lastG = 0, lastO = 0;
    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type="triangle";
        o.frequency.value = 520;
        g.gain.value = 0.06;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 160);
      }catch(e){}
    }
    function celebrate(){
      beep();
      // (بسيطة جداً) وميض خفيف في الشريط
      document.body.animate([{filter:"brightness(1.0)"},{filter:"brightness(1.08)"},{filter:"brightness(1.0)"}], {duration:450});
    }

    // Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let CODE = "";
    let roomBase = "";
    let unsubs = [];
    let mapUnsubs = [];
    let lockTimer = null;

    function clearAll(){
      try{ unsubs.forEach(fn=>fn&&fn()); }catch(e){}
      try{ mapUnsubs.forEach(fn=>fn&&fn()); }catch(e){}
      unsubs = [];
      mapUnsubs = [];
      if(lockTimer){ clearInterval(lockTimer); lockTimer=null; }
    }

    function showErr(msg){
      errBox.textContent = msg;
      errBox.style.display = "block";
    }
    function hideErr(){
      errBox.textContent = "";
      errBox.style.display = "none";
    }

    async function claimTvLock(code){
      const id = tvId();
      const lockRef = ref(db, `rooms/${code}/tvLock`);
      const now = Date.now();
      const TTL = 60 * 1000; // 60s

      const tx = await runTransaction(lockRef, (cur) => {
        if(cur == null) return { id, lastSeen: now };
        const curId = cur?.id;
        const curSeen = Number(cur?.lastSeen || 0);

        if(curId === id) return { id, lastSeen: now }; // refresh
        if(!curSeen || (now - curSeen) > TTL) return { id, lastSeen: now }; // takeover if stale
        return; // abort
      }, { applyLocally:false });

      if(!tx.committed) return false;

      try{
        const od = onDisconnect(lockRef);
        od.remove();
      }catch(e){}

      // heartbeat
      lockTimer = setInterval(() => {
        update(lockRef, { lastSeen: Date.now() }).catch(()=>{});
      }, 25000);

      return true;
    }

    function attachMapDeltaListeners(mapIndex){
      // remove previous
      try{ mapUnsubs.forEach(fn=>fn&&fn()); }catch(e){}
      mapUnsubs = [];

      const path = `${roomBase}/mapStates/${String(mapIndex)}`;

      // initial one-time snapshot (مرة وحدة)
      resetAllCells();
      get(ref(db, path)).then((snap)=>{
        const obj = snap.val() || {};
        for(const [k,v] of Object.entries(obj)){
          const rc = parseCellKey(k);
          if(rc) setCellStateByRC(rc.r, rc.c, v);
        }
      }).catch(()=>{});

      // delta updates (أقل تكلفة)
      mapUnsubs.push(onChildAdded(ref(db, path), (s)=>{
        const rc = parseCellKey(s.key);
        if(rc) setCellStateByRC(rc.r, rc.c, s.val());
      }));

      mapUnsubs.push(onChildChanged(ref(db, path), (s)=>{
        const rc = parseCellKey(s.key);
        if(rc) setCellStateByRC(rc.r, rc.c, s.val());
      }));

      mapUnsubs.push(onChildRemoved(ref(db, path), (s)=>{
        const rc = parseCellKey(s.key);
        if(rc) setCellStateByRC(rc.r, rc.c, 0);
      }));
    }

    async function start(code){
      clearAll();
      hideErr();

      CODE = cleanCode(code);
      if(CODE.length !== 6){
        showErr("اكتب رمز غرفة صحيح (6 أرقام)");
        return;
      }

      roomBase = `rooms/${CODE}`;
      statusLine.textContent = "جاري الاتصال...";

      // ✅ قفل TV واحد فقط
      const okLock = await claimTvLock(CODE);
      if(!okLock){
        showErr("يوجد جهاز عرض تلفاز آخر داخل هذه الغرفة بالفعل.");
        return;
      }

      backdrop.style.display = "none";

      // build overlay once
      buildGrid();

      // room name
      unsubs.push(onValue(ref(db, `${roomBase}/name`), (s)=>{
        const v = (s.val() || "").toString().trim();
        gameNameEl.textContent = v ? v : "—";
      }));

      // scores
      unsubs.push(onValue(ref(db, `${roomBase}/scores`), (s)=>{
        const sc = s.val() || { green:0, orange:0 };
        const g = Number(sc.green||0);
        const o = Number(sc.orange||0);
        scoreGreenEl.textContent = String(Number.isFinite(g)?g:0);
        scoreOrangeEl.textContent = String(Number.isFinite(o)?o:0);

        // احتفالية خفيفة عند زيادة النقاط
        if((g > lastG) || (o > lastO)) celebrate();
        lastG = g; lastO = o;
      }));

      // room status
      unsubs.push(onValue(ref(db, `${roomBase}/status`), (s)=>{
        const v = s.val();
        if(v === null) statusLine.textContent = "الغرفة غير موجودة";
        else statusLine.textContent = (v === "started") ? "اللعبة بدأت" : "في اللوبي";
      }, ()=>{
        statusLine.textContent = "تعذر الاتصال";
      }));

      // active map -> set image + delta map states
      unsubs.push(onValue(ref(db, `${roomBase}/activeMap`), async (s)=>{
        const m = Number(s.val() || 0);
        const ok = await setMapImage(m);
        if(!ok){
          statusLine.textContent = "لم يتم العثور على ملفات الخرائط في جذر المستودع";
        }
        attachMapDeltaListeners(m);
      }));

      // store last code
      try{ localStorage.setItem("sandooq_tv_last_code", CODE); }catch(e){}
    }

    // init
    (function(){
      const qs = new URLSearchParams(location.search);
      const codeFromUrl = cleanCode(qs.get("code") || "");

      if(codeFromUrl.length === 6){
        start(codeFromUrl);
        return;
      }

      // fallback: last code or modal
      let last = "";
      try{ last = cleanCode(localStorage.getItem("sandooq_tv_last_code") || ""); }catch(e){}
      codeInput.value = (last && last.length===6) ? last : "";
      backdrop.style.display = "flex";
    })();

    startBtn.addEventListener("click", ()=> start(codeInput.value));
    codeInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") start(codeInput.value); });
  </script>

  <!-- VERSION: tv.html — vTV-MapOnly-2 -->
</body>
</html>
