<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>عرض التلفاز - سباق الحروف</title>

  <!-- ✅ تسريع تحميل Firebase -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//www.gstatic.com">

  <!-- ✅ (اختياري) تسجيل SW بدري مثل باقي الصفحات -->
  <script>
  (function(){
    try{
      if(!("serviceWorker" in navigator)) return;
      if(!window.isSecureContext && location.hostname !== "localhost") return;
      var ASSET_VERSION = "2026-02-18-2";
      var vq = "?v=" + encodeURIComponent(ASSET_VERSION);
      navigator.serviceWorker
        .register("./sw.js" + vq, { scope: "./" })
        .then(function(reg){ try{ reg && reg.update && reg.update(); }catch(e){} })
        .catch(function(){});
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bg:#7b1f63;
      --bg2:#5f214f;
      --yellow:#f4c400;
      --txt:#fff;
      --muted:rgba(255,255,255,.78);
      --shadow:0 18px 55px rgba(0,0,0,.35);

      --green:#16a34a;
      --orange:#f28c00;

      --cell0:#ffffff;
      --cell1:#f4c400;
      --cell2:#16a34a;
      --cell3:#f28c00;
      --cellStroke: rgba(0,0,0,.28);
    }

    @font-face{
      font-family:"AA-GALAXY";
      src:url("AA-GALAXY.otf") format("opentype");
      font-display:swap;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 650px at 80% 70%, rgba(255,255,255,.07), transparent 55%),
        linear-gradient(135deg, var(--bg), var(--bg2));
      color:var(--txt);
      font-family:"AA-GALAXY", system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      overflow:hidden;
    }

    /* Top bar */
    .topbar{
      height:74px;
      display:grid;
      grid-template-columns: 120px 1fr auto;
      align-items:center;
      padding:10px 14px;
      gap:10px;
    }

    .logo{
      width:56px;height:56px;object-fit:contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.28));
      user-select:none; pointer-events:none;
      justify-self:start;
    }

    .gameName{
      text-align:center;
      font-size:34px;
      color:#fff;
      text-shadow:0 12px 22px rgba(0,0,0,.28);
      letter-spacing:.3px;
      line-height:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:0 6px;
    }

    .rightBox{
      display:flex;
      align-items:center;
      gap:10px;
      justify-self:end;
      flex-wrap:nowrap;
    }

    .scores{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .scoreChip{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: 0 14px 32px rgba(0,0,0,.20);
      min-width: 132px;
      justify-content:center;
    }
    .scoreChip .label{
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
      font-size:14px;
      color:rgba(255,255,255,.86);
      white-space:nowrap;
    }
    .scoreChip .num{
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:1000;
      font-size:28px;
      line-height:1;
      min-width: 22px;
      text-align:center;
    }
    .scoreChip.green .num{ color: var(--green); }
    .scoreChip.orange .num{ color: var(--orange); }

    .zoomWrap{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      box-shadow: 0 14px 32px rgba(0,0,0,.20);
      user-select:none;
    }
    .zoomWrap .zLabel{
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
      font-size:13px;
      color:rgba(255,255,255,.86);
      white-space:nowrap;
    }
    input[type="range"]{
      width:180px;
      accent-color: var(--yellow);
    }

    /* Map area */
    .main{
      height: calc(100vh - 74px);
      padding: 8px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .panel{
      flex:1;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }

    .statusLine{
      position:absolute;
      right:12px;
      bottom:10px;
      font-size:12px;
      color: rgba(255,255,255,.78);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      user-select:none;
      text-shadow: 0 10px 18px rgba(0,0,0,.25);
    }

    .mapStage{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
      overflow:hidden; /* ✅ الزوم ما يغطي التوب بار */
    }

    .mapWrap{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      transform: scale(var(--zoom, 1));
      transform-origin: center center;
      will-change: transform;
    }

    svg{
      width: min(1200px, 100%);
      height: min(780px, 100%);
      display:block;
    }

    .cell{ stroke: var(--cellStroke); stroke-width: 2.2; }
    .s0{ fill: var(--cell0); }
    .s1{ fill: var(--cell1); }
    .s2{ fill: var(--cell2); }
    .s3{ fill: var(--cell3); }

    .letter{
      font-family:"AA-GALAXY", system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-size:34px;
      font-weight:900;
      fill:#111;
      dominant-baseline: middle;
      text-anchor: middle;
      pointer-events:none;
    }

    /* Gate (no code / lock) */
    .gate{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .gateCard{
      width:min(560px, 96vw);
      background: rgba(20, 8, 25, .92);
      border:1px solid rgba(255,255,255,.16);
      border-radius:18px;
      padding:16px 14px 14px;
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      text-align:center;
    }
    .gTitle{
      margin:6px 0 8px;
      font-size:22px;
      color:var(--yellow);
    }
    .gHint{
      margin:0 0 12px;
      color:rgba(255,255,255,.82);
      font-size:13px;
      line-height:1.7;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
    }
    .gRow{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .gIn{
      width: min(360px, 90vw);
      height:54px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      color:#fff;
      padding:0 14px;
      font-size:18px;
      outline:none;
      text-align:center;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
      letter-spacing:2px;
      direction:ltr;
    }
    .gBtn{
      width: min(360px, 90vw);
      height:56px;
      border:none;
      border-radius:16px;
      background: var(--yellow);
      color:#111;
      font-size:18px;
      font-weight:1000;
      cursor:pointer;
      margin-top:10px;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .gErr{
      display:none;
      margin-top:10px;
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#7a1a1a;
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
      text-align:center;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-weight:900;
    }

    /* Confetti canvas */
    #fx{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:1000;
    }

    @media (max-width: 860px){
      .topbar{ grid-template-columns: 70px 1fr auto; height:78px; }
      input[type="range"]{ width:140px; }
      .gameName{ font-size:28px; }
      .scoreChip{ min-width:120px; padding:8px 10px; }
      .scoreChip .num{ font-size:24px; }
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>

  <div class="topbar">
    <img class="logo" src="logo.png" alt="شعار صندوق المسابقات" onerror="this.style.display='none'">
    <div class="gameName" id="gameName">—</div>

    <div class="rightBox">
      <div class="zoomWrap">
        <div class="zLabel">تكبير</div>
        <input id="zoom" type="range" min="80" max="140" step="2" value="100" aria-label="تكبير الخريطة">
      </div>

      <div class="scores">
        <div class="scoreChip orange">
          <div class="label">البرتقالي</div>
          <div class="num" id="scoreOrange">0</div>
        </div>
        <div class="scoreChip green">
          <div class="label">الأخضر</div>
          <div class="num" id="scoreGreen">0</div>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="panel">
      <div class="mapStage">
        <div class="mapWrap" id="mapWrap">
          <svg id="mapSvg" viewBox="0 0 1000 700" aria-label="خريطة الخلايا"></svg>
        </div>
      </div>
      <div class="statusLine" id="statusLine">جاري الاتصال...</div>
    </div>
  </div>

  <!-- Gate -->
  <div class="gate" id="gate" style="display:none">
    <div class="gateCard">
      <div class="gTitle" id="gTitle">عرض التلفاز</div>
      <p class="gHint" id="gHint">افتح الرابط من زر "عرض التلفاز" عند المقدم (أو اكتب رمز الغرفة هنا).</p>

      <div class="gRow">
        <input class="gIn" id="codeInput" maxlength="6" inputmode="numeric" placeholder="رمز الغرفة (6 أرقام)">
      </div>

      <button class="gBtn" id="startBtn">ابدأ العرض</button>
      <div class="gErr" id="gErr"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getDatabase, ref,
      onValue, onChildAdded, onChildChanged, onChildRemoved,
      runTransaction, onDisconnect
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    // ===== Helpers
    function normalizeDigits(s){
      const map = {
        "٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9",
        "۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9"
      };
      return String(s || "").replace(/[٠-٩۰-۹]/g, d => map[d] ?? d);
    }
    function cleanCode(s){ return normalizeDigits(s).replace(/\D/g, "").slice(0,6); }

    function ensureTvDeviceId(){
      const k = "sandooq_tv_device_id_v1";
      let id = "";
      try{ id = localStorage.getItem(k) || ""; }catch(e){}
      if(!id){
        try{ id = (crypto?.randomUUID ? crypto.randomUUID() : ("tv_" + Math.random().toString(16).slice(2) + Date.now().toString(16))); }catch(e){
          id = "tv_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
        }
        try{ localStorage.setItem(k, id); }catch(e){}
      }
      return id;
    }

    // ===== UI refs
    const gameNameEl = document.getElementById("gameName");
    const scoreGreenEl = document.getElementById("scoreGreen");
    const scoreOrangeEl = document.getElementById("scoreOrange");
    const statusLine = document.getElementById("statusLine");

    const zoomEl = document.getElementById("zoom");
    const mapWrap = document.getElementById("mapWrap");

    const gate = document.getElementById("gate");
    const codeInput = document.getElementById("codeInput");
    const startBtn = document.getElementById("startBtn");
    const gErr = document.getElementById("gErr");
    const gTitle = document.getElementById("gTitle");
    const gHint = document.getElementById("gHint");

    function showGate(title, hint, err){
      gTitle.textContent = title || "عرض التلفاز";
      gHint.textContent = hint || "افتح الرابط من زر عرض التلفاز عند المقدم.";
      if(err){
        gErr.textContent = err;
        gErr.style.display = "block";
      }else{
        gErr.textContent = "";
        gErr.style.display = "none";
      }
      gate.style.display = "flex";
    }
    function hideGate(){ gate.style.display = "none"; }

    // ===== Zoom (محلي) — بدون Firebase
    function loadZoom(code){
      try{
        const k = "sandooq_tv_zoom_v1_" + code;
        const v = Number(localStorage.getItem(k));
        if(Number.isFinite(v) && v>=80 && v<=140) return v;
      }catch(e){}
      return 100;
    }
    function saveZoom(code, v){
      try{
        const k = "sandooq_tv_zoom_v1_" + code;
        localStorage.setItem(k, String(v));
      }catch(e){}
    }
    function applyZoom(v){
      const z = Math.max(80, Math.min(140, Number(v) || 100));
      mapWrap.style.setProperty("--zoom", String(z/100));
    }

    // ===== Map drawing (5x5 hex + حروف)
    const mapSvg = document.getElementById("mapSvg");
    const CELLS = new Map();      // key -> polygon
    const LETTERS = new Map();    // key -> text
    const LETTER_GRID = [
      ["ش","أ","ث","د","هـ"],
      ["ي","ح","ض","ن","ك"],
      ["غ","ظ","ق","ر","ع"],
      ["ص","ز","س","ط","و"],
      ["ذ","ل","ب","م","ج"]
    ];

    function hexPointsPointyTop(cx, cy, r){
      const pts = [];
      for(let i=0;i<6;i++){
        const ang = (Math.PI/180) * (60*i - 30);
        pts.push((cx + r*Math.cos(ang)).toFixed(2) + "," + (cy + r*Math.sin(ang)).toFixed(2));
      }
      return pts.join(" ");
    }

    function cellKey(r,c){ return `${r}_${c}`; }

    function buildGrid(){
      mapSvg.innerHTML = "";
      CELLS.clear(); LETTERS.clear();

      const W=1000, H=700;
      mapSvg.setAttribute("viewBox", `0 0 ${W} ${H}`);

      const rows=5, cols=5;
      const r = 74;                    // حجم الخلية
      const dx = r * Math.sqrt(3);
      const dy = r * 1.5;

      const gridW = (cols-1)*dx + dx;
      const gridH = (rows-1)*dy + (2*r);

      const x0 = (W - gridW)/2 + (dx/2);
      const y0 = (H - gridH)/2 + r;

      const svgNS="http://www.w3.org/2000/svg";

      for(let row=0; row<rows; row++){
        for(let col=0; col<cols; col++){
          const cx = x0 + col*dx + ((row%2) ? (dx/2) : 0);
          const cy = y0 + row*dy;

          const poly = document.createElementNS(svgNS, "polygon");
          poly.setAttribute("points", hexPointsPointyTop(cx, cy, r));
          poly.classList.add("cell","s0");
          const k = cellKey(row,col);
          mapSvg.appendChild(poly);
          CELLS.set(k, poly);

          const t = document.createElementNS(svgNS, "text");
          t.setAttribute("x", String(cx));
          t.setAttribute("y", String(cy));
          t.classList.add("letter");
          t.textContent = (LETTER_GRID[row] && LETTER_GRID[row][col]) ? LETTER_GRID[row][col] : "—";
          mapSvg.appendChild(t);
          LETTERS.set(k, t);
        }
      }
    }

    function setCellVisual(k, st){
      const el = CELLS.get(k);
      const tt = LETTERS.get(k);
      if(!el) return;

      const s = Math.max(0, Math.min(3, Number(st) || 0));
      el.classList.remove("s0","s1","s2","s3");
      el.classList.add("s"+s);

      // لون حرف مناسب
      if(tt){
        if(s === 2 || s === 3) tt.style.fill = "#fff";
        else tt.style.fill = "#111";
      }
    }

    function clearAllCells(){
      for(const k of CELLS.keys()) setCellVisual(k, 0);
    }

    function parseCellKey(key){
      const s = String(key || "");
      let m = s.match(/^(\d+)[_\-,|:](\d+)$/);
      if(m) return { r:+m[1], c:+m[2], k: cellKey(+m[1], +m[2]) };
      m = s.match(/r(\d+)c(\d+)/i);
      if(m) return { r:+m[1], c:+m[2], k: cellKey(+m[1], +m[2]) };
      return null;
    }

    // ===== Confetti + Sound (احتفالية)
    const fx = document.getElementById("fx");
    const ctx = fx.getContext("2d");
    let fxW=0, fxH=0;
    function resizeFx(){
      fxW = fx.width = window.innerWidth;
      fxH = fx.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeFx);
    resizeFx();

    let lastCelebrateAt = 0;
    function playWinSound(){
      try{
        const AC = window.AudioContext || window.webkitAudioContext;
        if(!AC) return;
        const ac = new AC();
        const now = ac.currentTime;

        const notes = [523.25, 659.25, 783.99]; // C5 E5 G5
        notes.forEach((f, i) => {
          const o = ac.createOscillator();
          const g = ac.createGain();
          o.type = "triangle";
          o.frequency.value = f;
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.12, now + 0.02 + i*0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.30 + i*0.05);
          o.connect(g).connect(ac.destination);
          o.start(now + i*0.02);
          o.stop(now + 0.40 + i*0.05);
        });

        setTimeout(()=>{ try{ ac.close(); }catch(e){} }, 900);
      }catch(e){}
    }

    function celebrate(team){
      const t = Date.now();
      if(t - lastCelebrateAt < 900) return; // منع سبام
      lastCelebrateAt = t;

      playWinSound();

      const color = (team === "green") ? "#16a34a" : (team === "orange" ? "#f28c00" : "#f4c400");
      const pieces = [];
      const N = 140;

      for(let i=0;i<N;i++){
        pieces.push({
          x: fxW/2 + (Math.random()*160 - 80),
          y: fxH*0.18 + (Math.random()*60),
          vx: (Math.random()*6 - 3),
          vy: (Math.random()*-7 - 2),
          g: 0.18 + Math.random()*0.10,
          r: 3 + Math.random()*4,
          a: 0.9,
          rot: Math.random()*Math.PI,
          vr: (Math.random()*0.18 - 0.09),
          c: (Math.random()<0.65) ? color : "#ffffff"
        });
      }

      const start = performance.now();
      const dur = 1600;

      function tick(now){
        const dt = now - start;
        ctx.clearRect(0,0,fxW,fxH);

        for(const p of pieces){
          p.vy += p.g;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.a = Math.max(0, 0.95 - dt/dur);

          ctx.save();
          ctx.globalAlpha = p.a;
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.c;
          ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
          ctx.restore();
        }

        if(dt < dur) requestAnimationFrame(tick);
        else ctx.clearRect(0,0,fxW,fxH);
      }
      requestAnimationFrame(tick);
    }

    // ===== Firebase (قراءة + قفل TV جهاز واحد)
    let app=null, db=null;
    let CODE="";
    let roomBase="";
    let activeMap=0;

    let unsubMain = [];
    let unsubMap = [];
    function clearUnsubs(arr){
      try{ arr.forEach(u=>{ try{ u && u(); }catch(e){} }); }catch(e){}
      arr.length = 0;
    }

    async function claimTvLock(code){
      const deviceId = ensureTvDeviceId();
      const lockRef = ref(db, `rooms/${code}/tvLock`);

      // allow takeover only if ?force=1
      const force = (new URLSearchParams(location.search).get("force") === "1");

      const res = await runTransaction(lockRef, (cur) => {
        if(cur == null) return { deviceId, claimedAt: Date.now() };

        if(cur && cur.deviceId === deviceId) return cur;

        if(force) return { deviceId, claimedAt: Date.now() };

        return; // abort
      }, { applyLocally:false });

      if(!res.committed){
        return { ok:false, reason:"locked" };
      }

      // ✅ يفك القفل تلقائي إذا انقطع الاتصال
      try{ onDisconnect(lockRef).remove(); }catch(e){}
      return { ok:true, deviceId };
    }

    let lastScores = { green:0, orange:0 };

    function applyScores(v){
      const g = Number(v?.green ?? 0);
      const o = Number(v?.orange ?? 0);

      const gg = Number.isFinite(g) ? g : 0;
      const oo = Number.isFinite(o) ? o : 0;

      scoreGreenEl.textContent = String(gg);
      scoreOrangeEl.textContent = String(oo);

      // ✅ احتفالية عند زيادة النقاط
      if(gg > lastScores.green) celebrate("green");
      if(oo > lastScores.orange) celebrate("orange");
      lastScores = { green: gg, orange: oo };
    }

    function attachMapDeltaListeners(mapIndex){
      clearUnsubs(unsubMap);
      activeMap = Number(mapIndex || 0) || 0;

      clearAllCells();

      // ✅ أهم نقطة: تحديث خلية واحدة (onChildChanged) بدل قراءة كل الخريطة onValue
      const msRef = ref(db, `${roomBase}/mapStates/${String(activeMap)}`);

      unsubMap.push(onChildAdded(msRef, (snap) => {
        const p = parseCellKey(snap.key);
        if(!p) return;
        setCellVisual(p.k, snap.val());
      }));

      unsubMap.push(onChildChanged(msRef, (snap) => {
        const p = parseCellKey(snap.key);
        if(!p) return;
        setCellVisual(p.k, snap.val());
      }));

      unsubMap.push(onChildRemoved(msRef, (snap) => {
        const p = parseCellKey(snap.key);
        if(!p) return;
        setCellVisual(p.k, 0);
      }));
    }

    async function startTV(code){
      CODE = cleanCode(code);
      if(CODE.length !== 6){
        showGate("عرض التلفاز", "اكتب رمز الغرفة الصحيح.", "رمز الغرفة لازم يكون 6 أرقام");
        return;
      }

      hideGate();
      statusLine.textContent = "جاري الاتصال...";

      if(!db){
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
      }

      roomBase = `rooms/${CODE}`;

      // ابني الخريطة مرة وحدة
      if(CELLS.size === 0) buildGrid();

      // Zoom load
      const z = loadZoom(CODE);
      zoomEl.value = String(z);
      applyZoom(z);

      // ✅ قفل TV (جهاز واحد فقط)
      const lock = await claimTvLock(CODE);
      if(!lock.ok){
        showGate(
          "عرض التلفاز مستخدم",
          "فيه جهاز عرض ثاني شغال لنفس الغرفة. إذا تبي تستحوذ عليه: افتح الرابط مع ?force=1",
          "غير مسموح بأكثر من جهاز عرض واحد لهذه الغرفة"
        );
        return;
      }

      // listeners
      clearUnsubs(unsubMain);

      unsubMain.push(onValue(ref(db, `${roomBase}/name`), (s) => {
        const n = (s.val() || "").toString().trim();
        gameNameEl.textContent = n ? n : "سباق الحروف";
      }));

      unsubMain.push(onValue(ref(db, `${roomBase}/scores`), (s) => {
        applyScores(s.val() || {green:0, orange:0});
      }));

      unsubMain.push(onValue(ref(db, `${roomBase}/status`), (s) => {
        const v = s.val();
        if(v == null) statusLine.textContent = "الغرفة غير موجودة";
        else statusLine.textContent = (v === "started") ? "اللعبة بدأت" : "في اللوبي";
      }, () => {
        statusLine.textContent = "تعذر الاتصال";
      }));

      unsubMain.push(onValue(ref(db, `${roomBase}/activeMap`), (s) => {
        const m = Number(s.val() || 0) || 0;
        attachMapDeltaListeners(m);
      }));

      // حفظ آخر كود
      try{ localStorage.setItem("sandooq_tv_last_code", CODE); }catch(e){}
    }

    // Zoom interactions
    zoomEl.addEventListener("input", () => {
      const v = Number(zoomEl.value || 100);
      applyZoom(v);
      if(CODE) saveZoom(CODE, v);
    });

    // Gate start
    startBtn.addEventListener("click", () => {
      startTV(codeInput.value || "");
    });

    // init
    (function init(){
      const qs = new URLSearchParams(location.search);
      const codeFromUrl = cleanCode(qs.get("code") || "");

      if(codeFromUrl && codeFromUrl.length === 6){
        startTV(codeFromUrl);
        return;
      }

      // fallback: show gate
      let last = "";
      try{ last = cleanCode(localStorage.getItem("sandooq_tv_last_code") || ""); }catch(e){}
      showGate("عرض التلفاز", "اكتب رمز الغرفة هنا أو افتح رابط العرض من المقدم.", "");
      if(last && last.length === 6) codeInput.value = last;
    })();
  </script>

  <!-- VERSION: tv.html — vTV-MapOnly-DeltaLock-2 -->
</body>
</html>
