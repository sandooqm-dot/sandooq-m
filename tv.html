<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>عرض التلفاز - سباق الحروف</title>

  <!-- تقليل الكاش قدر الإمكان -->
  <meta http-equiv="Cache-Control" content="no-store, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- ✅ تسريع تحميل Firebase -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//www.gstatic.com">

  <style>
    :root{
      --bg:#7b1f63;
      --yellow:#f4c400;
      --white:#fff;
      --muted: rgba(255,255,255,.78);
      --shadow: 0 16px 40px rgba(0,0,0,.28);

      --green:#16a34a;
      --orange:#f28c00;

      --cell0:#ffffff;
      --cell1:#f4c400;
      --cell2:#16a34a;
      --cell3:#f28c00;
      --cellStroke: rgba(0,0,0,.28);
    }

    @font-face{
      font-family:"AA-GALAXY";
      src:url("AA-GALAXY.otf") format("opentype");
      font-display:swap;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      background: var(--bg);
      color:#fff;
      font-family:"AA-GALAXY", Arial, sans-serif;
      overflow:hidden;
    }

    /* ===== Top Bar ===== */
    .topbar{
      height:74px;
      padding:10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:120px;
    }
    .logo{
      width:44px;height:44px;object-fit:contain;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.25));
      user-select:none; pointer-events:none;
    }

    .centerTitle{
      flex:1;
      display:flex;
      justify-content:center;
      align-items:center;
      min-width:0;
    }
    .gameName{
      max-width:min(720px, 70vw);
      padding:10px 16px;
      border-radius:16px;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      color: var(--yellow);
      font-size:26px;
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .rightTools{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:280px;
      justify-content:flex-end;
    }

    .scores{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      min-width:140px;
      justify-content:space-between;
      font-family: Arial, sans-serif;
      font-weight:900;
    }
    .pill .n{ font-size:22px; line-height:1; }
    .pill.green .n{ color: var(--green); }
    .pill.orange .n{ color: var(--orange); }
    .pill .t{
      font-size:14px;
      color: rgba(255,255,255,.92);
      font-weight:900;
      white-space:nowrap;
    }

    .zoomWrap{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      font-family: Arial, sans-serif;
      font-weight:900;
    }
    .zoomWrap label{
      font-size:13px;
      color: rgba(255,255,255,.92);
      white-space:nowrap;
    }
    input[type="range"]{
      width:160px;
    }

    /* ===== Map Area ===== */
    main{
      height: calc(100vh - 74px);
      padding:10px 14px 16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .mapStage{
      width: min(1200px, 96vw);
      height: min(780px, calc(100vh - 110px));
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* هذا هو “الصندوق” اللي نكبره/نصغره بس بدون ما يلمس الهيدر */
    .mapCanvas{
      --zoom: 1;
      width:100%;
      height:100%;
      position:relative;
      transform: scale(var(--zoom));
      transform-origin: top center;
    }

    /* صورة الخريطة (من جذر المستودع) */
    .mapBg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      user-select:none;
      pointer-events:none;
    }

    /* SVG الخلايا فوق الصورة */
    .mapSvg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    .cellPoly{
      stroke: var(--cellStroke);
      stroke-width: 2;
      vector-effect: non-scaling-stroke;
    }
    .s0{ fill: var(--cell0); }
    .s1{ fill: var(--cell1); }
    .s2{ fill: var(--cell2); }
    .s3{ fill: var(--cell3); }

    .cellText{
      font-family: Arial, sans-serif;
      font-weight:900;
      fill:#111;
      text-anchor: middle;
      dominant-baseline: middle;
      user-select:none;
    }

    .status{
      position:absolute;
      right:10px;
      bottom:8px;
      font-family: Arial, sans-serif;
      font-size:12px;
      color: rgba(255,255,255,.78);
      text-shadow: 0 10px 18px rgba(0,0,0,.35);
      user-select:none;
    }

    /* ===== Setup / Blocked Overlays ===== */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(520px, 94vw);
      background: rgba(20, 8, 25, .92);
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;
      padding:16px 14px;
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      text-align:center;
    }
    .mTitle{
      margin:4px 0 10px;
      font-size:22px;
      color:var(--yellow);
    }
    .mHint{
      font-family: Arial, sans-serif;
      color:rgba(255,255,255,.82);
      font-size:13px;
      line-height:1.7;
      margin:0 0 12px;
    }
    .in{
      width: min(360px, 90vw);
      height:54px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      color:#fff;
      padding:0 14px;
      font-size:18px;
      outline:none;
      text-align:center;
      font-family: Arial, sans-serif;
      font-weight:900;
      letter-spacing:2px;
      direction:ltr;
    }
    .btn{
      width: min(360px, 90vw);
      height:56px;
      border:none;
      border-radius:16px;
      background: var(--yellow);
      color:#111;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      margin-top:12px;
      font-family: Arial, sans-serif;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .err{
      display:none;
      margin-top:10px;
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#7a1a1a;
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
      text-align:center;
      font-family: Arial, sans-serif;
      font-weight:900;
    }

    @media (max-width: 820px){
      .topbar{ height:auto; padding:10px 10px; flex-wrap:wrap; }
      .rightTools{ min-width:unset; width:100%; justify-content:center; }
      main{ height: calc(100vh - 120px); }
      input[type="range"]{ width:140px; }
      .gameName{ font-size:22px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <img class="logo" src="logo.png" alt="شعار صندوق المسابقات" onerror="this.style.display='none'">
    </div>

    <div class="centerTitle">
      <div class="gameName" id="gameName">—</div>
    </div>

    <div class="rightTools">
      <div class="scores">
        <div class="pill green">
          <span class="t">الأخضر</span>
          <span class="n" id="scoreGreen">0</span>
        </div>
        <div class="pill orange">
          <span class="t">البرتقالي</span>
          <span class="n" id="scoreOrange">0</span>
        </div>
      </div>

      <div class="zoomWrap">
        <label for="zoomRange">تكبير</label>
        <input id="zoomRange" type="range" min="85" max="130" value="100">
      </div>
    </div>
  </header>

  <main>
    <div class="mapStage">
      <div class="mapCanvas" id="mapCanvas">
        <img class="mapBg" id="mapBg" alt="الخريطة">
        <svg class="mapSvg" id="mapSvg" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet" aria-label="خريطة الخلايا"></svg>
      </div>
      <div class="status" id="statusLine">—</div>
    </div>
  </main>

  <!-- Setup overlay -->
  <div class="overlay" id="setupOverlay" style="display:none">
    <div class="modal">
      <div class="mTitle">عرض التلفاز</div>
      <p class="mHint">اكتب رمز الغرفة (6 أرقام) ثم ابدأ العرض.</p>
      <input class="in" id="codeInput" maxlength="6" inputmode="numeric" placeholder="رمز الغرفة">
      <button class="btn" id="startBtn">ابدأ العرض</button>
      <div class="err" id="setupErr"></div>
    </div>
  </div>

  <!-- Blocked overlay -->
  <div class="overlay" id="blockedOverlay" style="display:none">
    <div class="modal">
      <div class="mTitle">عرض التلفاز مستخدم</div>
      <p class="mHint" id="blockedMsg">عرض التلفاز مفتوح على جهاز آخر لنفس الغرفة.</p>
      <button class="btn" id="reloadBtn">إعادة المحاولة</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getDatabase, ref, onValue, onChildAdded, onChildChanged, onChildRemoved,
      runTransaction, onDisconnect, get
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const ASSET_VERSION = "2026-02-18-2";

    // ✅ كسر كاش رابط tv تلقائيًا (مرة وحدة)
    (function ensureV(){
      try{
        const u = new URL(location.href);
        if(!u.searchParams.get("v")){
          u.searchParams.set("v", ASSET_VERSION);
          location.replace(u.toString());
        }
      }catch(e){}
    })();

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    function normalizeDigits(s){
      const map = {
        "٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9",
        "۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9"
      };
      return String(s || "").replace(/[٠-٩۰-۹]/g, d => map[d] ?? d);
    }
    function cleanCode(s){
      return normalizeDigits(s).replace(/\D/g, "").slice(0,6);
    }

    function ensureDeviceId(){
      const key = "sandooq_device_id_v1";
      let id = "";
      try{ id = localStorage.getItem(key) || ""; }catch(e){}
      if(!id){
        try{
          id = (crypto?.randomUUID ? crypto.randomUUID() : ("tv_" + Math.random().toString(16).slice(2) + Date.now().toString(16)));
        }catch(e){
          id = ("tv_" + Math.random().toString(16).slice(2) + Date.now().toString(16));
        }
        try{ localStorage.setItem(key, id); }catch(e){}
      }
      return id;
    }

    // UI
    const gameNameEl = document.getElementById("gameName");
    const scoreGreenEl = document.getElementById("scoreGreen");
    const scoreOrangeEl = document.getElementById("scoreOrange");
    const zoomRange = document.getElementById("zoomRange");
    const mapCanvas = document.getElementById("mapCanvas");
    const mapBg = document.getElementById("mapBg");
    const mapSvg = document.getElementById("mapSvg");
    const statusLine = document.getElementById("statusLine");

    const setupOverlay = document.getElementById("setupOverlay");
    const codeInput = document.getElementById("codeInput");
    const startBtn = document.getElementById("startBtn");
    const setupErr = document.getElementById("setupErr");

    const blockedOverlay = document.getElementById("blockedOverlay");
    const reloadBtn = document.getElementById("reloadBtn");

    // Zoom
    zoomRange.addEventListener("input", () => {
      const v = Number(zoomRange.value || 100);
      const z = Math.max(0.85, Math.min(1.30, v/100));
      mapCanvas.style.setProperty("--zoom", String(z));
    });

    // Letters layout (مثل الصورة)
    const LETTERS = [
      ["ش","أ","ث","د","هـ"],
      ["ي","ح","ض","ن","ك"],
      ["غ","ظ","ق","ر","ع"],
      ["هـ","ز","س","ط","و"],
      ["ذ","ل","ب","م","ج"]
    ];

    // Cells refs
    const CELL_POLY = Array.from({length:5}, ()=>Array.from({length:5}, ()=>null));

    function hexPointsPointyTop(cx, cy, r){
      const pts = [];
      for(let i=0;i<6;i++){
        const ang = (Math.PI/180) * (60*i - 30);
        const x = cx + r * Math.cos(ang);
        const y = cy + r * Math.sin(ang);
        pts.push(`${x.toFixed(2)},${y.toFixed(2)}`);
      }
      return pts.join(" ");
    }

    function buildGrid(){
      mapSvg.innerHTML = "";
      const svgNS = "http://www.w3.org/2000/svg";

      const W = 1000, H = 700;
      mapSvg.setAttribute("viewBox", `0 0 ${W} ${H}`);

      const rows = 5, cols = 5;
      const r = 70;
      const dx = r * Math.sqrt(3);
      const dy = r * 1.5;

      const gridW = cols * dx;
      const gridH = (rows - 1) * dy + (2*r);

      const x0 = (W - gridW) / 2 + (dx/2);
      const y0 = (H - gridH) / 2 + r;

      for(let row=0; row<rows; row++){
        for(let col=0; col<cols; col++){
          const cx = x0 + col*dx + ((row%2) ? (dx/2) : 0);
          const cy = y0 + row*dy;

          const poly = document.createElementNS(svgNS, "polygon");
          poly.setAttribute("points", hexPointsPointyTop(cx, cy, r));
          poly.classList.add("cellPoly","s0");
          poly.dataset.r = String(row);
          poly.dataset.c = String(col);

          const txt = document.createElementNS(svgNS, "text");
          txt.setAttribute("x", String(cx));
          txt.setAttribute("y", String(cy+2));
          txt.classList.add("cellText");
          txt.setAttribute("font-size", "40");
          txt.textContent = LETTERS[row][col];

          mapSvg.appendChild(poly);
          mapSvg.appendChild(txt);

          CELL_POLY[row][col] = poly;
        }
      }
    }

    function clampRC(r,c){
      if(r<0||r>4||c<0||c>4) return null;
      return {r,c};
    }

    function parseCellKey(key){
      if(!key) return null;

      // r2c3
      let m = String(key).match(/^r(\d+)c(\d+)$/i);
      if(m) return clampRC(Number(m[1]), Number(m[2]));

      // 2_3 أو 2-3 أو 2,3 أو 2:3
      m = String(key).match(/^(\d+)\s*[_\-,:\|]\s*(\d+)$/);
      if(m) return clampRC(Number(m[1]), Number(m[2]));

      return null;
    }

    function setCellState(r,c,st){
      const el = CELL_POLY?.[r]?.[c];
      if(!el) return;
      const s = Math.max(0, Math.min(3, Number(st)||0));
      el.classList.remove("s0","s1","s2","s3");
      el.classList.add("s"+s);
    }

    function resetAllCells(){
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          setCellState(r,c,0);
        }
      }
    }

    // حاول تلقائيًا أسماء خرائط شائعة (0-based و 1-based) من جذر المستودع
    function mapCandidates(activeMap){
      const n0 = Number(activeMap)||0;
      const n1 = n0 + 1;
      const exts = ["png","webp","jpg","jpeg"];

      const out = [];
      for(const ext of exts){
        out.push(`map${n0}.${ext}`);
        out.push(`map${n1}.${ext}`);
      }
      // احتياطيات
      for(const ext of exts){
        out.push(`Map${n0}.${ext}`);
        out.push(`Map${n1}.${ext}`);
      }
      // كسر كاش
      return out.map(x => x + `?v=${encodeURIComponent(ASSET_VERSION)}`);
    }

    function loadMapImage(activeMap){
      const cands = mapCandidates(activeMap);
      let i = 0;

      const tryNext = () => {
        if(i >= cands.length){
          // ما لقينا ملف
          mapBg.removeAttribute("src");
          statusLine.textContent = "لم أجد ملفات الخريطة في الجذر (تأكد من رفع الخرائط الثلاث).";
          return;
        }
        const src = cands[i++];
        const img = new Image();
        img.onload = () => {
          mapBg.src = src;
          statusLine.textContent = "متصل";
        };
        img.onerror = () => tryNext();
        img.src = src;
      };

      tryNext();
    }

    // ===== Firebase =====
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let CODE = "";
    let activeMap = 0;

    // listeners cleanup
    let unsubRoom = [];
    let unsubMap = [];

    function clearUnsubs(list){
      try{ list.forEach(fn => { try{ fn && fn(); }catch(e){} }); }catch(e){}
      list.length = 0;
    }

    async function claimTvLock(code){
      const deviceId = ensureDeviceId();
      const lockRef = ref(db, `rooms/${code}/tvLock`);

      const res = await runTransaction(lockRef, (cur) => {
        // cur = { deviceId, ts }
        if(!cur) return { deviceId, ts: Date.now() };

        const curDev = cur?.deviceId || "";
        const ts = Number(cur?.ts || 0);

        // نفس الجهاز؟ يسمح
        if(curDev && curDev === deviceId){
          return { deviceId, ts: Date.now() };
        }

        // لو قديم جدًا (مثلاً 30 دقيقة) اعتبره منتهي
        if(ts && (Date.now() - ts) > (30 * 60 * 1000)){
          return { deviceId, ts: Date.now() };
        }

        // غير كذا: ارفض
        return;
      }, { applyLocally:false });

      if(!res.committed){
        return { ok:false };
      }

      try{
        onDisconnect(lockRef).remove();
      }catch(e){}
      return { ok:true };
    }

    function applyScores(s){
      const g = Number(s?.green ?? 0);
      const o = Number(s?.orange ?? 0);
      scoreGreenEl.textContent = String(Number.isFinite(g)?g:0);
      scoreOrangeEl.textContent = String(Number.isFinite(o)?o:0);
    }

    function setGameName(name){
      const t = (String(name || "").trim() || "سباق الحروف");
      gameNameEl.textContent = t;
    }

    function attachMapStates(code, mapIndex){
      clearUnsubs(unsubMap);
      resetAllCells();

      loadMapImage(mapIndex);

      const base = `rooms/${code}/mapStates/${String(mapIndex)}`;
      const baseRef = ref(db, base);

      // onChildAdded يجي لكل خلية موجودة + أي تحديث جديد
      const uAdd = onChildAdded(baseRef, (snap) => {
        const rc = parseCellKey(snap.key);
        if(!rc) return;
        setCellState(rc.r, rc.c, snap.val());
      });
      const uChg = onChildChanged(baseRef, (snap) => {
        const rc = parseCellKey(snap.key);
        if(!rc) return;
        setCellState(rc.r, rc.c, snap.val());
      });
      const uRem = onChildRemoved(baseRef, (snap) => {
        const rc = parseCellKey(snap.key);
        if(!rc) return;
        setCellState(rc.r, rc.c, 0);
      });

      unsubMap.push(uAdd, uChg, uRem);
    }

    function attachRoom(code){
      clearUnsubs(unsubRoom);
      statusLine.textContent = "جاري الاتصال...";

      // تحقق سريع من وجود الغرفة
      (async ()=>{
        try{
          const roomSnap = await get(ref(db, `rooms/${code}`));
          if(!roomSnap.exists()){
            statusLine.textContent = "الغرفة غير موجودة";
          }
        }catch(e){}
      })();

      const uName = onValue(ref(db, `rooms/${code}/name`), (s) => {
        setGameName(s.val());
      }, ()=>{});

      const uScores = onValue(ref(db, `rooms/${code}/scores`), (s) => {
        applyScores(s.val() || {green:0,orange:0});
      }, ()=>{});

      const uActiveMap = onValue(ref(db, `rooms/${code}/activeMap`), (s) => {
        activeMap = Number(s.val() || 0);
        attachMapStates(code, activeMap);
      }, ()=>{});

      unsubRoom.push(uName, uScores, uActiveMap);
    }

    function showSetup(msg){
      setupErr.style.display = msg ? "block" : "none";
      setupErr.textContent = msg || "";
      setupOverlay.style.display = "flex";
      blockedOverlay.style.display = "none";
    }

    function hideSetup(){
      setupOverlay.style.display = "none";
    }

    function showBlocked(msg){
      blockedOverlay.style.display = "flex";
      setupOverlay.style.display = "none";
      document.getElementById("blockedMsg").textContent = msg || "عرض التلفاز مفتوح على جهاز آخر لنفس الغرفة.";
    }

    async function start(code){
      const c = cleanCode(code);
      if(c.length !== 6){
        showSetup("اكتب رمز غرفة صحيح (6 أرقام)");
        return;
      }

      CODE = c;
      hideSetup();

      if(!CELL_POLY[0][0]) buildGrid();

      // قفل جهاز واحد
      const lock = await claimTvLock(CODE);
      if(!lock.ok){
        showBlocked("عرض التلفاز مفتوح على جهاز آخر لهذه الغرفة.");
        return;
      }

      attachRoom(CODE);
      statusLine.textContent = "متصل";
    }

    // Buttons
    startBtn.addEventListener("click", () => start(codeInput.value || ""));
    codeInput.addEventListener("keydown", (e) => { if(e.key === "Enter") start(codeInput.value || ""); });
    reloadBtn.addEventListener("click", () => location.reload());

    // init
    (function init(){
      const qs = new URLSearchParams(location.search);
      const fromUrl = cleanCode(qs.get("code") || "");
      if(fromUrl.length === 6){
        start(fromUrl);
      }else{
        showSetup("");
      }
    })();
  </script>

  <!-- VERSION: tv.html — vTV-2-PlayerStyle-MapOnly -->
</body>
</html>
