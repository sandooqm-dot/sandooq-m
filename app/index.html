<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لعبة سباق الحروف</title>
  <style>
    /* ✅ نفس خط اللعبة */
    @font-face{
      font-family:"AA-GALAXY";
      src:url("../AA-GALAXY.otf") format("opentype");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --bgSolid:#7b1f63;  /* ✅ (تعديل 4) خلفية سادة مثل اللعبة */
      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
    }

    body{
      margin:0;
      color:#fff;
      text-align:center;
      font-family:"AA-GALAXY", Arial, sans-serif;

      /* ✅ (تعديل 4) سادة */
      background: var(--bgSolid);

      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    button, input{ font-family:"AA-GALAXY", Arial, sans-serif; }

    header{position:relative;padding:30px 16px 0}
    .logo{
      position:absolute;left:14px;top:14px;
      width:86px;height:86px;object-fit:contain;
      pointer-events:none;
    }
    h1{margin:18px 0 14px;color:var(--yellow);font-size:28px}
    .wrap{width:92%;max-width:520px;margin:0 auto}
    .card{background:var(--card);color:var(--text);border-radius:12px;padding:14px}
    input{
      width:100%;box-sizing:border-box;
      padding:14px;margin:10px 0;
      font-size:16px;border-radius:10px;border:0;
    }
    button{
      width:100%;padding:16px;margin-top:10px;
      font-size:18px;border:none;border-radius:12px;cursor:pointer;
      background:var(--yellow);color:#000
    }
    button[disabled]{opacity:.75;cursor:not-allowed}
    .hint{font-size:13px;opacity:.9;margin-top:8px}
  </style>
</head>
<body>

  <header>
    <img class="logo" src="../logo.png" alt="شعار صندوق المسابقات">
    <h1>لعبة سباق الحروف</h1>
  </header>

  <div class="wrap">
    <div class="card">
      <input id="name" placeholder="ادخل اسم اللعبة">
      <input id="players" inputmode="numeric" placeholder="ادخل عدد اللاعبين (1 إلى 13)">
      <button id="btn">انشئ اللعبة</button>
      <div class="hint">تقدر تكتب الأرقام عربي أو إنجليزي (الحد الأقصى 13)</div>
    </div>
  </div>

  <script>
    // ✅ Durable Objects (Firebase removed نهائياً)
    const params = new URLSearchParams(location.search);
    const SYNC_BASE = (params.get("sync") || "https://sync.horof.sandooq-games.com").replace(/\/$/,"");

    function normalizeDigits(str){
      const map = {
        "٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9",
        "۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9"
      };
      return String(str ?? "").trim().replace(/[٠-٩۰-۹]/g, d => map[d] ?? d);
    }

    function random6(){
      return String(Math.floor(100000 + Math.random()*900000));
    }

    function randomKey(){
      try{
        if (crypto?.randomUUID) return crypto.randomUUID();
      }catch(e){}
      return (Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2) + Date.now().toString(36));
    }

    async function fetchJSON(url, opts){
      const r = await fetch(url, opts);
      const j = await r.json().catch(()=>null);
      return { ok: r.ok, status: r.status, json: j };
    }

    async function roomExists(code){
      const url = `${SYNC_BASE}/state?room=${encodeURIComponent(code)}`;
      const { json } = await fetchJSON(url, { cache:"no-store" });
      const st = (json && json.ok && json.state && typeof json.state === "object") ? json.state : {};
      return !!(st.createdAt || st.status || st.hostKey || st.presenterKey);
    }

    async function createRoom(){
      const name = document.getElementById("name").value.trim();
      const pRaw = document.getElementById("players").value;
      let players = Number(normalizeDigits(pRaw).replace(/\D/g,""));

      if(!name){ alert("اكتب اسم اللعبة"); return; }

      if(!Number.isFinite(players) || players < 1){
        alert("عدد اللاعبين لازم يكون 1 أو أكثر");
        return;
      }

      // ✅ حد أقصى 13
      if(players > 13){
        alert("الحد الأقصى لعدد اللاعبين هو 13");
        return;
      }

      const btn = document.getElementById("btn");
      btn.disabled = true;

      // ✅ توليد كود 6 أرقام غير مستخدم
      let code = "";
      for(let i=0;i<12;i++){
        const c = random6();
        try{
          const exists = await roomExists(c);
          if(!exists){ code = c; break; }
        }catch(e){}
      }

      if(!code){
        btn.disabled = false;
        alert("حاول مرة ثانية");
        return;
      }

      const hostKey = randomKey();

      // ✅ نفس شكل الحالة اللي تتوقعه اللعبة
      const room = {
        code,
        name,
        maxPlayers: players,
        hostKey,
        status: "lobby",
        createdAt: Date.now(),

        displayPid: null,
        activeMap: 0,
        freeze: false,
        buzzer: null,

        scores: { green: 0, orange: 0 },

        current: { letter: null, qIndex: 0, row: null, col: null, map: 0 },
        timer: { sel: 10, dur: 10, running: false, startTs: 0, done: false },

        questionMode: "default",
        customQuestions: {},
        customQuestionsUpdatedAt: 0,

        winEvent: null,
        winState: {},
        mapStates: {},
        players: {},
        tvLock: null
      };

      try{
        const url = `${SYNC_BASE}/action?room=${encodeURIComponent(code)}`;
        const { json } = await fetchJSON(url, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(room)
        });

        if(!json || !json.ok){
          btn.disabled = false;
          alert("صار خطأ أثناء إنشاء الغرفة، حاول مرة ثانية");
          return;
        }

        const u = new URL("../game.html", location.href);
        u.searchParams.set("role", "host");
        u.searchParams.set("code", code);
        u.searchParams.set("key", hostKey);
        // اختياري: تثبيت السيرفر من الرابط
        // u.searchParams.set("sync", SYNC_BASE);

        location.href = u.toString();

      }catch(e){
        btn.disabled = false;
        alert("صار خطأ، حاول مرة ثانية");
      }
    }

    // ✅ منع كتابة أكثر من 13 مباشرة داخل الحقل
    (function(){
      const inp = document.getElementById("players");
      if(!inp) return;

      inp.addEventListener("input", () => {
        const raw = inp.value;
        const digits = normalizeDigits(raw).replace(/\D/g, "");
        if(digits === ""){
          inp.value = "";
          return;
        }
        let n = Number(digits);
        if(!Number.isFinite(n)) n = 1;
        if(n > 13) n = 13;
        if(n < 1) n = 1;
        inp.value = String(n);
      });
    })();

    document.getElementById("btn").addEventListener("click", createRoom);
  </script>
</body>
</html>

<!-- VERSION: app/index.html — vSolidBG-Max13-DO-1 -->
