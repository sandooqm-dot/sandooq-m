<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>تفعيل اللعبة - صندوق المسابقات</title>

  <style>
    :root{
      --bg1:#7a3aa8;
      --bg2:#c93fa7;
      --card:#7f4bb7cc;
      --card2:#ffffff14;
      --stroke:#ffffff22;
      --text:#ffffff;
      --muted:#ffffffcc;
      --shadow:0 18px 40px rgba(0,0,0,.18);
      --btn1:#ff4fb1;
      --btn2:#6d4bff;
      --green1:#2ad37a;
      --green2:#00b86b;
      --danger:#ff4b4b;
      --line:#ffffff33;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(1000px 700px at 80% 20%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px 14px;
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(circle at 12px 12px, rgba(255,255,255,.08) 1px, transparent 1px);
      background-size:34px 34px;
      opacity:.35;
      pointer-events:none;
    }

    .wrap{width:min(430px,100%)}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border:1px solid var(--stroke);
      border-radius:30px;
      box-shadow:var(--shadow);
      padding:22px 18px 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:2px;
      margin-bottom:8px;
    }
    .brand img{
      width:52px; height:52px; object-fit:contain;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.18));
    }

    .title{
      text-align:center;
      font-weight:900;
      letter-spacing:.2px;
      margin:8px 0 6px;
      font-size:34px;
      text-shadow:0 2px 0 rgba(0,0,0,.12);
    }
    .subtitle{
      text-align:center;
      color:var(--muted);
      margin:0 0 14px;
      font-size:14px;
      line-height:1.6;
    }

    .field{
      position:relative;
      width:100%;
      margin:10px 0;
    }
    .field input{
      width:100%;
      padding:14px 44px 14px 44px;
      border-radius:16px;
      border:1px solid var(--stroke);
      outline:none;
      background:rgba(0,0,0,.12);
      color:#fff;
      font-size:15px;
    }
    .field input::placeholder{color:#ffffff9c}
    .icon{
      position:absolute; top:50%; transform:translateY(-50%);
      width:22px; height:22px;
      opacity:.9;
    }
    .icon.r{right:14px}
    .icon.l{left:14px; opacity:.7}

    .btn{
      width:100%;
      border:none;
      border-radius:18px;
      padding:14px 14px;
      font-weight:900;
      font-size:18px;
      color:#fff;
      cursor:pointer;
      box-shadow:0 14px 30px rgba(0,0,0,.16);
      transition:transform .08s ease, opacity .2s ease, filter .2s ease;
    }
    .btn:active{transform:scale(.99)}
    .btnPrimary{
      background:linear-gradient(90deg,var(--btn1),var(--btn2));
    }
    .btnGreen{
      background:linear-gradient(90deg,var(--green1),var(--green2));
    }
    .btnGhost{
      background:rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      box-shadow:none;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; filter:grayscale(.2)}

    .or{
      display:flex; align-items:center; gap:10px;
      margin:14px 0 12px;
      color:var(--muted);
      font-weight:800;
      justify-content:center;
    }
    .or:before,.or:after{
      content:"";
      height:1px; flex:1;
      background:var(--line);
    }

    .google{
      width:100%;
      border-radius:18px;
      padding:12px 14px;
      background:#fff;
      color:#222;
      font-weight:900;
      font-size:16px;
      border:none;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      box-shadow:0 14px 30px rgba(0,0,0,.14);
    }
    .google img{width:20px; height:20px}

    .links{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      padding:0 4px;
      color:var(--muted);
      font-size:13px;
      font-weight:800;
    }
    .links a{
      color:var(--muted);
      text-decoration:none;
      border-bottom:1px dashed rgba(255,255,255,.35);
      padding-bottom:2px;
    }

    .msg{
      margin:10px 0 0;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.12);
      border:1px solid var(--stroke);
      color:#fff;
      font-weight:800;
      font-size:13px;
      line-height:1.6;
      display:none;
      white-space:pre-wrap;
    }
    .msg.err{
      border-color:rgba(255,75,75,.45);
      background:rgba(255,75,75,.10);
    }
    .msg.ok{
      border-color:rgba(42,211,122,.45);
      background:rgba(42,211,122,.10);
    }

    .foot{
      text-align:center;
      margin-top:14px;
      color:#ffffffb3;
      font-size:12px;
      font-weight:800;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      justify-content:center;
      border-radius:999px;
      padding:8px 12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.10);
      color:#fff;
      font-weight:900;
      font-size:13px;
    }

    .topInfo{
      display:flex;
      justify-content:center;
      margin-top:10px;
      margin-bottom:4px;
    }

    .hide{display:none !important;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <img src="logo.png" alt="logo" />
      </div>

      <!-- شاشة: تسجيل/دخول -->
      <div id="view-auth">
        <div class="title">تسجيل الدخول</div>
        <div class="subtitle">
          لازم تسجّل دخول عشان تفتح اللعبة.<br/>
          (إذا حسابك مُفعّل بتدخل اللعبة مباشرة)
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="white" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="7" r="4" stroke="white" stroke-width="2"/></svg>
          <input id="email" type="email" placeholder="example@email.com" autocomplete="email" />
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2"/><path d="M12 15v2" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="password" type="password" placeholder="********" autocomplete="current-password" />
        </div>

        <button id="btnLogin" class="btn btnPrimary">دخول</button>

        <div class="or">أو</div>

        <button id="btnGoogle" class="google" type="button">
          <img alt="g" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
          الدخول بواسطة حساب جوجل
        </button>

        <div class="links">
          <a href="#" id="goCreate">إنشاء حساب جديد</a>
          <a href="#" id="goForgot">نسيت كلمة المرور؟</a>
        </div>

        <div id="authMsg" class="msg"></div>
      </div>

      <!-- شاشة: إنشاء حساب -->
      <div id="view-create" class="hide">
        <div class="title">إنشاء حساب</div>
        <div class="subtitle">
          أنشئ حسابك ثم ثبّت بريدك الإلكتروني.<br/>
          بعدها تفعّل اللعبة بالكود (مرة واحدة).
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4z" stroke="white" stroke-width="2" opacity=".0"/><path d="M4 8l8 6 8-6" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="4" y="6" width="16" height="12" rx="2" stroke="white" stroke-width="2"/></svg>
          <input id="cEmail" type="email" placeholder="example@email.com" autocomplete="email" />
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2"/><path d="M12 15v2" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="cPass" type="password" placeholder="كلمة مرور (8 أحرف على الأقل)" autocomplete="new-password" />
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2"/><path d="M12 15v2" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="cPass2" type="password" placeholder="تأكيد كلمة المرور" autocomplete="new-password" />
        </div>

        <button id="btnCreate" class="btn btnPrimary">إنشاء حساب</button>

        <div class="links" style="justify-content:center">
          <a href="#" id="haveAccount">لديك حساب بالفعل؟ سجل دخول</a>
        </div>

        <div id="createMsg" class="msg"></div>
      </div>

      <!-- شاشة: تأكيد البريد (OTP) -->
      <div id="view-verify" class="hide">
        <div class="title">تأكيد البريد الإلكتروني</div>
        <div class="subtitle">
          أدخل الرمز المرسل إلى:<br/>
          <span id="vEmail" style="font-weight:900"></span>
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M3 10l9-7 9 7v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V10z" stroke="white" stroke-width="2"/><path d="M9 21v-6h6v6" stroke="white" stroke-width="2"/></svg>
          <input id="otp" inputmode="numeric" placeholder="رمز التحقق" />
        </div>

        <button id="btnVerifyOtp" class="btn btnPrimary">تحقق من الرمز</button>
        <button id="btnResendOtp" class="btn btnGhost" style="margin-top:10px">لم تستلم الرمز؟ إعادة الإرسال</button>

        <div id="verifyMsg" class="msg"></div>
      </div>

      <!-- شاشة: تفعيل الكود -->
      <div id="view-activate" class="hide">
        <div class="title">تفعيل اللعبة</div>
        <div class="subtitle">أدخل كود التفعيل اللي وصلك بعد الشراء</div>

        <div class="topInfo">
          <span class="pill">الحساب: <span id="who" style="margin-right:6px"></span></span>
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 10V8a5 5 0 0 1 10 0v2" stroke="white" stroke-width="2"/><rect x="5" y="10" width="14" height="10" rx="2" stroke="white" stroke-width="2"/><path d="M12 14v2" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="code" placeholder="M32959" autocomplete="one-time-code" />
        </div>

        <button id="btnActivate" class="btn btnGreen">تفعيل</button>

        <div class="links" style="margin-top:12px; justify-content:center">
          <a href="#" id="btnLogout">تسجيل الخروج</a>
        </div>

        <div id="actMsg" class="msg"></div>
      </div>

      <!-- شاشة: نسيت كلمة المرور -->
      <div id="view-forgot" class="hide">
        <div class="title">نسيت كلمة المرور</div>
        <div class="subtitle">
          اكتب بريدك، وراح توصلك رسالة فيها رابط تغيير كلمة المرور.
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M4 8l8 6 8-6" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="4" y="6" width="16" height="12" rx="2" stroke="white" stroke-width="2"/></svg>
          <input id="fEmail" type="email" placeholder="example@email.com" autocomplete="email" />
        </div>

        <button id="btnSendReset" class="btn btnPrimary">إرسال رابط الاستعادة</button>

        <div class="links" style="justify-content:center">
          <a href="#" id="backToLogin1">رجوع لتسجيل الدخول</a>
        </div>

        <div id="forgotMsg" class="msg"></div>
      </div>

      <!-- شاشة: تغيير كلمة المرور (من رابط الإيميل) -->
      <div id="view-reset" class="hide">
        <div class="title">تغيير كلمة المرور</div>
        <div class="subtitle">
          اكتب كلمة مرور جديدة (8 أحرف على الأقل).
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2"/></svg>
          <input id="rPass1" type="password" placeholder="كلمة المرور الجديدة" autocomplete="new-password" />
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2"/></svg>
          <input id="rPass2" type="password" placeholder="تأكيد كلمة المرور" autocomplete="new-password" />
        </div>

        <button id="btnDoReset" class="btn btnGreen">حفظ كلمة المرور</button>

        <div class="links" style="justify-content:center; margin-top:12px">
          <a href="#" id="backToLogin2">رجوع لتسجيل الدخول</a>
        </div>

        <div id="resetMsg" class="msg"></div>
      </div>

      <div class="foot">© صندوق المسابقات</div>
    </div>
  </div>

  <script>
    const API_BASE = "/api2";
    const $ = (id)=>document.getElementById(id);

    // ✅ توكن الجلسة
    const TOKEN_KEY = "sandooq_token_v1";
    function getToken(){ return localStorage.getItem(TOKEN_KEY) || ""; }
    function setToken(t){
      if(!t) return;
      localStorage.setItem(TOKEN_KEY, String(t));
    }

    // ✅ توكن الاستعادة (من رابط الإيميل) نخزنه في sessionStorage
    const RESET_TOKEN_KEY = "sandooq_reset_token_v1";
    function getResetToken(){ return sessionStorage.getItem(RESET_TOKEN_KEY) || ""; }
    function setResetToken(t){
      if(!t) return;
      sessionStorage.setItem(RESET_TOKEN_KEY, String(t));
    }

    function getQuery(){
      try { return new URL(location.href).searchParams; } catch { return new URLSearchParams(); }
    }

    // ✅ التقاط token من الرابط بدون خلط:
    // - Google callback: /activate?token=SESSIONTOKEN
    // - Reset link:      /activate?reset=1&token=RESETTOKEN
    (function captureTokensFromUrl(){
      try{
        const u = new URL(location.href);
        const isReset = u.searchParams.get("reset") === "1";

        const t = u.searchParams.get("token");
        if(t){
          if(isReset){
            setResetToken(t);
            // نخفي التوكن من الرابط للأمان
            u.searchParams.delete("token");
            history.replaceState(null, "", u.toString());
          } else {
            setToken(t);
            u.searchParams.delete("token");
            history.replaceState(null, "", u.toString());
          }
        }
      }catch{}
    })();

    function show(viewId){
      const ids = ["view-auth","view-create","view-verify","view-activate","view-forgot","view-reset"];
      ids.forEach(x => $(x).classList.toggle("hide", x!==viewId));
    }

    function msg(el, text, type){
      el.classList.remove("err","ok");
      if(type) el.classList.add(type);
      el.textContent = text || "";
      el.style.display = text ? "block" : "none";
    }

    function normEmail(v){
      return (v||"").toString().trim().toLowerCase();
    }
    function normCode(v){
      return (v||"").toString().trim().toUpperCase().replace(/\s+/g,"").replace(/[–—−]/g,"-");
    }

    function getDeviceId(){
      const k="sandooq_device_id_v1";
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)+Date.now());
        localStorage.setItem(k,v);
      }
      return v;
    }

    function apiUrl(path){
      let p = String(path||"");
      if(!p.startsWith("/")) p = "/" + p;
      if(p.startsWith("/api2/")) return p;
      if(p.startsWith("/api/")) return p;
      return API_BASE + p;
    }

    async function api(path, body){
      const headers = {
        "Content-Type":"application/json",
        "X-Device-Id": getDeviceId()
      };

      const tok = getToken();
      if(tok) headers["Authorization"] = "Bearer " + tok;

      const res = await fetch(apiUrl(path), {
        method:"POST",
        headers,
        body: JSON.stringify(body||{}),
        credentials: "include"
      });

      let data=null;
      try{ data = await res.json(); }catch{ data = { ok:false, error:"BAD_RESPONSE" }; }

      if(data && data.token) setToken(data.token);

      return data;
    }

    async function logout(){
      try { await api("/logout", {}); } catch {}
      sessionStorage.removeItem("pending_email");
      localStorage.removeItem(TOKEN_KEY);
      boot();
    }

    // ====== روابط التنقل
    $("goCreate").onclick = (e)=>{ e.preventDefault(); show("view-create"); msg($("authMsg"),""); };
    $("haveAccount").onclick = (e)=>{ e.preventDefault(); show("view-auth"); msg($("createMsg"),""); };
    $("btnLogout").onclick = async (e)=>{ e.preventDefault(); await logout(); };

    $("goForgot").onclick = (e)=>{
      e.preventDefault();
      // نسخ الإيميل المكتوب إن وجد
      $("fEmail").value = normEmail($("email").value);
      msg($("forgotMsg"), "");
      show("view-forgot");
    };

    $("backToLogin1").onclick = (e)=>{ e.preventDefault(); show("view-auth"); msg($("authMsg"),""); };
    $("backToLogin2").onclick = (e)=>{ e.preventDefault(); show("view-auth"); msg($("authMsg"),""); };

    // ====== Google
    $("btnGoogle").onclick = async ()=>{
      msg($("authMsg"), "");
      window.location.href = "/api2/google/start";
    };

    // ====== Login
    $("btnLogin").onclick = async ()=>{
      msg($("authMsg"), "");
      const email = normEmail($("email").value);
      const password = $("password").value || "";
      if(!email) return msg($("authMsg"), "اكتب البريد الإلكتروني", "err");
      if(password.length < 8) return msg($("authMsg"), "كلمة المرور لازم تكون 8 أحرف أو أكثر", "err");

      const r = await api("/login", { email, password });
      if(!r?.ok){
        return msg($("authMsg"), translateErr(r), "err");
      }
      await boot();
    };

    // ====== Create
    $("btnCreate").onclick = async ()=>{
      msg($("createMsg"), "");
      const email = normEmail($("cEmail").value);
      const pw1 = $("cPass").value || "";
      const pw2 = $("cPass2").value || "";
      if(!email) return msg($("createMsg"), "اكتب البريد الإلكتروني", "err");
      if(pw1.length < 8) return msg($("createMsg"), "كلمة المرور لازم تكون 8 أحرف أو أكثر", "err");
      if(pw1 !== pw2) return msg($("createMsg"), "كلمتا المرور غير متطابقتين", "err");

      const r = await api("/register", { email, password: pw1 });
      if(!r?.ok){
        return msg($("createMsg"), translateErr(r), "err");
      }

      sessionStorage.setItem("pending_email", email);
      $("vEmail").textContent = email;
      show("view-verify");

      if (r.debugOtp) {
        msg($("verifyMsg"), "تم إرسال رمز التحقق ✅\n(للاختبار: " + r.debugOtp + ")", "ok");
      } else {
        msg($("verifyMsg"), "تم إرسال رمز التحقق لبريدك ✅", "ok");
      }
    };

    // ====== Verify OTP
    $("btnVerifyOtp").onclick = async ()=>{
      msg($("verifyMsg"), "");
      const email = sessionStorage.getItem("pending_email") || "";
      const otp = ($("otp").value || "").trim();
      if(!otp) return msg($("verifyMsg"), "اكتب رمز التحقق", "err");
      if(!email) return msg($("verifyMsg"), "ما قدرنا نحدد الإيميل. ارجع وسوّ تسجيل من جديد.", "err");

      const r = await api("/verify-email", { email, otp });
      if(!r?.ok){
        return msg($("verifyMsg"), translateErr(r), "err");
      }

      sessionStorage.removeItem("pending_email");
      await boot();
    };

    $("btnResendOtp").onclick = async ()=>{
      msg($("verifyMsg"), "");
      const email = sessionStorage.getItem("pending_email") || "";
      if(!email) return msg($("verifyMsg"), "ما قدرنا نحدد الإيميل. ارجع وسوّ تسجيل من جديد.", "err");

      const r = await api("/resend-otp", { email });
      if(!r?.ok){
        return msg($("verifyMsg"), translateErr(r), "err");
      }

      if (r.debugOtp) {
        msg($("verifyMsg"), "تمت إعادة إرسال الرمز ✅\n(للاختبار: " + r.debugOtp + ")", "ok");
      } else {
        msg($("verifyMsg"), "تمت إعادة إرسال الرمز ✅", "ok");
      }
    };

    // ====== Activate Code
    $("btnActivate").onclick = async ()=>{
      msg($("actMsg"), "");
      const code = normCode($("code").value);
      if(!code) return msg($("actMsg"), "الرجاء إدخال كود التفعيل", "err");

      const r = await api("/activate", { code });
      if(!r?.ok){
        return msg($("actMsg"), translateErr(r), "err");
      }

      window.location.replace("/app");
    };

    // ====== Forgot Password
    $("btnSendReset").onclick = async ()=>{
      msg($("forgotMsg"), "");
      const email = normEmail($("fEmail").value);
      if(!email) return msg($("forgotMsg"), "اكتب البريد الإلكتروني", "err");

      const r = await api("/forgot", { email });
      if(!r?.ok){
        return msg($("forgotMsg"), translateErr(r), "err");
      }

      msg($("forgotMsg"),
        "تم ✅\nإذا كان البريد مسجّل عندنا راح توصلك رسالة فيها رابط الاستعادة خلال لحظات.",
        "ok"
      );
    };

    // ====== Reset Password
    $("btnDoReset").onclick = async ()=>{
      msg($("resetMsg"), "");
      const t = getResetToken();
      if(!t) return msg($("resetMsg"), "الرابط غير صحيح أو انتهت صلاحيته. اطلب رابط جديد.", "err");

      const p1 = $("rPass1").value || "";
      const p2 = $("rPass2").value || "";
      if(p1.length < 8) return msg($("resetMsg"), "كلمة المرور لازم تكون 8 أحرف أو أكثر", "err");
      if(p1 !== p2) return msg($("resetMsg"), "كلمتا المرور غير متطابقتين", "err");

      const r = await api("/reset", { token: t, newPassword: p1 });
      if(!r?.ok){
        return msg($("resetMsg"), translateErr(r), "err");
      }

      sessionStorage.removeItem(RESET_TOKEN_KEY);
      msg($("resetMsg"), "تم تغيير كلمة المرور ✅\nالحين سجل دخول بكلمة المرور الجديدة.", "ok");

      setTimeout(()=>{
        show("view-auth");
        msg($("authMsg"), "تم تغيير كلمة المرور ✅ سجّل دخول الآن.", "ok");
      }, 700);
    };

    // ====== Boot
    async function boot(){
      // ✅ لو رابط استعادة: افتح شاشة reset مباشرة ولا ندخل في me
      const q = getQuery();
      if(q.get("reset") === "1"){
        show("view-reset");
        msg($("resetMsg"), "");
        return;
      }

      const pending = sessionStorage.getItem("pending_email") || "";
      if (pending) {
        $("vEmail").textContent = pending;
        show("view-verify");
        return;
      }

      const me = await api("/me", {});
      if(!me?.ok){
        show("view-auth");
        return;
      }

      const email = me.email || "";
      $("who").textContent = email;

      if(me.verified === false){
        sessionStorage.setItem("pending_email", email);
        $("vEmail").textContent = email;
        show("view-verify");
        msg($("verifyMsg"), "لازم تؤكد بريدك أولاً.", "err");
        return;
      }

      if(me.activated){
        window.location.replace("/app");
        return;
      }

      show("view-activate");
    }

    function translateErr(r){
      const e = (r && (r.error || r.code)) ? String(r.error || r.code) : "UNKNOWN_ERROR";

      if(e === "BAD_RESPONSE") return "صار خطأ في الاتصال بالسيرفر.";
      if(e === "DB_NOT_BOUND") return "في مشكلة إعدادات السيرفر (DB).";
      if(e === "BAD_JSON") return "طلب غير صالح.";
      if(e === "INVALID_EMAIL") return "البريد الإلكتروني غير صحيح.";
      if(e === "MISSING_FIELDS" || e === "MISSING_FIELD") return "الرجاء تعبئة جميع الحقول.";

      if(e === "EMAIL_EXISTS") return "هذا الإيميل مسجل مسبقًا.";
      if(e === "USER_NOT_FOUND") return "الإيميل أو كلمة المرور غير صحيحة.";
      if(e === "BAD_PASSWORD") return "الإيميل أو كلمة المرور غير صحيحة.";
      if(e === "EMAIL_NOT_VERIFIED") return "لازم تؤكد بريدك الإلكتروني أولاً.";

      if(e === "OTP_WRONG" || e === "OTP_INVALID" || e === "INVALID_OTP") return "رمز التحقق غير صحيح.";
      if(e === "OTP_EXPIRED") return "رمز التحقق انتهت صلاحيته. أعد الإرسال.";
      if(e === "OTP_TOO_SOON") return "انتظر دقيقة ثم أعد الإرسال.";
      if(e === "TOO_MANY_ATTEMPTS" || e === "OTP_LOCKED") return "محاولات كثيرة. جرّب بعد قليل.";

      if(e === "MAIL_NOT_CONFIGURED") return "خدمة إرسال الإيميل غير مفعّلة حالياً.";
      if(e === "MAIL_SEND_FAILED") return "فشل إرسال الإيميل. جرّب مرة ثانية.";

      if(e === "WEAK_PASSWORD") return "كلمة المرور ضعيفة. لازم 8 أحرف أو أكثر.";
      if(e === "TOKEN_INVALID") return "رابط الاستعادة غير صحيح.";
      if(e === "TOKEN_EXPIRED") return "انتهت صلاحية رابط الاستعادة. اطلب رابط جديد.";
      if(e === "TOKEN_USED") return "تم استخدام الرابط مسبقًا. اطلب رابط جديد.";

      if(e === "CODE_NOT_FOUND") return "الكود غير موجود.";
      if(e === "CODE_ALREADY_USED") return "الكود مستخدم مسبقًا.";
      if(e === "DEVICE_LIMIT_REACHED") return "تجاوزت الحد المسموح لربط الأجهزة (جهازين فقط).";

      return "حدث خطأ: " + e;
    }

    boot();
  </script>
</body>
</html>

<!-- activate.html – نظام التفعيل الجديد v9 (Forgot+Reset UI + token param safe) -->
