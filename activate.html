<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>تفعيل اللعبة - صندوق المسابقات</title>

  <style>
    :root{
      --bg1:#7a3aa8;
      --bg2:#c93fa7;
      --card:#7f4bb7cc;
      --card2:#ffffff14;
      --stroke:#ffffff22;
      --text:#ffffff;
      --muted:#ffffffcc;
      --shadow:0 18px 40px rgba(0,0,0,.18);
      --btn1:#ff4fb1;
      --btn2:#6d4bff;
      --green1:#2ad37a;
      --green2:#00b86b;
      --danger:#ff4b4b;
      --line:#ffffff33;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(1000px 700px at 80% 20%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px 14px;
    }

    /* خلفية سداسية خفيفة */
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(circle at 12px 12px, rgba(255,255,255,.08) 1px, transparent 1px);
      background-size:34px 34px;
      opacity:.35;
      pointer-events:none;
    }

    .wrap{width:min(430px,100%)}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border:1px solid var(--stroke);
      border-radius:30px;
      box-shadow:var(--shadow);
      padding:22px 18px 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:2px;
      margin-bottom:8px;
    }
    .brand img{
      width:52px; height:52px; object-fit:contain;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.18));
    }

    .title{
      text-align:center;
      font-weight:900;
      letter-spacing:.2px;
      margin:8px 0 6px;
      font-size:34px;
      text-shadow:0 2px 0 rgba(0,0,0,.12);
    }
    .subtitle{
      text-align:center;
      color:var(--muted);
      margin:0 0 14px;
      font-size:14px;
      line-height:1.6;
    }

    .sectionTitle{
      text-align:center;
      font-weight:900;
      font-size:22px;
      margin:14px 0 12px;
    }

    .row{
      display:flex;
      gap:10px;
    }

    .field{
      position:relative;
      width:100%;
      margin:10px 0;
    }
    .field input{
      width:100%;
      padding:14px 44px 14px 44px;
      border-radius:16px;
      border:1px solid var(--stroke);
      outline:none;
      background:rgba(0,0,0,.12);
      color:#fff;
      font-size:15px;
    }
    .field input::placeholder{color:#ffffff9c}
    .icon{
      position:absolute; top:50%; transform:translateY(-50%);
      width:22px; height:22px;
      opacity:.9;
    }
    .icon.r{right:14px}
    .icon.l{left:14px; opacity:.7}

    .btn{
      width:100%;
      border:none;
      border-radius:18px;
      padding:14px 14px;
      font-weight:900;
      font-size:18px;
      color:#fff;
      cursor:pointer;
      box-shadow:0 14px 30px rgba(0,0,0,.16);
      transition:transform .08s ease, opacity .2s ease, filter .2s ease;
    }
    .btn:active{transform:scale(.99)}
    .btnPrimary{
      background:linear-gradient(90deg,var(--btn1),var(--btn2));
    }
    .btnGreen{
      background:linear-gradient(90deg,var(--green1),var(--green2));
    }
    .btnGhost{
      background:rgba(255,255,255,.08);
      border:1px solid var(--stroke);
      box-shadow:none;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; filter:grayscale(.2)}

    .or{
      display:flex; align-items:center; gap:10px;
      margin:14px 0 12px;
      color:var(--muted);
      font-weight:800;
      justify-content:center;
    }
    .or:before,.or:after{
      content:"";
      height:1px; flex:1;
      background:var(--line);
    }

    .google{
      width:100%;
      border-radius:18px;
      padding:12px 14px;
      background:#fff;
      color:#222;
      font-weight:900;
      font-size:16px;
      border:none;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      box-shadow:0 14px 30px rgba(0,0,0,.14);
    }
    .google img{width:20px; height:20px}

    .links{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      padding:0 4px;
      color:var(--muted);
      font-size:13px;
      font-weight:800;
    }
    .links a{
      color:var(--muted);
      text-decoration:none;
      border-bottom:1px dashed rgba(255,255,255,.35);
      padding-bottom:2px;
    }

    .msg{
      margin:10px 0 0;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.12);
      border:1px solid var(--stroke);
      color:#fff;
      font-weight:800;
      font-size:13px;
      line-height:1.6;
      display:none;
      white-space:pre-wrap;
    }
    .msg.err{
      border-color:rgba(255,75,75,.45);
      background:rgba(255,75,75,.10);
    }
    .msg.ok{
      border-color:rgba(42,211,122,.45);
      background:rgba(42,211,122,.10);
    }

    .foot{
      text-align:center;
      margin-top:14px;
      color:#ffffffb3;
      font-size:12px;
      font-weight:800;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      justify-content:center;
      border-radius:999px;
      padding:8px 12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.10);
      color:#fff;
      font-weight:900;
      font-size:13px;
    }

    .topInfo{
      display:flex;
      justify-content:center;
      margin-top:10px;
      margin-bottom:4px;
    }

    .hide{display:none !important;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <img src="logo.png" alt="logo" />
      </div>

      <!-- شاشة: تسجيل/دخول -->
      <div id="view-auth">
        <div class="title">تسجيل الدخول</div>
        <div class="subtitle">
          لازم تسجّل دخول عشان تفتح اللعبة.<br/>
          (بعد التفعيل، تقدر تدخل من أي متصفح حتى المتصفح الخفي)
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="white" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="7" r="4" stroke="white" stroke-width="2"/></svg>
          <input id="email" type="email" placeholder="example@email.com" autocomplete="email" />
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2"/><path d="M12 15v2" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="password" type="password" placeholder="********" autocomplete="current-password" />
        </div>

        <button id="btnLogin" class="btn btnPrimary">دخول</button>

        <div class="or">أو</div>

        <button id="btnGoogle" class="google" type="button">
          <img alt="g" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
          الدخول بواسطة حساب جوجل
        </button>

        <div class="links">
          <a href="#" id="goCreate">إنشاء حساب جديد</a>
          <a href="#" id="goForgot">نسيت كلمة المرور؟</a>
        </div>

        <div id="authMsg" class="msg"></div>
      </div>

      <!-- شاشة: إنشاء حساب -->
      <div id="view-create" class="hide">
        <div class="title">إنشاء حساب</div>
        <div class="subtitle">
          أنشئ حسابك ثم ثبّت بريدك الإلكتروني.<br/>
          بعدها تفعّل اللعبة بالكود (مرة واحدة).
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4z" stroke="white" stroke-width="2" opacity=".0"/><path d="M4 8l8 6 8-6" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="4" y="6" width="16" height="12" rx="2" stroke="white" stroke-width="2"/></svg>
          <input id="cEmail" type="email" placeholder="example@email.com" autocomplete="email" />
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2"/><path d="M12 15v2" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="cPass" type="password" placeholder="كلمة مرور (8 أحرف على الأقل)" autocomplete="new-password" />
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="white" stroke-width="2" stroke-linecap="round"/><rect x="5" y="11" width="14" height="10" rx="2" stroke="white" stroke-width="2"/><path d="M12 15v2" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="cPass2" type="password" placeholder="تأكيد كلمة المرور" autocomplete="new-password" />
        </div>

        <button id="btnCreate" class="btn btnPrimary">إنشاء حساب</button>

        <div class="links" style="justify-content:center">
          <a href="#" id="haveAccount">لديك حساب بالفعل؟ سجل دخول</a>
        </div>

        <div id="createMsg" class="msg"></div>
      </div>

      <!-- شاشة: تأكيد البريد (OTP) -->
      <div id="view-verify" class="hide">
        <div class="title">تأكيد البريد الإلكتروني</div>
        <div class="subtitle">
          أدخل الرمز المرسل إلى:<br/>
          <span id="vEmail" style="font-weight:900"></span>
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M3 10l9-7 9 7v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V10z" stroke="white" stroke-width="2"/><path d="M9 21v-6h6v6" stroke="white" stroke-width="2"/></svg>
          <input id="otp" inputmode="numeric" placeholder="رمز التحقق" />
        </div>

        <button id="btnVerifyOtp" class="btn btnPrimary">تحقق من الرمز</button>
        <button id="btnResendOtp" class="btn btnGhost" style="margin-top:10px">لم تستلم الرمز؟ إعادة الإرسال</button>

        <div id="verifyMsg" class="msg"></div>
      </div>

      <!-- شاشة: تفعيل الكود -->
      <div id="view-activate" class="hide">
        <div class="title">تفعيل اللعبة</div>
        <div class="subtitle">أدخل كود التفعيل اللي وصلك بعد الشراء</div>

        <div class="topInfo">
          <span class="pill">الحساب: <span id="who" style="margin-right:6px"></span></span>
        </div>

        <div class="field">
          <svg class="icon r" viewBox="0 0 24 24" fill="none"><path d="M7 10V8a5 5 0 0 1 10 0v2" stroke="white" stroke-width="2"/><rect x="5" y="10" width="14" height="10" rx="2" stroke="white" stroke-width="2"/><path d="M12 14v2" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="code" placeholder="M 3 2 9 5 9" autocomplete="one-time-code" />
        </div>

        <button id="btnActivate" class="btn btnGreen">تفعيل</button>

        <div class="links" style="margin-top:12px">
          <a href="#" id="btnLogout">تسجيل الخروج</a>
          <span></span>
        </div>

        <div id="actMsg" class="msg"></div>
      </div>

      <!-- شاشة: جاهز / دخول اللعبة -->
      <div id="view-ready" class="hide">
        <div class="title">تم التفعيل</div>
        <div class="subtitle">✅ هذا الجهاز مُفعّل</div>

        <div class="topInfo">
          <span class="pill">مرحباً، <span id="readyEmail" style="margin-right:6px"></span></span>
        </div>

        <button id="btnEnterGame" class="btn btnGreen" style="margin-top:12px">دخول اللعبة</button>
        <button id="btnLogout2" class="btn btnGhost" style="margin-top:10px">تسجيل الخروج</button>

        <div id="readyMsg" class="msg"></div>
      </div>

      <div class="foot">© صندوق المسابقات</div>
    </div>
  </div>

  <script>
    // =========================
    //   Client helpers
    // =========================
    const $ = (id)=>document.getElementById(id);

    function show(viewId){
      const ids = ["view-auth","view-create","view-verify","view-activate","view-ready"];
      ids.forEach(x => $(x).classList.toggle("hide", x!==viewId));
    }

    function msg(el, text, type){
      el.classList.remove("err","ok");
      if(type) el.classList.add(type);
      el.textContent = text || "";
      el.style.display = text ? "block" : "none";
    }

    function normEmail(v){
      return (v||"").toString().trim().toLowerCase();
    }
    function normCode(v){
      return (v||"").toString().trim().toUpperCase().replace(/\s+/g,"").replace(/[–—−]/g,"-");
    }

    // Device ID ثابت لكل جهاز (مو آمن 100% لكن السيرفر بيحسب الأجهزة)
    function getDeviceId(){
      const k="sandooq_device_id_v1";
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)+Date.now());
        localStorage.setItem(k,v);
      }
      return v;
    }

    // Session token
    function setToken(t){
      if(t) localStorage.setItem("sandooq_token_v1", t);
      else localStorage.removeItem("sandooq_token_v1");
    }
    function getToken(){
      return localStorage.getItem("sandooq_token_v1") || "";
    }

    async function api(path, body, {auth=true}={}){
      const headers = { "Content-Type":"application/json", "X-Device-Id": getDeviceId() };
      if(auth && getToken()) headers["Authorization"] = "Bearer " + getToken();
      const res = await fetch(path, { method:"POST", headers, body: JSON.stringify(body||{}) });
      let data=null;
      try{ data = await res.json(); }catch{ data = { ok:false, error:"BAD_RESPONSE" }; }
      if(!res.ok && data && data.ok !== true){
        return data;
      }
      return data;
    }

    // =========================
    //   Navigation links
    // =========================
    $("goCreate").onclick = (e)=>{ e.preventDefault(); show("view-create"); msg($("authMsg"),""); };
    $("haveAccount").onclick = (e)=>{ e.preventDefault(); show("view-auth"); msg($("createMsg"),""); };
    $("goForgot").onclick = async (e)=>{
      e.preventDefault();
      msg($("authMsg"), "ميزة (نسيت كلمة المرور) بنضيفها بالخطوة الجاية.", "err");
    };

    $("btnGoogle").onclick = async ()=>{
      msg($("authMsg"), "زر Google جاهز بالواجهة. بنفعّله بالخطوة الخاصة بـ Google OAuth.", "err");
    };

    $("btnLogout").onclick = (e)=>{ e.preventDefault(); setToken(""); boot(); };
    $("btnLogout2").onclick = ()=>{ setToken(""); boot(); };

    $("btnEnterGame").onclick = ()=>{
      // هنا وجهة اللعبة بعد اعتماد حماية /api/me
      // تقدر تغيّرها لاحقاً للملف الأساسي
      window.location.href = "index.html";
    };

    // =========================
    //   Actions
    // =========================
    $("btnLogin").onclick = async ()=>{
      msg($("authMsg"), "");
      const email = normEmail($("email").value);
      const password = $("password").value || "";
      if(!email) return msg($("authMsg"), "اكتب البريد الإلكتروني", "err");
      if(password.length < 8) return msg($("authMsg"), "كلمة المرور لازم تكون 8 أحرف أو أكثر", "err");

      const r = await api("/api/login", { email, password }, {auth:false});
      if(!r?.ok){
        return msg($("authMsg"), translateErr(r), "err");
      }
      setToken(r.token);
      await boot();
    };

    $("btnCreate").onclick = async ()=>{
      msg($("createMsg"), "");
      const email = normEmail($("cEmail").value);
      const pw1 = $("cPass").value || "";
      const pw2 = $("cPass2").value || "";
      if(!email) return msg($("createMsg"), "اكتب البريد الإلكتروني", "err");
      if(pw1.length < 8) return msg($("createMsg"), "كلمة المرور لازم تكون 8 أحرف أو أكثر", "err");
      if(pw1 !== pw2) return msg($("createMsg"), "كلمتا المرور غير متطابقتين", "err");

      // 1) إنشاء الحساب (يرسل OTP)
      const r = await api("/api/register", { email, password: pw1 }, {auth:false});
      if(!r?.ok){
        return msg($("createMsg"), translateErr(r), "err");
      }

      // ينتقل لصفحة التحقق
      sessionStorage.setItem("pending_email", email);
      $("vEmail").textContent = email;
      show("view-verify");
      msg($("verifyMsg"), "تم إرسال رمز التحقق لبريدك ✅", "ok");
    };

    $("btnVerifyOtp").onclick = async ()=>{
      msg($("verifyMsg"), "");
      const email = sessionStorage.getItem("pending_email") || "";
      const otp = ($("otp").value || "").trim();
      if(!otp) return msg($("verifyMsg"), "اكتب رمز التحقق", "err");
      if(!email) return msg($("verifyMsg"), "ما قدرنا نحدد الإيميل. ارجع وسوّ تسجيل من جديد.", "err");

      const r = await api("/api/verify-email", { email, otp }, {auth:false});
      if(!r?.ok){
        return msg($("verifyMsg"), translateErr(r), "err");
      }

      // بعد التحقق: يدخل تلقائي (يعطينا token)
      if(r.token) setToken(r.token);
      sessionStorage.removeItem("pending_email");
      await boot();
    };

    $("btnResendOtp").onclick = async ()=>{
      msg($("verifyMsg"), "");
      const email = sessionStorage.getItem("pending_email") || "";
      if(!email) return msg($("verifyMsg"), "ما قدرنا نحدد الإيميل. ارجع وسوّ تسجيل من جديد.", "err");

      const r = await api("/api/resend-otp", { email }, {auth:false});
      if(!r?.ok){
        return msg($("verifyMsg"), translateErr(r), "err");
      }
      msg($("verifyMsg"), "تمت إعادة إرسال الرمز ✅", "ok");
    };

    $("btnActivate").onclick = async ()=>{
      msg($("actMsg"), "");
      const code = normCode($("code").value);
      if(!code) return msg($("actMsg"), "الرجاء إدخال كود التفعيل", "err");

      const r = await api("/api/activate", { code });
      if(!r?.ok){
        return msg($("actMsg"), translateErr(r), "err");
      }
      await boot();
    };

    // =========================
    //   Boot: decides which screen to show
    // =========================
    async function boot(){
      // إذا ما عنده توكن: شاشة الدخول
      if(!getToken()){
        show("view-auth");
        return;
      }

      // استعلام حالة الحساب
      const me = await api("/api/me", {});
      if(!me?.ok){
        // توكن منتهي/غير صالح
        setToken("");
        show("view-auth");
        msg($("authMsg"), "انتهت الجلسة. سجل دخول من جديد.", "err");
        return;
      }

      // حساب موجود
      const email = me.email || "";
      $("who").textContent = email;
      $("readyEmail").textContent = email;

      // إذا ما فعل الكود بعد
      if(!me.activated){
        show("view-activate");
        return;
      }

      // مفعل
      show("view-ready");
    }

    // =========================
    //   Error translation (واجهة عربية واضحة)
    // =========================
    function translateErr(r){
      const e = (r && (r.error || r.code)) ? String(r.error || r.code) : "UNKNOWN_ERROR";

      // رسائل عامة
      if(e === "SERVICE_UNAVAILABLE") return "الخدمة غير متاحة الآن. جرّب بعد قليل.";
      if(e === "BAD_RESPONSE") return "صار خطأ في الاتصال بالسيرفر.";
      if(e === "INVALID_EMAIL") return "البريد الإلكتروني غير صحيح.";
      if(e === "WEAK_PASSWORD") return "كلمة المرور ضعيفة.";
      if(e === "EMAIL_EXISTS") return "هذا الإيميل مسجل مسبقًا.";
      if(e === "INVALID_LOGIN") return "الإيميل أو كلمة المرور غير صحيحة.";
      if(e === "EMAIL_NOT_VERIFIED") return "لازم تؤكد بريدك الإلكتروني أولاً.";
      if(e === "OTP_INVALID") return "رمز التحقق غير صحيح.";
      if(e === "OTP_EXPIRED") return "رمز التحقق انتهت صلاحيته. أعد الإرسال.";
      if(e === "CODE_NOT_FOUND") return "الكود غير موجود.";
      if(e === "CODE_ALREADY_USED") return "الكود مستخدم مسبقًا.";
      if(e === "DEVICE_LIMIT_REACHED") return "تجاوزت الحد المسموح لربط الأجهزة (جهازين فقط).";
      if(e === "ACTIVATE_REQUIRED") return "لازم تفعّل اللعبة بالكود أول مرة.";
      if(e === "METHOD_NOT_ALLOWED") return "طلب غير صالح.";

      // fallback
      return "حدث خطأ: " + e;
    }

    // Start
    boot();
  </script>
</body>
</html>

<!-- activate.html – نظام التفعيل الجديد v2 (واجهة فقط) -->
