<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© | ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

  <style>
    :root{
      --bg1:#6c2bd9;
      --bg2:#ff3aa7;
      --card: rgba(255,255,255,.16);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.22);
      --text:#fff;
      --muted: rgba(255,255,255,.80);
      --input: rgba(255,255,255,.14);
      --btn: linear-gradient(90deg, #ff3aa7 0%, #6c2bd9 100%);
      --btn2: rgba(255,255,255,.14);
      --danger:#ff4d4d;
      --ok:#2fe38c;
      --shadow: 0 18px 50px rgba(0,0,0,.25);
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% 25%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(30deg, rgba(255,255,255,.08) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,.08) 87.5%, rgba(255,255,255,.08)),
        linear-gradient(150deg, rgba(255,255,255,.08) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,.08) 87.5%, rgba(255,255,255,.08)),
        linear-gradient(90deg, rgba(255,255,255,.06) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,.06) 87.5%, rgba(255,255,255,.06));
      background-size: 86px 150px;
      background-position: 0 0, 0 0, 43px 75px;
      opacity:.45;
      pointer-events:none;
      filter: blur(.2px);
    }

    .page{
      position:relative;
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .wrap{
      width:min(560px, 92vw);
      border-radius:26px;
      background: var(--card);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .topLogo{
      display:flex;
      justify-content:center;
      padding:18px 18px 0;
    }
    .topLogo img{
      width:70px;height:70px;object-fit:contain;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.25));
    }

    .content{ padding:14px 18px 18px; }

    .title{
      text-align:center;
      margin:6px 0 6px;
      font-size:26px;
      font-weight:900;
      letter-spacing:.2px;
      text-shadow: 0 8px 18px rgba(0,0,0,.25);
    }

    .sub{
      text-align:center;
      margin:0 0 14px;
      color:var(--muted);
      font-size:14px;
      line-height:1.8;
    }

    .panel{
      background: var(--card2);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px;
    }

    .row{ margin:10px 0; }

    .input{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.20);
      background: var(--input);
      box-sizing:border-box;
    }
    .input span{
      opacity:.85;
      font-size:18px;
      width:26px;
      text-align:center;
    }
    .input input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:15px;
    }
    .input input::placeholder{ color: rgba(255,255,255,.65); }

    .btn{
      width:100%;
      border:0;
      cursor:pointer;
      padding:13px 14px;
      border-radius:14px;
      color:#fff;
      font-weight:800;
      font-size:15px;
      background: var(--btn);
      box-shadow: 0 14px 26px rgba(0,0,0,.18);
      transition: transform .12s ease, opacity .12s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    .btnGhost{
      width:100%;
      border:1px solid rgba(255,255,255,.25);
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      color:#fff;
      font-weight:800;
      font-size:14px;
      background: var(--btn2);
      transition: transform .12s ease, opacity .12s ease;
    }
    .btnGhost:active{ transform: scale(.99); }
    .btnGhost[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    .sep{
      display:flex;
      align-items:center;
      gap:10px;
      margin:14px 0 10px;
      color:rgba(255,255,255,.7);
      font-weight:700;
      justify-content:center;
    }
    .sep::before,.sep::after{
      content:"";
      height:1px;
      flex:1;
      background: rgba(255,255,255,.25);
    }

    .miniLinks{
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .miniLinks button{
      background:transparent;
      border:0;
      color:rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      text-decoration: underline;
      text-underline-offset: 4px;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      font-weight:800;
      text-align:center;
      display:none;
    }
    .msg.danger{ border-color: rgba(255,77,77,.6); color: #ffd7d7; }
    .msg.ok{ border-color: rgba(47,227,140,.55); color: #d9ffe9; }

    .codeBox{
      background: rgba(0,0,0,.12);
      border:1px dashed rgba(255,255,255,.28);
      border-radius:18px;
      padding:12px;
      margin-bottom:12px;
    }
    .codeHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .codeHeader .tag{
      font-weight:900;
      font-size:13px;
      opacity:.92;
    }
    .badge{
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .badge.bad{ border-color: rgba(255,77,77,.6); color:#ffd0d0; }
    .badge.good{ border-color: rgba(47,227,140,.55); color:#d9ffe9; }

    .note{
      margin-top:8px;
      font-size:12px;
      color:rgba(255,255,255,.78);
      text-align:center;
      line-height:1.6;
    }

    .footer{
      text-align:center;
      padding:10px 0 14px;
      color:rgba(255,255,255,.75);
      font-weight:800;
      font-size:12px;
    }

    @media (max-width:420px){
      .title{font-size:24px}
      .wrap{border-radius:22px}
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="wrap">
      <div class="topLogo">
        <img src="logo.png" alt="logo">
      </div>

      <div class="content">

        <div class="title" id="pageTitle">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
        <div class="sub" id="pageSub">
          Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·: Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².<br>
          Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„â€¦ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„.
        </div>

        <div class="panel">

          <!-- âœ… Ù‚Ø³Ù… Ø§Ù„ÙƒÙˆØ¯ (ÙÙˆÙ‚) -->
          <div class="codeBox" id="codeBox">
            <div class="codeHeader">
              <div class="tag">ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·)</div>
              <div class="badge bad" id="codeBadge">CODE_REQUIRED</div>
            </div>

            <div class="row">
              <div class="input">
                <span>ğŸ”‘</span>
                <input id="codeInput" inputmode="text" autocomplete="off" placeholder="SNDQ-XXXX-XXXX-XXXX" />
              </div>
            </div>

            <button class="btn" id="activateBtn" disabled>ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯</button>

            <div class="msg danger" id="codeErr"></div>
            <div class="msg ok" id="codeOk"></div>

            <div class="note" id="deviceNote"></div>
          </div>

          <!-- âœ… Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
          <div id="viewLogin">
            <div class="row">
              <div class="input">
                <span>ğŸ‘¤</span>
                <input id="loginEmail" type="email" autocomplete="email" placeholder="example@email.com" />
              </div>
            </div>
            <div class="row">
              <div class="input">
                <span>ğŸ”’</span>
                <input id="loginPass" type="password" autocomplete="current-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              </div>
            </div>

            <button class="btn" id="loginBtn" disabled>Ø¯Ø®ÙˆÙ„</button>

            <div class="sep">Ø£Ùˆ</div>

            <button class="btnGhost" id="googleBtn">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„</button>

            <div class="miniLinks">
              <button type="button" id="goSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
              <button type="button" id="goReset">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
            </div>

            <div class="msg danger" id="loginErr"></div>
            <div class="msg ok" id="loginOk"></div>
          </div>

          <!-- âœ… Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
          <div id="viewSignup" style="display:none">
            <div class="title" style="font-size:22px;margin:4px 0 10px;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>

            <div class="row">
              <div class="input">
                <span>âœ‰ï¸</span>
                <input id="suEmail" type="email" autocomplete="email" placeholder="example@email.com" />
              </div>
            </div>
            <div class="row">
              <div class="input">
                <span>ğŸ”’</span>
                <input id="suPass" type="password" autocomplete="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (8+)" />
              </div>
            </div>
            <div class="row">
              <div class="input">
                <span>ğŸ”’</span>
                <input id="suPass2" type="password" autocomplete="new-password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              </div>
            </div>

            <button class="btn" id="signupBtn" disabled>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>

            <div class="sep">Ø£Ùˆ</div>

            <button class="btnGhost" id="googleBtn2">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„</button>

            <div class="miniLinks">
              <button type="button" id="backLogin1">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</button>
            </div>

            <div class="msg danger" id="suErr"></div>
            <div class="msg ok" id="suOk"></div>
          </div>

          <!-- âœ… Ø´Ø§Ø´Ø© Ù†Ø³ÙŠØ§Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
          <div id="viewReset" style="display:none">
            <div class="title" style="font-size:22px;margin:4px 0 10px;">Ù†Ø³ÙŠØªÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</div>
            <div class="sub" style="margin-bottom:8px">Ø£Ø¯Ø®Ù„ÙŠ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</div>

            <div class="row">
              <div class="input">
                <span>âœ‰ï¸</span>
                <input id="rsEmail" type="email" autocomplete="email" placeholder="example@email.com" />
              </div>
            </div>

            <button class="btn" id="resetBtn" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>

            <div class="miniLinks">
              <button type="button" id="backLogin2">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>

            <div class="msg danger" id="rsErr"></div>
            <div class="msg ok" id="rsOk"></div>
          </div>

        </div>

        <div class="footer">Â© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† (Ø«Ø§Ø¨ØªØ©)
  // =========================
  const LS = {
    activated: "sndq_activated_v2",
    code: "sndq_code_v2",
    device: "sndq_device_id_v2",
    email: "sndq_email_v2",
    token: "sndq_token_v2"
  };

  const params = new URLSearchParams(location.search);
  const returnTo = sanitizeReturn(params.get("r") || "game_full.html");

  function sanitizeReturn(v){
    try{
      v = (v || "").trim();
      if(!v) return "game_full.html";
      if(v.startsWith("http://") || v.startsWith("https://")) return "game_full.html";
      v = v.replace(/^\/+/, "");
      return v;
    }catch{ return "game_full.html"; }
  }

  const $ = (id)=>document.getElementById(id);

  function showMsg(el, text, type){
    if(!el) return;
    el.classList.remove("danger","ok");
    el.classList.add(type);
    el.textContent = text;
    el.style.display = "block";
  }
  function hideMsg(el){
    if(!el) return;
    el.style.display = "none";
    el.textContent = "";
    el.classList.remove("danger","ok");
  }

  function setBadge(text, good=false){
    const b = $("codeBadge");
    b.textContent = text;
    b.classList.toggle("good", !!good);
    b.classList.toggle("bad", !good);
  }

  function normalizeCode(v){
    v = (v||"").toString().trim().toUpperCase();
    v = v.replace(/[â€“â€”âˆ’]/g, "-").replace(/\s+/g,"");
    return v;
  }

  function go(target){
    location.replace(target);
  }

  function ensureDeviceId(){
    let id = localStorage.getItem(LS.device);
    if(id && id.length > 10) return id;

    try{
      id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("dev-" + Math.random().toString(16).slice(2) + Date.now());
    }catch{
      id = "dev-" + Math.random().toString(16).slice(2) + Date.now();
    }
    localStorage.setItem(LS.device, id);
    return id;
  }

  function explainVerifyError(err){
    switch(err){
      case "MISSING_CODE": return "Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„.";
      case "DEVICE_REQUIRED": return "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù… ÙŠÙ†Ø´Ø¦ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø². Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø© ÙˆØ¬Ø±Ø¨.";
      case "INVALID_CODE": return "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø³Ø®Ù‡ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª.";
      case "CODE_USED_OTHER_DEVICE": return "Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.";
      default: return err ? ("ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„: " + err) : "ØªØ¹Ø°Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯.";
    }
  }

  function explainRegisterError(err){
    switch(err){
      case "INVALID_EMAIL": return "Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­.";
      case "WEAK_PASSWORD": return "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (Ù„Ø§Ø²Ù… 8 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±).";
      case "CODE_REQUIRED": return "Ù„Ø§Ø²Ù… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹.";
      case "ACTIVATE_FIRST": return "Ù„Ø§Ø²Ù… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹.";
      case "CODE_NOT_FOUND": return "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….";
      case "CODE_ALREADY_USED_ON_ANOTHER_DEVICE": return "Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.";
      case "EMAIL_EXISTS": return "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹.";
      case "DEVICE_REQUIRED": return "ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²â€¦ Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø© ÙˆØ¬Ø±Ø¨.";
      default: return err ? ("ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + err) : "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.";
    }
  }

  function isEmail(v){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||"").trim());
  }

  function boot(){
    const deviceId = ensureDeviceId();
    $("deviceNote").textContent = "Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¬Ù‡Ø§Ø²: " + deviceId.slice(0,8) + "â€¦ (Ø«Ø§Ø¨Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­)";

    const token = localStorage.getItem(LS.token) || "";
    const activated = localStorage.getItem(LS.activated) === "1";
    const savedCode = localStorage.getItem(LS.code) || "";

    if(activated && token){
      go(returnTo + (returnTo.includes("?") ? "&" : "?") + "t=" + encodeURIComponent(token));
      return;
    }

    if(activated && savedCode){
      setBadge("ACTIVATED", true);
      $("codeBox").style.display = "none";
      $("pageTitle").textContent = "ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„";
      $("pageSub").innerHTML = "Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…ÙÙØ¹Ù‘Ù„ âœ…<br>Ø§Ù„Ø¢Ù†: Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„.";
      wire();
      return;
    }

    setBadge("CODE_REQUIRED", false);
    $("codeBox").style.display = "block";
    wire();
  }

  function wire(){
    // ===== ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ =====
    const codeInput = $("codeInput");
    const activateBtn = $("activateBtn");
    const codeErr = $("codeErr");
    const codeOk = $("codeOk");

    function refreshActivateState(){
      const code = normalizeCode(codeInput.value);
      activateBtn.disabled = (code.length < 8);
      hideMsg(codeErr); hideMsg(codeOk);
      if(code.length >= 8) setBadge("READY", false);
      else setBadge("CODE_REQUIRED", false);
    }

    codeInput.addEventListener("input", refreshActivateState);
    refreshActivateState();

    activateBtn.addEventListener("click", async ()=>{
      hideMsg(codeErr); hideMsg(codeOk);

      const code = normalizeCode(codeInput.value);
      if(!code){
        showMsg(codeErr, "Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹", "danger");
        return;
      }

      activateBtn.disabled = true;
      setBadge("CHECKINGâ€¦", false);

      const deviceId = ensureDeviceId();

      try{
        const res = await fetch("/api/verify", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ code, deviceId }),
          cache: "no-store",
          credentials: "include"
        });

        const data = await res.json().catch(()=> ({}));

        // âœ… verify ÙŠØ±Ø¬Ø¹ ok/status â€” Ù…Ùˆ valid
        if(res.ok && data && data.ok){
          localStorage.setItem(LS.activated, "1");
          localStorage.setItem(LS.code, code);

          setBadge("ACTIVATED", true);
          showMsg(codeOk, "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ âœ… Ø§Ù„Ø¢Ù† Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„.", "ok");

          $("codeBox").style.display = "none";
          $("pageTitle").textContent = "ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„";
          $("pageSub").innerHTML = "Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…ÙÙØ¹Ù‘Ù„ âœ…<br>Ø§Ù„Ø¢Ù†: Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„.";

          activateBtn.disabled = false;
          return;
        }

        const err = (data && (data.error || data.message)) || ("HTTP_" + res.status);
        setBadge("INVALID_CODE", false);
        showMsg(codeErr, explainVerifyError(err), "danger");
        activateBtn.disabled = false;

      }catch(e){
        setBadge("NETWORK_ERROR", false);
        showMsg(codeErr, "Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„â€¦ Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.", "danger");
        activateBtn.disabled = false;
      }
    });

    // ===== Ø§Ù„Ø´Ø§Ø´Ø§Øª =====
    function showView(name){
      $("viewLogin").style.display  = (name==="login") ? "block" : "none";
      $("viewSignup").style.display = (name==="signup") ? "block" : "none";
      $("viewReset").style.display  = (name==="reset") ? "block" : "none";

      hideMsg($("loginErr")); hideMsg($("loginOk"));
      hideMsg($("suErr")); hideMsg($("suOk"));
      hideMsg($("rsErr")); hideMsg($("rsOk"));
    }

    $("goSignup").onclick = ()=>showView("signup");
    $("goReset").onclick  = ()=>showView("reset");
    $("backLogin1").onclick = ()=>showView("login");
    $("backLogin2").onclick = ()=>showView("login");

    // ===== ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ =====
    const loginEmail = $("loginEmail"), loginPass = $("loginPass"), loginBtn = $("loginBtn");
    function refreshLogin(){
      loginBtn.disabled = !(isEmail(loginEmail.value) && (loginPass.value||"").length >= 8);
      hideMsg($("loginErr")); hideMsg($("loginOk"));
    }
    loginEmail.addEventListener("input", refreshLogin);
    loginPass.addEventListener("input", refreshLogin);
    refreshLogin();

    const suEmail=$("suEmail"), suPass=$("suPass"), suPass2=$("suPass2"), signupBtn=$("signupBtn");
    function refreshSignup(){
      const ok = isEmail(suEmail.value) && suPass.value.length>=8 && suPass2.value.length>=8 && (suPass.value===suPass2.value);
      signupBtn.disabled = !ok;
      hideMsg($("suErr")); hideMsg($("suOk"));
    }
    suEmail.addEventListener("input", refreshSignup);
    suPass.addEventListener("input", refreshSignup);
    suPass2.addEventListener("input", refreshSignup);
    refreshSignup();

    const rsEmail=$("rsEmail"), resetBtn=$("resetBtn");
    function refreshReset(){
      resetBtn.disabled = !isEmail(rsEmail.value);
      hideMsg($("rsErr")); hideMsg($("rsOk"));
    }
    rsEmail.addEventListener("input", refreshReset);
    refreshReset();

    // ===== Google/Reset/Login (Ù…Ø¤Ù‚ØªØ§Ù‹) =====
    function googleStart(){
      showMsg($("loginErr"), "ØªØ³Ø¬ÙŠÙ„ Google Ø³Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ APIs. Ø­Ø§Ù„ÙŠØ§Ù‹ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·.", "danger");
    }
    $("googleBtn").onclick = googleStart;
    $("googleBtn2").onclick = googleStart;

    loginBtn.onclick = ()=> showMsg($("loginErr"), "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø³Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø®Ù„Øµ login API. Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆØ§Ø¬Ù‡Ø©.", "danger");
    resetBtn.onclick = ()=> showMsg($("rsErr"), "Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø³Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†. Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆØ§Ø¬Ù‡Ø©.", "danger");

    // âœ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: /api/register
    signupBtn.onclick = async ()=>{
      hideMsg($("suErr")); hideMsg($("suOk"));
      signupBtn.disabled = true;

      const email = (suEmail.value || "").trim();
      const password = suPass.value || "";
      const password2 = suPass2.value || "";

      if(!isEmail(email)){
        showMsg($("suErr"), "Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­.", "danger");
        signupBtn.disabled = false;
        return;
      }
      if(password.length < 8){
        showMsg($("suErr"), "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§Ø²Ù… 8 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±.", "danger");
        signupBtn.disabled = false;
        return;
      }
      if(password !== password2){
        showMsg($("suErr"), "ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.", "danger");
        signupBtn.disabled = false;
        return;
      }

      const code = localStorage.getItem(LS.code) || "";
      if(!code){
        showMsg($("suErr"), "Ù„Ø§Ø²Ù… ØªÙØ¹Ù‘Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹.", "danger");
        signupBtn.disabled = false;
        return;
      }

      // âœ…âœ… Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù‡Ù…: deviceId Ù„Ø§Ø²Ù… ÙŠØ±ÙˆØ­ Ù…Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      const deviceId = ensureDeviceId();

      try{
        const res = await fetch("/api/register", {
          method: "POST",
          headers: {
            "Content-Type":"application/json",
            "X-Device-Id": deviceId
          },
          body: JSON.stringify({ email, password, code, deviceId }),
          cache: "no-store",
          credentials: "include"
        });

        const data = await res.json().catch(()=> ({}));

        if(res.ok && data && data.ok && data.token){
          localStorage.setItem(LS.email, data.email || email);
          localStorage.setItem(LS.token, data.token);

          showMsg($("suOk"), "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ… Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø©â€¦", "ok");

          setTimeout(()=>{
            go(returnTo + (returnTo.includes("?") ? "&" : "?") + "t=" + encodeURIComponent(data.token));
          }, 450);
          return;
        }

        const err = (data && (data.error || data.message)) || ("HTTP_" + res.status);
        showMsg($("suErr"), explainRegisterError(err), "danger");
        signupBtn.disabled = false;

      }catch(e){
        showMsg($("suErr"), "Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„â€¦ Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.", "danger");
        signupBtn.disabled = false;
      }
    };
  }

  boot();
</script>
</body>
</html>
