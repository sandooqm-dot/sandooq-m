<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© | ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

  <style>
    :root{
      --bg1:#6c2bd9;
      --bg2:#ff3aa7;
      --card: rgba(255,255,255,.16);
      --card2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.22);
      --text:#fff;
      --muted: rgba(255,255,255,.80);
      --input: rgba(255,255,255,.14);
      --btn: linear-gradient(90deg, #ff3aa7 0%, #6c2bd9 100%);
      --btn2: rgba(255,255,255,.14);
      --danger:#ff4d4d;
      --ok:#2fe38c;
      --shadow: 0 18px 50px rgba(0,0,0,.25);
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% 25%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow:hidden;
    }

    /* Ø®Ù„ÙÙŠØ© Ø³Ø¯Ø§Ø³ÙŠØ© Ø®ÙÙŠÙØ© */
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(30deg, rgba(255,255,255,.08) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,.08) 87.5%, rgba(255,255,255,.08)),
        linear-gradient(150deg, rgba(255,255,255,.08) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,.08) 87.5%, rgba(255,255,255,.08)),
        linear-gradient(90deg, rgba(255,255,255,.06) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,.06) 87.5%, rgba(255,255,255,.06));
      background-size: 86px 150px;
      background-position: 0 0, 0 0, 43px 75px;
      opacity:.45;
      pointer-events:none;
      filter: blur(.2px);
    }

    .page{
      position:relative;
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .wrap{
      width:min(560px, 92vw);
      border-radius:26px;
      background: var(--card);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .topLogo{
      display:flex;
      justify-content:center;
      padding:18px 18px 0;
    }
    .topLogo img{
      width:70px;height:70px;object-fit:contain;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.25));
    }

    .content{ padding:14px 18px 18px; }

    .title{
      text-align:center;
      margin:6px 0 6px;
      font-size:26px;
      font-weight:900;
      letter-spacing:.2px;
      text-shadow: 0 8px 18px rgba(0,0,0,.25);
    }

    .sub{
      text-align:center;
      margin:0 0 14px;
      color:var(--muted);
      font-size:14px;
      line-height:1.8;
    }

    .panel{
      background: var(--card2);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px;
    }

    .row{ margin:10px 0; }

    .input{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.20);
      background: var(--input);
      box-sizing:border-box;
    }
    .input span{
      opacity:.85;
      font-size:18px;
      width:26px;
      text-align:center;
    }
    .input input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:15px;
    }
    .input input::placeholder{ color: rgba(255,255,255,.65); }

    .btn{
      width:100%;
      border:0;
      cursor:pointer;
      padding:13px 14px;
      border-radius:14px;
      color:#fff;
      font-weight:800;
      font-size:15px;
      background: var(--btn);
      box-shadow: 0 14px 26px rgba(0,0,0,.18);
      transition: transform .12s ease, opacity .12s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    .btnGhost{
      width:100%;
      border:1px solid rgba(255,255,255,.25);
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      color:#fff;
      font-weight:800;
      font-size:14px;
      background: var(--btn2);
      transition: transform .12s ease, opacity .12s ease;
    }
    .btnGhost:active{ transform: scale(.99); }
    .btnGhost[disabled]{ opacity:.45; cursor:not-allowed; transform:none; }

    .sep{
      display:flex;
      align-items:center;
      gap:10px;
      margin:14px 0 10px;
      color:rgba(255,255,255,.7);
      font-weight:700;
      justify-content:center;
    }
    .sep::before,.sep::after{
      content:"";
      height:1px;
      flex:1;
      background: rgba(255,255,255,.25);
    }

    .miniLinks{
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .miniLinks button{
      background:transparent;
      border:0;
      color:rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      text-decoration: underline;
      text-underline-offset: 4px;
    }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      font-weight:800;
      text-align:center;
      display:none;
    }
    .msg.danger{ border-color: rgba(255,77,77,.6); color: #ffd7d7; }
    .msg.ok{ border-color: rgba(47,227,140,.55); color: #d9ffe9; }

    /* Ù‚Ø³Ù… Ø§Ù„ÙƒÙˆØ¯ ÙÙˆÙ‚ */
    .codeBox{
      background: rgba(0,0,0,.12);
      border:1px dashed rgba(255,255,255,.28);
      border-radius:18px;
      padding:12px;
      margin-bottom:12px;
    }
    .codeHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .codeHeader .tag{
      font-weight:900;
      font-size:13px;
      opacity:.92;
    }
    .badge{
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .badge.bad{ border-color: rgba(255,77,77,.6); color:#ffd0d0; }
    .badge.good{ border-color: rgba(47,227,140,.55); color:#d9ffe9; }

    .footer{
      text-align:center;
      padding:10px 0 14px;
      color:rgba(255,255,255,.75);
      font-weight:800;
      font-size:12px;
    }

    @media (max-width:420px){
      .title{font-size:24px}
      .wrap{border-radius:22px}
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="wrap">
      <div class="topLogo">
        <img src="logo.png" alt="logo">
      </div>

      <div class="content">

        <div class="title" id="pageTitle">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
        <div class="sub" id="pageSub">
          Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·: Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².<br>
          Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„â€¦ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØµÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
        </div>

        <div class="panel">

          <!-- âœ… Ù‚Ø³Ù… Ø§Ù„ÙƒÙˆØ¯ (ÙÙˆÙ‚) -->
          <div class="codeBox" id="codeBox">
            <div class="codeHeader">
              <div class="tag">ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·)</div>
              <div class="badge bad" id="codeBadge">CODE_REQUIRED</div>
            </div>

            <div class="row">
              <div class="input">
                <span>ğŸ”‘</span>
                <input id="codeInput" inputmode="text" autocomplete="off" placeholder="SNDOQ-XXXX-XXXX-XXXX" />
              </div>
            </div>

            <button class="btn" id="activateBtn" disabled>ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯</button>

            <div class="msg danger" id="codeErr"></div>
            <div class="msg ok" id="codeOk"></div>
          </div>

          <!-- âœ… Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
          <div id="viewLogin">
            <div class="row">
              <div class="input">
                <span>ğŸ‘¤</span>
                <input id="loginEmail" type="email" autocomplete="email" placeholder="example@email.com" />
              </div>
            </div>
            <div class="row">
              <div class="input">
                <span>ğŸ”’</span>
                <input id="loginPass" type="password" autocomplete="current-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              </div>
            </div>

            <button class="btn" id="loginBtn" disabled>Ø¯Ø®ÙˆÙ„</button>

            <div class="sep">Ø£Ùˆ</div>

            <button class="btnGhost" id="googleBtn">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„</button>

            <div class="miniLinks">
              <button type="button" id="goSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
              <button type="button" id="goReset">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
            </div>

            <div class="msg danger" id="loginErr"></div>
            <div class="msg ok" id="loginOk"></div>
          </div>

          <!-- âœ… Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
          <div id="viewSignup" style="display:none">
            <div class="title" style="font-size:22px;margin:4px 0 10px;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>

            <div class="row">
              <div class="input">
                <span>âœ‰ï¸</span>
                <input id="suEmail" type="email" autocomplete="email" placeholder="example@email.com" />
              </div>
            </div>
            <div class="row">
              <div class="input">
                <span>ğŸ”’</span>
                <input id="suPass" type="password" autocomplete="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              </div>
            </div>
            <div class="row">
              <div class="input">
                <span>ğŸ”’</span>
                <input id="suPass2" type="password" autocomplete="new-password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              </div>
            </div>

            <button class="btn" id="signupBtn" disabled>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>

            <div class="sep">Ø£Ùˆ</div>

            <button class="btnGhost" id="googleBtn2">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„</button>

            <div class="miniLinks">
              <button type="button" id="backLogin1">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</button>
            </div>

            <div class="msg danger" id="suErr"></div>
            <div class="msg ok" id="suOk"></div>
          </div>

          <!-- âœ… Ø´Ø§Ø´Ø© Ù†Ø³ÙŠØ§Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
          <div id="viewReset" style="display:none">
            <div class="title" style="font-size:22px;margin:4px 0 10px;">Ù†Ø³ÙŠØªÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</div>
            <div class="sub" style="margin-bottom:8px">Ø£Ø¯Ø®Ù„ÙŠ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ³Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</div>

            <div class="row">
              <div class="input">
                <span>âœ‰ï¸</span>
                <input id="rsEmail" type="email" autocomplete="email" placeholder="example@email.com" />
              </div>
            </div>

            <button class="btn" id="resetBtn" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>

            <div class="miniLinks">
              <button type="button" id="backLogin2">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>

            <div class="msg danger" id="rsErr"></div>
            <div class="msg ok" id="rsOk"></div>
          </div>

        </div>

        <div class="footer">Â© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† (Ø«Ø§Ø¨ØªØ©)
  // =========================
  const LS = {
    activated: "sndq_activated_v1",
    code: "sndq_code_v1",
    email: "sndq_email_v1",
    token: "sndq_token_v1"
  };

  // âœ… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªÙØ¹ÙŠÙ„
  const params = new URLSearchParams(location.search);
  const returnTo = sanitizeReturn(params.get("r") || "play.html");

  function sanitizeReturn(v){
    try{
      v = (v || "").trim();
      if(!v) return "play.html";
      // Ù…Ù†Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠØ©
      if(v.startsWith("http://") || v.startsWith("https://")) return "play.html";
      // Ù…Ù†Ø¹ Ù…Ø³Ø§Ø±Ø§Øª ØºØ±ÙŠØ¨Ø©
      v = v.replace(/^\//, "");
      return v;
    }catch{ return "play.html"; }
  }

  // =========================
  // Helpers UI
  // =========================
  const $ = (id)=>document.getElementById(id);

  function showMsg(el, text, type){
    if(!el) return;
    el.classList.remove("danger","ok");
    el.classList.add(type);
    el.textContent = text;
    el.style.display = "block";
  }
  function hideMsg(el){
    if(!el) return;
    el.style.display = "none";
    el.textContent = "";
    el.classList.remove("danger","ok");
  }

  function setBadge(text, good=false){
    const b = $("codeBadge");
    b.textContent = text;
    b.classList.toggle("good", !!good);
    b.classList.toggle("bad", !good);
  }

  function isEmail(v){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||"").trim());
  }

  function normalizeCode(v){
    v = (v||"").trim().toUpperCase();
    v = v.replace(/\s+/g,"");
    return v;
  }

  function go(target){
    // Ù…Ù†Ø¹ loop: Ù†Ø³ØªØ®Ø¯Ù… replace Ø¨Ø¯Ù„ assign
    location.replace(target);
  }

  // =========================
  // Ù…Ù†Ø¹ â€œØ­Ù„Ù‚Ø©â€ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  // =========================
  function boot(){
    // Ø¥Ø°Ø§ Ù…ØªÙØ¹Ù„ ÙˆØ¹Ù†Ø¯Ù†Ø§ tokenâ€¦ Ù†Ø·Ù„Ø¹ ÙÙˆØ±Ù‹Ø§
    const activated = localStorage.getItem(LS.activated) === "1";
    const token = localStorage.getItem(LS.token) || "";
    const email = localStorage.getItem(LS.email) || "";

    if(activated && token && email){
      // Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±
      go(returnTo + (returnTo.includes("?") ? "&" : "?") + "t=" + encodeURIComponent(token));
      return;
    }

    // Ù„Ùˆ Ù…ØªÙØ¹Ù„ Ø¨Ø¯ÙˆÙ† token (Ø­Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…Ø©) Ù†Ø®Ù„ÙŠÙ‡ ÙŠØ·Ù„Ø¨ Ø¯Ø®ÙˆÙ„
    if(activated && !token){
      setBadge("ACTIVATED", true);
      $("codeBox").style.display = "none";
      $("pageTitle").textContent = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      $("pageSub").innerHTML = "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²â€¦ Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.";
    } else {
      // ØºÙŠØ± Ù…ÙØ¹Ù„: Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§Ø²Ù…
      setBadge("CODE_REQUIRED", false);
      $("codeBox").style.display = "block";
    }

    wire();
  }

  // =========================
  // Wiring
  // =========================
  function wire(){
    // ------- Code activation -------
    const codeInput = $("codeInput");
    const activateBtn = $("activateBtn");
    const codeErr = $("codeErr");
    const codeOk = $("codeOk");

    function refreshActivateState(){
      const code = normalizeCode(codeInput.value);
      activateBtn.disabled = (code.length < 8); // Ù…Ø±Ù†
      hideMsg(codeErr); hideMsg(codeOk);
    }
    codeInput.addEventListener("input", refreshActivateState);
    refreshActivateState();

    activateBtn.addEventListener("click", async ()=>{
      hideMsg(codeErr); hideMsg(codeOk);
      activateBtn.disabled = true;

      const code = normalizeCode(codeInput.value);
      if(!code){
        showMsg(codeErr, "Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹", "danger");
        activateBtn.disabled = false;
        return;
      }

      try{
        // 1) Ø¬Ø±Ù‘Ø¨ API ÙÙŠ Cloudflare (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯Ùƒ)
        const r = await fetch("/api/activate", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ code })
        });

        if(r.ok){
          const data = await r.json().catch(()=>({}));
          if(data && data.ok && data.token){
            localStorage.setItem(LS.activated, "1");
            localStorage.setItem(LS.code, code);
            localStorage.setItem(LS.token, data.token);
            if(data.email) localStorage.setItem(LS.email, data.email);

            setBadge("ACTIVATED", true);
            showMsg(codeOk, "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ âœ…", "ok");
            // Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù†Ø®Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ù„Ùˆ Ø±Ø¬Ù‘Ø¹Ù†Ø§ token ÙƒØ§Ù…Ù„ Ù†ÙØªØ­ Ù…Ø¨Ø§Ø´Ø±Ø©
            go(returnTo + (returnTo.includes("?") ? "&" : "?") + "t=" + encodeURIComponent(data.token));
            return;
          }
          // Ù„Ùˆ Ø±Ø¬Ø¹ ok=false
          showMsg(codeErr, (data && data.message) ? data.message : "ØªØ¹Ø°Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯", "danger");
          setBadge("INVALID_CODE", false);
          activateBtn.disabled = false;
          return;
        }

        // 2) Ø¥Ø°Ø§ API ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯â€¦ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø© Ø¨Ø¯Ù„ ØªØ¹Ù„ÙŠÙ‚
        showMsg(codeErr, "ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ /api/activate ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ù„Ø§Ø²Ù… Ù†Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø¨Ø§ÙƒÙ†Ø¯ (Cloudflare Workers + D1) Ø¹Ø´Ø§Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¹Ø§Ù„Ù…ÙŠ ÙˆØ«Ø§Ø¨Øª.", "danger");
        setBadge("BACKEND_REQUIRED", false);
        activateBtn.disabled = false;

      } catch (e){
        showMsg(codeErr, "ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.", "danger");
        setBadge("NETWORK_ERROR", false);
        activateBtn.disabled = false;
      }
    });

    // ------- Login / Signup / Reset views -------
    function showView(name){
      $("viewLogin").style.display  = (name==="login") ? "block" : "none";
      $("viewSignup").style.display = (name==="signup") ? "block" : "none";
      $("viewReset").style.display  = (name==="reset") ? "block" : "none";

      hideMsg($("loginErr")); hideMsg($("loginOk"));
      hideMsg($("suErr")); hideMsg($("suOk"));
      hideMsg($("rsErr")); hideMsg($("rsOk"));
    }

    $("goSignup").onclick = ()=>showView("signup");
    $("goReset").onclick  = ()=>showView("reset");
    $("backLogin1").onclick = ()=>showView("login");
    $("backLogin2").onclick = ()=>showView("login");

    // ------- Enable buttons -------
    const loginEmail = $("loginEmail"), loginPass = $("loginPass");
    const loginBtn = $("loginBtn");

    function refreshLogin(){
      loginBtn.disabled = !(isEmail(loginEmail.value) && (loginPass.value||"").length >= 6);
      hideMsg($("loginErr")); hideMsg($("loginOk"));
    }
    loginEmail.addEventListener("input", refreshLogin);
    loginPass.addEventListener("input", refreshLogin);
    refreshLogin();

    const suEmail=$("suEmail"), suPass=$("suPass"), suPass2=$("suPass2");
    const signupBtn=$("signupBtn");
    function refreshSignup(){
      const ok = isEmail(suEmail.value) && suPass.value.length>=6 && suPass2.value.length>=6 && (suPass.value===suPass2.value);
      signupBtn.disabled = !ok;
      hideMsg($("suErr")); hideMsg($("suOk"));
    }
    suEmail.addEventListener("input", refreshSignup);
    suPass.addEventListener("input", refreshSignup);
    suPass2.addEventListener("input", refreshSignup);
    refreshSignup();

    const rsEmail=$("rsEmail"), resetBtn=$("resetBtn");
    function refreshReset(){
      resetBtn.disabled = !isEmail(rsEmail.value);
      hideMsg($("rsErr")); hideMsg($("rsOk"));
    }
    rsEmail.addEventListener("input", refreshReset);
    refreshReset();

    // ------- Actions (ØªØ­ØªØ§Ø¬ Ø¨Ø§ÙƒÙ†Ø¯) -------
    $("loginBtn").onclick = async ()=>{
      hideMsg($("loginErr")); hideMsg($("loginOk"));
      loginBtn.disabled = true;

      try{
        const r = await fetch("/api/auth/login", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ email: loginEmail.value.trim(), password: loginPass.value })
        });

        const data = await r.json().catch(()=>({}));
        if(r.ok && data && data.ok && data.token){
          localStorage.setItem(LS.activated, "1");
          localStorage.setItem(LS.email, loginEmail.value.trim());
          localStorage.setItem(LS.token, data.token);
          showMsg($("loginOk"), "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…", "ok");
          go(returnTo + (returnTo.includes("?") ? "&" : "?") + "t=" + encodeURIComponent(data.token));
          return;
        }

        showMsg($("loginErr"), (data && data.message) ? data.message : "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©", "danger");
        loginBtn.disabled = false;

      } catch{
        showMsg($("loginErr"), "ÙˆØ§Ø¬Ù‡Ù†Ø§ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† /api/auth/login ÙÙŠ Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯.", "danger");
        loginBtn.disabled = false;
      }
    };

    $("signupBtn").onclick = async ()=>{
      hideMsg($("suErr")); hideMsg($("suOk"));
      signupBtn.disabled = true;

      try{
        const r = await fetch("/api/auth/signup", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ email: suEmail.value.trim(), password: suPass.value })
        });

        const data = await r.json().catch(()=>({}));
        if(r.ok && data && data.ok){
          showMsg($("suOk"), "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ… Ø§Ù„Ø¢Ù† Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ", "ok");
          // Ù†Ù†Ù‚Ù„Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙˆÙ†Ø¹Ø¨Ù‘ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
          showView("login");
          $("loginEmail").value = suEmail.value.trim();
          $("loginPass").value = "";
          refreshLogin();
          return;
        }

        showMsg($("suErr"), (data && data.message) ? data.message : "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨", "danger");
        signupBtn.disabled = false;

      } catch{
        showMsg($("suErr"), "ÙˆØ§Ø¬Ù‡Ù†Ø§ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† /api/auth/signup ÙÙŠ Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯.", "danger");
        signupBtn.disabled = false;
      }
    };

    $("resetBtn").onclick = async ()=>{
      hideMsg($("rsErr")); hideMsg($("rsOk"));
      resetBtn.disabled = true;

      try{
        const r = await fetch("/api/auth/reset", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ email: rsEmail.value.trim() })
        });

        const data = await r.json().catch(()=>({}));
        if(r.ok && data && data.ok){
          showMsg($("rsOk"), "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…", "ok");
          resetBtn.disabled = false;
          return;
        }

        showMsg($("rsErr"), (data && data.message) ? data.message : "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", "danger");
        resetBtn.disabled = false;

      } catch{
        showMsg($("rsErr"), "ÙˆØ§Ø¬Ù‡Ù†Ø§ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† /api/auth/reset ÙÙŠ Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯.", "danger");
        resetBtn.disabled = false;
      }
    };

    // Google (ÙŠØ­ØªØ§Ø¬ OAuth ÙÙŠ Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯)
    function googleStart(){
      // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ endpoint Ø¬Ø§Ù‡Ø² Ø¨ÙŠØ¨Ø¯Ø£ OAuth
      // ÙŠØ±Ø¬Ø¹Ù†Ø§ Ø¨Ø¹Ø¯Ù‡Ø§ Ù„Ù€ /activate.html?r=...&token=...
      location.href = "/api/auth/google?return=" + encodeURIComponent("/activate.html?r=" + returnTo);
    }
    $("googleBtn").onclick = googleStart;
    $("googleBtn2").onclick = googleStart;
  }

  boot();
</script>
</body>
</html>
