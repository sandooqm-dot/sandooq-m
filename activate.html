<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>تسجيل الدخول</title>
  <style>
    :root{
      --bg1:#7e49b7;
      --bg2:#c84aa3;
      --card: rgba(255,255,255,.14);
      --card2: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.22);
      --text:#fff;
      --muted: rgba(255,255,255,.75);
      --danger:#ff6b6b;
      --ok:#2ee59d;
      --btn1:#ff4fb8;
      --btn2:#5b7cff;
      --shadow: 0 20px 60px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box;font-family: system-ui,-apple-system,"Segoe UI",Tahoma,Arial;}
    body{
      margin:0; min-height:100vh;
      background: radial-gradient(1200px 700px at 25% 20%, rgba(255,255,255,.18), transparent 60%),
                  linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      color:var(--text);
    }
    .wrap{width:min(420px, 100%);}
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--border);
      border-radius:28px;
      box-shadow: var(--shadow);
      padding:22px 18px 18px;
      backdrop-filter: blur(10px);
    }
    .logo{
      display:flex; align-items:center; justify-content:center;
      margin:6px 0 10px;
    }
    .logo img{
      height:34px; width:auto; display:block;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }
    h1{
      margin:6px 0 6px;
      text-align:center;
      font-size:40px; letter-spacing:.5px;
    }
    .sub{
      margin:0 0 14px;
      text-align:center;
      color:var(--muted);
      line-height:1.55;
      font-size:14px;
    }
    .field{
      position:relative;
      margin:10px 0;
    }
    input{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.12);
      color:#fff;
      padding:14px 14px;
      outline:none;
      font-size:16px;
    }
    input::placeholder{color: rgba(255,255,255,.55);}
    .btn{
      width:100%;
      border:none;
      border-radius:18px;
      padding:14px 14px;
      color:#fff;
      font-size:18px;
      cursor:pointer;
      background: linear-gradient(90deg, var(--btn1), var(--btn2));
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      margin-top:10px;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed;}
    .sep{
      display:flex; align-items:center; gap:10px;
      margin:14px 0 12px;
      color:rgba(255,255,255,.7);
    }
    .sep:before,.sep:after{
      content:""; height:1px; background:rgba(255,255,255,.28); flex:1;
    }
    .gbtn{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.35);
      background:#fff;
      color:#111;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .g{
      width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:50%;
      background:#fff;
    }
    .links{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      font-size:14px;
      color: rgba(255,255,255,.8);
    }
    .links a{
      color: rgba(255,255,255,.88);
      text-decoration:none;
      border-bottom:1px dashed rgba(255,255,255,.35);
      padding-bottom:2px;
    }
    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.14);
      color:rgba(255,255,255,.92);
      font-size:14px;
      line-height:1.5;
      display:none;
    }
    .msg.ok{border-color: rgba(46,229,157,.55); color:#eafff6;}
    .msg.bad{border-color: rgba(255,107,107,.55); color:#fff2f2;}
    .foot{
      text-align:center;
      margin-top:14px;
      color: rgba(255,255,255,.75);
      font-size:12px;
    }
    .hide{display:none !important;}
    .smallbtn{
      width:100%;
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(0,0,0,.10);
      color:#fff;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="logo">
        <img src="logo.png" alt="logo">
      </div>

      <!-- LOADING -->
      <section id="viewLoading">
        <h1 style="font-size:34px;">جاري التحقق…</h1>
        <p class="sub">لحظة بس ✨</p>
        <div class="msg" id="loadingMsg"></div>
      </section>

      <!-- LOGIN -->
      <section id="viewLogin" class="hide">
        <h1>تسجيل الدخول</h1>
        <p class="sub">لازم تسجل دخول عشان تفتح اللعبة.<br>(إذا حسابك مُفعّل بتدخل اللعبة مباشرة)</p>

        <div class="field">
          <input id="loginEmail" type="email" placeholder="example@email.com" autocomplete="email">
        </div>
        <div class="field">
          <input id="loginPass" type="password" placeholder="********" autocomplete="current-password">
        </div>

        <button class="btn" id="btnLogin">دخول</button>

        <div class="sep">أو</div>

        <button class="gbtn" id="btnGoogle">
          <span class="g">G</span>
          الدخول بواسطة حساب جوجل
        </button>

        <div class="links">
          <a href="#" id="goRegister">إنشاء حساب جديد</a>
          <a href="#" id="goForgot">نسيت كلمة المرور؟</a>
        </div>

        <div class="msg" id="loginMsg"></div>
        <div class="foot">© صندوق المسابقات</div>
      </section>

      <!-- REGISTER -->
      <section id="viewRegister" class="hide">
        <h1 style="font-size:34px;">إنشاء حساب</h1>
        <p class="sub">اكتب الإيميل وكلمة المرور… وبنرسل لك رمز تحقق.</p>

        <div class="field">
          <input id="regEmail" type="email" placeholder="example@email.com" autocomplete="email">
        </div>
        <div class="field">
          <input id="regPass" type="password" placeholder="كلمة المرور" autocomplete="new-password">
        </div>
        <div class="field">
          <input id="regPass2" type="password" placeholder="تأكيد كلمة المرور" autocomplete="new-password">
        </div>

        <button class="btn" id="btnRegister">إنشاء حساب</button>

        <div class="sep">أو</div>

        <button class="gbtn" id="btnGoogle2">
          <span class="g">G</span>
          إنشاء/دخول عبر جوجل
        </button>

        <div class="links">
          <a href="#" id="backToLogin1">رجوع لتسجيل الدخول</a>
          <span></span>
        </div>

        <div class="msg" id="regMsg"></div>
        <div class="foot">© صندوق المسابقات</div>
      </section>

      <!-- OTP -->
      <section id="viewOtp" class="hide">
        <h1 style="font-size:34px;">تأكيد البريد</h1>
        <p class="sub">أدخل رمز التحقق المرسل لبريدك.</p>

        <div class="field">
          <input id="otpEmail" type="email" placeholder="email" readonly>
        </div>

        <div class="field">
          <input id="otpCode" inputmode="numeric" placeholder="رمز التحقق" autocomplete="one-time-code">
        </div>

        <button class="btn" id="btnVerifyOtp">تأكيد</button>
        <button class="smallbtn" id="btnResendOtp">إعادة إرسال الرمز</button>

        <div class="links">
          <a href="#" id="backToLogin2">رجوع</a>
          <span></span>
        </div>

        <div class="msg" id="otpMsg"></div>
        <div class="foot">© صندوق المسابقات</div>
      </section>

      <!-- ACTIVATE CODE -->
      <section id="viewCode" class="hide">
        <h1 style="font-size:34px;">تفعيل الكود</h1>
        <p class="sub">اول مرة فقط: أدخل كود التفعيل لربطه بحسابك.</p>

        <div class="field">
          <input id="actCode" placeholder="اكتب كود التفعيل هنا…">
        </div>

        <button class="btn" id="btnActivate">تفعيل</button>
        <button class="smallbtn" id="btnLogout">تسجيل خروج (للاختبار)</button>

        <div class="msg" id="codeMsg"></div>
        <div class="foot">© صندوق المسابقات</div>
      </section>

      <!-- FORGOT (Placeholder) -->
      <section id="viewForgot" class="hide">
        <h1 style="font-size:34px;">نسيت كلمة المرور</h1>
        <p class="sub">هذي الخطوة بنكمّلها بعد ما نثبت Google بالكامل.</p>
        <button class="smallbtn" id="backToLogin3">رجوع</button>
        <div class="foot">© صندوق المسابقات</div>
      </section>

    </div>
  </div>

<script>
(() => {
  // ==== CONFIG ====
  const TOKEN_KEY  = "sandooq_token_v1";
  const DEVICE_KEY = "sandooq_device_id_v1";
  const GAME_KEY   = "horof";   // مهم لتمييز اللعبة
  const GAME_URL   = "/app";    // وجهة اللعبة بعد التفعيل

  // ==== UI HELPERS ====
  const $ = (id) => document.getElementById(id);

  const views = {
    loading: $("viewLoading"),
    login: $("viewLogin"),
    register: $("viewRegister"),
    otp: $("viewOtp"),
    code: $("viewCode"),
    forgot: $("viewForgot"),
  };

  function show(viewName){
    Object.values(views).forEach(v => v.classList.add("hide"));
    views[viewName].classList.remove("hide");
  }

  function setMsg(el, text, kind){
    if(!el) return;
    el.className = "msg" + (kind ? (" " + kind) : "");
    el.textContent = text || "";
    el.style.display = text ? "block" : "none";
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // ==== DEVICE ID ====
  function getDeviceId(){
    let id = localStorage.getItem(DEVICE_KEY);
    if(!id){
      try{ id = crypto.randomUUID(); }
      catch{ id = "dev_" + Math.random().toString(16).slice(2) + Date.now(); }
      localStorage.setItem(DEVICE_KEY, id);
    }
    return id;
  }

  // ==== URL PARAMS ====
  function getParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }
  function removeParams(...names){
    const u = new URL(location.href);
    names.forEach(n => u.searchParams.delete(n));
    history.replaceState({}, "", u.toString());
  }

  // ==== API ====
  async function api(path, {method="GET", body=null, auth=true} = {}){
    const headers = { "Content-Type": "application/json", "X-Device-Id": getDeviceId() };
    const token = localStorage.getItem(TOKEN_KEY);

    if(auth && token) headers["Authorization"] = "Bearer " + token;

    const res = await fetch(path, {
      method,
      headers,
      credentials: "include",
      body: body ? JSON.stringify(body) : null
    });

    const text = await res.text();
    let json = null;
    try{ json = text ? JSON.parse(text) : null; }catch{}
    return { ok: res.ok, status: res.status, json, text };
  }

  function extractToken(payload){
    if(!payload) return null;
    return payload.token || payload.authToken || payload.access_token || payload.accessToken || null;
  }

  function isActivated(payload){
    // نحاول نلتقط أي شكل منطقي ممكن من /api2/me
    if(!payload) return false;

    if(payload.activated === true) return true;
    if(payload.is_activated === true) return true;
    if(payload.has_activation === true) return true;
    if(payload.hasGame === true) return true;
    if(payload.license === true) return true;

    const user = payload.user || payload.data || null;
    if(user){
      if(user.activated === true) return true;
      if(user.has_activation === true) return true;
      if(Array.isArray(user.games) && user.games.includes(GAME_KEY)) return true;
      if(Array.isArray(user.activated_games) && user.activated_games.includes(GAME_KEY)) return true;
    }

    if(Array.isArray(payload.games) && payload.games.includes(GAME_KEY)) return true;
    if(Array.isArray(payload.activated_games) && payload.activated_games.includes(GAME_KEY)) return true;

    return false;
  }

  async function boot(){
    show("loading");
    setMsg($("loadingMsg"), "", "");

    // reset للتجربة
    if(getParam("reset") === "1"){
      localStorage.removeItem(TOKEN_KEY);
      // لا نمسح device id إلا إذا تبغى
      removeParams("reset");
    }

    // لو جاء توكن بالـ URL (اختياري للمستقبل)
    const urlToken = getParam("token") || getParam("t");
    if(urlToken){
      localStorage.setItem(TOKEN_KEY, urlToken);
      removeParams("token","t");
    }

    // 1) جرّب /api2/me (بالتوكن إن وجد) أو بالكوكيز
    const me = await api(`/api2/me?game=${encodeURIComponent(GAME_KEY)}`, { method:"GET", auth:true });

    if(me.ok){
      // لو السيرفر رجّع توكن جديد
      const t = extractToken(me.json);
      if(t) localStorage.setItem(TOKEN_KEY, t);

      // 2) إذا مفعّل -> للعبة
      if(isActivated(me.json)){
        location.replace(GAME_URL);
        return;
      }

      // 3) إذا غير مفعّل -> شاشة الكود
      show("code");
      setMsg($("codeMsg"), "تم تسجيل الدخول ✅ الآن فعّل الكود لأول مرة فقط.", "ok");
      return;
    }

    // غير مسجّل: روح للّوجين
    show("login");
  }

  // ==== EVENTS ====
  $("btnGoogle").addEventListener("click", () => {
    // أهم شيء: لا تفتح callback مباشرة — لازم start
    location.href = `/api2/google/start?game=${encodeURIComponent(GAME_KEY)}&return=${encodeURIComponent("/activate")}`;
  });
  $("btnGoogle2").addEventListener("click", () => {
    location.href = `/api2/google/start?game=${encodeURIComponent(GAME_KEY)}&return=${encodeURIComponent("/activate")}`;
  });

  $("btnLogin").addEventListener("click", async () => {
    const email = $("loginEmail").value.trim();
    const pass  = $("loginPass").value;
    if(!email || !pass){
      setMsg($("loginMsg"), "اكتب الإيميل وكلمة المرور.", "bad");
      return;
    }
    setMsg($("loginMsg"), "جاري تسجيل الدخول…", "");
    const r = await api("/api2/login", { method:"POST", body:{ email, password: pass }, auth:false });
    if(!r.ok){
      setMsg($("loginMsg"), (r.json && (r.json.error || r.json.message)) ? (r.json.error || r.json.message) : "فشل تسجيل الدخول.", "bad");
      return;
    }
    const t = extractToken(r.json);
    if(t) localStorage.setItem(TOKEN_KEY, t);
    await boot();
  });

  $("goRegister").addEventListener("click", (e) => { e.preventDefault(); show("register"); setMsg($("regMsg"), "", ""); });
  $("backToLogin1").addEventListener("click", (e) => { e.preventDefault(); show("login"); setMsg($("loginMsg"), "", ""); });
  $("backToLogin2").addEventListener("click", (e) => { e.preventDefault(); show("login"); setMsg($("loginMsg"), "", ""); });
  $("backToLogin3").addEventListener("click", (e) => { e.preventDefault(); show("login"); });

  $("goForgot").addEventListener("click", (e) => { e.preventDefault(); show("forgot"); });

  $("btnRegister").addEventListener("click", async () => {
    const email = $("regEmail").value.trim();
    const p1 = $("regPass").value;
    const p2 = $("regPass2").value;
    if(!email || !p1 || !p2){
      setMsg($("regMsg"), "كمّل الحقول.", "bad");
      return;
    }
    if(p1 !== p2){
      setMsg($("regMsg"), "كلمتا المرور غير متطابقتين.", "bad");
      return;
    }
    setMsg($("regMsg"), "جاري إنشاء الحساب…", "");
    const r = await api("/api2/register", { method:"POST", body:{ email, password: p1 }, auth:false });
    if(!r.ok){
      setMsg($("regMsg"), (r.json && (r.json.error || r.json.message)) ? (r.json.error || r.json.message) : "فشل إنشاء الحساب.", "bad");
      return;
    }

    // بعض الأنظمة ترجع token مباشرة، وبعضها لا (OTP أولاً)
    const t = extractToken(r.json);
    if(t) localStorage.setItem(TOKEN_KEY, t);

    // ندخّلك شاشة OTP دائمًا أولاً حسب تدفقك الحالي
    $("otpEmail").value = email;
    show("otp");
    setMsg($("otpMsg"), "تم الإرسال ✅ اكتب رمز التحقق.", "ok");
  });

  $("btnVerifyOtp").addEventListener("click", async () => {
    const email = $("otpEmail").value.trim();
    const otp   = $("otpCode").value.trim();
    if(!email || !otp){
      setMsg($("otpMsg"), "اكتب الرمز.", "bad");
      return;
    }
    setMsg($("otpMsg"), "جاري التحقق…", "");
    const r = await api("/api2/verify-email", { method:"POST", body:{ email, otp }, auth:false });
    if(!r.ok){
      setMsg($("otpMsg"), (r.json && (r.json.error || r.json.message)) ? (r.json.error || r.json.message) : "فشل التحقق.", "bad");
      return;
    }
    const t = extractToken(r.json);
    if(t) localStorage.setItem(TOKEN_KEY, t);

    // بعد التحقق: نفحص هل عنده تفعيل ولا يروح للكود
    await boot();
  });

  $("btnResendOtp").addEventListener("click", async () => {
    const email = $("otpEmail").value.trim();
    if(!email) return;
    setMsg($("otpMsg"), "جاري إعادة الإرسال…", "");
    const r = await api("/api2/resend-otp", { method:"POST", body:{ email }, auth:false });
    if(!r.ok){
      setMsg($("otpMsg"), "تعذر إعادة الإرسال.", "bad");
      return;
    }
    setMsg($("otpMsg"), "تم إرسال رمز جديد ✅", "ok");
  });

  $("btnActivate").addEventListener("click", async () => {
    const code = $("actCode").value.trim();
    if(!code){
      setMsg($("codeMsg"), "اكتب كود التفعيل.", "bad");
      return;
    }
    setMsg($("codeMsg"), "جاري التفعيل…", "");
    const r = await api("/api2/activate", { method:"POST", body:{ code, game: GAME_KEY }, auth:true });
    if(!r.ok){
      setMsg($("codeMsg"), (r.json && (r.json.error || r.json.message)) ? (r.json.error || r.json.message) : "فشل التفعيل.", "bad");
      return;
    }
    setMsg($("codeMsg"), "تم التفعيل ✅ سيتم نقلك للعبة…", "ok");
    await sleep(600);
    location.replace(GAME_URL);
  });

  $("btnLogout").addEventListener("click", () => {
    localStorage.removeItem(TOKEN_KEY);
    location.replace("/activate?reset=1");
  });

  // ==== START ====
  boot();

})();
</script>
</body>
</html>

<!-- activate.html – إصدار 2 (Google Redirect + Auto Route to Code/Game) -->
