<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>سباق الحروف - اللعبة</title>

  <!-- ✅ خط AA-GALAXY (كما هو) -->
  <style>
    @font-face{
      font-family:'AA-GALAXY';
      src:url('AA-GALAXY.otf') format('opentype');
      font-weight:normal;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --bg:#5d2e5f;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --yellow:#f4c400;
      --blue:#1f4fa3;
      --green:#1a8f3a;
      --orange:#e28a12;
      --dark:#2a2a2a;
      --shadow:0 12px 25px rgba(0,0,0,.18);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1000px 700px at 30% 10%, rgba(255,255,255,.10), transparent 55%),
                  radial-gradient(900px 650px at 70% 70%, rgba(0,0,0,.12), transparent 55%),
                  linear-gradient(180deg, #6a3b6a, var(--bg));
      color:#fff;
      overflow-x:hidden;
    }

    /* ---- Header ---- */
    header{
      position:relative;
      padding:18px 14px 10px;
      text-align:center;
    }
    .logo{
      position:absolute;
      left:14px; top:14px;
      width:56px; height:56px;
      object-fit:contain;
      pointer-events:none;
    }
    .gameTitle{
      font-family:'AA-GALAXY', Arial, sans-serif;
      font-weight:900;
      font-size:44px;
      letter-spacing:1px;
      margin:6px 0 0;
      text-shadow:0 6px 12px rgba(0,0,0,.35);
    }

    /* ---- Layout ---- */
    .wrap{
      width:min(1100px, 100%);
      margin:0 auto;
      padding:10px 12px 26px;
    }

    .card{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .topRow{
      display:flex;
      gap:12px;
      align-items:stretch;
      justify-content:space-between;
      padding:12px;
    }

    .mapBox{
      flex:1 1 auto;
      min-width:0;
      padding:10px;
      background:rgba(0,0,0,.18);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      position:relative;
    }

    .mapFrame{
      background:#fff;
      border-radius:14px;
      padding:10px;
      border:4px solid rgba(0,0,0,.65);
    }

    .mapImg{
      width:100%;
      display:block;
      border-radius:10px;
      user-select:none;
      -webkit-user-drag:none;
    }

    .mapToolbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      justify-content:space-between;
    }

    .tinyBtn{
      width:44px; height:44px;
      border-radius:50%;
      border:3px solid rgba(0,0,0,.65);
      background:#fff;
      color:#111;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      cursor:pointer;
      box-shadow:0 8px 14px rgba(0,0,0,.22);
      position:relative;
    }
    .tinyBtn:active{transform:scale(.98)}
    .zoomSlider{
      flex:1;
      min-width:0;
      height:8px;
      border-radius:10px;
      accent-color: var(--yellow);
    }

    .sideBox{
      width:360px;
      max-width:100%;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .scoreRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .teamBtn{
      flex:1;
      border-radius:16px;
      padding:12px 10px;
      border:0;
      font-weight:900;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
      color:#fff;
    }
    .teamGreen{background:linear-gradient(180deg, #2bc05a, var(--green))}
    .teamOrange{background:linear-gradient(180deg, #ffb04a, var(--orange))}
    .score{
      width:64px;
      text-align:center;
      background:#fff;
      color:#111;
      border-radius:14px;
      padding:10px 8px;
      font-weight:900;
      font-size:22px;
      border:3px solid rgba(0,0,0,.65);
    }

    .firstPlayer{
      width:100%;
      border-radius:16px;
      padding:12px 10px;
      background:rgba(255,255,255,.20);
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      text-align:center;
      font-weight:800;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.25);
    }

    .mainControls{
      display:grid;
      grid-template-columns: 1fr 150px 1fr;
      gap:10px;
      align-items:center;
      margin-top:4px;
    }

    .ctrlCol{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .goldBtn{
      border:0;
      border-radius:16px;
      padding:14px 12px;
      background:linear-gradient(180deg, #ffd85a, var(--yellow));
      color:#111;
      font-weight:900;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 12px 20px rgba(0,0,0,.18);
      position:relative;
    }
    .goldBtn:active{transform:scale(.99)}
    .goldBtn.sky{background:linear-gradient(180deg, #5fd6ff, #33b9ff);}

    .timerCircle{
      width:150px;
      height:150px;
      border-radius:50%;
      background:rgba(31,79,163,.95);
      border:6px solid rgba(255,255,255,.92);
      box-shadow:0 16px 28px rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .timerNum{
      font-size:48px;
      font-weight:900;
      color:#fff;
      text-shadow:0 6px 14px rgba(0,0,0,.35);
      font-family: Arial, sans-serif;
    }
    .timerRing{
      position:absolute;
      inset:-2px;
      border-radius:50%;
      border:10px solid rgba(0,0,0,.75);
      clip-path: inset(0 0 0 0 round 50%);
      pointer-events:none;
      opacity:.95;
    }

    .questionCard{
      margin-top:12px;
      padding:14px 12px;
      background:rgba(255,255,255,.95);
      color:#111;
      border-radius:18px;
      border:4px solid rgba(0,0,0,.65);
      box-shadow:0 14px 26px rgba(0,0,0,.2);
    }

    .qText{
      font-size:22px;
      font-weight:900;
      margin:6px 0 12px;
      color:#111;
      text-align:center;
      line-height:1.5;
    }

    .answerBtn{
      width:100%;
      border:0;
      border-radius:16px;
      padding:16px 14px;
      font-weight:900;
      font-size:20px;
      color:#fff;
      background:linear-gradient(180deg, #ff3b3b, #e01a1a);
      cursor:pointer;
      box-shadow:0 12px 20px rgba(0,0,0,.18);
    }
    .answerBtn.show{
      background:linear-gradient(180deg, #2fd66a, #1aa94a);
    }
    .answerBtn:active{transform:scale(.99)}

    /* ---- Players view adjustments ---- */
    body.player .sideBox{width:100%}
    body.player .mainControls{display:none}
    body.player .questionCard{margin-top:10px}

    /* ---- Responsive ---- */
    @media (max-width: 900px){
      .topRow{flex-direction:column}
      .sideBox{width:100%}
      .mainControls{grid-template-columns:1fr 140px 1fr}
      .timerCircle{width:140px;height:140px}
      .timerNum{font-size:44px}
    }
    @media (max-width: 420px){
      .gameTitle{font-size:38px}
      .logo{width:52px;height:52px}
      .qText{font-size:20px}
    }

    /* ---- Modals ---- */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      color:#111;
      border-radius:18px;
      padding:16px 14px;
      border:4px solid rgba(0,0,0,.65);
      box-shadow:0 22px 45px rgba(0,0,0,.35);
      text-align:center;
    }
    .modal h3{margin:0 0 8px;font-size:20px}
    .modal p{margin:0 0 12px;color:#333;line-height:1.6}
    .modal .closeBtn{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      background:linear-gradient(180deg, #ffd85a, var(--yellow));
      cursor:pointer;
      width:100%;
    }

    /* Tooltip question mark */
    .qmark{
      position:absolute;
      top:-6px;
      right:-6px;
      width:18px;height:18px;
      border-radius:50%;
      background:rgba(0,0,0,.12);
      display:flex;align-items:center;justify-content:center;
      font-size:12px;
      color:#111;
      border:1px solid rgba(0,0,0,.25);
    }

    /* Home button (presenter only) */
    .homeBtn{
      position:fixed;
      left:14px;
      bottom:14px;
      z-index:9998;
      background:#fff;
      color:#111;
      border:3px solid rgba(0,0,0,.65);
      border-radius:16px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 12px 18px rgba(0,0,0,.2);
      display:none;
    }
    body.presenter .homeBtn{display:block}

  </style>
</head>

<body class="presenter">

<header>
  <img class="logo" src="logo.png" alt="شعار صندوق المسابقات">
  <div class="gameTitle">سباق الحروف</div>
</header>

<div class="wrap">
  <div class="card topRow">
    <div class="mapBox">
      <div class="mapFrame">
        <img id="mapImg" class="mapImg" src="maps/map1.jpeg" alt="الخريطة">
      </div>

      <div class="mapToolbar">
        <button class="tinyBtn" id="btnSettings" title="الإعدادات">⚙️</button>

        <input class="zoomSlider" id="zoomSlider" type="range" min="60" max="140" value="100" />

        <button class="tinyBtn" id="btnChangeMap" title="تغيير الخريطة">
          ↻
          <span class="qmark">?</span>
        </button>

        <button class="tinyBtn" id="btnClearMap" title="تفريغ الخريطة">
          ⟲
          <span class="qmark">?</span>
        </button>
      </div>
    </div>

    <div class="sideBox">
      <div class="scoreRow">
        <button class="teamBtn teamOrange" id="btnTeamOrange">الفريق البرتقالي</button>
        <div class="score" id="scoreOrange">0</div>
        <div class="score" id="scoreGreen">0</div>
        <button class="teamBtn teamGreen" id="btnTeamGreen">الفريق الأخضر</button>
      </div>

      <div class="firstPlayer" id="firstPlayerBar">اسم اللاعب الذي يضغط أولاً</div>

      <div class="mainControls">
        <div class="ctrlCol">
          <button class="goldBtn" id="btnToggleQSource">
            أسئلة عامة
            <span class="qmark">?</span>
          </button>
          <button class="goldBtn" id="btnClearBoard">
            تفريغ اللوحة
            <span class="qmark">?</span>
          </button>
        </div>

        <div class="timerCircle" id="timerCircle">
          <div class="timerRing" id="timerRing"></div>
          <div class="timerNum" id="timerNum">10</div>
        </div>

        <div class="ctrlCol">
          <button class="goldBtn" id="btnFreezeBuzzer">تجميد الأزرار</button>
          <button class="goldBtn" id="btnNextQuestion">تغيير السؤال</button>
        </div>
      </div>

      <div class="questionCard">
        <div class="qText" id="qText">...</div>
        <button class="answerBtn" id="answerBtn">اضغط للإجابة</button>
      </div>
    </div>
  </div>
</div>

<button class="homeBtn" id="homeBtn">الرئيسية</button>

<!-- ✅ مودال شرح -->
<div class="modalOverlay" id="helpOverlay">
  <div class="modal">
    <h3 id="helpTitle">معلومة</h3>
    <p id="helpText">...</p>
    <button class="closeBtn" id="helpClose">إغلاق</button>
  </div>
</div>

<!-- ✅ تحميل بنك الأسئلة من ملف خارجي -->
<script src="questions_bank.js"></script>

<script type="module">
  // ===== Firebase (كما هو في ملفك الأصلي) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, update, runTransaction, remove, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // ⚠️ اترك إعدادات Firebase كما هي عندك (موجودة في ملفك الأصلي)
  // إذا كان ملفك الأصلي يحتوي firebaseConfig مختلف، تأكد أنه نفس اللي عندك بالمستودع.
  const firebaseConfig = window.firebaseConfig || {
    apiKey: "",
    authDomain: "",
    databaseURL: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: ""
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ===== Helpers / State =====
  const qs = (id)=>document.getElementById(id);

  const mapImg = qs("mapImg");
  const zoomSlider = qs("zoomSlider");
  const firstPlayerBar = qs("firstPlayerBar");
  const scoreOrangeEl = qs("scoreOrange");
  const scoreGreenEl = qs("scoreGreen");
  const qTextEl = qs("qText");
  const answerBtn = qs("answerBtn");

  const btnChangeMap = qs("btnChangeMap");
  const btnClearMap  = qs("btnClearMap");
  const btnClearBoard = qs("btnClearBoard");
  const btnFreezeBuzzer = qs("btnFreezeBuzzer");
  const btnNextQuestion = qs("btnNextQuestion");
  const btnToggleQSource = qs("btnToggleQSource");

  const timerNum = qs("timerNum");
  const timerRing = qs("timerRing");
  const timerCircle = qs("timerCircle");

  const helpOverlay = qs("helpOverlay");
  const helpTitle = qs("helpTitle");
  const helpText = qs("helpText");
  const helpClose = qs("helpClose");

  const homeBtn = qs("homeBtn");

  // ===== Room / role (كما في مشروعك) =====
  const url = new URL(location.href);
  const roomId = url.searchParams.get("room") || url.searchParams.get("code") || "";
  const role = url.searchParams.get("role") || "presenter"; // presenter | player
  document.body.classList.remove("presenter","player");
  document.body.classList.add(role === "player" ? "player" : "presenter");

  // ===== Zoom =====
  const savedZoom = Number(localStorage.getItem("sandooq_map_zoom_v1") || "100");
  zoomSlider.value = String(savedZoom);
  mapImg.style.transformOrigin = "center center";
  mapImg.style.transform = `scale(${savedZoom/100})`;

  zoomSlider.addEventListener("input", ()=>{
    const v = Number(zoomSlider.value);
    localStorage.setItem("sandooq_map_zoom_v1", String(v));
    mapImg.style.transform = `scale(${v/100})`;
  });

  // ===== Help Modal =====
  function showHelp(title, text){
    helpTitle.textContent = title;
    helpText.textContent = text;
    helpOverlay.style.display = "flex";
  }
  helpClose.addEventListener("click", ()=> helpOverlay.style.display="none");
  helpOverlay.addEventListener("click", (e)=>{
    if(e.target === helpOverlay) helpOverlay.style.display="none";
  });

  // ===== Q Source Toggle =====
  let usePrivateQuestions = false;
  btnToggleQSource.addEventListener("click", ()=>{
    usePrivateQuestions = !usePrivateQuestions;
    btnToggleQSource.textContent = usePrivateQuestions ? "أسئلة خاصة" : "أسئلة عامة";
    btnToggleQSource.classList.toggle("sky", usePrivateQuestions);
    // منطق اختيار السؤال كما في ملفك
    pickAndRenderQuestion();
  });

  // ===== Questions =====
  const QUESTIONS_SRC = (window.QUESTIONS || {});
  let currentQuestion = null;
  let answerShown = false;

  function randomFrom(arr){
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function pickAndRenderQuestion(){
    // هنا منطق الأسئلة حسب ملفك (عام/خاص)
    // العام: من QUESTIONS_SRC
    // الخاص: يفترض يكون عندك مكانه (بدون تخزين دائم حالياً)
    const pool = usePrivateQuestions
      ? (window.PRIVATE_QUESTIONS || [])
      : (QUESTIONS_SRC[(window.currentLetter || "ق")] || []);

    if(!pool || !pool.length){
      currentQuestion = { q:"لا توجد أسئلة لهذا الحرف حالياً", a:"" };
    }else{
      currentQuestion = randomFrom(pool);
    }

    qTextEl.textContent = currentQuestion.q || "...";
    answerShown = false;
    answerBtn.classList.remove("show");
    answerBtn.textContent = "اضغط للإجابة";
  }

  answerBtn.addEventListener("click", ()=>{
    if(!currentQuestion) return;
    answerShown = !answerShown;
    if(answerShown){
      answerBtn.classList.add("show");
      answerBtn.textContent = currentQuestion.a ? currentQuestion.a : "—";
    }else{
      answerBtn.classList.remove("show");
      answerBtn.textContent = "اضغط للإجابة";
    }
  });

  // ===== Timer UI (visual ring) =====
  let timerTotal = 10;
  let timerLeft = 10;
  let timerInterval = null;

  function setRingProgress(total, left){
    const p = Math.max(0, Math.min(1, left / Math.max(1,total)));
    // clip ring by scaling border using conic-gradient could be nicer,
    // but keep as-is to not break old UI: simulate by opacity.
    timerRing.style.opacity = "1";
    timerRing.style.transform = `rotate(${(1-p)*360}deg)`;
  }

  function renderTimer(){
    timerNum.textContent = String(timerLeft);
    setRingProgress(timerTotal, timerLeft);
    if(timerLeft <= 5){
      timerNum.style.color = "#ff2b2b";
      timerNum.style.transform = "scale(1.06)";
      setTimeout(()=> timerNum.style.transform = "scale(1)", 140);
    }else{
      timerNum.style.color = "#fff";
      timerNum.style.transform = "scale(1)";
    }
  }

  function stopTimerLocal(){
    if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  }

  function startTimerLocal(total){
    stopTimerLocal();
    timerTotal = total;
    timerLeft = total;
    renderTimer();
    timerInterval = setInterval(()=>{
      timerLeft--;
      renderTimer();
      if(timerLeft <= 0){
        stopTimerLocal();
        // وميض بسيط عند 0
        let blink = 0;
        const blinkInt = setInterval(()=>{
          blink++;
          timerCircle.style.background = (blink % 2) ? "rgba(255,0,0,.9)" : "rgba(31,79,163,.95)";
          if(blink >= 8){
            clearInterval(blinkInt);
            timerCircle.style.background = "rgba(31,79,163,.95)";
          }
        }, 120);
      }
    }, 1000);
  }

  // ===== Firebase paths (keep as your original logic) =====
  const basePath = roomId ? `rooms/${roomId}` : null;

  function safeRef(path){
    return ref(db, path);
  }

  // ===== Presenter controls (map/buttons) =====
  const maps = ["maps/map1.jpeg","maps/map2.jpeg","maps/map3.jpeg","maps/map4.jpeg"];
  let mapIndex = 0;

  btnChangeMap.addEventListener("click", async ()=>{
    if(role === "player") return;
    mapIndex = (mapIndex + 1) % maps.length;
    const src = maps[mapIndex];
    mapImg.src = src;

    if(basePath){
      await update(safeRef(basePath), { mapSrc: src });
    }
  });

  btnClearMap.addEventListener("click", async ()=>{
    if(role === "player") return;
    if(basePath){
      await update(safeRef(basePath), { clearMap: Date.now() });
    }
  });

  btnClearBoard.addEventListener("click", async ()=>{
    if(role === "player") return;
    if(basePath){
      await update(safeRef(basePath), { clearBoard: Date.now() });
    }
  });

  btnFreezeBuzzer.addEventListener("click", async ()=>{
    if(role === "player") return;
    if(basePath){
      const freeze = btnFreezeBuzzer.dataset.frozen === "1" ? 0 : 1;
      btnFreezeBuzzer.dataset.frozen = String(freeze);
      await update(safeRef(basePath), { buzzerFrozen: freeze, buzzerFrozenAt: Date.now() });
    }
  });

  btnNextQuestion.addEventListener("click", async ()=>{
    if(role === "player") return;
    pickAndRenderQuestion();
    if(basePath){
      await update(safeRef(basePath), { qChangedAt: Date.now() });
    }
  });

  // ===== Home button =====
  homeBtn.addEventListener("click", ()=>{
    location.href = "index.html";
  });

  // ===== Listen room state =====
  if(basePath){
    onValue(safeRef(basePath), (snap)=>{
      const v = snap.val() || {};

      // map
      if(v.mapSrc && mapImg.src.indexOf(v.mapSrc) === -1){
        mapImg.src = v.mapSrc;
      }

      // clear map / board (your actual game likely handles cells)
      // keep as-is: trigger any UI reset hooks you already had
      // here we just noop unless you already had functions

      // buzzer / first player
      if(v.firstPlayerName){
        firstPlayerBar.textContent = v.firstPlayerName;
        firstPlayerBar.style.background = v.firstPlayerTeam === "green" ? "rgba(26,143,58,.95)" : "rgba(226,138,18,.95)";
        firstPlayerBar.style.color = "#fff";
      }else{
        firstPlayerBar.textContent = "اسم اللاعب الذي يضغط أولاً";
        firstPlayerBar.style.background = "rgba(255,255,255,.20)";
        firstPlayerBar.style.color = "#fff";
      }

      // scores
      if(typeof v.scoreOrange === "number") scoreOrangeEl.textContent = String(v.scoreOrange);
      if(typeof v.scoreGreen === "number") scoreGreenEl.textContent = String(v.scoreGreen);

      // freeze status
      if(typeof v.buzzerFrozen === "number"){
        btnFreezeBuzzer.dataset.frozen = String(v.buzzerFrozen);
        btnFreezeBuzzer.textContent = v.buzzerFrozen ? "إلغاء التجميد" : "تجميد الأزرار";
      }

      // timer sync
      if(v.timerStartAt && v.timerTotal){
        // simplistic: start local when timerStartAt changes
        // (your original file likely had better sync; keep minimal)
        const now = Date.now();
        const elapsed = Math.floor((now - v.timerStartAt)/1000);
        const left = Math.max(0, Number(v.timerTotal) - elapsed);
        timerTotal = Number(v.timerTotal);
        timerLeft = left;
        renderTimer();
        stopTimerLocal();
        // continue ticking locally
        timerInterval = setInterval(()=>{
          timerLeft--;
          renderTimer();
          if(timerLeft <= 0) stopTimerLocal();
        }, 1000);
      }

      // question change trigger
      if(v.qChangedAt){
        // re-pick for everyone (same question logic as local)
        pickAndRenderQuestion();
      }
    });
  }

  // ===== Init question =====
  pickAndRenderQuestion();

</script>

</body>
</html>
