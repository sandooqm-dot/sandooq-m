function afterRender(room){
  // تحديثات بعد ما الواجهة تكون موجودة
  try{
    TIMER_UI.latestTimer = room.timer || {};
    requestAnimationFrame(()=>{ try{ applyTimerDom(); }catch(e){} });
  }catch(e){}

  try{
    const we = room.winEvent;
    if(we && we.ts && Number(we.ts) !== LAST_WIN_TS){
      LAST_WIN_TS = Number(we.ts);
      showWin(String(we.team || ""));
    }
  }catch(e){}
}

onValue(roomRef, (snap) => {
  if(!snap.exists()){
    main.textContent = "اللعبة غير موجودة (رمز غير صحيح).";
    setGameName("");
    return;
  }

  const room = snap.val();
  setGameName(room?.name);

  // ✅ تحقق صلاحية المقدم
  if(role === "host"){
    if(!hostKey || hostKey !== room.presenterKey){
      main.textContent = "صلاحية المقدم غير صحيحة.";
      return;
    }

    // لوبي/لعبة
    if(room.status === "lobby"){
      renderHostLobby(room);
      // (اختياري) لا يحتاج afterRender هنا
      return;
    }else{
      renderGame(room, null);
      afterRender(room);
      return;
    }
  }

  // ✅ تحقق اللاعب
  const players = room.players || {};
  const me = pid ? players[pid] : null;
  if(!pid || !me){
    main.textContent = "بيانات اللاعب غير صحيحة.";
    return;
  }

  // انتظار/لعبة
  if(room.status === "lobby"){
    renderWaiting("بانتظار بدء اللعبة من المقدم...");
    return;
  }else{
    renderGame(room, me);
    afterRender(room);
    return;
  }
});
