<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>سباق الحروف</title>

  <!-- خط العنوان -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan&display=swap" rel="stylesheet">

  <style>
    /* (نفس ستايلك الأصلي بدون أي تغيير) */
    :root{
      --bg:#1f4fa3;
      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
      --navy:#0b2f74;
      --gold:#f4c400;
      --shadow:0 10px 20px rgba(0,0,0,.18);
      --radius:18px;
      --radius2:16px;
      --pad:14px;
      --gap:10px;
    }

    body{
      margin:0;
      background:var(--bg);
      font-family:Arial, sans-serif;
      color:#fff;
      text-align:center;
    }

    header{
      position:relative;
      padding:30px 16px 0;
    }

    .logo{
      position:absolute;
      left:14px;
      top:14px;
      width:86px;
      height:86px;
      object-fit:contain;
      pointer-events:none;
    }

    h1{
      margin:0;
      font-family:"Baloo Bhaijaan", system-ui, sans-serif;
      font-size:46px;
      font-weight:400;
      color:var(--yellow);
      text-shadow:0 3px 0 rgba(0,0,0,.18);
      letter-spacing:.2px;
    }

    #gameName{
      margin-top:10px;
      font-size:16px;
      opacity:.95;
      min-height:18px;
    }

    /* باقي الستايل كما هو في ملفك */
    /* ... */

  </style>
</head>

<body>
  <header>
    <img src="logo.png" class="logo" alt="logo" />
    <h1>سباق الحروف</h1>
    <div id="gameName"></div>
  </header>

  <main id="main" style="padding:16px"></main>

  <!-- Popups / Modals (كما هي) -->
  <div id="tipPopup" style="display:none"></div>
  <div id="scorePickerBackdrop" style="display:none"></div>
  <div id="winBackdrop" style="display:none"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.appspot.com",
      messagingSenderId: "689464698673",
      appId: "1:689464698673:web:dfc3f1c1e3536b5f0d5f5b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --------- (باقي كودك الأصلي كما هو) ---------
    // ملاحظة: لم أغيّر أي ستايل أو أماكن عناصر. التعديل الوحيد في الأسفل عند الاستماع للغرفة للاعبين.

    const params = new URLSearchParams(location.search);
    const role = params.get("role");
    const code = params.get("code");
    const hostKey = params.get("key");
    const pid = params.get("pid");

    const main = document.getElementById("main");
    const gameNameEl = document.getElementById("gameName");
    const tipPopup = document.getElementById("tipPopup");
    const scorePickerBackdrop = document.getElementById("scorePickerBackdrop");
    const winBackdrop = document.getElementById("winBackdrop");

    function setGameName(s){
      if(!gameNameEl) return;
      gameNameEl.textContent = s ? String(s) : "";
    }

    if(!role || !code){
      main.textContent = "بيانات الدخول غير مكتملة.";
      throw new Error("Missing params");
    }

    const roomRef = ref(db, `rooms/${code}`);

    // --------- (دوالك الأصلية: renderHostLobby, renderWaiting, renderGame, ... إلخ) ---------
    // (موجودة عندك في الملف الأصلي — ما تم تغييرها)

    // ====== (هنا بقية كودك الأصلي... كما هو) ======
    // ...
    // (إلى أن نصل لمكان onValue(roomRef, ...) في آخر الملف)

    // ----- متغيرات الفوز/المؤقت كما هي -----
    let LAST_WIN_TS = 0;

    function showWin(team){
      if(!team) return;
      winBackdrop.style.display = "flex";
      // ... (كما هو في ملفك)
    }

    const TIMER_UI = {
      latestTimer: {},
      // ... (كما هو)
    };

    function applyTimerDom(){
      const clock = document.getElementById("timerClock");
      const numEl = document.getElementById("timerNumber");
      if(!clock || !numEl) return;
      // ... (كما هو)
    }

    function renderWaiting(msg){
      main.textContent = msg || "";
    }

    // =========================================================
    // ✅ تقوية التحمل (بدون لمس الستايل/الألوان/أماكن الأزرار):
    // - المقدم: نفس الاستماع القديم (room كامل) لأن المقدم يحتاج كل بيانات الغرفة.
    // - اللاعب: استماع مُجزّأ لأهم الحقول فقط + رندر مُخفّف (throttle) لتقليل الضغط عند كثرة اللاعبين.
    // =========================================================
    if(role === "host"){
      onValue(roomRef, (snap) => {
            if(!snap.exists()){
              main.textContent = "اللعبة غير موجودة (رمز غير صحيح).";
              setGameName("");
              return;
            }
            const room = snap.val();
            setGameName(room?.name);

            TIMER_UI.latestTimer = room.timer || {};
            applyTimerDom();

            // ✅ (9) عرض الاحتفال للجميع عند تغير winEvent
            const we = room.winEvent;
            if(we && we.ts && Number(we.ts) !== LAST_WIN_TS){
              LAST_WIN_TS = Number(we.ts);
              showWin(String(we.team || ""));
            }

            if(role === "host"){
              if(!hostKey || hostKey !== room.presenterKey){
                main.textContent = "صلاحية المقدم غير صحيحة.";
                return;
              }
              if(room.status === "lobby"){
                // renderHostLobby(room);  // (كما هو عندك)
                return;
              }

              // renderGame(room, null);  // (كما هو عندك)
              return;
            }

            // مسار اللاعب داخل هذا callback غير مستخدم لأننا فصلناه تحت
            const players = room.players || {};
            const me = players?.[pid] || null;
            if(!pid || !me){
              main.textContent = "بيانات اللاعب غير صحيحة.";
              return;
            }

            if(room.status === "lobby"){
              renderWaiting("بانتظار بدء اللعبة من المقدم...");
              return;
            }

            // renderGame(room, me); // (كما هو عندك)
          });
    }else{
      const ROOM_LITE = {
        name: "",
        status: "lobby",
        activeMap: 0,
        mapStates: {},
        timer: {},
        freeze: false,
        buzzer: null,
        current: null,
        scores: null,
        questionMode: "default",
        customQuestionsUpdatedAt: 0,
        customQuestions: {},
        winEvent: null
      };

      let meLite = null;

      let _renderQueued = false;
      function scheduleRenderLite(){
        if(_renderQueued) return;
        _renderQueued = true;
        requestAnimationFrame(() => {
          _renderQueued = false;
          renderLite();
        });
      }

      function renderLite(){
        setGameName(ROOM_LITE.name);

        TIMER_UI.latestTimer = ROOM_LITE.timer || {};
        applyTimerDom();

        if(!pid || !meLite){
          main.textContent = "بيانات اللاعب غير صحيحة.";
          return;
        }

        if(ROOM_LITE.status === "lobby" || !ROOM_LITE.status){
          renderWaiting("بانتظار بدء اللعبة من المقدم...");
          return;
        }

        // renderGame(ROOM_LITE, meLite); // ✅ نفس رندرك الأصلي
      }

      // ✅ احتفال الفوز للجميع (بدون تحميل كامل الغرفة)
      onValue(ref(db, `rooms/${code}/winEvent`), (snap) => {
        const we = snap.val();
        ROOM_LITE.winEvent = we || null;
        if(we && we.ts && Number(we.ts) !== LAST_WIN_TS){
          LAST_WIN_TS = Number(we.ts);
          showWin(String(we.team || ""));
        }
      });

      // ✅ اسم الغرفة
      onValue(ref(db, `rooms/${code}/name`), (snap) => {
        if(snap.exists()){
          ROOM_LITE.name = String(snap.val() || "");
          scheduleRenderLite();
        }
      });

      // ✅ حالة الغرفة (وتحقق وجودها)
      onValue(ref(db, `rooms/${code}/status`), (snap) => {
        if(!snap.exists()){
          main.textContent = "اللعبة غير موجودة (رمز غير صحيح).";
          setGameName("");
          return;
        }
        ROOM_LITE.status = String(snap.val() || "lobby");
        scheduleRenderLite();
      });

      // ✅ بيانات اللاعب نفسه فقط (بدون تحميل قائمة اللاعبين كاملة)
      onValue(ref(db, `rooms/${code}/players/${pid}`), (snap) => {
        meLite = snap.val() || null;
        scheduleRenderLite();
      });

      // ✅ تجميد/زر أول لاعب/السؤال/السكور/المؤقت
      onValue(ref(db, `rooms/${code}/freeze`), (snap) => { ROOM_LITE.freeze = !!snap.val(); scheduleRenderLite(); });
      onValue(ref(db, `rooms/${code}/buzzer`), (snap) => { ROOM_LITE.buzzer = snap.val() || null; scheduleRenderLite(); });
      onValue(ref(db, `rooms/${code}/current`), (snap) => { ROOM_LITE.current = snap.val() || null; scheduleRenderLite(); });
      onValue(ref(db, `rooms/${code}/scores`), (snap) => { ROOM_LITE.scores = snap.val() || null; scheduleRenderLite(); });

      onValue(ref(db, `rooms/${code}/timer`), (snap) => {
        ROOM_LITE.timer = snap.val() || {};
        TIMER_UI.latestTimer = ROOM_LITE.timer || {};
        applyTimerDom();
        scheduleRenderLite();
      });

      // ✅ نوع الأسئلة + تحميل أسئلة المقدم فقط عند الحاجة
      let _unsubCustom = null;

      onValue(ref(db, `rooms/${code}/questionMode`), (snap) => {
        ROOM_LITE.questionMode = String(snap.val() || "default");

        if(ROOM_LITE.questionMode === "custom"){
          if(!_unsubCustom){
            _unsubCustom = onValue(ref(db, `rooms/${code}/customQuestions`), (s2) => {
              ROOM_LITE.customQuestions = s2.val() || {};
              scheduleRenderLite();
            });
          }
        }else{
          ROOM_LITE.customQuestions = {};
          if(_unsubCustom){ _unsubCustom(); _unsubCustom = null; }
        }

        scheduleRenderLite();
      });

      onValue(ref(db, `rooms/${code}/customQuestionsUpdatedAt`), (snap) => {
        ROOM_LITE.customQuestionsUpdatedAt = Number(snap.val() || 0);
        scheduleRenderLite();
      });

      // ✅ الخريطة النشطة فقط + حالاتها (بدون تحميل كل الخرائط)
      let _unsubMap = null;

      function watchMap(mapId){
        const mid = String(mapId ?? 0);
        ROOM_LITE.activeMap = Number(mid);

        if(!ROOM_LITE.mapStates) ROOM_LITE.mapStates = {};

        if(_unsubMap){ _unsubMap(); _unsubMap = null; }

        _unsubMap = onValue(ref(db, `rooms/${code}/mapStates/${mid}`), (snap) => {
          ROOM_LITE.mapStates[mid] = snap.val() || {};
          scheduleRenderLite();
        });
      }

      onValue(ref(db, `rooms/${code}/activeMap`), (snap) => {
        watchMap(snap.val());
        scheduleRenderLite();
      });

      // أول عرض
      renderWaiting("جاري التحميل...");
    }

    // ====== نهاية الملف ======
  </script>
</body>
</html>
