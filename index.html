<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„Ø¹Ø¨Ø© Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø­Ø±ÙˆÙ</title>
  <style>
    /* âœ… Ù†ÙØ³ Ø®Ø· Ø§Ù„Ù„Ø¹Ø¨Ø© */
    @font-face{
      font-family:"AA-GALAXY";
      src:url("AA-GALAXY.otf") format("opentype");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }

    :root{
      /* âœ… Ù†ÙØ³ Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© */
      --bg1:#7b1f63;
      --bg2:#5f214f;
      --bg3:#3a1234;

      --yellow:#f4c400;
      --card:#ffffff;
      --text:#111;
    }

    body{
      margin:0;
      color:#fff;
      text-align:center;
      font-family:"AA-GALAXY", Arial, sans-serif;
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(900px 650px at 80% 25%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 48%, var(--bg3) 100%);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    button, input{
      font-family:"AA-GALAXY", Arial, sans-serif;
    }

    header{position:relative;padding:30px 16px 0}
    .logo{
      position:absolute;left:14px;top:14px;
      width:86px;height:86px;object-fit:contain;
      pointer-events:none;
    }
    h1{margin:18px 0 14px;color:var(--yellow);font-size:28px}
    .wrap{width:92%;max-width:520px;margin:0 auto}
    .card{background:var(--card);color:var(--text);border-radius:12px;padding:14px}
    input{
      width:100%;box-sizing:border-box;
      padding:14px;margin:10px 0;
      font-size:16px;border-radius:10px;border:0;
    }
    button{
      width:100%;padding:16px;margin-top:10px;
      font-size:18px;border:none;border-radius:12px;cursor:pointer;
      background:var(--yellow);color:#000
    }
    .hint{font-size:13px;opacity:.9;margin-top:8px}
  </style>
</head>
<body>

  <!-- ====== ğŸ”’ Ø¨ÙˆØ§Ø¨Ø© ØªÙØ¹ÙŠÙ„ Ù„Ù„Ù…Ù‚Ø¯Ù‘Ù… ÙÙ‚Ø· ====== -->
  <div id="licenseGate" style="position:fixed;inset:0;z-index:999999;display:flex;align-items:center;justify-content:center;color:#fff;font-family:'AA-GALAXY', Arial, sans-serif;
    background:
      radial-gradient(1100px 700px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
      radial-gradient(900px 650px at 80% 25%, rgba(255,255,255,.08), transparent 55%),
      linear-gradient(135deg, #7b1f63 0%, #5f214f 48%, #3a1234 100%);">
    <div style="width:min(520px,92%);background:rgba(255,255,255,.10);padding:18px;border-radius:12px;text-align:center">
      <h2 style="margin:0 0 10px">ØªÙØ¹ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø¯Ù…</h2>
      <p style="margin:0 0 12px;opacity:.9">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„ÙŠ ÙˆØµÙ„Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡. Ø³ÙŠØªÙ… Ø±Ø¨Ø·Ù‡ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².</p>

      <input id="licenseCode" placeholder="SNDQ-XXXX-XXXX-XXXX"
        style="width:100%;padding:12px;border-radius:10px;border:0;font-size:16px;box-sizing:border-box;margin:8px 0;font-family:'AA-GALAXY', Arial, sans-serif;" />

      <button id="licenseBtn"
        style="width:100%;padding:12px;border-radius:10px;border:0;font-size:16px;cursor:pointer;background:#f4c400;color:#000;font-family:'AA-GALAXY', Arial, sans-serif;">
        ØªÙØ¹ÙŠÙ„ ÙˆØ¯Ø®ÙˆÙ„
      </button>

      <div id="licenseMsg" style="margin-top:10px;opacity:.95"></div>
    </div>
  </div>

  <script>
  (function(){
    // âœ… Cloudflare Pages Functions endpoint (Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†)
    const VERIFY_URL = "/functions/api/verify";

    const gate = document.getElementById('licenseGate');
    const msgEl = document.getElementById('licenseMsg');
    const input = document.getElementById('licenseCode');
    const btn = document.getElementById('licenseBtn');

    function setMsg(t){ msgEl.textContent = t || ""; }

    function getDeviceId(){
      let id = localStorage.getItem("deviceId");
      if(!id){
        id = "dev_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
        localStorage.setItem("deviceId", id);
      }
      return id;
    }

    async function verifyFetch(code){
      const res = await fetch(VERIFY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code, deviceId: getDeviceId() })
      });

      // Ù„Ùˆ Ø±Ø¬Ø¹ JSON
      const ct = res.headers.get("content-type") || "";
      if(ct.includes("application/json")) return await res.json();

      // fallback
      const txt = await res.text();
      try { return JSON.parse(txt); } catch(e){ return { ok:false, msg: txt || "Bad response" }; }
    }

    // Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ ØªÙØ¹ÙŠÙ„ (Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²)
    async function autoCheck(){
      const saved = localStorage.getItem("activatedCode");
      if(!saved) return;
      try{
        const data = await verifyFetch(saved);
        if(data && data.ok && (data.valid === true || data.ok === true)){
          gate.style.display = "none";
        }
      }catch(e){}
    }
    autoCheck();

    btn.addEventListener("click", async () => {
      const code = (input.value || "").trim();
      if(!code) return setMsg("Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");

      setMsg("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...");
      btn.disabled = true;

      try{
        const data = await verifyFetch(code);

        // Ù†ØªÙˆÙ‚Ø¹ Ù…Ù† verify.js: ok + valid
        if(data && data.ok && data.valid === true){
          localStorage.setItem("activatedCode", code);
          setMsg("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„");
          gate.style.display = "none";
        }else{
          setMsg((data && (data.msg || data.reason)) ? (data.msg || data.reason) : "Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
        }
      }catch(e){
        setMsg("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†");
      }finally{
        btn.disabled = false;
      }
    });
  })();
  </script>
  <!-- ====== Ù†Ù‡Ø§ÙŠØ© Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ ====== -->

  <header>
    <img class="logo" src="logo.png" alt="Ø´Ø¹Ø§Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª">
    <h1>Ù„Ø¹Ø¨Ø© Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø­Ø±ÙˆÙ</h1>
  </header>

  <div class="wrap">
    <div class="card">
      <input id="name" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©">
      <input id="players" inputmode="numeric" placeholder="Ø§Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (1 Ø£Ùˆ Ø£ÙƒØ«Ø±)">
      <button id="btn">Ø§Ù†Ø´Ø¦ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      <div class="hint">ØªÙ‚Ø¯Ø± ØªÙƒØªØ¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy2FEg8Xj0pA05syDawTh37rI1NEbQTjQ",
      authDomain: "sabaq-alhorof.firebaseapp.com",
      databaseURL: "https://sabaq-alhorof-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sabaq-alhorof",
      storageBucket: "sabaq-alhorof.firebasestorage.app",
      messagingSenderId: "1053646928152",
      appId: "1:1053646928152:web:032d50148c3a4f1148066d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function normalizeDigits(str){
      const map = {"Ù ":"0","Ù¡":"1","Ù¢":"2","Ù£":"3","Ù¤":"4","Ù¥":"5","Ù¦":"6","Ù§":"7","Ù¨":"8","Ù©":"9"};
      return String(str ?? "").trim().replace(/[Ù -Ù©]/g, d => map[d]);
    }

    function random6(){
      return String(Math.floor(100000 + Math.random()*900000));
    }

    function randomKey(){
      return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
    }

    async function createRoom(){
      const name = document.getElementById("name").value.trim();
      const pRaw = document.getElementById("players").value;
      const players = Number(normalizeDigits(pRaw));

      if(!name){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©"); return; }

      // âœ… Ø¨Ø¯ÙˆÙ† Ø­Ø¯ Ø£Ø¹Ù„Ù‰ (1 Ø£Ùˆ Ø£ÙƒØ«Ø±)
      if(!Number.isFinite(players) || players < 1){
        alert("Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† 1 Ø£Ùˆ Ø£ÙƒØ«Ø±");
        return;
      }

      const btn = document.getElementById("btn");
      btn.disabled = true;

      let code = "";
      for(let i=0;i<10;i++){
        const c = random6();
        const exists = (await get(ref(db, `rooms/${c}`))).exists();
        if(!exists){ code = c; break; }
      }

      if(!code){
        btn.disabled = false;
        alert("Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©");
        return;
      }

      const presenterKey = randomKey();

      const room = {
        code,
        name,
        maxPlayers: players,
        presenterKey,
        status: "lobby",
        createdAt: Date.now(),
        activeMap: 0,
        freeze: false,
        buzzer: null,
        current: { letter: null, qIndex: 0, row: null, col: null, map: 0 },
        players: {},
        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù…Ø§ ÙŠØ¶Ø± Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
        scores: { orange: 0, green: 0 }
      };

      await set(ref(db, `rooms/${code}`), room);

      // ÙŠÙˆØ¯Ù‘ÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØµÙØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† (Ø¯Ø§Ø®Ù„ game.html)
      location.href = `game.html?role=host&code=${encodeURIComponent(code)}&key=${encodeURIComponent(presenterKey)}`;
    }

    document.getElementById("btn").addEventListener("click", createRoom);
  </script>
</body>
</html>
