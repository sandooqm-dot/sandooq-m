<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>جاري فتح اللعبة</title>
  <style>
    :root{
      --bg1:#123c8a;
      --bg2:#1f4fa3;
      --card:#ffffff;
      --text:#111;
      --muted:#666;
      --yellow:#f4c400;

      /* (TV) */
      --hexBorder: rgba(0,0,0,.80);
      --hexPale: rgba(255, 231, 140, .65);
      --hexGreen: rgba(26,163,74,.88);
      --hexOrange: rgba(242,140,0,.88);
    }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 700px at 20% 25%, rgba(255,255,255,.14), transparent 60%),
                  radial-gradient(900px 600px at 70% 70%, rgba(255,255,255,.10), transparent 55%),
                  linear-gradient(160deg, var(--bg2), var(--bg1));
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      color:#fff;
      padding:24px 14px;
      box-sizing:border-box;
    }
    .wrap{ width:min(560px, 92vw); text-align:center; }
    .logo{
      width:64px; height:64px; object-fit:contain;
      margin:0 auto 14px;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.18));
      user-select:none;
      pointer-events:none;
    }
    .card{
      background: rgba(255,255,255,.95);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:22px 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.20);
      color:var(--text);
    }
    .title{
      font-weight:800;
      font-size:22px;
      margin:0 0 6px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
    }
    .row{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:16px;
      flex-wrap:wrap;
    }
    button{
      border:none;
      border-radius:12px;
      padding:12px 16px;
      font-weight:800;
      cursor:pointer;
      font-size:15px;
      min-width:170px;
    }
    .btn-primary{ background: var(--yellow); color:#1b1b1b; }
    .btn-secondary{ background: #e9eefc; color:#1f4fa3; }
    .small{
      margin-top:12px;
      color:#fff;
      opacity:.85;
      font-size:12px;
    }
    .spinner{
      display:inline-block;
      width:18px;height:18px;
      border:3px solid rgba(0,0,0,.18);
      border-top-color: rgba(0,0,0,.55);
      border-radius:50%;
      animation: spin 0.9s linear infinite;
      vertical-align:-4px;
      margin-left:6px;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    .hidden{ display:none !important; }
    .dbg{
      margin-top:10px;
      font-size:12px;
      color:#000;
      opacity:.55;
      direction:ltr;
      text-align:center;
      display:none;
    }

    /* =========================
       ✅ (TV) جهاز عرض الشاشة
       ========================= */
    body.displayMode{
      padding:0;
      align-items:stretch;
      justify-content:stretch;
    }
    body.displayMode .wrap{ display:none; }

    .tvRoot{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
    }

    .tvTop{
      position:sticky;
      top:0;
      z-index:50;
      padding: calc(10px + env(safe-area-inset-top)) 14px 10px;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.18);
    }

    .tvTopRow{
      display:flex;
      align-items:center;
      gap:12px;
    }

    /* يمين: اللوجو + السلايدر */
    .tvRight{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
      min-width: 280px;
      justify-content:flex-start;
    }
    .tvLogo{
      width:54px;
      height:54px;
      object-fit:contain;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.18));
      user-select:none;
      pointer-events:none;
    }

    .tvZoomWrap{
      flex:1 1 auto;
      min-width: 160px;
      max-width: 320px;
      display:flex;
      align-items:center;
    }

    /* سلايدر (نفس الإحساس) */
    input[type="range"]{
      width:100%;
      -webkit-appearance:none;
      appearance:none;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.80);
      border:3px solid rgba(0,0,0,.70);
      box-shadow:0 10px 18px rgba(0,0,0,.20);
      outline:none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:22px;
      height:22px;
      border-radius:50%;
      background: var(--yellow);
      border:3px solid rgba(0,0,0,.85);
      box-shadow:0 8px 14px rgba(0,0,0,.18);
      cursor:pointer;
    }
    input[type="range"]::-moz-range-thumb{
      width:22px;height:22px;border-radius:50%;
      background: var(--yellow);
      border:3px solid rgba(0,0,0,.85);
      box-shadow:0 8px 14px rgba(0,0,0,.18);
      cursor:pointer;
    }

    /* وسط: اسم اللعبة الذي كتبه المقدم */
    .tvCenter{
      flex:1 1 auto;
      text-align:center;
      font-weight:900;
      font-size:22px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:0 6px;
    }

    /* يسار: لوحة النتائج (غير قابلة للضغط) */
    .tvLeft{
      flex:0 0 auto;
      min-width: 300px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      pointer-events:none; /* ✅ لا يمكن التحكم فيها */
      user-select:none;
    }
    .tvTeamPill{
      height:44px;
      padding:0 14px;
      border-radius:999px;
      border:3px solid rgba(0,0,0,.85);
      color:#fff;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 18px rgba(0,0,0,.20);
      white-space:nowrap;
      font-size:16px;
    }
    .tvTeamPill.green{ background: rgba(26,163,74,.95); }
    .tvTeamPill.orange{ background: rgba(242,140,0,.95); }

    .tvScoreBox{
      width:56px;
      height:44px;
      border-radius:14px;
      border:3px solid rgba(0,0,0,.85);
      background:#fff;
      color:#111;
      font-size:22px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 18px rgba(0,0,0,.20);
    }

    /* الخريطة بالأسفل (غير قابلة للضغط) */
    .tvBody{
      flex:1 1 auto;
      overflow:auto;
      padding: 12px 12px calc(16px + env(safe-area-inset-bottom));
      box-sizing:border-box;
    }

    .mapOuter{ width:100%; display:flex; justify-content:center; }
    .mapScale{
      width:min(94vw, 980px);
      transform:scale(var(--zoom, 1));
      transform-origin:center top;
    }
    .mapBox{
      position:relative;
      width:100%;
      overflow:hidden;
      border-radius:0;
      background:transparent;
      box-shadow:0 18px 34px rgba(0,0,0,.30);
      border:6px solid rgba(0,0,0,.80);
    }
    .mapBox img{
      width:100%;
      height:auto;
      display:block;
      object-fit:unset;
      user-select:none;
      pointer-events:none;
    }
    .overlaySvg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none; /* ✅ لا يمكن الضغط على الخلايا */
    }
    .overlaySvg .cell{
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      stroke: var(--hexBorder);
      stroke-width: 1;
    }
    .overlaySvg .state0{ fill: rgba(0,0,0,0.001); }
    .overlaySvg .state1{ fill: var(--hexPale); }
    .overlaySvg .state2{ fill: var(--hexGreen); }
    .overlaySvg .state3{ fill: var(--hexOrange); }

    @keyframes palePulse {
      0%   { opacity: 1; }
      50%  { opacity: .35; }
      100% { opacity: 1; }
    }
    .overlaySvg .pulse{ animation: palePulse 1.1s ease-in-out infinite; }

    .tvMsg{
      text-align:center;
      margin-top:14px;
      opacity:.92;
      font-weight:800;
    }
  </style>
</head>
<body>
  <!-- ✅ الوضع العادي (فتح سريع) -->
  <div class="wrap">
    <img class="logo" src="logo.png" alt="صندوق المسابقات" onerror="this.style.display='none'">
    <div class="card">
      <div class="title"><span id="stateText">جاري فتح اللعبة</span><span class="spinner" id="sp"></span></div>
      <p class="sub" id="stateSub">لحظة.. جاري فتح اللعبة.</p>

      <div class="dbg" id="dbg"></div>
    </div>
    <div class="small">© صندوق المسابقات</div>
  </div>

  <!-- ✅ جهاز عرض الشاشة (يظهر فقط عند display=1) -->
  <div id="tvRoot" class="tvRoot hidden">
    <div class="tvTop">
      <div class="tvTopRow">
        <div class="tvRight">
          <img class="tvLogo" src="logo.png" alt="صندوق المسابقات" onerror="this.style.display='none'">
          <div class="tvZoomWrap">
            <input id="tvZoom" type="range" min="0.8" max="1.35" step="0.01" value="1" aria-label="تكبير تصغير الخريطة">
          </div>
        </div>

        <div id="tvGameName" class="tvCenter">—</div>

        <div class="tvLeft" aria-label="لوحة النتائج">
          <div class="tvTeamPill green">الفريق الأخضر</div>
          <div id="tvScoreGreen" class="tvScoreBox">0</div>
          <div id="tvScoreOrange" class="tvScoreBox">0</div>
          <div class="tvTeamPill orange">الفريق البرتقالي</div>
        </div>
      </div>
    </div>

    <div class="tvBody">
      <div class="mapOuter">
        <div id="mapScale" class="mapScale" style="--zoom:1">
          <div id="mapBox" class="mapBox">
            <img id="mapImg" src="" alt="">
            <svg id="overlay" class="overlaySvg"></svg>
          </div>
        </div>
      </div>

      <div id="tvMsg" class="tvMsg"></div>
    </div>
  </div>

  <script>
    (function(){
      const qs = new URLSearchParams(location.search);

      const DBG = qs.get("dbg") === "1";
      const dbgEl = document.getElementById("dbg");
      if (DBG) dbgEl.style.display = "block";
      const dbg = (t)=>{ if(DBG){ dbgEl.textContent = t; } };

      // ✅ تسجيل Service Worker بأسرع وقت (بدون ما نوقف التحويل)
      const canSW =
        ("serviceWorker" in navigator) &&
        (location.protocol === "https:" || location.hostname === "localhost");

      if (canSW) {
        try{
          navigator.serviceWorker.register("./sw.js").catch(() => {});
        }catch(e){}
      }

      // =========================
      // ✅ وضع جهاز عرض الشاشة
      // URL: index.html?display=1&code=ROOM_CODE
      // =========================
      const isDisplay = (qs.get("display") === "1");
      if(isDisplay){
        document.body.classList.add("displayMode");
        document.getElementById("tvRoot").classList.remove("hidden");

        const tvMsg = document.getElementById("tvMsg");
        const tvGameName = document.getElementById("tvGameName");
        const tvScoreGreen = document.getElementById("tvScoreGreen");
        const tvScoreOrange = document.getElementById("tvScoreOrange");

        const tvZoom = document.getElementById("tvZoom");
        const mapScale = document.getElementById("mapScale");
        const mapBox = document.getElementById("mapBox");
        const mapImg = document.getElementById("mapImg");
        const overlay = document.getElementById("overlay");

        const code = (qs.get("code") || "").trim();
        if(!code){
          tvMsg.textContent = "رمز الغرفة غير موجود بالرابط.";
          return;
        }

        // ✅ Cloudflare Worker/DO base (يمكن تغييره من الرابط عبر sync=)
        const SYNC_BASE = (qs.get("sync") || "https://horof-sync.sandooq-m.workers.dev").replace(/\/$/,"");

        // ✅ (نفس فكرة كسر الكاش للخرائط)
        const ASSET_VERSION = (qs.get("v") || "2026-02-15-1");
        const vq = `?v=${encodeURIComponent(ASSET_VERSION)}`;

        // ✅ إعداد SVG خلايا 5x5
        overlay.innerHTML = "";
        overlay.setAttribute("xmlns", "http://www.w3.org/2000/svg");
        const svgNS = "http://www.w3.org/2000/svg";
        for(let row=0; row<5; row++){
          for(let col=0; col<5; col++){
            const poly = document.createElementNS(svgNS, "polygon");
            poly.classList.add("cell", "state0");
            poly.setAttribute("data-row", row);
            poly.setAttribute("data-col", col);
            overlay.appendChild(poly);
          }
        }
        const CELLS = Array.from(overlay.querySelectorAll(".cell"));

        function setGameName(raw){
          const s0 = String(raw ?? "").replace(/\s+/g, " ").trim();
          if(!s0){ tvGameName.textContent = "—"; return; }
          const MAX_CHARS = 80;
          let s = s0;
          if(s.length > MAX_CHARS) s = s.slice(0, MAX_CHARS - 1).trim() + "…";
          tvGameName.textContent = s;
        }
        function clamp(n,min,max){
          n = Number(n);
          if(!Number.isFinite(n)) n = min;
          return Math.max(min, Math.min(max, n));
        }

        function cellKey(row,col){ return `${row}-${col}`; }

        function setStateClass(el, st){
          el.classList.remove("state0","state1","state2","state3","pulse");
          el.classList.add(`state${st}`);
          if(st === 1) el.classList.add("pulse");
        }

        function hexPointsPointyTop(x, y, w, h){
          const pts = [
            [x + w/2, y],
            [x + w,   y + h*0.25],
            [x + w,   y + h*0.75],
            [x + w/2, y + h],
            [x,       y + h*0.75],
            [x,       y + h*0.25],
          ];
          return pts.map(p => `${p[0].toFixed(2)},${p[1].toFixed(2)}`).join(" ");
        }

        // ✅ اكتشاف مساحة شبكة السداسي داخل صورة الخريطة
        const BBOX_CACHE = {};
        function detectHexBBox(img){
          const nw = img.naturalWidth, nh = img.naturalHeight;
          const maxW = 700;
          const scale = Math.min(1, maxW / nw);

          const cw = Math.round(nw * scale);
          const ch = Math.round(nh * scale);

          const canvas = document.createElement("canvas");
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext("2d", { willReadFrequently:true });
          ctx.drawImage(img, 0, 0, cw, ch);

          const data = ctx.getImageData(0,0,cw,ch).data;

          let minX = cw, minY = ch, maxX = -1, maxY = -1;
          let found = false;

          const step = 2;
          for(let y=0; y<ch; y+=step){
            for(let x=0; x<cw; x+=step){
              const i = (y*cw + x) * 4;
              const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
              if(a < 10) continue;

              const bright = (r + g + b) / 3;
              if(bright < 245){
                found = true;
                if(x < minX) minX = x;
                if(y < minY) minY = y;
                if(x > maxX) maxX = x;
                if(y > maxY) maxY = y;
              }
            }
          }

          if(!found){
            return { x0:0.12, y0:0.04, x1:0.90, y1:0.95 };
          }

          minX = Math.max(0, minX - 2);
          minY = Math.max(0, minY - 2);
          maxX = Math.min(cw - 1, maxX + 2);
          maxY = Math.min(ch - 1, maxY + 2);

          return {
            x0: minX / cw,
            y0: minY / ch,
            x1: (maxX + 1) / cw,
            y1: (maxY + 1) / ch,
          };
        }

        function applyZoomFix(){
          const z = clamp(tvZoom.value || 1, 0.8, 1.35);
          mapScale.style.setProperty("--zoom", z);

          const baseH = mapBox.offsetHeight || 0;
          const extra = Math.max(0, baseH * (z - 1));
          mapScale.parentElement.style.marginBottom = `${extra}px`;
        }

        const ZOOM_KEY = `sabaq_tv_zoom_${code}`;
        const savedZoom = Number(localStorage.getItem(ZOOM_KEY) || "");
        if(Number.isFinite(savedZoom) && savedZoom >= 0.8 && savedZoom <= 1.35){
          tvZoom.value = String(savedZoom);
        }
        tvZoom.addEventListener("input", () => {
          try{
            localStorage.setItem(ZOOM_KEY, String(tvZoom.value || "1"));
          }catch(e){}
          applyZoomFix();
        });

        function placeHexes(srcKey){
          const W = mapImg.clientWidth;
          const H = mapImg.clientHeight;
          if(!W || !H) return;

          overlay.setAttribute("viewBox", `0 0 ${W} ${H}`);
          overlay.setAttribute("preserveAspectRatio", "none");

          const bbox = BBOX_CACHE[srcKey];
          if(!bbox) return;

          const x0 = bbox.x0 * W;
          const y0 = bbox.y0 * H;
          const x1 = bbox.x1 * W;
          const y1 = bbox.y1 * H;

          const gridW = x1 - x0;
          const gridH = y1 - y0;

          const w = gridW / 5.5;
          const h = gridH / 4.0;
          const stepY = h * 0.75;

          let i = 0;
          for(let row=0; row<5; row++){
            for(let col=0; col<5; col++){
              const left = x0 + col*w + (row%2)*(w/2);
              const top  = y0 + row*stepY;
              CELLS[i++].setAttribute("points", hexPointsPointyTop(left, top, w, h));
            }
          }

          applyZoomFix();
        }

        function setMapSrc(activeMap){
          const srcBase = ([
            "maps/map1.jpeg",
            "maps/map2.jpeg",
            "maps/map3.jpeg"
          ][activeMap] || "maps/map1.jpeg");

          const key = srcBase;
          mapImg.src = srcBase + vq;

          const onReady = () => {
            try{
              if(!BBOX_CACHE[key]) BBOX_CACHE[key] = detectHexBBox(mapImg);
              requestAnimationFrame(()=> placeHexes(key));
            }catch(e){}
          };
          if(mapImg.complete) onReady();
          else mapImg.addEventListener("load", onReady, { once:true });

          window.addEventListener("resize", () => {
            try{ placeHexes(key); applyZoomFix(); }catch(e){}
          }, { passive:true });

          return key;
        }

        // ✅ (NEW) قراءة الغرفة من Durable Object بدل Firebase
        let lastActiveMap = null;
        let lastMapKey = null;
        let alive = true;

        async function fetchRoom(){
          const url = `${SYNC_BASE}/state?room=${encodeURIComponent(code)}`;
          const r = await fetch(url, { cache:"no-store" });
          const j = await r.json().catch(()=>null);
          if(!j || !j.ok) throw new Error("STATE_FAIL");
          return (j.state && typeof j.state === "object") ? j.state : {};
        }

        function readMapStates(room, activeMap){
          const ms = room.mapStates;
          if(!ms || typeof ms !== "object") return {};
          // يدعم مفاتيح رقمية أو نصية
          return ms[String(activeMap)] || ms[activeMap] || {};
        }

        async function tick(){
          if(!alive) return;
          try{
            const room = await fetchRoom();

            // إذا الغرفة لسه ما انعملت
            if(!room || Object.keys(room).length === 0){
              tvMsg.textContent = "الغرفة غير موجودة أو لم يتم إنشاؤها بعد.";
              return;
            }

            setGameName(room.name);

            const scores = room.scores || { green:0, orange:0 };
            tvScoreGreen.textContent = String(Number(scores.green ?? 0));
            tvScoreOrange.textContent = String(Number(scores.orange ?? 0));

            const activeMap = Number(room.activeMap || 0);
            if(lastActiveMap !== activeMap){
              lastActiveMap = activeMap;
              lastMapKey = setMapSrc(activeMap);
            }

            const mapStates = readMapStates(room, activeMap);
            for(const cell of CELLS){
              const r = Number(cell.getAttribute("data-row"));
              const c = Number(cell.getAttribute("data-col"));
              const k = cellKey(r,c);
              const st = Number(mapStates?.[k] ?? 0);
              setStateClass(cell, st);
            }

            tvMsg.textContent = "";
            dbg("DISPLAY(DO) room ok: " + code + " map=" + activeMap);

          }catch(e){
            tvMsg.textContent = "تعذر قراءة بيانات الغرفة.";
            dbg("DO error: " + (e?.message || e));
          }
        }

        function loop(){
          if(!alive) return;
          tick();
          const slow = document.hidden ? 1800 : 900;
          setTimeout(loop, slow);
        }

        tvMsg.textContent = "جاري الاتصال بالغرفة…";
        loop();

        window.addEventListener("beforeunload", ()=>{ alive = false; });

        return; // ✅ لا نكمل تحويل فتح اللعبة
      }

      // =========================
      // ✅ الوضع العادي: فتح اللعبة بسرعة (كما هو)
      // =========================

      // هدف اللعبة
      let r = (qs.get("r") || "game_full.html").trim();
      r = r.replace(/^\/+/, "");
      if (r.startsWith("http://") || r.startsWith("https://")) {
        try { r = new URL(r).pathname.replace(/^\/+/, ""); } catch(e){}
      }

      dbg("redirect -> " + r);

      // ✅ Redirect مرة واحدة فقط
      let didGo = false;
      const go = () => {
        if (didGo) return;
        didGo = true;
        location.replace(r);
      };

      // ✅ تحويل فوري تقريباً (غير ملحوظ)
      if (typeof requestAnimationFrame === "function") {
        requestAnimationFrame(go);
      } else {
        setTimeout(go, 0);
      }

      // ✅ ضمان: لو أي سبب ما تحوّل
      setTimeout(go, 120);
    })();
  </script>

  <!-- VERSION: index.html — vFastOpen-3 + DisplayMode-DO-1 -->
</body>
</html>
